<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>G7 • Unit 1 • Interactive Rational Numbers (Enhanced)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
<style>
  :root{--maroon:#6C1D45;--gold:#C7A34F;--ink:#1f2937;--paper:#ffffff;--soft:#f7f7f8}
  html,body{height:100%;background:#2d3748;color:#111;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  #stage{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;padding:10px}
  #deck{position:relative;width:100%;max-width:1280px;aspect-ratio:16/9;background:var(--paper);box-shadow:0 14px 36px rgba(0,0,0,.35);overflow:hidden;border-radius:18px}
  .slide{position:absolute;inset:0;padding:3.5%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;opacity:0;transform:translateY(14px) scale(.985);transition:.4s ease;pointer-events:none}
  .slide.active{opacity:1;transform:none;pointer-events:auto}
  .card{border:1px solid #e5e7eb;border-radius:16px;background:#fafafa}
  .btn{padding:.55rem 1rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
  .btn.maroon{background:var(--maroon);color:#fff;border-color:var(--maroon)}
  .chip{display:inline-flex;align-items:center;gap:.4rem;background:#f1f5f9;border-radius:9999px;padding:.4rem .8rem}
  .text-maroon{color:var(--maroon)} .text-gold{color:var(--gold)} .bg-maroon{background:var(--maroon)}
  #controls{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:.5rem;z-index:20}
  #controls button{width:42px;height:42px;border-radius:999px;border:none;background:#fff;font-weight:700}
  #counter{color:#fff;font-weight:700;min-width:100px;text-align:center}
  #progress{position:absolute;left:0;bottom:0;height:5px;width:0;background:var(--gold);z-index:10;transition:width .35s ease}
  .nl-wrap{width:100%;max-width:920px}
  canvas.nline{width:100%;height:170px;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa);border:2px solid #ececec}
  /* Fraction Lab canvases */
  .lab-can{width:100%;height:260px;border-radius:12px;background:#fff;border:2px solid #ececec}
  .toggle{display:inline-flex;border:1px solid #cbd5e1;border-radius:9999px;overflow:hidden}
  .toggle button{padding:.35rem .75rem;border:none;background:#fff}
  .toggle button.active{background:var(--maroon);color:#fff}
</style>
</head>
<body>
<div id="stage">
  <div id="deck" class="relative">

    <!-- Title -->
    <section class="slide active bg-maroon text-white">
      <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight">Unit 1 — The Number System</h1>
      <p class="text-gold text-2xl md:text-3xl mt-2 font-semibold">Addition &amp; Subtraction of Rational Numbers</p>
      <p class="mt-2 text-lg">QLA • Grade 7</p>
    </section>

    <!-- NEW Warm-Up: WODB + Estimation Duel -->
    <section class="slide" id="warmup">
      <h2 class="text-3xl font-extrabold text-maroon mb-3">Warm‑Up: Notice & Wonder + WODB</h2>
      <div class="grid lg:grid-cols-2 gap-5 w-full max-w-5xl text-left">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Which One Doesn't Belong?</h3>
          <div id="wodbSet" class="grid grid-cols-2 gap-3"></div>
          <div class="mt-3 flex gap-2 items-center">
            <button id="wodbNew" class="btn">New set</button>
            <span class="text-sm">Click a tile, defend your choice.</span>
          </div>
          <div id="wodbClaim" class="mt-2 font-semibold"></div>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Estimation Duel: \(p+q\) on a Number Line</h3>
          <div class="nl-wrap"><canvas id="estLine" class="nline" aria-label="Estimation number line"></canvas></div>
          <div class="mt-2 text-sm">Place your guesses for \(p\) and \(p+q\). Closest wins; reveal actual after debate.</div>
          <div class="mt-2 flex flex-wrap gap-2 text-sm">
            <button id="estNew" class="btn">New duel</button>
            <button id="estReveal" class="btn maroon">Reveal</button>
            <span class="chip">p ≈ <b id="gP">?</b></span>
            <span class="chip">p+q ≈ <b id="gR">?</b></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Fraction Interpretation Lab -->
    <section class="slide" id="fracLab">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Fraction Lab: Interpret \(\,\frac{a}{b}\; \square\; \frac{c}{d}\,\)</h2>
      <div class="grid lg:grid-cols-3 gap-5 w-full max-w-6xl text-left">
        <div class="card p-4">
          <h3 class="text-lg font-bold text-maroon mb-1">1) Setup (Predict)</h3>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <label class="chip">a <input id="A_num" type="number" class="border rounded px-2 py-1 w-20" value="1"></label>
            <label class="chip">b <input id="A_den" type="number" class="border rounded px-2 py-1 w-20" value="3"></label>
            <label class="chip">c <input id="B_num" type="number" class="border rounded px-2 py-1 w-20" value="1"></label>
            <label class="chip">d <input id="B_den" type="number" class="border rounded px-2 py-1 w-20" value="4"></label>
          </div>
          <div class="mt-2 toggle" role="tablist" aria-label="Choose operation">
            <button id="opAdd" class="active" aria-selected="true">Add</button>
            <button id="opSub">Subtract</button>
          </div>
          <div class="mt-2 toggle" role="tablist" aria-label="Representation">
            <button id="repPie" class="active">Pie</button>
            <button id="repBar">Bars</button>
            <button id="repLine">Number Line</button>
          </div>
          <div class="mt-2 text-sm">Your prediction: <input id="pred" class="border rounded px-2 py-1 w-40" placeholder="e.g., 7/12 or 0.58"></div>
          <div class="mt-2 flex gap-2"><button id="labNew" class="btn">Random</button><button id="labClear" class="btn">Clear</button></div>
        </div>
        <div class="card p-4">
          <h3 class="text-lg font-bold text-maroon mb-1">2) Model (Build equivalents)</h3>
          <canvas id="labModel" class="lab-can" aria-label="Fraction model canvas"></canvas>
          <div class="mt-2 text-sm flex flex-wrap gap-2">
            <span class="chip">LCM(b,d) = <b id="labLCM">–</b></span>
            <span class="chip">Eqv: <b id="eqA">–</b></span>
            <span class="chip">Eqv: <b id="eqB">–</b></span>
            <label class="chip"><input id="showLCMGrid" type="checkbox" class="mr-2">Show partitions</label>
          </div>
          <div class="mt-2 flex gap-2"><button id="labStep1" class="btn maroon">Build equivalents</button><button id="labStep2" class="btn">Combine / Remove</button></div>
        </div>
        <div class="card p-4">
          <h3 class="text-lg font-bold text-maroon mb-1">3) Record (Simplify & Explain)</h3>
          <div class="text-xl">\(\frac{a}{b}\; <span id="opSym">+</span>\; \frac{c}{d} =\) <b id="labAns">?</b></div>
          <div class="mt-2 text-sm">Simplest form: <input id="labUser" class="border rounded px-2 py-1 w-40" placeholder="e.g., 7/12"></div>
          <div class="mt-2 flex gap-2"><button id="labCheck" class="btn maroon">Check</button><button id="labHint" class="btn">Hint</button></div>
          <div id="labFb" class="mt-2 h-6 font-semibold"></div>
          <div id="labHintBox" class="mt-2 text-sm"></div>
        </div>
      </div>
      <div class="mt-3 text-sm text-gray-600">Tip: Toggle Pie/Bars/Line to compare models. In subtraction, orange shows the amount removed.</div>
    </section>

    <!-- Guided Practice (refined tasks) -->
    <section class="slide" id="guided">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Guided Practice: Like & Unlike Denominators</h2>
      <div class="grid lg:grid-cols-2 gap-6 w-full max-w-5xl text-left">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Like Denominators</h3>
          <div id="likeList" class="grid gap-3"></div>
          <div class="mt-3 flex gap-2"><button id="likeCheck" class="btn maroon">Check</button><button id="likeNew" class="btn">New set</button></div>
          <div id="likeFb" class="mt-2 h-6 font-semibold"></div>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Unlike Denominators (Guided)</h3>
          <div id="unlikeBox" class="grid gap-3"></div>
          <div class="mt-3 flex gap-2"><button id="unlikeCheck" class="btn maroon">Check</button><button id="unlikeNew" class="btn">New pair</button></div>
          <div id="unlikeFb" class="mt-2 h-6 font-semibold"></div>
        </div>
      </div>
    </section>

    <!-- Exit ticket -->
    <section class="slide" id="exit">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Exit Ticket</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">3–2–1 Reflect</h3>
          <ul class="list-disc list-inside">
            <li>3 ideas from the Fraction Lab</li>
            <li>2 representations you trust (and why)</li>
            <li>1 question you still have</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">Up Next</h3>
          <p>Multi‑step rational problems & estimation for reasonableness (AERO 7.EE.3).</p>
        </div>
      </div>
    </section>

    <!-- Controls -->
    <div id="controls">
      <button id="prev" title="Previous">«</button>
      <button id="fs" title="Fullscreen">⤢</button>
      <div id="counter" class="text-white">1 / 4</div>
      <button id="next" title="Next">»</button>
    </div>
    <div id="progress"></div>
  </div>
</div>

<script>
// ---------- Boot KaTeX
window.addEventListener('DOMContentLoaded',()=>{
  const run=(root=document.body)=>{
    if(!window.renderMathInElement) return;
    window.renderMathInElement(root,{delimiters:[{left:'$$',right:'$$',display:true},{left:'\\[',right:'\\]',display:true},{left:'\\(',right:'\\)',display:false}],throwOnError:false});
  };
  if(window.renderMathInElement) run(); else {const t=setInterval(()=>{if(window.renderMathInElement){clearInterval(t);run()}},25); setTimeout(()=>clearInterval(t),6e3)}
  window._rerenderMath=run;
});

// ---------- Slide engine
(function(){
  const slides=[...document.querySelectorAll('.slide')];
  const prev=I('prev'), next=I('next'), counter=I('counter'), progress=I('progress'), fsBtn=I('fs');
  let i=0;
  function show(k){
    i=(k+slides.length)%slides.length; slides.forEach((s,idx)=>s.classList.toggle('active',idx===i));
    counter.textContent=(i+1)+' / '+slides.length; progress.style.width=((i+1)/slides.length*100)+'%';
    if(slides[i].id==='warmup') { wodbNew(); drawEst(); }
    if(slides[i].id==='fracLab') { labRender(); }
    if(slides[i].id==='guided') { renderLike(); newUnlike(); }
    if(window._rerenderMath) window._rerenderMath(slides[i]);
  }
  prev.addEventListener('click',()=>show(i-1)); next.addEventListener('click',()=>show(i+1));
  document.addEventListener('keydown',e=>{ if(e.key==='ArrowRight') show(i+1); if(e.key==='ArrowLeft') show(i-1); if(e.key.toLowerCase()==='f') toggleFS(); });
  function toggleFS(){ const el=I('deck'); if(!document.fullscreenElement){(el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el);} else{(document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen).call(document);} }
  fsBtn.addEventListener('click',toggleFS);
  window.addEventListener('resize',()=>{ if(slides[i].id==='warmup') drawEst(); if(slides[i].id==='fracLab') labRender(); });
  function I(x){return document.getElementById(x)}
  show(0);
})();

// ---------- Helpers
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const gcd=(a,b)=>{a=Math.trunc(Math.abs(a));b=Math.trunc(Math.abs(b));while(b){[a,b]=[b,a%b]}return a||1};
const lcm=(a,b)=>Math.abs(a*b)/gcd(a,b);
function parseRational(s){
  if(typeof s==='number') return [Math.trunc(s*1000),1000];
  if(!s) return null; s=s.toString().trim().replace('−','-');
  const f=s.match(/^(-?\d+)\/(-?\d+)$/); if(f){let n=+f[1],d=+f[2]; if(d===0) return null; let g=gcd(n,d); d<0&&(g=-g); return [n/g,d/g];}
  if(!isNaN(Number(s))){ const parts=s.split('.'); if(parts.length===1) return [Number(s),1]; const k=parts[1].length; const n=Math.round(Number(s)*10**k); const d=10**k; let g=gcd(n,d); return [n/g,d/g]; }
  return null;
}
function toFrac(n,d){let g=gcd(n,d); d<0&&(g=-g); return [n/g,d/g]}
const addFrac=(a,b)=>toFrac(a[0]*b[1]+b[0]*a[1], a[1]*b[1]);
const subFrac=(a,b)=>toFrac(a[0]*b[1]-b[0]*a[1], a[1]*b[1]);
const fracEq=(a,b)=>a[0]*b[1]===b[0]*a[1];
const sFrac=([n,d])=> d===1? String(n) : `${n}/${d}`;

// ---------- WODB Warm-up
(function(){
  const T=()=>({val:randVal(), type:['int','frac','dec'][Math.floor(Math.random()*3)]});
  function randVal(){ const r=Math.random(); if(r<.34) return Math.floor(Math.random()*17)-8; if(r<.67){ const den=[4,5,6,8,10,12][Math.floor(Math.random()*6)]; const num=Math.floor(Math.random()*(den*2+1))-den; return `${num}/${den}` } const v=Math.round((Math.random()*20-10)*10)/10; return v.toFixed(1).replace(/\.0$/,''); }
  window.wodbNew=function(){
    const cells=[T(),T(),T(),T()]; const box=document.getElementById('wodbSet'); box.innerHTML='';
    cells.forEach((c,idx)=>{
      const d=document.createElement('button'); d.className='border rounded p-3 bg-white hover:ring-2 hover:ring-[var(--gold)] text-left';
      d.innerHTML=`<div class="text-sm text-gray-500">Tile ${idx+1}</div><div class="text-2xl font-extrabold">${c.type==='frac'?`\\( ${c.val} \\)`:c.val}</div>`;
      d.addEventListener('click',()=>{
        const claim=genClaim(cells,idx); document.getElementById('wodbClaim').innerHTML=claim; if(window._rerenderMath) window._rerenderMath(document.getElementById('warmup'));
      });
      box.appendChild(d);
    });
    if(window._rerenderMath) window._rerenderMath(document.getElementById('warmup'));
  }
  function genClaim(cells,idx){
    const picked=cells[idx]; const others=cells.filter((_,i)=>i!==idx);
    const p=picked.val; const fr=picked.type==='frac';
    if(fr) return `I think Tile ${idx+1} doesn’t belong because it’s a <b>fraction</b> and the others can be written without a denominator. Convert the others to fractions to compare.`;
    if(typeof p==='string' && p.includes('/')) return `Tile ${idx+1}: <b>unlike denominators</b> with others → needs LCM to compare.`;
    const num=parseFloat(p);
    if(num<0) return `Tile ${idx+1} is the only <b>negative</b> value.`;
    if(Number.isInteger(num)) return `Tile ${idx+1} is the only <b>integer</b> (no fractional part).`;
    return `Tile ${idx+1} is different by <b>place value structure</b> (decimal vs fraction).`;
  }
  document.getElementById('wodbNew').addEventListener('click',wodbNew);
})();

// ---------- Estimation Duel
(function(){
  const c=document.getElementById('estLine'); const gP=document.getElementById('gP'); const gR=document.getElementById('gR');
  const state={min:-12,max:12,p:0,q:0, gp:null, gr:null, reveal:false};
  function map(x){const m=28,W=c.clientWidth;return m+(x-state.min)*(W-2*m)/(state.max-state.min)}
  function unmap(px){const m=28,W=c.clientWidth;return state.min+(px-m)*(state.max-state.min)/(W-2*m)}
  function draw(){ if(!c) return; const ctx=c.getContext('2d'); c.width=c.clientWidth*devicePixelRatio; c.height=c.clientHeight*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
    const y=c.clientHeight/2,m=28; ctx.clearRect(0,0,c.clientWidth,c.clientHeight);
    ctx.lineWidth=2; ctx.strokeStyle='#6C1D45'; ctx.beginPath(); ctx.moveTo(m,y); ctx.lineTo(c.clientWidth-m,y); ctx.stroke();
    for(let t=state.min;t<=state.max;t++){const x=map(t); ctx.beginPath(); ctx.moveTo(x,y-8); ctx.lineTo(x,y+8); ctx.stroke(); if(t%2==0){ctx.fillStyle='#555'; ctx.font='12px Inter'; ctx.fillText(String(t),x-6,y+24);}}
    if(state.gp!=null){ ctx.fillStyle='#6C1D45'; ctx.beginPath(); ctx.arc(map(state.gp),y,7,0,Math.PI*2); ctx.fill(); }
    if(state.gr!=null){ ctx.fillStyle='#C7A34F'; ctx.beginPath(); ctx.arc(map(state.gr),y,7,0,Math.PI*2); ctx.fill(); }
    if(state.reveal){ ctx.strokeStyle='#C7A34F'; ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(map(state.p),y); ctx.lineTo(map(state.p+state.q),y); ctx.stroke(); }
  }
  function newDuel(){ state.p=+(Math.random()*12-6).toFixed(1); state.q=+(Math.random()*8-4).toFixed(1); state.gp=null; state.gr=null; state.reveal=false; gP.textContent='?'; gR.textContent='?'; draw(); }
  c.addEventListener('click',e=>{ const r=c.getBoundingClientRect(); const x=unmap(e.clientX-r.left); if(state.gp==null){state.gp=x; gP.textContent=x.toFixed(1);} else {state.gr=x; gR.textContent=x.toFixed(1);} draw(); });
  document.getElementById('estNew').addEventListener('click',newDuel);
  document.getElementById('estReveal').addEventListener('click',()=>{state.reveal=true; draw();});
  window.drawEst=draw; window.estNew=newDuel; newDuel();
})();

// ---------- Fraction Lab (Pie/Bars/Number Line)
(function(){
  const A_num=G('A_num'), A_den=G('A_den'), B_num=G('B_num'), B_den=G('B_den');
  const opAdd=G('opAdd'), opSub=G('opSub'), opSym=G('opSym');
  const repPie=G('repPie'), repBar=G('repBar'), repLine=G('repLine');
  const pred=G('pred'), LCMOut=G('labLCM'), eqA=G('eqA'), eqB=G('eqB');
  const labModel=G('labModel'), showGrid=G('showLCMGrid');
  const step1=G('labStep1'), step2=G('labStep2'), labAns=G('labAns'), labUser=G('labUser'), labCheck=G('labCheck'), labHint=G('labHint'), labHintBox=G('labHintBox');
  const labNew=G('labNew'), labClear=G('labClear');
  const state={op:'+', rep:'pie', built:false, combined:false};
  function G(id){return document.getElementById(id)}
  function active(btn,group){ [repPie,repBar,repLine,opAdd,opSub].forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }

  opAdd.addEventListener('click',()=>{state.op='+'; opSym.textContent='+'; active(opAdd); labRender();});
  opSub.addEventListener('click',()=>{state.op='-'; opSym.textContent='−'; active(opSub); labRender();});
  repPie.addEventListener('click',()=>{state.rep='pie'; active(repPie); labRender();});
  repBar.addEventListener('click',()=>{state.rep='bar'; active(repBar); labRender();});
  repLine.addEventListener('click',()=>{state.rep='line'; active(repLine); labRender();});

  [A_num,A_den,B_num,B_den,showGrid].forEach(el=>el.addEventListener('input',()=>{state.built=false; state.combined=false; labAns.textContent='?'; labRender();}));
  labNew.addEventListener('click',()=>{ A_den.value=[3,4,5,6,8,10,12][rand(0,6)]; B_den.value=[3,4,5,6,8,10,12][rand(0,6)]; A_num.value=rand(1,Math.max(1,A_den.value-1)); B_num.value=rand(1,Math.max(1,B_den.value-1)); state.built=false; state.combined=false; labAns.textContent='?'; labRender(); });
  labClear.addEventListener('click',()=>{pred.value=''; labUser.value=''; state.built=false; state.combined=false; labAns.textContent='?'; labRender();});

  step1.addEventListener('click',()=>{ buildEquivalents(); state.built=true; labRender(); });
  step2.addEventListener('click',()=>{ if(!state.built) buildEquivalents(); state.combined=true; labRender(true); });

  labCheck.addEventListener('click',()=>{
    const ans = compute(); const got=parseRational(labUser.value);
    if(got && fracEq(got,ans)){ fb('labFb','✅ Correct! '+sFrac(ans),'green'); } else { fb('labFb','❌ Not quite. Expected '+sFrac(ans),'red'); }
  });
  labHint.addEventListener('click',()=>{
    const b=Number(A_den.value), d=Number(B_den.value); const L=lcm(b,d);
    labHintBox.innerHTML=`<div class="chip">Hint: LCM(${b}, ${d}) = <b>${L}</b>. Build equivalents: \( ${A_num}/${b} = ${A_num*(L/b)}/${L} \), \( ${B_num}/${d} = ${B_num*(L/d)}/${L} \).</div>`;
    if(window._rerenderMath) window._rerenderMath(G('fracLab'));
  })

  function compute(){
    const a=[Number(A_num.value), Number(A_den.value)], b=[Number(B_num.value), Number(B_den.value)];
    return state.op==='+'? addFrac(a,b): subFrac(a,b);
  }
  function buildEquivalents(){
    const b=Number(A_den.value), d=Number(B_den.value); const L=lcm(b,d); const eA=[Number(A_num.value)*(L/b), L]; const eB=[Number(B_num.value)*(L/d), L];
    LCMOut.textContent=L; eqA.textContent=`${eA[0]}/${eA[1]}`; eqB.textContent=`${eB[0]}/${eB[1]}`;
  }
  function fb(id,msg,color){ const el=G(id); el.textContent=msg; el.className='mt-2 h-6 font-semibold '+(color==='green'?'text-green-700':'text-red-700'); }
  function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a}

  // Rendering
  function labRender(animate=false){
    const ctx=labModel.getContext('2d'); labModel.width=labModel.clientWidth*devicePixelRatio; labModel.height=labModel.clientHeight*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
    const W=labModel.clientWidth, H=labModel.clientHeight; ctx.clearRect(0,0,W,H);
    const aN=Number(A_num.value), aD=Number(A_den.value), bN=Number(B_num.value), bD=Number(B_den.value);
    const L=lcm(aD,bD); const eA=aN*(L/aD), eB=bN*(L/bD);
    LCMOut.textContent=L; eqA.textContent=`${eA}/${L}`; eqB.textContent=`${eB}/${L}`;
    // decide op
    const sign = (state.op==='+'? +1 : -1);
    const total = clamp(eA + sign*eB, -L*2, L*2);
    // layout boxes
    const pad=24; const cols=3; const boxW=(W-4*pad)/cols; const boxH=H-2*pad;
    // draw boxes labels
    drawBox(ctx,pad,pad,boxW,boxH,'A',state.rep,eA,L,showGrid.checked);
    drawBox(ctx,2*pad+boxW,pad,boxW,boxH,(state.op==='+'?'+':'−'),state.rep,eB,L,showGrid.checked,true);
    drawBox(ctx,3*pad+2*boxW,pad,boxW,boxH,'Result',state.rep,total,L,showGrid.checked,false,true);

    // write algebraic answer if combined
    if(state.combined){ const ans = toFrac(total, L); labAns.textContent=sFrac(ans); if(window._rerenderMath) window._rerenderMath(G('fracLab')); }
  }

  function drawBox(ctx,x,y,w,h,label,rep,count,L,grid,neg=false,emph=false){
    // frame
    ctx.save(); ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=2; ctx.strokeRect(x,y,w,h);
    ctx.fillStyle='#111'; ctx.font='14px Inter'; ctx.fillText(label,x+4,y+16);
    // choose renderer
    if(rep==='pie') drawPie(ctx,x,y,w,h,count,L,grid,neg,emph);
    else if(rep==='bar') drawBars(ctx,x,y,w,h,count,L,grid,neg,emph);
    else drawLine(ctx,x,y,w,h,count,L,grid,neg,emph);
    ctx.restore();
  }

  function drawPie(ctx,x,y,w,h,count,L,grid,neg,emph){
    const cx=x+w/2, cy=y+h/2, r=Math.min(w,h)*0.36; const start=-Math.PI/2; const unit=2*Math.PI/L;
    // grid slices
    if(grid){ ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1; for(let k=0;k<L;k++){ ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,start+k*unit,start+(k+1)*unit); ctx.closePath(); ctx.stroke(); }}
    // fill count
    const sign = count<0?-1:1; const n=Math.abs(count);
    for(let k=0;k<n;k++){
      const a0=start+k*unit; const a1=a0+unit; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,r,a0,a1); ctx.closePath(); ctx.fillStyle = neg? '#f59e0b' : '#6C1D45'; ctx.globalAlpha=emph?0.95:0.85; ctx.fill(); ctx.globalAlpha=1; }
    // outline
    ctx.beginPath(); ctx.arc(cx,cy,r,0,2*Math.PI); ctx.strokeStyle=emph?'#C7A34F':'#94a3b8'; ctx.lineWidth=emph?3:2; ctx.stroke();
  }

  function drawBars(ctx,x,y,w,h,count,L,grid,neg,emph){
    const pw=w*0.8, ph=h*0.6; const px=x+(w-pw)/2, py=y+(h-ph)/2;
    ctx.strokeStyle=emph?'#C7A34F':'#94a3b8'; ctx.lineWidth=emph?3:2; ctx.strokeRect(px,py,pw,ph);
    const unit=pw/L; if(grid){ ctx.strokeStyle='#e5e7eb'; for(let k=1;k<L;k++){ ctx.beginPath(); ctx.moveTo(px+k*unit,py); ctx.lineTo(px+k*unit,py+ph); ctx.stroke(); }}
    const n=Math.abs(count); ctx.fillStyle=neg?'#f59e0b':'#6C1D45'; ctx.globalAlpha=0.9;
    ctx.fillRect(px,py,n*unit,ph); ctx.globalAlpha=1;
  }

  function drawLine(ctx,x,y,w,h,count,L,grid,neg,emph){
    const mY=y+h/2; const left=x+w*0.1, right=x+w*0.9; const len=right-left; const unit=len/L;
    ctx.strokeStyle=emph?'#C7A34F':'#94a3b8'; ctx.lineWidth=emph?3:2; ctx.beginPath(); ctx.moveTo(left,mY); ctx.lineTo(right,mY); ctx.stroke();
    if(grid){ ctx.strokeStyle='#e5e7eb'; for(let k=0;k<=L;k++){ const xx=left+k*unit; ctx.beginPath(); ctx.moveTo(xx,mY-10); ctx.lineTo(xx,mY+10); ctx.stroke(); }}
    const n=Math.abs(count); ctx.strokeStyle=neg?'#f59e0b':'#6C1D45'; ctx.lineWidth=6; ctx.beginPath(); ctx.moveTo(left,mY); ctx.lineTo(left+n*unit,mY); ctx.stroke();
  }

  window.labRender=labRender;
})();

// ---------- Guided Practice (reuse of like/unlike from prior lesson)
(function(){
  const likePairs=[['5/8','-1/8','+'],['7/9','2/9','-'],['-3/10','4/10','+'],['-5/6','-1/6','+'],['11/12','1/12','-'],['-7/15','2/15','+']];
  const likeState={set:[]};
  window.renderLike=function(){
    const box=document.getElementById('likeList'); box.innerHTML=''; likeState.set=[];
    likePairs.sort(()=>Math.random()-0.5).slice(0,4).forEach((t,idx)=>{
      const [a,b,op]=t; const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1}</div>
        <div class="text-xl mt-1">\\( ${a} ${op} ${b} \\) = <input class="lin border rounded px-2 py-1 w-32" placeholder="e.g., 1/4"></div>`;
      row.dataset.a=a; row.dataset.b=b; row.dataset.op=op; box.appendChild(row);
      likeState.set.push({a,b,op});
    });
    if(window._rerenderMath) window._rerenderMath(document.getElementById('guided'));
  }
  document.getElementById('likeNew').addEventListener('click',renderLike);
  document.getElementById('likeCheck').addEventListener('click',()=>{
    let total=0,ok=0; document.getElementById('likeList').querySelectorAll('.card').forEach(row=>{
      total++; const A=parseRational(row.dataset.a), B=parseRational(row.dataset.b); const op=row.dataset.op;
      const ans=(op==='+')? addFrac(A,B): subFrac(A,B); const inp=row.querySelector('.lin'); const got=parseRational(inp.value);
      if(got && fracEq(toFrac(got[0],got[1]), ans)){inp.style.borderColor='#22c55e'; ok++;} else {inp.style.borderColor='#ef4444';}
    });
    const fb=document.getElementById('likeFb'); fb.textContent= ok===total?'✅ All correct!':'Score: '+ok+'/'+total;
  });

  // Unlike guided
  const unlikeState={};
  window.newUnlike=function(){
    const den1=[3,4,5,6,8,9][Math.floor(Math.random()*6)];
    const den2=[4,5,6,7,8,9,10][Math.floor(Math.random()*7)];
    const n1=Math.floor(Math.random()*den1), n2=Math.floor(Math.random()*den2);
    const op=Math.random()<0.5?'+':'-';
    const box=document.getElementById('unlikeBox');
    box.innerHTML=`
      <div class="card p-4 text-lg">\\( \\frac{${n1}}{${den1}} ${op} \\frac{${n2}}{${den2}} \\)</div>
      <div class="card p-4">
        <ol class="list-decimal ml-5">
          <li class="mt-1">LCM = <input id="lcmIn" class="border rounded px-2 py-1 w-28" placeholder="LCM"></li>
          <li class="mt-1">Build equivalents →
            <div class="mt-1 flex flex-wrap items-center gap-2">
              <span>\\( \\frac{${n1}}{${den1}} = \\)</span><input id="eq1" class="border rounded px-2 py-1 w-24" placeholder="?">/
              <input id="d1" class="border rounded px-2 py-1 w-24" placeholder="?">
              <span class="ml-4">\\( \\frac{${n2}}{${den2}} = \\)</span><input id="eq2" class="border rounded px-2 py-1 w-24" placeholder="?">/
              <input id="d2" class="border rounded px-2 py-1 w-24" placeholder="?">
            </div>
          </li>
          <li class="mt-1">Operate & simplify: <input id="unAns" class="border rounded px-2 py-1 w-28" placeholder="e.g., 7/12"></li>
        </ol>
      </div>`;
    if(window._rerenderMath) window._rerenderMath(document.getElementById('guided'));
    unlikeState.a=`${n1}/${den1}`; unlikeState.b=`${n2}/${den2}`; unlikeState.op=op;
  }
  document.getElementById('unlikeNew').addEventListener('click',newUnlike);
  document.getElementById('unlikeCheck').addEventListener('click',()=>{
    const a=parseRational(unlikeState.a), b=parseRational(unlikeState.b), op=unlikeState.op; const L=lcm(a[1],b[1]);
    const A=[a[0]*(L/a[1]), L], B=[b[0]*(L/b[1]), L]; const ans = (op==='+')? addFrac(A,B) : subFrac(A,B);
    let ok=true; function chk(id,v){ const el=document.getElementById(id); const good=(String(el.value).trim()==String(v)); el.style.borderColor=good?'#22c55e':'#ef4444'; if(!good) ok=false; }
    chk('lcmIn',L); chk('eq1',A[0]); chk('d1',A[1]); chk('eq2',B[0]); chk('d2',B[1]);
    const got=parseRational(document.getElementById('unAns').value); if(!(got && fracEq(got, ans))){ok=false; document.getElementById('unAns').style.borderColor='#ef4444'} else document.getElementById('unAns').style.borderColor='#22c55e';
    document.getElementById('unlikeFb').textContent= ok?'✅ Nice work!':'❌ Check highlights';
  });
})();
</script>
</body>
</html>
