<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>G7 ‚Ä¢ Unit 1 ‚Ä¢ Addition & Subtraction of Rational Numbers ‚Äî Interactive (QLA)</title>

<!-- Fonts & Tailwind -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

<style>
  :root{
    --maroon:#6C1D45;--gold:#C7A34F;--dark:#1e1e23;--ink:#111;--bg:#f7f7fb;--paper:#ffffff
  }
  html,body{height:100%;background:var(--dark);color:#111;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  /* Stage + Slide system */
  #stage{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;padding:8px}
  #screen{position:relative;width:100%;max-width:1400px;aspect-ratio:16/9;background:var(--paper);box-shadow:0 16px 42px rgba(0,0,0,.4);overflow:hidden;border-radius:18px}
  .slide{position:absolute;inset:0;padding:3.6%;display:flex;flex-direction:column;gap:16px;opacity:0;transform:translateY(16px) scale(.985);transition:.45s ease;pointer-events:none}
  .slide.active{opacity:1;transform:none;pointer-events:auto}
  .part-tag{position:absolute;top:14px;left:14px;font-weight:800;background:#f4efe9;color:var(--maroon);border:2px solid var(--gold);padding:.25rem .6rem;border-radius:999px}
  .big{font-size:clamp(24px,2.6vw,36px)}
  .huge{font-size:clamp(34px,3.8vw,56px);line-height:1.05}
  .card{background:#fafafa;border:1px solid #ececec;border-radius:14px;padding:14px}
  .chip{display:inline-flex;align-items:center;gap:.5rem;background:#f1f1f5;border:1px solid #e6e6ea;border-radius:999px;padding:.35rem .75rem;cursor:pointer}
  .chip:hover{outline:2px solid var(--gold)}
  .btn{padding:.6rem 1rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:800}
  .btn.maroon{background:var(--maroon);color:#fff;border-color:var(--maroon)}
  .btn.ghost{background:#fff0;border-color:#dcdcdc}
  .hint{background:#fff8db;border:1px solid #ffe38a;border-radius:10px;padding:.5rem .75rem}
  .banner{height:90px;background:linear-gradient(90deg,#fff,#f7f3ea);border-bottom:3px solid var(--gold);border-radius:12px}
  .titlebar{display:flex;gap:14px;align-items:center}
  .titlebar h1{font-weight:900}
  /* Presenter bar */
  #presenter{position:fixed;bottom:14px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.62);padding:.45rem .6rem;border-radius:999px;z-index:120;backdrop-filter:blur(6px)}
  #presenter button{height:44px;min-width:44px;border-radius:999px;border:none;background:#fff;cursor:pointer;font-weight:800}
  #presenter button:hover{transform:scale(1.05)}
  #counter{color:#fff;font-weight:800;min-width:92px;text-align:center}
  #progress{position:fixed;left:0;bottom:0;height:5px;width:0;background:var(--gold);z-index:110;transition:width .35s ease}
  #fsHint{position:absolute;top:10px;right:12px;color:#fff;background:rgba(0,0,0,.38);padding:.25rem .5rem;border-radius:8px;font-size:.82rem}
  /* Ink overlay */
  #ink{position:absolute;inset:0;pointer-events:none}
  #ink canvas{position:absolute;inset:0}
  .ink-on #ink{pointer-events:auto;cursor:crosshair}
  /* Teacher tools drawer */
  #tools{position:fixed;right:12px;top:12px;z-index:130;width:min(420px,92vw);max-height:88vh;overflow:auto;background:#ffffff;border:2px solid var(--gold);border-radius:14px;box-shadow:0 16px 48px rgba(0,0,0,.35);display:none}
  #tools header{display:flex;justify-content:space-between;align-items:center;padding:.6rem .8rem;border-bottom:1px solid #eee;font-weight:800;color:var(--maroon)}
  #tools .body{padding:.8rem}
  #tools .row{display:flex;gap:10px;flex-wrap:wrap}
  #tools .pill{border:1px solid #ddd;border-radius:999px;padding:.25rem .6rem;font-weight:700;cursor:pointer}
  #tools .pill.on{background:var(--maroon);color:#fff;border-color:var(--maroon)}
  #tools .mini{display:flex;gap:6px;align-items:center}
  /* Poll dots */
  .dot{width:14px;height:14px;border-radius:999px;background:#e5e7eb;display:inline-block;margin-right:6px}
  .dot.on{background:var(--gold)}
  /* Number line canvas */
  .nl-wrap{width:100%;max-width:920px;margin:0 auto}
  canvas.nline{width:100%;height:170px;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa);border:2px solid #ececec}
  /* Sortable */
  .sortable li{user-select:none}.sortable .dragging{opacity:.5}
  /* Confetti */
  .confetti{position:fixed;pointer-events:none;z-index:150}
  /* Board mode */
  .board *{letter-spacing:.3px}
  .board #presenter{background:rgba(0,0,0,.7)}
  .board .slide{padding:3%}
</style>
</head>
<body>

<div id="stage" aria-live="polite">
  <div id="screen" class="relative">
    <div id="fsHint">Keys: ‚Üê/‚Üí, 1‚Äì7 (Parts), F (fullscreen), T (tools), P (pen), B (board)</div>

    <!-- ============ PART A ‚Ä¢ LAUNCH ============ -->
    <section class="slide active" data-part="A">
      <span class="part-tag">Part A ‚Ä¢ Launch</span>
      <div class="banner"></div>
      <div class="titlebar">
        <div>
          <h1 class="huge text-[color:var(--maroon)]">Unit 1 ‚Äî The Number System</h1>
          <div class="big text-[color:var(--gold)] font-extrabold">Lesson: Addition &amp; Subtraction of Rational Numbers</div>
          <div class="mt-1 text-gray-600">Qatar Leadership Academy ‚Äî Grade 7 ‚Ä¢ AERO 7.NS.1b‚Äì1c</div>
        </div>
      </div>

      <div class="grid lg:grid-cols-2 gap-4 mt-2">
        <div class="card">
          <div class="text-xl font-extrabold text-[color:var(--maroon)] mb-1">Learning Objectives</div>
          <ul class="list-disc list-inside big leading-relaxed">
            <li>Interpret \(p+q\) on a number line as moving \(q\) units from \(p\) (right if \(q&gt;0\), left if \(q&lt;0\)).</li>
            <li>Use \(p-q=p+(-q)\) to make sense of subtraction.</li>
            <li>Add/subtract rational numbers across forms (integers, fractions, decimals) and justify strategies.</li>
            <li>Use prime factorization to find LCM for unlike denominators.</li>
          </ul>
        </div>
        <div class="card">
          <div class="text-xl font-extrabold text-[color:var(--maroon)] mb-1">Keywords (tap)</div>
          <div class="flex flex-wrap gap-2 big">
            <span class="chip" data-key="rational">rational number</span>
            <span class="chip" data-key="integer">integer</span>
            <span class="chip" data-key="sum">sum</span>
            <span class="chip" data-key="difference">difference</span>
            <span class="chip" data-key="inverse">additive inverse</span>
            <span class="chip" data-key="prime">prime</span>
            <span class="chip" data-key="composite">composite</span>
            <span class="chip" data-key="primefact">prime factorization</span>
            <span class="chip" data-key="lcm">LCM</span>
            <span class="chip" data-key="numberline">number line</span>
          </div>
          <div class="hint mt-3 text-sm">Use the **tools drawer (T)** for a quick A‚ÄìD poll on ‚ÄúWhat does subtracting a negative do?‚Äù</div>
        </div>
      </div>

      <div class="card mt-1">
        <div class="text-xl font-extrabold text-[color:var(--maroon)]">Warm‚ÄëUp: Notice &amp; Wonder</div>
        <div class="grid md:grid-cols-3 gap-3 big">
          <div class="p-2 border rounded">
            <div class="font-bold text-[color:var(--maroon)]">Integers</div>
            <div>\( -3 + 7 = \) <span class="font-extrabold" data-reveal="w1">?</span></div>
            <button class="btn reveal" data-target="w1">Reveal</button>
          </div>
          <div class="p-2 border rounded">
            <div class="font-bold text-[color:var(--maroon)]">Fractions</div>
            <div>\( \frac{5}{8}-\frac{3}{8}= \) <span class="font-extrabold" data-reveal="w2">?</span></div>
            <button class="btn reveal" data-target="w2">Reveal</button>
          </div>
          <div class="p-2 border rounded">
            <div class="font-bold text-[color:var(--maroon)]">Decimals</div>
            <div>\( 2.6 + (-1.25) = \) <span class="font-extrabold" data-reveal="w3">?</span></div>
            <button class="btn reveal" data-target="w3">Reveal</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ PART B ‚Ä¢ BUILD CONCEPTS ============ -->
    <section class="slide" data-part="B" id="primeSlide">
      <span class="part-tag">Part B ‚Ä¢ Build</span>
      <div class="titlebar"><h2 class="huge text-[color:var(--maroon)]">Prime &amp; Composite</h2></div>
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="card">
          <p class="big">A <strong>prime</strong> is an integer \( \ge 2 \) with exactly two positive factors: 1 and itself. A <strong>composite</strong> has more than two. 1 is <em>neither</em>.</p>
          <div id="primeList" class="grid md:grid-cols-2 gap-2 mt-2"></div>
          <div class="mt-2 flex gap-2">
            <button id="primeNew" class="btn">New set</button>
            <button id="primeCheck" class="btn maroon">Check</button>
            <div id="primeFb" class="font-bold text-[color:var(--maroon)]"></div>
          </div>
        </div>
        <div class="card" id="pfSlide">
          <div class="text-xl font-extrabold text-[color:var(--maroon)] mb-1">Prime Factorization (Exponent Form)</div>
          <p class="big">Write \( n=\prod p_i^{e_i} \). Example: \( 60 = 2^2\cdot3\cdot5 \).</p>
          <div id="pfList" class="grid gap-2 mt-2"></div>
          <div class="mt-2 flex gap-2">
            <button id="pfNew" class="btn">New set</button>
            <button id="pfCheck" class="btn maroon">Check</button>
            <div id="pfFb" class="font-bold text-[color:var(--maroon)]"></div>
          </div>
        </div>
      </div>
      <div class="card mt-2" id="lcmExSlide">
        <div class="text-xl font-extrabold text-[color:var(--maroon)]">LCM ‚Äî Two Methods</div>
        <div class="grid md:grid-cols-2 gap-3 big">
          <div>
            <div class="font-bold text-[color:var(--maroon)]">Method 1: Listing multiples</div>
            <div id="lcmListArea"></div>
          </div>
          <div>
            <div class="font-bold text-[color:var(--maroon)]">Method 2: Prime exponents</div>
            <div id="lcmPrimeArea"></div>
          </div>
        </div>
        <div class="mt-2 flex gap-2">
          <button id="lcmNew" class="btn">New example</button>
          <span class="hint text-sm">Ask: Which method would you choose? (Run a poll in <b>Tools</b>.)</span>
        </div>
      </div>
    </section>

    <!-- ============ PART C ‚Ä¢ EXPLORE ============ -->
    <section class="slide" data-part="C" id="addSlide">
      <span class="part-tag">Part C ‚Ä¢ Explore</span>
      <h2 class="huge text-[color:var(--maroon)]">Explore \(p+q\) and \(p-q\) on a Number Line</h2>
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="card">
          <div class="text-xl font-bold text-[color:var(--maroon)]">Addition \(p+q\)</div>
          <p class="text-gray-600 big">Drag \(p\). The gold arrow shows \(q\). Result is \(p+q\).</p>
          <div class="nl-wrap mt-1"><canvas id="lineAdd" class="nline" aria-label="Interactive number line (addition)"></canvas></div>
          <div class="mt-2 flex flex-wrap items-center gap-3 big">
            <label class="chip">p = <input id="pInput" class="border rounded px-2 py-1 w-24" value="-2"/></label>
            <label class="chip">q = <input id="qInput" class="border rounded px-2 py-1 w-24" value="3.5"/></label>
            <span class="chip">p+q = <b id="sumOut">1.5</b></span>
            <button id="randAdd" class="btn">Random</button>
            <button id="snapAdd" class="btn">Snap tenths</button>
            <button id="resetAdd" class="btn">Reset</button>
          </div>
          <div class="hint mt-2 text-sm">Rule (AERO 7.NS.1b): start at \(p\), move \(q\) ‚Äî right if \(q&gt;0\), left if \(q&lt;0\).</div>
        </div>

        <div class="card" id="subSlide">
          <div class="text-xl font-bold text-[color:var(--maroon)]">Subtraction \(p-q=p+(-q)\)</div>
          <div class="nl-wrap mt-1"><canvas id="lineSub" class="nline" aria-label="Interactive number line (subtraction)"></canvas></div>
          <div class="mt-2 flex flex-wrap items-center gap-3 big">
            <label class="chip">p = <input id="p2Input" class="border rounded px-2 py-1 w-24" value="1"/></label>
            <label class="chip">q = <input id="q2Input" class="border rounded px-2 py-1 w-24" value="-4"/></label>
            <span class="chip">p‚àíq = <b id="diffOut">5</b></span>
            <button id="randSub" class="btn">Random</button>
          </div>
          <div class="mt-2">
            <div class="font-bold text-[color:var(--maroon)]">Quick Check</div>
            <div class="grid gap-2 big">
              <div>1) \( 6 - 9 =\) <input class="qc border rounded px-2 py-1 w-24" data-prob="6-9" data-ans="-3"></div>
              <div>2) \( -4 - (-7) =\) <input class="qc border rounded px-2 py-1 w-24" data-prob="-4 - (-7)" data-ans="3"></div>
              <div>3) \( -2.5 - 1.5 =\) <input class="qc border rounded px-2 py-1 w-24" data-prob="-2.5 - 1.5" data-ans="-4"></div>
            </div>
            <div class="mt-2 flex gap-2">
              <button id="checkQC" class="btn maroon">Check</button>
              <button id="resetQC" class="btn">Reset</button>
              <div id="qcFb" class="font-bold text-[color:var(--maroon)]"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ PART D ‚Ä¢ PRACTICE A ============ -->
    <section class="slide" data-part="D" id="likeSlide">
      <span class="part-tag">Part D ‚Ä¢ Practice A</span>
      <h2 class="huge text-[color:var(--maroon)]">Fractions (Like Denominators) &amp; Decimals</h2>
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="card">
          <div class="text-xl font-bold text-[color:var(--maroon)] mb-1">Like Denominators</div>
          <p class="text-gray-600 big">Add/subtract numerators; keep denominator; simplify.</p>
          <div id="likeList" class="grid gap-2 mt-1"></div>
          <div class="mt-2 flex gap-2">
            <button id="likeCheck" class="btn maroon">Check</button>
            <button id="likeNew" class="btn">New set</button>
            <div id="likeFb" class="font-bold text-[color:var(--maroon)]"></div>
          </div>
        </div>
        <div class="card" id="decSlide">
          <div class="text-xl font-bold text-[color:var(--maroon)] mb-1">Decimals (Align by place value)</div>
          <div id="decList" class="grid gap-2 mt-1"></div>
          <div class="mt-2 flex gap-2">
            <button id="decCheck" class="btn maroon">Check</button>
            <button id="decNew" class="btn">New set</button>
            <div id="decFb" class="font-bold text-[color:var(--maroon)]"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ PART E ‚Ä¢ PRACTICE B ============ -->
    <section class="slide" data-part="E" id="unlikeSlide">
      <span class="part-tag">Part E ‚Ä¢ Practice B</span>
      <h2 class="huge text-[color:var(--maroon)]">Fractions (Unlike Denominators)</h2>
      <div class="card big">
        <div class="mb-1">Find the <span class="chip" data-key="lcm">LCM</span>, build equivalent fractions, combine, then simplify.</div>
        <div id="unlikeBox" class="grid md:grid-cols-2 gap-3"></div>
        <div class="mt-2 flex gap-2">
          <button id="unlikeCheck" class="btn maroon">Check</button>
          <button id="unlikeNew" class="btn">New pair</button>
          <div id="unlikeFb" class="font-bold text-[color:var(--maroon)]"></div>
        </div>
      </div>
      <div class="hint mt-2 text-sm">Use the **pen (P)** to annotate each step live on the board.</div>
    </section>

    <!-- ============ PART F ‚Ä¢ REASON & EXPLAIN ============ -->
    <section class="slide" data-part="F" id="reasonSlide">
      <span class="part-tag">Part F ‚Ä¢ Reason</span>
      <h2 class="huge text-[color:var(--maroon)]">Reasoning, Ordering, &amp; Error Analysis</h2>
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="card" id="sortSlide">
          <div class="text-xl font-bold text-[color:var(--maroon)]">Order Rational Numbers (Low ‚Üí High)</div>
          <ul id="sortList" class="sortable border rounded-md bg-white p-3 space-y-2 mt-2"></ul>
          <div class="mt-2 flex gap-2">
            <button id="sortNew" class="btn">New set</button>
            <button id="sortCheck" class="btn maroon">Check</button>
            <div id="sortFb" class="font-bold text-[color:var(--maroon)]"></div>
          </div>
        </div>
        <div class="card" id="challengeSlide">
          <div class="text-xl font-bold text-[color:var(--maroon)]">Error Analysis &amp; Missing Addends</div>
          <div class="grid gap-3">
            <div id="errBox" class="text-xl"></div>
            <div class="big">
              <label class="mr-2"><input type="radio" name="errChoice" value="A"> Added/subtracted denominators directly</label><br/>
              <label class="mr-2"><input type="radio" name="errChoice" value="B"> Failed to use common denominator</label><br/>
              <label class="mr-2"><input type="radio" name="errChoice" value="C"> Sign error</label><br/>
              <label class="mr-2"><input type="radio" name="errChoice" value="D"> Decimal place-value misalignment</label>
            </div>
            <div class="flex gap-2">
              <button id="errCheck" class="btn maroon">Check</button>
              <button id="errReveal" class="btn">Reveal correct work</button>
              <button id="errNew" class="btn">New example</button>
            </div>
            <div id="errFb" class="font-bold text-[color:var(--maroon)]"></div>
            <div id="errRevealBox" class="hint text-sm"></div>
          </div>

          <div class="mt-4 grid gap-2">
            <div class="font-bold text-[color:var(--maroon)]">Missing number</div>
            <div class="big">\( p + q = r \). If \(p=-4.5\), \(r=1.25\), then \(q=\) <input class="ch1 border rounded px-2 py-1 w-28" data-ans="5.75"></div>
            <div class="big">\( p - q = r \). If \(p=\frac{3}{4}\), \(r=-\frac{5}{4}\), then \(q=\) <input class="ch1 border rounded px-2 py-1 w-28" data-ans="2"></div>
            <div class="flex gap-2 mt-1">
              <button id="chCheck" class="btn maroon">Check</button>
              <button id="chReset" class="btn">Reset</button>
              <div id="chFb" class="font-bold text-[color:var(--maroon)]"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card mt-2">
        <div class="text-xl font-bold text-[color:var(--maroon)]">Strategy Board (student‚Äëauthored)</div>
        <div class="grid md:grid-cols-[1fr_auto] gap-3 big">
          <div id="strategyList" class="grid gap-2"></div>
          <div class="flex flex-col gap-2">
            <input id="strategyIn" class="border rounded px-2 py-2 w-72" placeholder="Add a class strategy (e.g., 'Use LCM 12')">
            <button id="addStrategy" class="btn">Post strategy</button>
            <button id="clearStrategy" class="btn ghost">Clear</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ============ PART G ‚Ä¢ EXIT & NEXT ============ -->
    <section class="slide" data-part="G" id="exitSlide">
      <span class="part-tag">Part G ‚Ä¢ Exit</span>
      <h2 class="huge text-[color:var(--maroon)]">Mixed Practice &amp; Exit Ticket</h2>
      <div class="grid lg:grid-cols-2 gap-4">
        <div class="card" id="mixedSlide">
          <div class="text-xl font-bold text-[color:var(--maroon)]">Practice Generator (mixed)</div>
          <div class="flex items-center gap-3 mt-1 big">
            <span>Difficulty:</span>
            <select id="level" class="border rounded px-2 py-1">
              <option value="easy">easy (integers)</option>
              <option value="med" selected>medium (like‚Äëdenominator fractions &amp; decimals)</option>
              <option value="hard">hard (unlike denominators; signed)</option>
            </select>
            <button id="newQ" class="btn">New question</button>
          </div>
          <div class="mt-2 text-2xl">Compute: <span id="qText" class="font-extrabold"></span></div>
          <div class="mt-2">
            <input id="ans" class="border rounded px-3 py-2 w-60" placeholder="e.g., -7/6 or  -1.166..." />
            <button id="checkQ" class="btn maroon">Check</button>
            <button id="hintQ" class="btn">Hint</button>
          </div>
          <div id="qHint" class="mt-2 text-sm"></div>
          <div id="qFb" class="mt-1 font-bold text-[color:var(--maroon)]"></div>
        </div>

        <div class="card">
          <div class="text-xl font-bold text-[color:var(--maroon)]">Exit Ticket</div>
          <div class="grid md:grid-cols-2 gap-3 big">
            <div class="p-2 border rounded">
              <div class="font-bold text-[color:var(--maroon)]">3‚Äì2‚Äì1 Reflect</div>
              <ul class="list-disc list-inside">
                <li>3 ideas you learned about adding/subtracting rationals</li>
                <li>2 strategies you can use (visual &amp; arithmetic)</li>
                <li>1 question you still have</li>
              </ul>
            </div>
            <div class="p-2 border rounded">
              <div class="font-bold text-[color:var(--maroon)]">Up Next</div>
              <p>Extend to <strong>multi‚Äëstep problems</strong> and estimation for reasonableness (AERO 7.EE.3).</p>
              <p class="hint text-sm mt-2">Use the tools drawer to time a 90‚Äësec write, then cold‚Äëcall 3 students.</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Ink overlay -->
    <div id="ink"><canvas id="inkCanvas"></canvas></div>
  </div>
</div>

<!-- Presenter controls -->
<div id="presenter" role="group" aria-label="Slideshow controls">
  <button id="prev" title="Previous (‚Üê)">‚ü®</button>
  <button id="fs" title="Toggle Fullscreen (F)">‚§¢</button>
  <button id="pen" title="Toggle Pen (P)">‚úé</button>
  <button id="toolsBtn" title="Teacher Tools (T)">‚ò∞</button>
  <div id="counter">A / 7</div>
  <button id="next" title="Next (‚Üí)">‚ü©</button>
</div>
<div id="progress"></div>

<!-- Teacher Tools Drawer -->
<div id="tools" role="dialog" aria-modal="true" aria-live="polite">
  <header>
    <span>Teacher Tools</span>
    <button id="toolsClose" class="btn">‚úï</button>
  </header>
  <div class="body">
    <!-- Timer -->
    <div class="mb-3">
      <div class="font-extrabold text-[color:var(--maroon)]">Timer</div>
      <div class="row mt-1">
        <button class="pill mini tset" data-secs="30">30s</button>
        <button class="pill mini tset" data-secs="60">60s</button>
        <button class="pill mini tset" data-secs="90">90s</button>
        <button class="pill mini tset" data-secs="180">3m</button>
        <button class="pill mini" id="tstart">Start</button>
        <button class="pill mini" id="tstop">Stop</button>
        <button class="pill mini" id="treset">Reset</button>
        <span id="tread" class="ml-2 font-bold">00:00</span>
      </div>
    </div>

    <!-- Randomizer -->
    <div class="mb-3">
      <div class="font-extrabold text-[color:var(--maroon)]">Random Name</div>
      <div class="row mt-1">
        <input id="namesIn" class="border rounded px-2 py-1 grow" placeholder="Comma-separated list of student names"/>
        <button id="saveNames" class="pill">Save</button>
        <button id="spinName" class="pill">Spin</button>
        <span id="nameOut" class="font-bold ml-1"></span>
      </div>
    </div>

    <!-- Polls -->
    <div class="mb-3">
      <div class="font-extrabold text-[color:var(--maroon)]">Quick Poll</div>
      <div class="row mt-1">
        <button class="pill poll" data-k="A">A <span class="dot" id="pa"></span></button>
        <button class="pill poll" data-k="B">B <span class="dot" id="pb"></span></button>
        <button class="pill poll" data-k="C">C <span class="dot" id="pc"></span></button>
        <button class="pill poll" data-k="D">D <span class="dot" id="pd"></span></button>
        <button class="pill" id="pClear">Clear</button>
      </div>
      <div class="font-extrabold text-[color:var(--maroon)] mt-3">Status Check</div>
      <div class="row mt-1">
        <button class="pill status" data-k="R">üî¥</button>
        <button class="pill status" data-k="Y">üü°</button>
        <button class="pill status" data-k="G">üü¢</button>
        <button class="pill" id="sClear">Clear</button>
        <span id="statusRead" class="ml-2"></span>
      </div>
    </div>

    <!-- Board toggle -->
    <div class="mb-1">
      <div class="row">
        <button id="boardMode" class="pill">Toggle Board Mode (B)</button>
      </div>
    </div>
  </div>
</div>

<!-- Glossary popover -->
<div id="pop" class="fixed left-4 bottom-4 max-w-[560px] w-[90vw] bg-white border-2 border-[color:var(--gold)] rounded-lg shadow-2xl p-3 z-[140] hidden text-left">
  <div class="flex items-start justify-between">
    <div id="popBody"></div>
    <button id="popClose" class="btn ml-2">‚úï</button>
  </div>
</div>

<script>
/* =========================
   Boot KaTeX (auto-render)
========================= */
window.addEventListener('DOMContentLoaded', () => {
  const run = (root = document.body) => {
    if (!window.renderMathInElement) return;
    window.renderMathInElement(root, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '\\(', right: '\\)', display: false }
      ],
      throwOnError: false
    });
  };
  if (window.renderMathInElement) run();
  else {
    const t = setInterval(() => {
      if (window.renderMathInElement) { clearInterval(t); run(); }
    }, 25);
    setTimeout(() => clearInterval(t), 6000);
  }
  window._rerenderMath = run;
});

/* =========================
   Utilities & Math helpers
========================= */
const id = (x) => document.getElementById(x);
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
function confetti(x=window.innerWidth/2,y=window.innerHeight/2){
  for(let k=0;k<18;k++){
    const d=document.createElement('div'); d.className='confetti';
    d.style.left=x+'px'; d.style.top=y+'px'; d.style.width='8px'; d.style.height='8px';
    d.style.background=['#6C1D45','#C7A34F','#E8D5B7','#8a3d64'][k%4];
    document.body.appendChild(d);
    const dx=(Math.random()*2-1)*240, dy=(Math.random()*-1-0.3)*300, rot=Math.random()*720;
    d.animate([{transform:'translate(0,0) rotate(0deg)'},{transform:`translate(${dx}px,${dy}px) rotate(${rot}deg)`,opacity:0}],
              {duration:900+Math.random()*700,easing:'cubic-bezier(.2,.8,.2,1)'}).onfinish=()=>d.remove();
  }
}
function downloadJSON(filename, data){
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function downloadCSV(filename, rows){
  const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

// Number helpers
const gcd=(a,b)=>{a=Math.trunc(Math.abs(a));b=Math.trunc(Math.abs(b));while(b){[a,b]=[b,a%b]}return a||1};
const lcm=(a,b)=>Math.abs(a*b)/gcd(a,b);
function isPrime(n){ if(n<2 || n%1) return false; for(let k=2;k*k<=n;k++) if(n%k===0) return false; return true; }
function primeFactorMap(n){
  const m=new Map(); let x=Math.abs(n); let p=2;
  while(p*p<=x){
    while(x%p===0){ m.set(p,(m.get(p)||0)+1); x/=p; }
    p=(p===2)?3:p+2;
  }
  if(x>1) m.set(x,(m.get(x)||0)+1);
  return m;
}

// Rational helpers
function parseRational(s){
  if(typeof s==='number') return [Math.trunc(s*1000),1000]; // approximate to avoid float issues for quick typing
  if(!s) return null;
  s=s.toString().trim().replace('‚àí','-');
  const m=s.match(/^(-?\d+)\s+(\d+)\/(\d+)$/);
  if(m){const A=+m[1],B=+m[2],C=+m[3];const sign=A<0?-1:1;return [A*C+sign*B, C];}
  const f=s.match(/^(-?\d+)\/(-?\d+)$/);
  if(f){let n=+f[1],d=+f[2]; if(d===0) return null; let g=gcd(n,d); d<0&&(g=-g); return [n/g,d/g];}
  if(!isNaN(Number(s))){
    const parts=s.split('.');
    if(parts.length===1) return [Number(s),1];
    const k=parts[1].length; const n=Math.round(Number(s)*10**k); const d=10**k; let g=gcd(n,d); return [n/g,d/g];
  }
  return null;
}
function toFrac(n,d){let g=gcd(n,d); d<0&&(g=-g); return [n/g,d/g]}
const addFrac=(a,b)=>toFrac(a[0]*b[1]+b[0]*a[1], a[1]*b[1]);
const subFrac=(a,b)=>toFrac(a[0]*b[1]-b[0]*a[1], a[1]*b[1]);
const fracEq=(a,b)=>a[0]*b[1]===b[0]*a[1];
const sFrac=([n,d])=> d===1? String(n) : `${n}/${d}`;
const asNumber=([n,d])=> n/d;

/* =========================
   Slide Deck & Presenter
========================= */
const slides=[...document.querySelectorAll('.slide')];
const prev=id('prev'), next=id('next'), counter=id('counter'), progress=id('progress'), fsBtn=id('fs');
const penBtn=id('pen'), toolsBtn=id('toolsBtn');
const deckTitle='G7_Unit1_AddSub_Rationals_QLA_Interactive';
let i=0;
const parts = [...new Set(slides.map(s=>s.dataset.part))]; // ['A','B',...]
function show(k){
  i=(k+slides.length)%slides.length;
  slides.forEach((s,idx)=>s.classList.toggle('active',idx===i));
  counter.textContent = slides[i].dataset.part + ' / ' + parts.length;
  progress.style.width=((i+1)/slides.length*100)+'%';
  const sid=slides[i].id||'';
  if(sid==='addSlide') drawAdd();
  if(sid==='subSlide') drawSub();
  if(sid==='lcmExSlide' || slides[i].querySelector('#lcmListArea')) newLCMEx(false);
  if(window._rerenderMath) window._rerenderMath(slides[i]);
}
prev.addEventListener('click',()=>show(i-1));
next.addEventListener('click',()=>show(i+1));
document.addEventListener('keydown',e=>{
  if(e.key==='ArrowRight') show(i+1);
  if(e.key==='ArrowLeft') show(i-1);
  if(e.key.toLowerCase()==='f') toggleFS();
  if(e.key.toLowerCase()==='t') toggleTools();
  if(e.key.toLowerCase()==='p') toggleInk();
  if(e.key.toLowerCase()==='b') toggleBoard();
  // jump to parts 1‚Äì7
  if('1234567'.includes(e.key)){
    const idx = slides.findIndex(s=>s.dataset.part===parts[Number(e.key)-1]);
    if(idx>=0) show(idx);
  }
});
function toggleFS(){
  const el=id('screen');
  if(!document.fullscreenElement){(el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el);}
  else{(document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen).call(document);}
}
fsBtn.addEventListener('click',toggleFS);

/* =========================
   Board Mode & Ink Overlay
========================= */
let boardOn=false;
function toggleBoard(){
  boardOn=!boardOn;
  document.body.classList.toggle('board',boardOn);
}
const inkWrap=id('ink'), inkCanvas=id('inkCanvas'); let inkOn=false, ctxInk=null, drawing=false, last=null;
function resizeInk(){
  const r=id('screen').getBoundingClientRect();
  inkCanvas.width=r.width*devicePixelRatio; inkCanvas.height=r.height*devicePixelRatio;
  inkCanvas.style.width=r.width+'px'; inkCanvas.style.height=r.height+'px';
  ctxInk=inkCanvas.getContext('2d'); ctxInk.scale(devicePixelRatio,devicePixelRatio);
  ctxInk.lineCap='round'; ctxInk.lineJoin='round'; ctxInk.strokeStyle='#111'; ctxInk.lineWidth=4;
}
function toggleInk(){
  inkOn=!inkOn; document.body.classList.toggle('ink-on',inkOn);
}
penBtn.addEventListener('click',toggleInk);
window.addEventListener('resize',resizeInk);
resizeInk();
inkCanvas.addEventListener('pointerdown',e=>{ if(!inkOn)return; drawing=true; last=[e.offsetX,e.offsetY]; });
window.addEventListener('pointerup',()=>drawing=false);
inkCanvas.addEventListener('pointermove',e=>{
  if(!inkOn||!drawing) return;
  ctxInk.beginPath();
  ctxInk.moveTo(last[0],last[1]);
  ctxInk.lineTo(e.offsetX,e.offsetY);
  ctxInk.stroke();
  last=[e.offsetX,e.offsetY];
});
inkCanvas.addEventListener('dblclick',()=>{ // quick erase all
  const r=inkCanvas.getBoundingClientRect();
  ctxInk.clearRect(0,0,r.width,r.height);
});

/* =========================
   Teacher Tools Drawer
========================= */
const tools = id('tools'); const toolsClose=id('toolsClose');
function toggleTools(){ tools.style.display = (tools.style.display==='block')?'none':'block'; }
toolsBtn.addEventListener('click',toggleTools); toolsClose.addEventListener('click',toggleTools);

// Timer
let tSecs=60, tLeft=60, tInt=null;
[...document.querySelectorAll('.tset')].forEach(b=>b.addEventListener('click',()=>{tSecs=+b.dataset.secs; tLeft=tSecs; tread();}));
id('tstart').addEventListener('click',()=>{ if(tInt) return; tInt=setInterval(()=>{tLeft=Math.max(0,tLeft-1); tread(); if(tLeft===0){clearInterval(tInt); tInt=null; confetti(window.innerWidth-200,120);} },1000);});
id('tstop').addEventListener('click',()=>{clearInterval(tInt); tInt=null;});
id('treset').addEventListener('click',()=>{tLeft=tSecs; tread();});
function tread(){ const m=String(Math.floor(tLeft/60)).padStart(2,'0'); const s=String(tLeft%60).padStart(2,'0'); id('tread').textContent=`${m}:${s}`; }

// Randomizer
const LS='QLA_G7_NAMES';
const savedNames = localStorage.getItem(LS)||'';
id('namesIn').value = savedNames;
id('saveNames').addEventListener('click',()=>{ localStorage.setItem(LS,id('namesIn').value||''); });
id('spinName').addEventListener('click',()=>{
  const arr=(id('namesIn').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  if(arr.length===0){ id('nameOut').textContent='(no names)'; return; }
  id('nameOut').textContent = arr[Math.floor(Math.random()*arr.length)];
});

// Polls & Status
const pollDots={A:id('pa'),B:id('pb'),C:id('pc'),D:id('pd')};
let pollState={A:false,B:false,C:false,D:false};
document.querySelectorAll('.poll').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const k=btn.dataset.k; pollState[k]=!pollState[k];
    pollDots[k].classList.toggle('on',pollState[k]);
  });
});
id('pClear').addEventListener('click',()=>{
  pollState={A:false,B:false,C:false,D:false};
  Object.values(pollDots).forEach(d=>d.classList.remove('on'));
});
let statusCounts={R:0,Y:0,G:0};
document.querySelectorAll('.status').forEach(btn=>{
  btn.addEventListener('click',()=>{
    statusCounts[btn.dataset.k]++; id('statusRead').textContent=`R:${statusCounts.R} Y:${statusCounts.Y} G:${statusCounts.G}`;
  });
});
id('sClear').addEventListener('click',()=>{statusCounts={R:0,Y:0,G:0}; id('statusRead').textContent='';});

// Board mode button
id('boardMode').addEventListener('click',toggleBoard);

/* =========================
   Glossary Popover
========================= */
const POP=id('pop'), POP_BODY=id('popBody');
const GLOS={
  rational:'<strong>Rational number</strong>: any number that can be written as a fraction of integers (terminating or repeating decimal).',
  integer:'<strong>Integer</strong>: {..., ‚àí3, ‚àí2, ‚àí1, 0, 1, 2, 3, ...}',
  sum:'<strong>Sum</strong>: result of addition.',
  difference:'<strong>Difference</strong>: result of subtraction.',
  inverse:'<strong>Additive inverse</strong> of p is ‚àíp (they add to 0).',
  prime:'<strong>Prime</strong>: integer ‚â•2 with exactly two positive factors (1 and itself).',
  composite:'<strong>Composite</strong>: integer ‚â•2 with more than two positive factors.',
  primefact:'<strong>Prime factorization</strong>: \(72=2^{3}\cdot 3^{2}\).',
  lcm:'<strong>LCM</strong> (least common multiple): smallest positive multiple of each denominator.',
  numberline:'<strong>Number line</strong>: points laid out in order; left is less, right is greater.'
};
document.addEventListener('click',e=>{
  const el=e.target.closest('.chip[data-key]'); 
  if(el){ POP_BODY.innerHTML=GLOS[el.dataset.key]; POP.classList.remove('hidden'); if(window._rerenderMath) _rerenderMath(POP); }
});
id('popClose').addEventListener('click',()=>POP.classList.add('hidden'));

/* =========================
   Part A: Warm-up reveals
========================= */
const warmAnswers={w1:'4', w2:'\\(\\tfrac{1}{4}\\)', w3:'1.35'};
document.querySelectorAll('.reveal').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const t=btn.dataset.target; const sp=document.querySelector(`[data-reveal="${t}"]`);
    sp.innerHTML=warmAnswers[t]; if(window._rerenderMath) _rerenderMath(sp);
  });
});

/* =========================
   Part B: Primes, PF, LCM
========================= */
const primeState={set:[]};
function primeNew(){
  const nums=new Set();
  while(nums.size<8){ const x=Math.floor(Math.random()*98)+2; nums.add(x); }
  primeState.set=[...nums].sort((a,b)=>a-b).map(n=>({n,prime:isPrime(n)}));
  const box=id('primeList'); box.innerHTML='';
  primeState.set.forEach((o,idx)=>{
    const row=document.createElement('div'); row.className='card flex items-center justify-between';
    row.innerHTML=`<div class="text-2xl">\\( ${o.n} \\)</div>
      <select class="border rounded px-2 py-1 big" id="pc_${idx}">
        <option value="">‚Äî classify ‚Äî</option>
        <option value="P">Prime</option>
        <option value="C">Composite</option>
      </select>`;
    box.appendChild(row);
  });
  if(window._rerenderMath) _rerenderMath(id('primeSlide'));
}
function primeCheck(){
  let ok=0; primeState.set.forEach((o,idx)=>{
    const sel=id('pc_'+idx); const got=sel.value; const want=o.prime?'P':'C';
    sel.style.borderColor=(got===want && got!=='') ? '#22c55e' : '#ef4444';
    if(got===want && got!=='') ok++;
  });
  id('primeFb').textContent=(ok===primeState.set.length)?'‚úÖ All correct!':'Score: '+ok+'/'+primeState.set.length;
  if(ok===primeState.set.length) confetti();
}
id('primeNew').addEventListener('click',primeNew);
id('primeCheck').addEventListener('click',primeCheck);
primeNew();

// Prime factorization
const pfState={set:[], primes:[2,3,5,7,11,13]};
function buildN(exps){ return pfState.primes.reduce((acc,p)=>acc*Math.pow(p,exps[p]||0),1) }
function pfNew(){
  const list=[];
  while(list.length<4){
    const exps={};
    pfState.primes.forEach(p=>{
      let e=0;
      if(p<=5){ e=Math.floor(Math.random()*3); }
      else if(p===7){ e=Math.random()<0.7?0:1; }
      else { e=Math.random()<0.8?0:1; }
      exps[p]=e;
    });
    if(Object.values(exps).every(e=>e===0)) exps[2]=1;
    const n=buildN(exps);
    if(n>=60 && n<=5000){ list.push({n,exps}); }
  }
  pfState.set=list;
  const box=id('pfList'); box.innerHTML='';
  pfState.set.forEach((o,idx)=>{
    const row=document.createElement('div'); row.className='card';
    row.innerHTML=`
      <div class="text-xl mb-1">\\( ${o.n} = 2^{\\square}\\cdot 3^{\\square}\\cdot 5^{\\square}\\cdot 7^{\\square}\\cdot 11^{\\square}\\cdot 13^{\\square} \\)</div>
      <div class="flex flex-wrap gap-2">
        ${pfState.primes.map(p=>`<label class="chip">${p}: <input class="pfexp border rounded px-2 py-1 w-16" id="pf_${idx}_${p}" placeholder="exp"></label>`).join('')}
      </div>`;
    box.appendChild(row);
  });
  if(window._rerenderMath) _rerenderMath(id('pfSlide'));
}
function pfCheck(){
  let total=0,ok=0;
  pfState.set.forEach((o,idx)=>{
    total++;
    let good=true;
    pfState.primes.forEach(p=>{
      const inp=id(`pf_${idx}_${p}`); const g=Number(inp.value||0); const want=o.exps[p]||0;
      if(g===want){ inp.style.borderColor='#22c55e'; } else { good=false; inp.style.borderColor='#ef4444'; }
    });
    if(good) ok++;
  });
  id('pfFb').textContent= ok===total ? '‚úÖ All correct!' : 'Score: '+ok+'/'+total;
  if(ok===total) confetti();
}
id('pfNew').addEventListener('click',pfNew);
id('pfCheck').addEventListener('click',pfCheck);
pfNew();

// LCM examples
const lcmState={a:0,b:0, l:0, listA:[], listB:[], expA:{}, expB:{}, expLCM:{}};
function mults(a,count=10){ return Array.from({length:count},(_,i)=>a*(i+1)); }
function mapToObj(m){ const o={}; m.forEach((v,k)=>o[k]=v); return o; }
function newLCMEx(fireConfetti=true){
  let a=0,b=0; while(a===b || a<4 || b<4){ a=Math.floor(Math.random()*15)+4; b=Math.floor(Math.random()*15)+4; }
  const listA=mults(a,10), listB=mults(b,10);
  const common=listA.find(x=>listB.includes(x)) || lcm(a,b);
  const fa=primeFactorMap(a), fb=primeFactorMap(b);
  const primes=[...new Set([...fa.keys(), ...fb.keys()])].sort((x,y)=>x-y);
  const expLCM={}; primes.forEach(p=>expLCM[p]=Math.max(fa.get(p)||0, fb.get(p)||0));
  const L=primes.reduce((acc,p)=>acc*Math.pow(p,expLCM[p]),1);

  lcmState.a=a; lcmState.b=b; lcmState.l=L; lcmState.listA=listA; lcmState.listB=listB;
  lcmState.expA=mapToObj(fa); lcmState.expB=mapToObj(fb); lcmState.expLCM=expLCM;

  const listArea=id('lcmListArea'), primeArea=id('lcmPrimeArea');
  if(listArea){
    listArea.innerHTML=`
      <div class="mb-1">\\( a=${a},\\; b=${b} \\)</div>
      <div>Multiples of \\(a\\): ${listA.map(x=> x===common? '<b>'+x+'</b>' : x).join(', ')}</div>
      <div>Multiples of \\(b\\): ${listB.map(x=> x===common? '<b>'+x+'</b>' : x).join(', ')}</div>
      <div class="mt-1">First common multiple: <b>${common}</b></div>`;
  }
  if(primeArea){
    const fmt=(obj)=>Object.keys(obj).sort((x,y)=>+x-+y).map(p=>` ${p}^{${obj[p]}}`).join('\\cdot')||'1';
    primeArea.innerHTML=`
      <div>\\( a = ${ fmt(lcmState.expA) } \\)</div>
      <div>\\( b = ${ fmt(lcmState.expB) } \\)</div>
      <div class="mt-1">\\( \\mathrm{LCM}(a,b) = ${ fmt(lcmState.expLCM) } = ${L} \\)</div>`;
  }
  if(window._rerenderMath){ _rerenderMath(id('lcmExSlide')); }
  if(fireConfetti) confetti();
}
id('lcmNew')?.addEventListener('click',()=>newLCMEx(true));
newLCMEx(false);

/* =========================
   Part C: Number Lines + QC
========================= */
const cA=id('lineAdd'); const pIn=id('pInput'), qIn=id('qInput'), sumOut=id('sumOut');
const addState={min:-12,max:12,snap:false,p:-2,q:3.5,drag:false};
function mapAdd(x){const m=28,W=cA.clientWidth;return m+(x-addState.min)*(W-2*m)/(addState.max-addState.min)}
function unmapAdd(px){const m=28,W=cA.clientWidth;return addState.min+(px-m)*(addState.max-addState.min)/(W-2*m)}
function drawAdd(){
  if(!cA) return; const ctx=cA.getContext('2d');
  cA.width=cA.clientWidth*devicePixelRatio; cA.height=cA.clientHeight*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
  const y=cA.clientHeight/2, m=28; ctx.clearRect(0,0,cA.clientWidth,cA.clientHeight);
  ctx.lineWidth=2; ctx.strokeStyle='#6C1D45'; ctx.beginPath(); ctx.moveTo(m,y); ctx.lineTo(cA.clientWidth-m,y); ctx.stroke();
  for(let t=addState.min;t<=addState.max;t++){const x=mapAdd(t); ctx.beginPath(); ctx.moveTo(x,y-8); ctx.lineTo(x,y+8); ctx.stroke(); if(t%2==0){ctx.fillStyle='#555'; ctx.font='12px Inter'; ctx.fillText(String(t),x-6,y+24);}}
  const px=mapAdd(addState.p); ctx.fillStyle='#6C1D45'; ctx.beginPath(); ctx.arc(px,y,9,0,Math.PI*2); ctx.fill();
  const qx=mapAdd(addState.p+addState.q); ctx.strokeStyle='#C7A34F'; ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(px,y); ctx.lineTo(qx,y); ctx.stroke();
  ctx.fillStyle='#C7A34F'; ctx.beginPath(); ctx.arc(qx,y,9,0,Math.PI*2); ctx.fill();
  sumOut.textContent=(addState.p+addState.q).toFixed(2).replace(/\.00$/,'');
}
function setFromInputs(){ addState.p=Number(pIn.value||0); addState.q=Number(qIn.value||0); drawAdd(); }
pIn?.addEventListener('input', setFromInputs); qIn?.addEventListener('input', setFromInputs);
cA?.addEventListener('mousedown',e=>{addState.drag=true; handleAdd(e)}); window.addEventListener('mouseup',()=>addState.drag=false);
window.addEventListener('mousemove',e=>{if(addState.drag) handleAdd(e)});
function handleAdd(e){const r=cA.getBoundingClientRect(); let val=unmapAdd((e.clientX||e.touches?.[0].clientX)-r.left); if(addState.snap) val=Math.round(val*10)/10; addState.p=clamp(val,addState.min,addState.max); pIn.value=addState.p; drawAdd();}
id('randAdd')?.addEventListener('click',()=>{addState.p=+(Math.random()*12-6).toFixed(1); addState.q=+(Math.random()*8-4).toFixed(1); pIn.value=addState.p; qIn.value=addState.q; drawAdd();});
id('resetAdd')?.addEventListener('click',()=>{addState.p=-2;addState.q=3.5;pIn.value=-2;qIn.value=3.5;drawAdd()});
id('snapAdd')?.addEventListener('click',()=>{addState.snap=!addState.snap; id('snapAdd').classList.toggle('ring-2')});

// Subtraction line
const cS=id('lineSub'); const p2=id('p2Input'), q2=id('q2Input'), diffOut=id('diffOut');
const subState={min:-12,max:12,p:1,q:-4};
function mapS(x){const m=28,W=cS.clientWidth;return m+(x-subState.min)*(W-2*m)/(subState.max-subState.min)}
function drawSub(){
  const ctx=cS.getContext('2d'); cS.width=cS.clientWidth*devicePixelRatio; cS.height=cS.clientHeight*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
  const y=cS.clientHeight/2, m=28; ctx.clearRect(0,0,cS.clientWidth,cS.clientHeight);
  ctx.lineWidth=2; ctx.strokeStyle='#6C1D45'; ctx.beginPath(); ctx.moveTo(m,y); ctx.lineTo(cS.clientWidth-m,y); ctx.stroke();
  for(let t=subState.min;t<=subState.max;t++){const x=mapS(t); ctx.beginPath(); ctx.moveTo(x,y-8); ctx.lineTo(x,y+8); ctx.stroke(); if(t%2==0){ctx.fillStyle='#555'; ctx.font='12px Inter'; ctx.fillText(String(t),x-6,y+24);}}
  const px=mapS(subState.p); const qx=mapS(subState.p - subState.q); // move by -q for subtraction
  ctx.fillStyle='#6C1D45'; ctx.beginPath(); ctx.arc(px,y,9,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle='#C7A34F'; ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(px,y); ctx.lineTo(qx,y); ctx.stroke();
  ctx.fillStyle='#C7A34F'; ctx.beginPath(); ctx.arc(qx,y,9,0,Math.PI*2); ctx.fill();
  diffOut.textContent=(subState.p - subState.q).toFixed(2).replace(/\.00$/,'');
}
function setSub(){subState.p=Number(p2.value||0); subState.q=Number(q2.value||0); drawSub()}
p2?.addEventListener('input', setSub); q2?.addEventListener('input', setSub);
id('randSub')?.addEventListener('click',()=>{subState.p=+(Math.random()*8-4).toFixed(1); subState.q=+(Math.random()*8-4).toFixed(1); p2.value=subState.p; q2.value=subState.q; drawSub()});

// Quick check
id('checkQC')?.addEventListener('click',()=>{
  let total=0,ok=0; [...document.querySelectorAll('.qc')].forEach(inp=>{total++; const want=Number(inp.dataset.ans); const got=Number(inp.value); if(got===want){inp.style.borderColor='#22c55e'; ok++;} else {inp.style.borderColor='#ef4444';}});
  id('qcFb').textContent= ok===total?'‚úÖ Great!':'Score: '+ok+'/'+total; if(ok===total) confetti();
});
id('resetQC')?.addEventListener('click',()=>{document.querySelectorAll('.qc').forEach(i=>{i.value='';i.style.borderColor='#e5e7eb'}); id('qcFb').textContent=''});

/* =========================
   Part D: Like + Decimals
========================= */
const likePairs=[['5/8','-1/8','+'],['7/9','2/9','-'],['-3/10','4/10','+'],['-5/6','-1/6','+'],['11/12','1/12','-'],['-7/15','2/15','+']];
const likeState={set:[]};
function renderLike(){
  const box=id('likeList'); if(!box) return; box.innerHTML=''; likeState.set=[];
  likePairs.sort(()=>Math.random()-0.5).slice(0,4).forEach((t,idx)=>{
    const [a,b,op]=t; const row=document.createElement('div'); row.className='card';
    row.innerHTML=`<div class="text-left font-semibold text-[color:var(--maroon)]">Item ${idx+1}</div>
      <div class="text-2xl mt-1">\\( ${a} ${op} ${b} \\) = <input class="lin border rounded px-2 py-1 w-32" placeholder="e.g., 1/4"></div>`;
    row.dataset.a=a; row.dataset.b=b; row.dataset.op=op; box.appendChild(row);
    likeState.set.push({a,b,op});
  });
  if(window._rerenderMath) _rerenderMath(id('likeSlide'));
}
renderLike();
id('likeNew')?.addEventListener('click',renderLike);
id('likeCheck')?.addEventListener('click',()=>{
  let total=0,ok=0; id('likeList').querySelectorAll('.card').forEach(row=>{
    total++; const A=parseRational(row.dataset.a), B=parseRational(row.dataset.b); const op=row.dataset.op;
    const ans=(op==='+')? addFrac(A,B): subFrac(A,B);
    const inp=row.querySelector('.lin'); const got=parseRational(inp.value);
    if(got && fracEq(toFrac(got[0],got[1]), ans)){inp.style.borderColor='#22c55e'; ok++;} else {inp.style.borderColor='#ef4444';}
  });
  id('likeFb').textContent= ok===total?'‚úÖ All correct!':'Score: '+ok+'/'+total; if(ok===total) confetti();
});

// Decimals
const decState={set:[]};
function newDecSet(){
  const bank=[['2.75','-3.4'],['-1.2','-0.8'],['5.06','-2.31'],['-4.5','1.75'],['3.2','0.45'],['-6.75','-1.25']];
  const box=id('decList'); if(!box) return; box.innerHTML=''; decState.set=[];
  bank.sort(()=>Math.random()-0.5).slice(0,4).forEach((p,idx)=>{
    const [a,b]=p; const op=Math.random()<0.5?'+':'-';
    const row=document.createElement('div'); row.className='card';
    row.innerHTML=`<div class="text-left font-semibold text-[color:var(--maroon)]">Item ${idx+1}</div>
      <div class="text-2xl mt-1">${a} ${op} ${b} = <input class="din border rounded px-2 py-1 w-32" placeholder="e.g., 0.44"></div>`;
    row.dataset.a=a; row.dataset.b=b; row.dataset.op=op; box.appendChild(row);
    decState.set.push({a,b,op});
  });
}
newDecSet(); id('decNew')?.addEventListener('click',newDecSet);
id('decCheck')?.addEventListener('click',()=>{
  let total=0,ok=0; id('decList').querySelectorAll('.card').forEach(row=>{
    total++;
    const a=parseFloat(row.dataset.a), b=parseFloat(row.dataset.b), op=row.dataset.op;
    const ans = op==='+' ? a + b : a - b;
    const got = Number(row.querySelector('.din').value);
    if(Math.abs(got-ans)<1e-10){row.querySelector('.din').style.borderColor='#22c55e'; ok++;} else {row.querySelector('.din').style.borderColor='#ef4444'}
  });
  id('decFb').textContent= ok===total?'‚úÖ All correct!':'Score: '+ok+'/'+total; if(ok===total) confetti();
});

/* =========================
   Part E: Unlike Denoms
========================= */
const unlikeState={a:null,b:null,op:null};
function newUnlike(){
  const den1=[3,4,5,6,8,9][Math.floor(Math.random()*6)];
  const den2=[4,5,6,7,8,9,10][Math.floor(Math.random()*7)];
  const n1=Math.floor(Math.random()*den1), n2=Math.floor(Math.random()*den2);
  const op=Math.random()<0.5?'+':'-';
  const box=id('unlikeBox'); 
  if(!box) return;
  box.innerHTML = `
    <div class="card">
      <div class="text-2xl">\\( \\frac{${n1}}{${den1}} ${op} \\frac{${n2}}{${den2}} \\)</div>
      <div class="mt-2">LCM = <input id="lcmIn" class="border rounded px-2 py-1 w-28" placeholder="LCM"></div>
      <div class="mt-2 flex flex-wrap items-center gap-3">
        <span>\\( \\frac{${n1}}{${den1}} = \\)</span>
        <input id="eq1" class="border rounded px-2 py-1 w-24" placeholder="?"> /
        <input id="d1"  class="border rounded px-2 py-1 w-24" placeholder="?">
        <span class="ml-6">\\( \\frac{${n2}}{${den2}} = \\)</span>
        <input id="eq2" class="border rounded px-2 py-1 w-24" placeholder="?"> /
        <input id="d2"  class="border rounded px-2 py-1 w-24" placeholder="?">
      </div>
    </div>
    <div class="card">
      <div>Final answer (simplest): <input id="unAns" class="border rounded px-2 py-1 w-32" placeholder="e.g., 7/12"></div>
    </div>`;
  if(window._rerenderMath) _rerenderMath(id('unlikeSlide'));
  unlikeState.a=`${n1}/${den1}`; unlikeState.b=`${n2}/${den2}`; unlikeState.op=op;
}
newUnlike();
id('unlikeNew')?.addEventListener('click',newUnlike);
id('unlikeCheck')?.addEventListener('click',()=>{
  const a=parseRational(unlikeState.a), b=parseRational(unlikeState.b); const op=unlikeState.op;
  const L=lcm(a[1],b[1]);
  const A=[a[0]*(L/a[1]), L], B=[b[0]*(L/b[1]), L];
  const ans = (op==='+')? addFrac(A,B) : subFrac(A,B);
  let ok=true;
  const lcmIn=id('lcmIn'); if(Number(lcmIn.value)==L){lcmIn.style.borderColor='#22c55e'} else {ok=false; lcmIn.style.borderColor='#ef4444'}
  function eqCheck(idn, val){const el=id(idn); if(Number(el.value)==val){el.style.borderColor='#22c55e'} else {ok=false; el.style.borderColor='#ef4444'}}
  eqCheck('eq1', A[0]); eqCheck('d1', A[1]); eqCheck('eq2', B[0]); eqCheck('d2', B[1]);
  const got=parseRational(id('unAns').value);
  if(!(got && fracEq(got, ans))){ok=false; id('unAns').style.borderColor='#ef4444'} else id('unAns').style.borderColor='#22c55e';
  id('unlikeFb').textContent= ok?'‚úÖ Nice work!':'‚ùå Check highlights'; if(ok) confetti();
});

/* =========================
   Part F: Reasoning + Challenges
========================= */
// Ordering
const sortState={items:[]};
function genRationalString(){
  const t=Math.random();
  if(t<0.33){ const v=Math.floor(Math.random()*21)-10; return {disp:String(v), val:v}; }
  else if(t<0.66){
    const den=[4,5,6,8,10,12][Math.floor(Math.random()*6)];
    const num=Math.floor(Math.random()*(den*2+1))-den;
    return {disp:`\\( \\frac{${num}}{${den}} \\)`, val:num/den};
  } else {
    const v=Math.round((Math.random()*20-10)*10)/10; return {disp:String(v.toFixed(1).replace(/\\.0$/,'')), val:v};
  }
}
function sortNew(){
  const set=[]; while(set.length<5){ set.push(genRationalString()); }
  sortState.items=set;
  const ul=id('sortList'); ul.innerHTML='';
  set.forEach((o,idx)=>{
    const li=document.createElement('li'); li.className='border rounded px-3 py-2 flex items-center justify-between cursor-move';
    li.setAttribute('draggable','true'); li.dataset.val=o.val; li.innerHTML=`<span class="text-2xl">${o.disp}</span><span class="text-gray-400 text-sm">drag</span>`;
    ul.appendChild(li);
  });
  enableDrag(ul);
  if(window._rerenderMath) _rerenderMath(id('sortSlide'));
}
function enableDrag(ul){
  let dragEl=null;
  ul.querySelectorAll('li').forEach(li=>{
    li.addEventListener('dragstart',()=>{dragEl=li; li.classList.add('dragging')});
    li.addEventListener('dragend',()=>{dragEl=null; li.classList.remove('dragging')});
  });
  ul.addEventListener('dragover',e=>{
    e.preventDefault();
    const after=getDragAfterElement(ul,e.clientY);
    if(after==null) ul.appendChild(dragEl); else ul.insertBefore(dragEl,after);
  });
  function getDragAfterElement(container, y){
    const els=[...container.querySelectorAll('li:not(.dragging)')];
    return els.reduce((closest,child)=>{
      const box=child.getBoundingClientRect();
      const offset=y - box.top - box.height/2;
      if(offset<0 && offset>closest.offset){ return {offset,element:child}; } else { return closest; }
    }, {offset:Number.NEGATIVE_INFINITY}).element;
  }
}
id('sortNew')?.addEventListener('click',sortNew);
id('sortCheck')?.addEventListener('click',()=>{
  const now=[...id('sortList').children].map(li=>({val:Number(li.dataset.val), el:li}));
  const sorted=[...now].sort((a,b)=>a.val-b.val);
  let ok=true;
  now.forEach((o,idx)=>{ if(o!==sorted[idx]) ok=false; });
  now.forEach((o,idx)=>o.el.style.borderColor = (o===sorted[idx])? '#22c55e' : '#ef4444');
  id('sortFb').textContent= ok? '‚úÖ Correct order!' : 'Some items are out of order.';
  if(ok) confetti();
});
sortNew();

// Error analysis bank
function errorBank(){
  return [
    {work:'\\( (-\\tfrac{3}{4}) + (\\tfrac{1}{2}) = -\\tfrac{4}{6} = -\\tfrac{2}{3} \\)', correct:'Use a common denominator 4: \\( -\\tfrac{3}{4} + \\tfrac{1}{2} = -\\tfrac{3}{4} + \\tfrac{2}{4} = -\\tfrac{1}{4} \\).', key:'A'},
    {work:'\\( 6 - 9 = 3 \\)', correct:'Subtracting a larger number yields a negative: \\( 6-9=-3 \\).', key:'C'},
    {work:'\\( -2.5 - 1.5 = -1.0 \\)', correct:'Both negative: difference is \\( -4.0 \\).', key:'C'},
    {work:'\\( \\tfrac{3}{5} + \\tfrac{1}{2} = \\tfrac{4}{7} \\)', correct:'LCD 10: \\( \\tfrac{3}{5}+\\tfrac{1}{2}=\\tfrac{6}{10}+\\tfrac{5}{10}=\\tfrac{11}{10}=1\\tfrac{1}{10} \\).', key:'A'},
    {work:'\\( 2.6 + (-1.25) = 2. - 1.25 = 0.75 \\) (misaligned)', correct:'Align decimals: \\( 2.60 + (-1.25)=1.35 \\).', key:'D'}
  ];
}
const errState={item:null};
function errNew(){
  const bank=errorBank(); errState.item=bank[Math.floor(Math.random()*bank.length)];
  id('errBox').innerHTML=`Incorrect work:<br/> <div class="mt-1 text-[color:var(--maroon)]"> ${errState.item.work} </div>`;
  id('errFb').textContent=''; id('errRevealBox').textContent='';
  if(window._rerenderMath) _rerenderMath(id('challengeSlide'));
}
id('errNew')?.addEventListener('click',errNew);
id('errCheck')?.addEventListener('click',()=>{
  const sel=[...document.querySelectorAll('input[name="errChoice"]')].find(x=>x.checked);
  if(!sel){ id('errFb').textContent='Choose an option.'; return; }
  if(sel.value===errState.item.key){ id('errFb').textContent='‚úÖ Correct diagnosis.'; confetti(); }
  else { id('errFb').textContent='‚ùå Not quite. Try again or reveal the correct work.'; }
});
id('errReveal')?.addEventListener('click',()=>{
  id('errRevealBox').innerHTML = `<div class="hint">${errState.item.correct}</div>`;
  if(window._rerenderMath) _rerenderMath(id('challengeSlide'));
});
errNew();

// Missing addend
id('chCheck')?.addEventListener('click',()=>{
  let ok=true; document.querySelectorAll('.ch1').forEach(inp=>{const want=parseRational(inp.dataset.ans); const got=parseRational(inp.value); if(!(got && fracEq(got,want))){ok=false; inp.style.borderColor='#ef4444'} else inp.style.borderColor='#22c55e'}); id('chFb').textContent= ok?'‚úÖ Excellent!':'‚ùå Try to fix the red ones'; if(ok) confetti();
});
id('chReset')?.addEventListener('click',()=>{document.querySelectorAll('.ch1').forEach(i=>{i.value='';i.style.borderColor='#e5e7eb'}); id('chFb').textContent=''});

// Strategy board
const SKEY='QLA_G7_STRATEGIES';
function renderStrategies(){
  const list=JSON.parse(localStorage.getItem(SKEY)||'[]');
  const host=id('strategyList'); host.innerHTML='';
  list.forEach((s,idx)=>{
    const row=document.createElement('div'); row.className='flex items-center justify-between p-2 border rounded bg-white';
    row.innerHTML=`<span>${s.text}</span>
      <span class="flex items-center gap-2">
        <button class="btn ghost up" data-i="${idx}">üëç ${s.votes||0}</button>
        <button class="btn ghost del" data-i="${idx}">üóë</button>
      </span>`;
    host.appendChild(row);
  });
  host.querySelectorAll('.up').forEach(b=>b.addEventListener('click',()=>{
    const i=+b.dataset.i; const L=JSON.parse(localStorage.getItem(SKEY)||'[]'); L[i].votes=(L[i].votes||0)+1; localStorage.setItem(SKEY,JSON.stringify(L)); renderStrategies();
  }));
  host.querySelectorAll('.del').forEach(b=>b.addEventListener('click',()=>{
    const i=+b.dataset.i; const L=JSON.parse(localStorage.getItem(SKEY)||'[]'); L.splice(i,1); localStorage.setItem(SKEY,JSON.stringify(L)); renderStrategies();
  }));
}
id('addStrategy')?.addEventListener('click',()=>{
  const v=id('strategyIn').value.trim(); if(!v) return;
  const L=JSON.parse(localStorage.getItem(SKEY)||'[]'); L.push({text:v,votes:0}); localStorage.setItem(SKEY,JSON.stringify(L)); id('strategyIn').value=''; renderStrategies();
});
id('clearStrategy')?.addEventListener('click',()=>{ localStorage.removeItem(SKEY); renderStrategies();});
renderStrategies();

/* =========================
   Part G: Mixed Generator
========================= */
const qText=id('qText'), ansIn=id('ans'), qFb=id('qFb'), qHint=id('qHint'), level=id('level');
let current=null;
function frac(n,d){return [n,d]}
function ri(a,b){return Math.floor(Math.random()*(b-a+1))+a}
function newQuestion(){
  qFb.textContent=''; qHint.textContent=''; ansIn.value='';
  const lvl=level.value; let A,B,op;
  if(lvl==='easy'){ A=frac(ri(-9,9),1); B=frac(ri(-9,9),1); op=Math.random()<0.5?'+':'-'; }
  else if(lvl==='med'){
    if(Math.random()<0.5){ const d=[4,5,6,8,10][ri(0,4)]; A=frac(ri(-d+1,d-1),d); B=frac(ri(-d+1,d-1),d); }
    else { const a=(ri(-30,30)/10), b=(ri(-30,30)/10); A=parseRational(String(a)); B=parseRational(String(b)); }
    op=Math.random()<0.5?'+':'-';
  } else {
    const d1=[3,4,5,6,8,9][ri(0,5)], d2=[4,5,6,7,8,10][ri(0,5)];
    A=frac(ri(-d1+1,d1-1),d1); B=frac(ri(-d2+1,d2-1),d2); op=Math.random()<0.5?'+':'-';
  }
  current={A,B,op};
  qText.innerHTML = `\\( ${sFrac(A)} \\ ${op}\\ ${sFrac(B)} \\)`;
  if(window._rerenderMath) _rerenderMath(id('mixedSlide'));
}
id('newQ')?.addEventListener('click',newQuestion); newQuestion();
id('hintQ')?.addEventListener('click',()=>{
  if(!current) return;
  const {A,B,op}=current;
  if(A[1]===B[1]) qHint.innerHTML=`<div class="hint">Like denominators: \\( ${sFrac(A)} ${op} ${sFrac(B)} \\Rightarrow ${(op==='+')? (A[0]+'+'+B[0]): (A[0]+'-'+B[0])} \\) over \\( ${A[1]} \\).</div>`;
  else {const L=lcm(A[1],B[1]); qHint.innerHTML=`<div class="hint">Unlike denominators: \\(\\mathrm{LCM}(${A[1]}, ${B[1]}) = ${L}\\). Equivalents: \\( ${sFrac([A[0]*(L/A[1]),L])} ${op} ${sFrac([B[0]*(L/B[1]),L])} \\).</div>`}
  if(window._rerenderMath) _rerenderMath(id('mixedSlide'));
});
id('checkQ')?.addEventListener('click',()=>{
  if(!current) return;
  const got=parseRational(ansIn.value); if(!got){qFb.textContent='Enter a valid number or fraction.'; qFb.className='mt-1 font-bold text-red-700'; return;}
  const {A,B,op}=current; const ans = op==='+'? addFrac(A,B): subFrac(A,B);
  if(fracEq(got, ans)){qFb.textContent='‚úÖ Correct! '+sFrac(ans); qFb.className='mt-1 font-bold text-green-700'; confetti();}
  else {qFb.textContent='‚ùå Not quite. Expected '+sFrac(ans); qFb.className='mt-1 font-bold text-red-700';}
});

/* =========================
   Init & Resize hooks
========================= */
window.addEventListener('resize',()=>{ if(slides[i].id==='addSlide') drawAdd(); if(slides[i].id==='subSlide') drawSub(); resizeInk(); });
show(0);
</script>
</body>
</html>
