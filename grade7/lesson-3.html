<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>G7 • Unit 1 • Lesson 3 — Prime Factorization Toolkit (v2)</title>

<!-- Fonts & Tailwind -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

<style>
  :root{--maroon:#6C1D45;--gold:#C7A34F;--dark:#2C2C2E;--light:#F5F5F5;--accent:#E8D5B7}
  html,body{height:100%;background:#2d3748;color:#111;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  #deck{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;padding:10px}
  #slides{position:relative;width:100%;max-width:1280px;aspect-ratio:16/9;background:#fff;box-shadow:0 14px 36px rgba(0,0,0,.35);overflow:hidden;border-radius:18px}
  .slide{position:absolute;inset:0;padding:3.5%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;opacity:0;transform:translateY(14px) scale(.985);transition:.55s ease;pointer-events:none}
  .slide.active{opacity:1;transform:none;pointer-events:auto}
  .bg-maroon{background-color:var(--maroon)} .text-maroon{color:var(--maroon)} .text-gold{color:var(--gold)}
  .banner{width:100%;height:120px;background:#fff center/contain no-repeat;border-bottom:3px solid var(--gold);border-radius:10px}
  .card{border:1px solid #e5e7eb;border-radius:14px;background:#fafafa}
  .chip{display:inline-flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.05);border-radius:9999px;padding:.35rem .75rem;cursor:pointer}
  .chip:hover{outline:2px solid var(--gold)}
  .pill{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #e5e7eb;border-radius:999px;padding:.35rem .75rem;background:#fff;cursor:pointer}
  .pill.active{border-color:#22c55e;box-shadow:0 0 0 2px rgba(34,197,94,.15)}
  .btn{padding:.55rem 1rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
  .btn.maroon{background:var(--maroon);color:#fff;border-color:var(--maroon)}
  .btn:hover{filter:brightness(0.98)}
  #controls{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.55);padding:.4rem .6rem;border-radius:999px;z-index:20;backdrop-filter:blur(6px)}
  #controls button{width:42px;height:42px;border-radius:999px;border:none;background:#fff;cursor:pointer;font-weight:700}
  #controls button:hover{transform:scale(1.06)}
  #counter{color:#fff;font-weight:700;min-width:84px;text-align:center}
  #progress{position:fixed;left:0;bottom:0;height:5px;width:0;background:var(--gold);z-index:30;transition:width .35s ease}
  #fsHint{position:absolute;top:10px;right:12px;color:#fff;background:rgba(0,0,0,.35);padding:.25rem .5rem;border-radius:8px;font-size:.8rem}

  /* Part Navigator */
  #partNav{position:fixed;top:18px;left:18px;z-index:35;display:flex;gap:.4rem;background:rgba(255,255,255,.8);padding:.35rem .35rem;border-radius:999px;border:2px solid var(--gold);backdrop-filter:blur(4px)}
  #partNav button{font-weight:800}

  /* Global student toolbar */
  #globalBar{
    position:fixed; top:18px; right:18px; z-index:45; display:flex; gap:.5rem;
    background:rgba(255,255,255,.92); border:2px solid var(--gold); border-radius:999px;
    padding:.35rem .55rem; align-items:center; backdrop-filter:blur(6px)
  }
  #globalBar .tog{display:inline-flex; align-items:center; gap:.35rem; padding:.3rem .6rem; border:1px solid #e5e7eb; border-radius:999px; background:#fff; cursor:pointer; font-weight:700}
  #globalBar .tog.active{border-color:#22c55e; box-shadow:0 0 0 2px rgba(34,197,94,.15)}
  #globalBar input[type="text"]{height:30px; padding:.2rem .5rem; border:1px solid #e5e7eb; border-radius:8px; width:110px}
  #globalBar .btnMini{padding:.35rem .6rem; border-radius:999px; border:1px solid #e5e7eb; background:#fff; font-weight:800; cursor:pointer}
  #globalBar .btnMini:hover{filter:brightness(.98)}
  .inlineNote{display:inline-block; background:#eef2ff; border:1px dashed #c7d2fe; padding:.15rem .35rem; border-radius:8px; font-size:.85rem}

  /* Clarify / HOT / Qatar connect cards */
  .clarify{
    width:min(100%, 980px); margin-top:.75rem; text-align:left; background:#fffef7; border:1px solid #ffe69c; border-radius:12px;
    padding:.75rem 1rem; box-shadow:0 4px 10px rgba(0,0,0,.04)
  }
  .clarify summary{font-weight:800; color:var(--maroon); cursor:pointer}
  .clarify .mini{display:grid; grid-template-columns: 1fr; gap:.35rem; margin-top:.4rem; font-size:.95rem}
  .clarify .mini .tag{display:inline-block; font-weight:700; color:#374151}

  .hotBox{width:min(100%,980px); margin-top:.6rem; background:#fafaff; border:1px solid #dbeafe; border-radius:12px; padding:.75rem 1rem; text-align:left}
  .hotBox h4{margin:0 0 .25rem 0; color:#1d4ed8; font-weight:800}
  .hotBox .q{padding:.4rem .5rem; border-left:4px solid #93c5fd; background:#fff}

  .qatCard{width:min(100%,980px); margin-top:.6rem; background:#f8faf8; border:1px solid #d1fae5; border-radius:12px; padding:.75rem 1rem; text-align:left}
  .qatCard h4{margin:0 0 .25rem 0; color:#065f46; font-weight:800}
  .qatCard .q{padding:.4rem .5rem; border-left:4px solid #10b981; background:#fff}

  .hint{background:#fff3cd;border:1px solid #ffe69c;border-radius:10px;padding:.5rem .75rem}
  .workline{padding:.25rem .5rem;border-left:4px solid var(--gold);margin:.3rem 0;background:#fff}

  /* Factor Tree canvas */
  .wide-wrap{width:100%;max-width:1000px}
  canvas.tree{width:100%;height:340px;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa);border:2px solid #ececec}

  .confetti{position:fixed;pointer-events:none;z-index:50}

  /* Worksheet modal */
  #wsModal{position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:60}
  #wsPanel{width:min(600px, 92vw); background:#fff; border:2px solid var(--gold); border-radius:14px; box-shadow:0 14px 36px rgba(0,0,0,.35); padding:14px; position:relative}
  #wsPanel h3{margin:0 0 6px 0; color:var(--maroon); font-weight:900}
  #wsPanel label{display:block; margin:.35rem 0 .15rem; font-weight:700}
  #wsPanel select,#wsPanel input[type="number"]{width:100%; border:1px solid #e5e7eb; border-radius:8px; padding:.35rem .5rem}
  #wsPanel .actions{display:flex; gap:.5rem; justify-content:flex-end; margin-top:.6rem}
  #wsClose{position:absolute; right:14px; top:10px; cursor:pointer; font-weight:900}
</style>
</head>
<body>

<div id="deck" aria-live="polite">
  <div id="slides" class="relative">
    <div id="fsHint">Press <strong>F</strong> for fullscreen</div>

    <!-- 0 • Title -->
    <section class="slide active bg-maroon text-white" id="titleSlide">
      <div class="w-full h-16 banner mb-6 rounded-md" style="background-image:url('../assets/qla_banner.png')" aria-label="QLA Partner Banner"></div>
      <div class="flex items-center gap-8">
        <img src="../assets/qla_logo.png" alt="QLA Logo" class="h-24 w-auto" onerror="this.style.display='none'"/>
        <div class="text-left">
          <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight">Unit 1 — The Number System</h1>
          <p class="text-gold text-2xl md:text-3xl mt-2 font-semibold">Lesson 3: Prime Factorization Toolkit</p>
          <p class="mt-2 text-lg">Qatar Leadership Academy — Grade 7</p>
        </div>
      </div>
      <div class="absolute bottom-6 text-sm text-gray-100">Aligned to AERO 7.NS foundations &amp; 7.EE.3 applications. Member of Qatar Foundation.</div>
    </section>

    <!-- ──────────────────────────────── PART 1 ──────────────────────────────── -->
    <!-- 1 • Part 1: LO & Keywords -->
    <section class="slide" id="p1IntroSlide" aria-label="Part 1 Intro">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 1 — Primes, Factors &amp; Multiples</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P1)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Distinguish and find <strong>factors</strong> and <strong>multiples</strong> of a number.</li>
            <li>Use quick <strong>divisibility rules</strong> (2, 3, 5, 7) & a √n prime test.</li>
            <li>Classify numbers as <strong>prime</strong> or <strong>composite</strong>; recall common primes ≤ 100.</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords (tap for definitions)</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="factor">factor</span>
            <span class="chip" data-key="multiple">multiple</span>
            <span class="chip" data-key="prime">prime</span>
            <span class="chip" data-key="composite">composite</span>
            <span class="chip" data-key="divrule">divisibility</span>
            <span class="chip" data-key="prtest">prime test</span>
          </div>
          <p class="text-xs text-gray-500 mt-3">Click a keyword to view a quick definition.</p>
        </div>
      </div>

      <!-- Clarify & Plan -->
      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Clarify</span> <b>Factors</b> divide exactly; <b>multiples</b> are skip‑counts. <b>Prime</b> = exactly two positive factors (1 and itself). 1 is neither prime nor composite.</div>
          <div><span class="tag">Plan</span> Apply rules (2,3,5,7). If none apply, test primes up to \\(\\sqrt{n}\\).</div>
          <div><span class="tag">Why it works</span> If \\(n=ab\\) and \\(a>\\sqrt{n}\\), then \\(b<\\sqrt{n}\\). You only need to test up to \\(\\sqrt{n}\\).</div>
        </div>
      </details>
    </section>

    <!-- 2 • Warm‑Up -->
    <section class="slide" id="warmSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Warm‑Up: Factors vs. Multiples (Small Numbers)</h2>
      <div class="grid md:grid-cols-3 gap-4 w-full max-w-5xl">
        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">Factor idea</div>
          <div class="text-2xl">\( 24 \div 6 = 4 \Rightarrow 6 \) is a factor of \(24\).</div>
          <div class="text-sm mt-1">All factors of \(24\): \(1,2,3,4,6,8,12,24\).</div>
        </div>
        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">Multiple idea</div>
          <div class="text-2xl">Multiples of \(4\): \(4,8,12,16,20,\dots\)</div>
          <div class="text-sm mt-1">A multiple is \(4 \times \text{(whole number)}\).</div>
        </div>
        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">Prime vs. Composite</div>
          <div class="text-2xl">\( 17 \) is prime; \( 18=2\cdot 3^2 \) is composite.</div>
        </div>
      </div>

      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Tip</span> Use factor <em>pairs</em> to avoid missing factors—search up to \\(\\sqrt{n}\\).</div>
        </div>
      </details>
    </section>

    <!-- 3 • Explain: Factors, Multiples & Divisibility -->
    <section class="slide" id="explainSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Explain: Factors, Multiples &amp; Divisibility</h2>
      <div class="grid lg:grid-cols-2 gap-6 w-full max-w-5xl text-left">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">Definitions</h3>
          <ul class="list-disc list-inside">
            <li><strong>Factor:</strong> whole number that divides another exactly.</li>
            <li><strong>Multiple:</strong> result of \(n \times \text{(whole number)}\).</li>
            <li><strong>Prime:</strong> exactly two positive factors: 1 and itself.</li>
            <li><strong>Composite:</strong> more than two positive factors.</li>
          </ul>
          <div class="mt-3 hint">Example: Are \(3\) and \(8\) factors of \(24\)?  
            \(24\div 3=8\Rightarrow 3\) is a factor.  
            \(24\div 8=3\Rightarrow 8\) is a factor.</div>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">Divisibility Rules (2, 3, 5, 7)</h3>
          <ul class="list-disc list-inside">
            <li><strong>2:</strong> last digit even (0,2,4,6,8).</li>
            <li><strong>3:</strong> sum of digits divisible by 3.</li>
            <li><strong>5:</strong> last digit 0 or 5.</li>
            <li><strong>7:</strong> remove last digit, double it, subtract from the rest; repeat (e.g., 203 → 20 − 6 = 14 ✓).</li>
          </ul>
          <div class="mt-3">
            <div class="text-sm mb-1">Try it:</div>
            <input id="divTry" class="border rounded px-2 py-1 w-40" placeholder="e.g., 84" aria-label="Enter number to test divisibility">
            <button id="divCheck" class="btn">Check rules</button>
            <div id="divFb" class="mt-2 text-sm" aria-live="polite"></div>
          </div>
        </div>
      </div>

      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Clarify</span> The 7‑rule is a shortcut preserving divisibility (modular reasoning).</div>
          <div><span class="tag">Misconception</span> “Not divisible by 2,3,5,7 ⇒ prime.” Not always (e.g., \(121=11^2\)).</div>
        </div>
      </details>

      <button class="btn mt-3" data-hot="pc">Challenge / HOT</button>
      <div class="hotBox" id="hot_pc" style="display:none"></div>
    </section>

    <!-- 4 • Prime list ≤ 100 -->
    <section class="slide" id="primeListSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Common Prime Numbers (≤ 100)</h2>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div id="primeGrid" class="grid grid-cols-10 gap-2 text-lg" aria-label="Prime grid up to 100"></div>
        <div class="mt-3 hint text-sm">To test if \(n\) is prime, try dividing by primes ≤ \( \sqrt{n} \): \(2,3,5,7\) (and \(11\) for larger \(n\)).</div>
      </div>
      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Plan</span> Use this as your “palette” when building factor trees.</div>
        </div>
      </details>
    </section>

    <!-- 5 • Classify: Prime or Composite -->
    <section class="slide" id="pcSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Classify Numbers: Prime or Composite</h2>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="text-sm text-gray-600 mb-2">Use divisibility (2,3,5,7) and the prime list. Remember: 1 is <em>neither</em> prime nor composite.</div>
        <div class="flex items-center gap-3 mb-2">
          <span>Level:</span>
          <select id="pcLevel" class="border rounded px-2 py-1" aria-label="Prime Composite level">
            <option value="easy" selected>easy (2–40)</option>
            <option value="med">medium (2–100)</option>
            <option value="hard">hard (2–200)</option>
          </select>
          <button id="pcNew" class="btn">New set</button>
          <button id="pcCheck" class="btn maroon">Check</button>
          <button id="pcExportCSV" class="btn">Export CSV</button>
          <button id="pcExportJSON" class="btn">Export JSON</button>
        </div>
        <div id="pcList" class="grid md:grid-cols-4 gap-2"></div>
        <div id="pcFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>
      </div>

      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Plan</span> Test primes ≤ \( \sqrt{n} \). Use the grid, not guesswork.</div>
          <div><span class="tag">Try</span> Your own number: <input id="pcOwn" class="border rounded px-2 py-1 w-28" placeholder="e.g., 119"> <button id="pcOwnBtn" class="btn">Classify</button> <span id="pcOwnFb" class="inlineNote"></span></div>
        </div>
      </details>

      <button class="btn mt-3" data-hot="pc_only">Challenge / HOT</button>
      <div class="hotBox" id="hot_pc_only" style="display:none"></div>
    </section>

    <!-- 6 • Worked example: Factors & Multiples -->
    <section class="slide" id="fmExplainSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Worked Example: Find All Factors &amp; Multiples</h2>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div id="fmExample" class="text-lg"></div>
        <div class="mt-2"><button id="fmNextEx" class="btn">Another example</button></div>
        <div class="hint mt-3 text-sm">Strategy: test small divisors up to \( \sqrt{n} \); list factor pairs. Multiples are \(n,2n,3n,\dots\)</div>
      </div>
      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Pitfall</span> Don’t stop after finding a single factor—write its <b>pair</b>.</div>
        </div>
      </details>
      <button class="btn mt-3" data-hot="fm">Challenge / HOT</button>
      <div class="hotBox" id="hot_fm" style="display:none"></div>
    </section>

    <!-- 7 • Activity: Pick Factors & Multiples -->
    <section class="slide" id="fmSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Pick the Factors &amp; Multiples</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="fmLevel" class="border rounded px-2 py-1" aria-label="Factors Multiples level">
          <option value="easy" selected>easy (small targets ≤ 30)</option>
          <option value="med">medium (targets ≤ 60)</option>
          <option value="hard">hard (targets ≤ 100)</option>
        </select>
        <button id="fmNew" class="btn">New set</button>
        <button id="fmCheck" class="btn maroon">Check</button>
        <button id="fmExportCSV" class="btn">Export CSV</button>
        <button id="fmExportJSON" class="btn">Export JSON</button>
      </div>
      <div class="grid lg:grid-cols-2 gap-6 w-full max-w-5xl text-left">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-1">All factors of target</h3>
          <div id="fTarget" class="text-lg mb-2"></div>
          <div id="fChoices" class="grid grid-cols-4 gap-2"></div>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-1">All multiples of target (under 100)</h3>
          <div id="mTarget" class="text-lg mb-2"></div>
          <div id="mChoices" class="grid grid-cols-4 gap-2"></div>
        </div>
      </div>
      <div id="fmFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>

      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Clarify</span> Even → divisible by 2; ends in 0/5 → divisible by 5; digit sum multiple of 3 → divisible by 3; use the 7‑rule as needed.</div>
        </div>
      </details>
    </section>

    <!-- 8 • Part 1: Real‑Life mini‑tasks -->
    <section class="slide" id="p1RealSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Part 1 Real‑Life Mini‑Tasks (Factors &amp; Multiples)</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="p1RealLevel" class="border rounded px-2 py-1" aria-label="P1 real level">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="p1RealNew" class="btn">New set</button>
        <button id="p1RealCheck" class="btn maroon">Check</button>
        <button id="p1RealExportCSV" class="btn">Export CSV</button>
        <button id="p1RealExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="p1RealList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div class="hint mt-3 text-sm">Enter <b>1</b> for “yes” and <b>0</b> for “no” when asked a yes/no divisibility or primality question.</div>
      <div id="p1RealFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>

      <div class="qatCard" id="qat_p1"></div>
    </section>

    <!-- ──────────────────────────────── PART 2 ──────────────────────────────── -->
    <!-- 9 • Part 2: LO & Keywords -->
    <section class="slide" id="p2IntroSlide">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 2 — Prime Factorization (Tree/Table)</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P2)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Construct <strong>factor trees</strong> or <strong>division tables</strong> to prime‑factorize a number.</li>
            <li>Write the factorization in <strong>exponent form</strong> and verify it multiplies back.</li>
            <li>Recognize uniqueness of prime factorization (informal <strong>FTA</strong> idea).</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords (tap for definitions)</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="pfe">prime factorization</span>
            <span class="chip" data-key="exp">exponent</span>
            <span class="chip" data-key="tree">factor tree</span>
            <span class="chip" data-key="table">division table</span>
            <span class="chip" data-key="fta">FTA</span>
          </div>
        </div>
      </div>

      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Bridge</span> From factors to <b>prime</b> factors: a canonical (unique) “DNA” for each number.</div>
          <div><span class="tag">Why unique</span> This is the informal Fundamental Theorem of Arithmetic (FTA).</div>
        </div>
      </details>
    </section>

    <!-- 10 • Factor Tree / Table -->
    <section class="slide" id="treeSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Prime Factorization: Tree or Table</h2>
      <div class="flex flex-wrap items-center gap-3 mb-2">
        <span>View:</span>
        <span id="viewTree" class="pill active">Tree</span>
        <span id="viewTable" class="pill">Table</span>
        <span class="ml-4">Level:</span>
        <select id="treeLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy (≤ 200)</option>
          <option value="med">medium (≤ 600)</option>
          <option value="hard">hard (≤ 2000)</option>
        </select>
        <button id="treeNewNum" class="btn">New number</button>
        <label class="chip">Number: <input id="treeN" class="border rounded px-2 py-1 w-28" value="180" aria-label="Tree number"/></label>
        <button id="treeReset" class="btn">Reset</button>
        <button id="treeAuto" class="btn">Auto‑split</button>
      </div>
      <div class="wide-wrap" id="treeView">
        <canvas id="treeCanvas" class="tree" aria-label="Factor tree canvas"></canvas>
      </div>
      <div id="tableView" class="w-full max-w-5xl hidden">
        <div id="tableRows" class="text-left"></div>
      </div>
      <div class="mt-3 flex flex-wrap items-center gap-2 text-sm">
        <div>Leaves: <span id="leafChips" class="inline-flex flex-wrap gap-2"></span></div>
        <label class="chip">Leaf ID: <input id="leafId" class="border rounded px-2 py-1 w-20" placeholder="id" aria-label="Leaf id"></label>
        <label class="chip">Split as <input id="splitA" class="border rounded px-2 py-1 w-16" placeholder="a" aria-label="Split a"> × <input id="splitB" class="border rounded px-2 py-1 w-16" placeholder="b" aria-label="Split b"></label>
        <button id="treeSplit" class="btn">Split</button>
        <button id="treeExportCSV" class="btn">Export CSV</button>
        <button id="treeExportJSON" class="btn">Export JSON</button>
      </div>
      <div class="mt-2 text-lg">Prime factorization: <b id="treeOut"></b></div>
      <div id="treeFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>

      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Plan</span> Split by smallest prime divisor; stop when leaves are prime. Multiply leaves to verify.</div>
        </div>
      </details>
      <button class="btn mt-3" data-hot="pf">Challenge / HOT</button>
      <div class="hotBox" id="hot_pf" style="display:none"></div>
    </section>

    <!-- 11 • Prime Factorization (Exponent Form) -->
    <section class="slide" id="pfSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Write in Exponent Form</h2>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="flex items-center gap-3 mb-2">
          <span>Level:</span>
          <select id="pfLevel" class="border rounded px-2 py-1">
            <option value="easy" selected>easy (≤ 200; primes ≤ 13)</option>
            <option value="med">medium (≤ 600; primes ≤ 17)</option>
            <option value="hard">hard (≤ 2000; primes ≤ 19)</option>
          </select>
          <button id="pfNew" class="btn">New set</button>
          <button id="pfCheck" class="btn maroon">Check</button>
          <button id="pfExportCSV" class="btn">Export CSV</button>
          <button id="pfExportJSON" class="btn">Export JSON</button>
        </div>
        <div id="pfList" class="grid md:grid-cols-2 gap-3"></div>
        <div id="pfFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>
      </div>
      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Clarify</span> Exponent counts repeats of a prime: \\(180=2^2\\cdot3^2\\cdot5\\).</div>
        </div>
      </details>
      <button class="btn mt-3" data-hot="pfexp">Challenge / HOT</button>
      <div class="hotBox" id="hot_pfexp" style="display:none"></div>

      <div class="qatCard" id="qat_p2"></div>
    </section>

    <!-- 12 • Part 2: Real‑Life mini‑tasks -->
    <section class="slide" id="p2RealSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Part 2 Real‑Life Mini‑Tasks (Prime Powers)</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="p2RealLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="p2RealNew" class="btn">New set</button>
        <button id="p2RealCheck" class="btn maroon">Check</button>
        <button id="p2RealExportCSV" class="btn">Export CSV</button>
        <button id="p2RealExportJSON" class="btn">Export JSON</button>
      </div>
      <div class="card p-4 w-full max-w-5xl text-left">
        <ul class="list-disc list-inside text-sm text-gray-600">
          <li><b>Factor layouts:</b> number of positive factors equals the number of ways to make equal groups (including 1 and itself).</li>
          <li><b>Power of 2:</b> how many times you can keep halving before odd.</li>
          <li><b>Square tiles:</b> largest square factor gives the biggest square side for a given area.</li>
        </ul>
      </div>
      <div id="p2RealList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl mt-2"></div>
      <div id="p2RealFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>
    </section>

    <!-- ──────────────────────────────── PART 3 ──────────────────────────────── -->
    <!-- 13 • Part 3: LO & Keywords -->
    <section class="slide" id="p3IntroSlide">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 3 — HCF/GCF &amp; LCM</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P3)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Determine <strong>GCF/HCF</strong> and <strong>LCM</strong> by listing and by prime exponents; optionally use <strong>Euclid</strong>.</li>
            <li>Select an efficient method based on number size.</li>
            <li>For two numbers, verify \(ab=\mathrm{GCF}(a,b)\cdot \mathrm{LCM}(a,b)\).</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords (tap for definitions)</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="hcf">HCF/GCF</span>
            <span class="chip" data-key="lcm">LCM</span>
            <span class="chip" data-key="euclid">Euclid</span>
            <span class="chip" data-key="pfe">prime factorization</span>
          </div>
        </div>
      </div>

      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Bridge</span> From exponents to operators: <b>GCF</b>=min exponents, <b>LCM</b>=max exponents.</div>
          <div><span class="tag">Identity</span> Two numbers satisfy \(ab=\gcf(a,b)\cdot\operatorname{lcm}(a,b)\).</div>
        </div>
      </details>
    </section>

    <!-- 14 • Worked Examples: GCF/LCM -->
    <section class="slide" id="gclExplainSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Worked Examples: HCF/GCF &amp; LCM</h2>
      <div class="grid lg:grid-cols-2 gap-6 w-full max-w-5xl text-left">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">By Listing</h3>
          <div id="gclListEx" class="text-lg"></div>
          <button id="gclListNext" class="btn mt-2">Another example</button>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">By Prime Exponents</h3>
          <div id="gclPrimeEx" class="text-lg"></div>
          <button id="gclPrimeNext" class="btn mt-2">Another example</button>
        </div>
      </div>
      <div class="hint mt-3 text-sm">For two numbers \(a,b\): \(ab=\mathrm{GCF}(a,b)\cdot \mathrm{LCM}(a,b)\). Small numbers → listing is fine; bigger numbers → use primes.</div>

      <button class="btn mt-3" data-hot="gcl">Challenge / HOT</button>
      <div class="hotBox" id="hot_gcl" style="display:none"></div>
    </section>

    <!-- 15 • Explorer: GCF & LCM -->
    <section class="slide" id="gclSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Explorer: GCF &amp; LCM</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="gclLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy (2 numbers; ≤ 40)</option>
          <option value="med">medium (2 numbers; ≤ 120)</option>
          <option value="hard">hard (3 numbers; ≤ 200)</option>
        </select>
        <span class="ml-2">Method:</span>
        <span id="mList" class="pill active">Listing</span>
        <span id="mPrime" class="pill">Prime exponents</span>
        <span id="mEuclid" class="pill">Euclid (optional)</span>
      </div>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="flex flex-wrap items-center gap-2 text-sm">
          <label class="chip">a = <input id="gA" class="border rounded px-2 py-1 w-20" value="24" aria-label="gA"></label>
          <label class="chip">b = <input id="gB" class="border rounded px-2 py-1 w-20" value="36" aria-label="gB"></label>
          <label class="chip">c = <input id="gC" class="border rounded px-2 py-1 w-20" value="" aria-label="gC (optional)"></label>
          <button id="gRun" class="btn maroon">Compute</button>
          <button id="gRand" class="btn">Randomize</button>
          <button id="gExportCSV" class="btn">Export CSV</button>
          <button id="gExportJSON" class="btn">Export JSON</button>
        </div>
        <div class="grid md:grid-cols-2 gap-4 mt-3">
          <div class="card p-4">
            <div class="font-semibold text-maroon mb-1" id="methodTitle">Listing Trace</div>
            <div id="gMethodOut" class="text-lg"></div>
          </div>
          <div class="card p-4">
            <div class="font-semibold text-maroon mb-1">Results</div>
            <div class="text-lg">GCF = <b id="gGCF"></b>, &nbsp; LCM = <b id="gLCM"></b></div>
          </div>
        </div>
      </div>
      <div class="hint mt-3 text-sm">Tip: For easy level, list a few multiples. For medium/hard, use prime exponents for speed.</div>

      <div class="qatCard" id="qat_p3"></div>
    </section>

    <!-- 16 • Practice: GCF & LCM -->
    <section class="slide" id="glPractice">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Practice: GCF &amp; LCM</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="glLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy (2 numbers; ≤ 40)</option>
          <option value="med">medium (2 numbers; ≤ 120)</option>
          <option value="hard">hard (3 numbers; ≤ 200)</option>
        </select>
        <button id="glNew" class="btn">New set</button>
        <button id="glCheck" class="btn maroon">Check</button>
        <button id="glExportCSV" class="btn">Export CSV</button>
        <button id="glExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="glList" class="w-full max-w-5xl grid md:grid-cols-2 gap-3"></div>
      <div id="glFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>
    </section>

    <!-- 17 • Part 3: Real‑Life tasks -->
    <section class="slide" id="p3RealSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Part 3 Real‑Life Tasks (HCF &amp; LCM)</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="p3RealLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="p3RealNew" class="btn">New set</button>
        <button id="p3RealCheck" class="btn maroon">Check</button>
        <button id="p3RealExportCSV" class="btn">Export CSV</button>
        <button id="p3RealExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="p3RealList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="p3RealFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>
    </section>

    <!-- ──────────────────────────────── PART 4 ──────────────────────────────── -->
    <!-- 18 • Part 4: LO & Keywords -->
    <section class="slide" id="p4IntroSlide">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 4 — Integrate: Applications, Puzzles &amp; Error Analysis</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P4)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Apply factorization to simplify fractions and find common denominators.</li>
            <li>Combine primes, HCF/LCM, and divisibility in multi‑step problems.</li>
            <li>Diagnose and correct typical errors; justify method choice.</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords (tap for definitions)</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="lcd">LCD</span>
            <span class="chip" data-key="simp">simplify</span>
            <span class="chip" data-key="err">error analysis</span>
            <span class="chip" data-key="strategy">strategy</span>
          </div>
        </div>
      </div>

      <details class="clarify" open>
        <summary>Clarify &amp; Plan</summary>
        <div class="mini">
          <div><span class="tag">Bridge</span> We now blend all tools: primes → exponents → GCF/LCM → fraction work → integrated tasks.</div>
        </div>
      </details>
    </section>

    <!-- 19 • Solved Applications -->
    <section class="slide" id="appExplainSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Solved Examples: Applications</h2>
      <div class="grid lg:grid-cols-2 gap-6 w-full max-w-5xl text-left">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">Simplify a Fraction</h3>
          <div id="appSimpEx" class="text-lg"></div>
          <button id="appSimpNext" class="btn mt-2">Another example</button>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">Find a Common Denominator</h3>
          <div id="appLCDEx" class="text-lg"></div>
          <button id="appLCDNext" class="btn mt-2">Another example</button>
        </div>
      </div>

      <button class="btn mt-3" data-hot="app">Challenge / HOT</button>
      <div class="hotBox" id="hot_app" style="display:none"></div>
    </section>

    <!-- 20 • Applications Practice -->
    <section class="slide" id="appSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Applications: Simplify &amp; Common Denominators</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="appLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="appNew" class="btn">New set</button>
        <button id="appCheck" class="btn maroon">Check</button>
        <button id="appExportCSV" class="btn">Export CSV</button>
        <button id="appExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="appList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="appFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>

      <div class="qatCard" id="qat_p4"></div>
    </section>

    <!-- 21 • Challenge -->
    <section class="slide" id="challengeSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Challenge: Constraints &amp; Puzzles</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="chLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="chNew" class="btn">New set</button>
        <button id="chCheck" class="btn maroon">Check</button>
        <button id="chExportCSV" class="btn">Export CSV</button>
        <button id="chExportJSON" class="btn">Export JSON</button>
      </div>
      <div class="grid md:grid-cols-2 gap-6 w-full max-w-5xl text-left">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-1">Mystery Number</h3>
          <div id="mystPrompt" class="text-lg mb-2"></div>
          <div>Answer: <input id="mystAns" class="border rounded px-2 py-1 w-40" placeholder="enter number" aria-label="Mystery number answer"></div>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-1">Given GCF &amp; LCM</h3>
          <div id="gcPairPrompt" class="text-lg mb-2"></div>
          <div class="text-sm">Enter any pair \(a,b\) with those values:</div>
          <div class="mt-1">a = <input id="gcA" class="border rounded px-2 py-1 w-24">, b = <input id="gcB" class="border rounded px-2 py-1 w-24"></div>
        </div>
      </div>
      <div id="chFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>
    </section>

    <!-- 22 • Error Analysis -->
    <section class="slide" id="errSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Error Analysis</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="errLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="errNew" class="btn">New example</button>
        <button id="errReveal" class="btn">Reveal correct work</button>
      </div>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div id="errBox" class="text-lg"></div>
        <div class="mt-2">
          <label class="mr-2"><input type="radio" name="errChoice" value="A"> Misclassified prime/composite</label><br/>
          <label class="mr-2"><input type="radio" name="errChoice" value="B"> Wrong factorization / illegal split</label><br/>
          <label class="mr-2"><input type="radio" name="errChoice" value="C"> Incorrect GCF/LCM rule/use</label><br/>
          <label class="mr-2"><input type="radio" name="errChoice" value="D"> Application mistake (simplify/LCD)</label>
        </div>
        <div class="mt-2 flex gap-2">
          <button id="errCheck" class="btn maroon">Check</button>
          <button id="errExportCSV" class="btn">Export CSV</button>
          <button id="errExportJSON" class="btn">Export JSON</button>
        </div>
        <div id="errFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>
        <div id="errRevealBox" class="mt-2 text-sm"></div>
      </div>
    </section>

    <!-- 23 • Mixed Review -->
    <section class="slide" id="mixSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Mixed Review Generator</h2>
      <div class="card p-5 w-full max-w-3xl text-left">
        <div class="flex items-center gap-3">
          <span>Level:</span>
          <select id="mixLevel" class="border rounded px-2 py-1">
            <option value="easy" selected>easy</option>
            <option value="med">medium</option>
            <option value="hard">hard</option>
          </select>
          <button id="mixNew" class="btn">New question</button>
        </div>
        <div class="mt-3 text-2xl">Task: <span id="mixQ" class="font-extrabold"></span></div>
        <div class="mt-2">
          <input id="mixAns" class="border rounded px-3 py-2 w-72" placeholder="e.g., 2^3·3^2·5; GCF=6, LCM=90; prime; 1,2,3,6" aria-label="Mixed answer">
          <button id="mixCheck" class="btn maroon">Check</button>
          <button id="mixHint" class="btn">Hint</button>
          <button id="mixExportCSV" class="btn">Export CSV</button>
          <button id="mixExportJSON" class="btn">Export JSON</button>
        </div>
        <div id="mixHintBox" class="mt-3 text-sm"></div>
        <div id="mixFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>
      </div>
    </section>

    <!-- 24 • Part 4 Capstone Real‑Life -->
    <section class="slide" id="capSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Capstone: Integrate It All</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="capLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="capNew" class="btn">New set</button>
        <button id="capCheck" class="btn maroon">Check</button>
        <button id="capExportCSV" class="btn">Export CSV</button>
        <button id="capExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="capList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="capFb" class="mt-2 h-6 font-semibold" aria-live="polite"></div>
    </section>

    <!-- 25 • Exit Ticket -->
    <section class="slide" id="exitSlide">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Exit Ticket</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">3–2–1 Reflect</h3>
          <ul class="list-disc list-inside">
            <li>3 ideas about factors, primes, and exponents</li>
            <li>2 methods to get GCF/LCM (and when to use each)</li>
            <li>1 question you still have</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">Up Next</h3>
          <p>We will connect factorization to efficient fraction arithmetic and BEDMAS work in expressions.</p>
        </div>
      </div>
      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-[88%] h-[110px] banner rounded-md" style="background-image:url('../assets/qla_banner.png')"></div>
    </section>

  </div>
</div>

<!-- Controls -->
<div id="controls" role="group" aria-label="Slideshow controls">
  <button id="prev" title="Previous (←)">&laquo;</button>
  <button id="fs" title="Toggle Fullscreen (F)">⤢</button>
  <div id="counter">1 / 26</div>
  <button id="next" title="Next (→)">&raquo;</button>
</div>
<div id="progress"></div>

<!-- Part Navigator -->
<div id="partNav" aria-label="Part navigator">
  <button id="navP1" class="btn">Part&nbsp;1</button>
  <button id="navP2" class="btn">Part&nbsp;2</button>
  <button id="navP3" class="btn">Part&nbsp;3</button>
  <button id="navP4" class="btn">Part&nbsp;4</button>
</div>

<!-- Global Student/Teacher Toolbar -->
<div id="globalBar" aria-label="Student Teacher toolbar">
  <span class="tog" id="togStudent">Student</span>
  <span class="tog" id="togTeacher">Teacher</span>
  <span class="tog active" id="togQatar">Qatar mode</span>
  <span class="tog active" id="togScaf">Scaffolds</span>
  <span class="tog" id="togAuto">Auto‑level</span>
  <span class="inlineNote" title="Reproducible sets">Seed</span>
  <input type="text" id="seedBox" placeholder="e.g., 7NS-3" aria-label="seed">
  <button class="btnMini" id="seedApply">Apply</button>
  <button class="btnMini" id="btnWS">Worksheet</button>
</div>

<!-- Glossary popover -->
<div id="pop" role="dialog" aria-modal="true" aria-live="polite" style="display:none; position:fixed; inset:auto auto 20px 20px; max-width:min(560px,90vw); background:#fff;border:2px solid var(--gold);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.25);padding:14px 16px;z-index:40;text-align:left">
  <span class="close" title="Close" style="float:right;color:#666;cursor:pointer;font-weight:800">✕</span>
  <div id="popBody"></div>
</div>

<!-- Worksheet Modal -->
<div id="wsModal">
  <div id="wsPanel" role="dialog" aria-modal="true">
    <div id="wsClose" title="Close">✕</div>
    <h3>Worksheet Builder</h3>
    <label>Activity</label>
    <select id="wsType">
      <option value="pc">Prime vs Composite</option>
      <option value="factors">List All Factors</option>
      <option value="pfe">Prime Factorization (exponents)</option>
      <option value="gcflcm">GCF & LCM</option>
      <option value="lcd">LCD & equivalents</option>
      <option value="mixed">Mixed Review</option>
    </select>
    <label>Difficulty</label>
    <select id="wsLevel"><option>easy</option><option>med</option><option>hard</option></select>
    <label>Count</label>
    <input id="wsCount" type="number" min="4" max="24" value="10"/>
    <label><input id="wsAns" type="checkbox" checked> Include answer key</label>
    <div class="actions">
      <button class="btnMini" id="wsGo">Generate</button>
    </div>
  </div>
</div>

<script>
/* ---------- Core shell, helpers, and all activities (v2) ---------- */
document.addEventListener('DOMContentLoaded', () => {

  /* ---------- KaTeX auto-render ---------- */
  const runKaTeX = (root = document.body) => {
    if (!window.renderMathInElement) return;
    window.renderMathInElement(root, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '\\(', right: '\\)', display: false }
      ],
      throwOnError: false
    });
  };
  if (window.renderMathInElement) runKaTeX();
  else {
    const t = setInterval(() => { if (window.renderMathInElement) { clearInterval(t); runKaTeX(); } }, 25);
    setTimeout(() => clearInterval(t), 6000);
  }
  window._rerenderMath = runKaTeX;

  /* ---------- Slides navigation ---------- */
  const slides=[...document.querySelectorAll('.slide')];
  const prev=byId('prev'), next=byId('next'), counter=byId('counter'), progress=byId('progress'), fsBtn=byId('fs');
  let i=0;
  function show(k){
    i=(k+slides.length)%slides.length;
    slides.forEach((s,idx)=>s.classList.toggle('active',idx===i));
    counter.textContent=(i+1)+' / '+slides.length;
    progress.style.width=((i+1)/slides.length*100)+'%';
    if(slides[i].id==='treeSlide') drawTree();
    runKaTeX(slides[i]);
  }
  prev.addEventListener('click',()=>show(i-1));
  next.addEventListener('click',()=>show(i+1));
  document.addEventListener('keydown',e=>{
    if(e.key==='ArrowRight') show(i+1);
    if(e.key==='ArrowLeft') show(i-1);
    if(e.key.toLowerCase()==='f') toggleFS();
  });
  function toggleFS(){
    const el=byId('slides');
    if(!document.fullscreenElement){(el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el);}
    else{(document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen).call(el);}
  }
  fsBtn.addEventListener('click',toggleFS);

  /* Part Navigator */
  const partStarts=['p1IntroSlide','p2IntroSlide','p3IntroSlide','p4IntroSlide'];
  function goPart(idx){
    const targetId=partStarts[idx]; const node=document.getElementById(targetId);
    if(!node) return; const pos=slides.findIndex(s=>s.id===targetId); if(pos>=0) show(pos);
  }
  byId('navP1').addEventListener('click',()=>goPart(0));
  byId('navP2').addEventListener('click',()=>goPart(1));
  byId('navP3').addEventListener('click',()=>goPart(2));
  byId('navP4').addEventListener('click',()=>goPart(3));

  /* ---------- Helpers ---------- */
  function byId(x){return document.getElementById(x)}
  function msg(el,s){ if(el) el.textContent=s }
  function downloadJSON(filename, data){
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function downloadCSV(filename, rows){
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function confetti(x=window.innerWidth/2,y=window.innerHeight/2){
    for(let k=0;k<18;k++){
      const d=document.createElement('div'); d.className='confetti';
      d.style.left=x+'px'; d.style.top=y+'px'; d.style.width='8px'; d.style.height='8px';
      d.style.background=['#6C1D45','#C7A34F','#E8D5B7','#8a3d64'][k%4];
      document.body.appendChild(d);
      const dx=(Math.random()*2-1)*240, dy=(Math.random()*-1-0.3)*300, rot=Math.random()*720;
      d.animate([{transform:'translate(0,0) rotate(0deg)'},{transform:`translate(${dx}px,${dy}px) rotate(${rot}deg)`,opacity:0}],
                {duration:900+Math.random()*700,easing:'cubic-bezier(.2,.8,.2,1)'}).onfinish=()=>d.remove();
    }
  }
  function toast(msg){
    const d=document.createElement('div');
    d.style.position='fixed'; d.style.bottom='18px'; d.style.left='50%'; d.style.transform='translateX(-50%)';
    d.style.background='#111827'; d.style.color='#fff'; d.style.padding='.4rem .7rem'; d.style.borderRadius='10px';
    d.style.boxShadow='0 8px 20px rgba(0,0,0,.35)'; d.style.zIndex='70'; d.textContent=msg;
    document.body.appendChild(d); setTimeout(()=>{ d.style.opacity='0'; d.style.transition='opacity .5s'; setTimeout(()=>d.remove(),500); }, 1200);
  }

  /* ---------- Math utilities ---------- */
  function isPrime(n){ n=Math.floor(n); if(n<2) return false; if(n%2===0) return n===2; for(let p=3;p*p<=n;p+=2) if(n%p===0) return false; return true; }
  function primesUpTo(N){ const arr=[]; for(let x=2;x<=N;x++) if(isPrime(x)) arr.push(x); return arr; }
  function factors(n){ n=Math.abs(Math.floor(n)); const list=[]; for(let d=1; d*d<=n; d++) if(n%d===0){ list.push(d); if(d*d!==n) list.push(n/d); } return list.sort((a,b)=>a-b); }
  function multiples(n, limit=100){ const L=[]; for(let k=1;k*n<=limit;k++) L.push(k*n); return L; }
  const gcd=(a,b)=>{a=Math.abs(a);b=Math.abs(b);while(b){[a,b]=[b,a%b]}return a||1};
  const lcm2=(a,b)=> Math.abs(a*b)/gcd(a,b);
  function gcdArr(arr){ return arr.reduce((g,x)=>gcd(g,x)); }
  function lcmArr(arr){ return arr.reduce((L,x)=>lcm2(L,x)); }
  function primeFactorMap(n){ n=Math.abs(Math.floor(n)); const m=new Map(); let x=n; let p=2; while(p*p<=x){ while(x%p===0){ m.set(p,(m.get(p)||0)+1); x/=p; } p=(p===2)?3:p+2; } if(x>1) m.set(x,(m.get(x)||0)+1); return m; }
  function mapToObj(m){ const o={}; m.forEach((v,k)=>o[k]=v); return o; }
  function fmtExp(obj){ const keys=Object.keys(obj).filter(k=>obj[k]>0).map(Number).sort((a,b)=>a-b);
    if(keys.length===0) return '1';
    return keys.map(p=>` ${p}^{${obj[p]}}`).join('\\cdot');
  }
  function gcfLCMByPrimes(arr){
    const maps=arr.map(primeFactorMap);
    const primes=[...new Set(maps.flatMap(m=>[...m.keys()]))].sort((x,y)=>x-y);
    const g={}, l={};
    primes.forEach(p=>{
      const exps=maps.map(m=>m.get(p)||0);
      g[p]=Math.min(...exps); l[p]=Math.max(...exps);
    });
    const pow=(obj)=>Object.keys(obj).reduce((acc,p)=>acc*Math.pow(+p,obj[p]),1);
    return {gExp:g, lExp:l, gVal:pow(g), lVal:pow(l)};
  }
  function divCount(n){ const m=primeFactorMap(n); let t=1; m.forEach(e=>t*=(e+1)); return t; }
  function v_p(n,p){ let e=0; while(n%p===0){e++; n/=p} return e; }
  function largestSquareSide(n){ const m=primeFactorMap(n); let side=1; m.forEach((e,p)=>{ side*=Math.pow(p, Math.floor(e/2)); }); return side; }

  /* ---------- Seeded RNG ---------- */
  const origRandom = Math.random;
  function cyrb128(str){ let h1=1779033703,h2=3144134277,h3=1013904242,h4=2773480762; for(let i=0;i<str.length;i++){ let k=str.charCodeAt(i); h1=h2^Math.imul(h1^k,597399067); h2=h3^Math.imul(h2^k,2869860233); h3=h4^Math.imul(h3^k,951274213); h4=h1^Math.imul(h4^k,2716044179) } h1=Math.imul(h3^(h1>>>18),597399067); h2=Math.imul(h4^(h2>>>22),2869860233); h3=Math.imul(h1^(h3>>>17),951274213); h4=Math.imul(h2^(h4>>>19),2716044179); return [(h1^h2^h3^h4)>>>0,(h2^h1)>>>0,(h3^h1)>>>0,(h4^h1)>>>0]}
  function mulberry32(a){ return function(){ a|=0; a=a+0x6D2B79F5|0; var t=Math.imul(a^a>>>15,1|a); t=t+Math.imul(t^t>>>7,61|t)^t; return ((t^t>>>14)>>>0)/4294967296 } }
  let seeded=null;
  function setGlobalSeed(s){
    if(!s){ Math.random = origRandom; seeded=null; return; }
    const st = cyrb128(String(s)); seeded = mulberry32(st[0]); Math.random = ()=>seeded();
  }
  function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function choice(A){ return A[Math.floor(Math.random()*A.length)] }

  /* ---------- Glossary ---------- */
  const POP=byId('pop'), POP_BODY=byId('popBody');
  const GLOS={
    factor:'<strong>Factor</strong>: a whole number that divides another exactly.',
    multiple:'<strong>Multiple</strong>: product of a number with an integer (e.g., multiples of 6: 6,12,18,...).',
    prime:'<strong>Prime</strong>: integer ≥2 with exactly two positive factors: 1 and itself.',
    composite:'<strong>Composite</strong>: integer ≥2 with more than two positive factors.',
    pfe:'<strong>Prime factorization</strong>: writing a number as a product of primes using exponents.',
    exp:'<strong>Exponent</strong>: repeated multiplication, e.g., \\(2^3=2\\cdot2\\cdot2\\).',
    hcf:'<strong>HCF/GCF</strong>: greatest common factor among given numbers.',
    lcm:'<strong>LCM</strong>: least common multiple common to given numbers.',
    divrule:'<strong>Divisibility</strong>: shortcuts to test 2,3,5,7 without long division.',
    prtest:'<strong>Prime test</strong>: try dividing by primes up to \\(\\sqrt{n}\\).',
    tree:'<strong>Factor tree</strong>: split a composite into factors until leaves are prime.',
    table:'<strong>Division table</strong>: repeatedly divide by small primes until 1 remains.',
    fta:'<strong>FTA</strong>: every integer \\(\\ge2\\) has a unique prime factorization (up to order).',
    euclid:'<strong>Euclidean algorithm</strong>: remainder steps to get the GCF.',
    lcd:'<strong>LCD</strong>: least common denominator (LCM of denominators).',
    simp:'<strong>Simplify</strong>: divide numerator & denominator by the fraction’s GCF.',
    err:'<strong>Error analysis</strong>: identify and correct the mistake.',
    strategy:'<strong>Strategy</strong>: pick a method that fits the size & structure of numbers.'
  };
  function showPop(html, anchor){
    POP_BODY.innerHTML=html; POP.style.display='block';
    const r=anchor?anchor.getBoundingClientRect():{left:20,top:window.innerHeight-120};
    POP.style.left=Math.min(r.left, window.innerWidth-POP.offsetWidth-20)+'px';
    POP.style.bottom=(window.innerHeight - r.top + 10)+'px';
  }
  POP.querySelector('.close').addEventListener('click',()=>POP.style.display='none');
  document.addEventListener('click',e=>{
    const el=e.target.closest('.chip[data-key]'); if(el){const key=el.dataset.key; if(GLOS[key]) showPop(GLOS[key], el);}
  });

  /* ---------- Global Toolbar ---------- */
  const STATE = { teacher:false, qatar:true, scaffold:true, autolvl:false, streak:0 };
  function setTog(el, on){ el.classList.toggle('active', !!on) }
  setTog(byId('togStudent'), !STATE.teacher);
  setTog(byId('togTeacher'), STATE.teacher);
  setTog(byId('togQatar'), STATE.qatar);
  setTog(byId('togScaf'), STATE.scaffold);
  setTog(byId('togAuto'), STATE.autolvl);

  byId('togStudent').onclick = ()=>{ STATE.teacher=false; setTog(byId('togStudent'),true); setTog(byId('togTeacher'),false); refreshVisibility(); };
  byId('togTeacher').onclick = ()=>{ STATE.teacher=true; setTog(byId('togTeacher'),true); setTog(byId('togStudent'),false); refreshVisibility(); };
  byId('togQatar').onclick = ()=>{ STATE.qatar=!STATE.qatar; setTog(byId('togQatar'), STATE.qatar); refreshVisibility(); };
  byId('togScaf').onclick = ()=>{ STATE.scaffold=!STATE.scaffold; setTog(byId('togScaf'), STATE.scaffold); document.querySelectorAll('.clarify').forEach(el=>el.style.display=STATE.scaffold?'block':'none'); };
  byId('togAuto').onclick = ()=>{ STATE.autolvl=!STATE.autolvl; setTog(byId('togAuto'), STATE.autolvl); };

  byId('seedApply').onclick = ()=>{
    const s = byId('seedBox').value.trim();
    setGlobalSeed(s || null);
    toast(`Seed ${s?('set to "'+s+'"'):'cleared'}. Regenerate any set to use it.`);
  };

  function refreshVisibility(){
    document.querySelectorAll('[data-key="sc-ans"]').forEach(el=>{ el.style.display = STATE.teacher? 'block':'none'; });
    document.querySelectorAll('.qatCard').forEach(el=>{ el.style.display = STATE.qatar? 'block':'none'; });
  }
  refreshVisibility();

  /* ---------- Divisibility Try-it ---------- */
  byId('divCheck').addEventListener('click',()=>{
    const s=byId('divTry').value.trim(); const n=Number(s);
    if(!s || !Number.isFinite(n)){ byId('divFb').textContent='Enter a whole number.'; return; }
    const r2 = (n%2===0),
          r3 = (String(Math.abs(n)).split('').map(Number).reduce((a,b)=>a+b,0)%3===0),
          r5= ([0,5].includes(Math.abs(n)%10)),
          r7= checkDiv7(n);
    byId('divFb').innerHTML = `Divisible by 2: <b>${r2?'Yes':'No'}</b> • 3: <b>${r3?'Yes':'No'}</b> • 5: <b>${r5?'Yes':'No'}</b> • 7: <b>${r7?'Yes':'No'}</b>`;
  });
  function checkDiv7(n){
    let x=Math.abs(n);
    while(x>70){
      const last=x%10; x=Math.floor(x/10)-2*last;
    }
    return [0,7,14,21,28,35,42,49,56,63,70].includes(Math.abs(x));
  }

  /* ---------- Prime grid ≤ 100 ---------- */
  (function renderPrimeGrid(){
    const primes=primesUpTo(100);
    const grid=byId('primeGrid'); grid.innerHTML='';
    primes.forEach(p=>{
      const cell=document.createElement('div');
      cell.className='px-2 py-1 rounded border text-center'; cell.textContent=p;
      grid.appendChild(cell);
    });
  })();

  /* ---------- PC: prime/composite ---------- */
  const pcState={set:[]};
  function pcRange(level){ return level==='easy'?[2,40]: level==='med'?[2,100]:[2,200] }
  function pcNew(){
    const level=byId('pcLevel').value;
    const [a,b]=pcRange(level);
    const nums=new Set();
    while(nums.size<8){ nums.add(rand(a,b)); }
    pcState.set=[...nums].sort((x,y)=>x-y).map(n=>({n,prime:isPrime(n)}));
    const box=byId('pcList'); box.innerHTML='';
    pcState.set.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-3 flex items-center justify-between';
      row.innerHTML=`<div class="text-xl">\$begin:math:text$ ${o.n} \\$end:math:text$</div>
        <div class="flex gap-2">
          <label class="pill"><input type="radio" name="pc_${idx}" value="P" class="mr-1">Prime</label>
          <label class="pill"><input type="radio" name="pc_${idx}" value="C" class="mr-1">Composite</label>
        </div>`;
      box.appendChild(row);
    });
    runKaTeX(byId('pcSlide'));
  }
  function pcCheck(){
    let ok=0;
    pcState.set.forEach((o,idx)=>{
      const sel=[...document.getElementsByName('pc_'+idx)].find(x=>x.checked)?.value||'';
      const want=o.prime?'P':'C';
      const row=byId('pcList').children[idx];
      if(sel===want){ row.style.borderColor='#22c55e'; ok++; } else row.style.borderColor='#ef4444';
    });
    byId('pcFb').textContent= ok===pcState.set.length? '✅ All correct!' : 'Score: '+ok+'/'+pcState.set.length;
    if(ok===pcState.set.length) confetti();
  }
  byId('pcNew').addEventListener('click',pcNew); pcNew();
  byId('pcCheck').addEventListener('click',pcCheck);
  byId('pcExportCSV').addEventListener('click',()=>{
    const rows=[['number','isPrime','userChoice']];
    pcState.set.forEach((o,idx)=>{
      const sel=[...document.getElementsByName('pc_'+idx)].find(x=>x.checked)?.value||'';
      rows.push([o.n,o.prime?'Prime':'Composite', sel==='P'?'Prime':sel==='C'?'Composite':'']);
    });
    downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_prime_composite.csv`, rows);
  });
  byId('pcExportJSON').addEventListener('click',()=>{
    const data=pcState.set.map((o,idx)=>({number:o.n, isPrime:o.prime, user:[...document.getElementsByName('pc_'+idx)].find(x=>x.checked)?.value||''}));
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_prime_composite.json`, data);
  });
  // classify own number
  const pcOwnBtn = byId('pcOwnBtn'); if(pcOwnBtn){
    pcOwnBtn.addEventListener('click', ()=>{
      const s = byId('pcOwn').value.trim(); const n = Number(s); const fb = byId('pcOwnFb');
      if(!Number.isFinite(n) || n<1) { fb.textContent = 'Enter a positive integer.'; return; }
      fb.textContent = isPrime(n)? 'prime ✅' : (n===1? 'neither (1) ⚠️' : 'composite ✅');
    });
  }

  /* ---------- Worked example: F/M ---------- */
  function fmExampleRun(){
    const n=[12,18,24,30][rand(0,3)];
    const m=[3,4,5,6][rand(0,3)];
    const F=factors(n).join(', ');
    const M=multiples(m,60).join(', ');
    byId('fmExample').innerHTML = `
      <div class="workline">Find all factors of \$begin:math:text$${n}\\$end:math:text$: try divisors up to \$begin:math:text$\\\\sqrt{${n}}\\$end:math:text$. Pairs → <b>${F}</b>.</div>
      <div class="workline">List multiples of \$begin:math:text$${m}\\$end:math:text$ up to 60: <b>${M}</b>.</div>`;
    runKaTeX(byId('fmExplainSlide'));
  }
  byId('fmNextEx').addEventListener('click',fmExampleRun); fmExampleRun();

  /* ---------- Pick F/M ---------- */
  const fmState={FT:0,MT:0,Fset:[],Mset:[]};
  function fmRanges(level){ return level==='easy'? {fMax:30,mBaseMax:10} : level==='med'? {fMax:60,mBaseMax:12} : {fMax:100,mBaseMax:15} }
  function fmNew(){
    const level=byId('fmLevel').value;
    const {fMax,mBaseMax}=fmRanges(level);
    const FT=rand(10,fMax), MT=rand(2,Math.min(mBaseMax,12));
    const Fcorrect=factors(FT);
    const Fchoices=new Set(Fcorrect);
    while(Fchoices.size<12){ Fchoices.add(rand(2,Math.min(fMax,48))); }
    const Mcorrect=multiples(MT,100);
    const Mchoices=new Set(Mcorrect);
    while(Mchoices.size<12){ const x=rand(2,100); if(!Mcorrect.includes(x)) Mchoices.add(x); else if(Math.random()<0.4) Mchoices.add(x+1); }
    fmState.FT=FT; fmState.MT=MT; fmState.Fset=[...Fchoices].sort((a,b)=>a-b); fmState.Mset=[...Mchoices].sort((a,b)=>a-b);
    byId('fTarget').innerHTML=`Pick all factors of \$begin:math:text$ ${FT} \\$end:math:text$.`; byId('mTarget').innerHTML=`Pick all multiples of \$begin:math:text$ ${MT} \\$end:math:text$ under 100.`;
    const Fbox=byId('fChoices'); Fbox.innerHTML=''; fmState.Fset.forEach(v=>{
      const lab=document.createElement('label'); lab.className='pill';
      lab.innerHTML=`<input type="checkbox" value="${v}" class="mr-1">${v}`; Fbox.appendChild(lab);
    });
    const Mbox=byId('mChoices'); Mbox.innerHTML=''; fmState.Mset.forEach(v=>{
      const lab=document.createElement('label'); lab.className='pill';
      lab.innerHTML=`<input type="checkbox" value="${v}" class="mr-1">${v}`; Mbox.appendChild(lab);
    });
    runKaTeX(byId('fmSlide'));
  }
  function fmCheck(){
    const Fsel=[...byId('fChoices').querySelectorAll('input[type="checkbox"]')].filter(x=>x.checked).map(x=>+x.value);
    const Msel=[...byId('mChoices').querySelectorAll('input[type="checkbox"]')].filter(x=>x.checked).map(x=>+x.value);
    const Fwant=new Set(factors(fmState.FT));
    const Mwant=new Set(multiples(fmState.MT,100));
    let goodF=true, goodM=true;
    [...byId('fChoices').children].forEach(l=>{
      const v=+l.querySelector('input').value;
      const ok=Fwant.has(v);
      const chosen=Fsel.includes(v);
      l.style.borderColor = ( (chosen&&ok) || (!chosen&&!ok) )? '#22c55e':'#ef4444';
      if(l.style.borderColor==='#ef4444') goodF=false;
    });
    [...byId('mChoices').children].forEach(l=>{
      const v=+l.querySelector('input').value;
      const ok=Mwant.has(v);
      const chosen=Msel.includes(v);
      l.style.borderColor = ( (chosen&&ok) || (!chosen&&!ok) )? '#22c55e':'#ef4444';
      if(l.style.borderColor==='#ef4444') goodM=false;
    });
    byId('fmFb').textContent = (goodF&&goodM)? '✅ Excellent selections!' : 'Some selections need revision (red).';
    if(goodF&&goodM) confetti();
  }
  byId('fmNew').addEventListener('click',fmNew); fmNew();
  byId('fmCheck').addEventListener('click',fmCheck);
  byId('fmExportCSV').addEventListener('click',()=>{
    const Fsel=[...byId('fChoices').querySelectorAll('input[type="checkbox"]')].filter(x=>x.checked).map(x=>+x.value);
    const Msel=[...byId('mChoices').querySelectorAll('input[type="checkbox"]')].filter(x=>x.checked).map(x=>+x.value);
    const rows=[['task','target','choices','correct','user'],
      ['factors', fmState.FT, fmState.Fset.join(' '), factors(fmState.FT).join(' '), Fsel.join(' ')],
      ['multiples', fmState.MT, fmState.Mset.join(' '), multiples(fmState.MT,100).join(' '), Msel.join(' ')]];
    downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_factors_multiples.csv`, rows);
  });
  byId('fmExportJSON').addEventListener('click',()=>{
    const Fsel=[...byId('fChoices').querySelectorAll('input[type="checkbox"]')].filter(x=>x.checked).map(x=>+x.value);
    const Msel=[...byId('mChoices').querySelectorAll('input[type="checkbox"]')].filter(x=>x.checked).map(x=>+x.value);
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_factors_multiples.json`, {
      factors:{target:fmState.FT, choices:fmState.Fset, correct:factors(fmState.FT), user:Fsel},
      multiples:{target:fmState.MT, choices:fmState.Mset, correct:multiples(fmState.MT,100), user:Msel}
    });
  });

  /* ---------- Part 1 Real ---------- */
  const p1RealState={items:[]};
  function p1Scale(lv,a,b){ return lv==='easy'? rand(Math.floor(a/2), Math.floor(b/2)) : lv==='med'? rand(a,b) : rand(b, b*2); }
  function p1RealNew(){
    const lv=byId('p1RealLevel').value; p1RealState.items=[]; const box=byId('p1RealList'); box.innerHTML='';
    // 1) Packaging
    (function(){
      const boxes=rand(3,10), per=rand(4,12), P=boxes*per;
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Packaging</div>
        <div class="mt-1">You have <b>${P}</b> cupcakes and pack exactly <b>${per}</b> per box. How many boxes?</div>
        <div class="mt-2">Answer: <input class="rin border rounded px-2 py-1 w-28"></div>`;
      box.appendChild(row);
      p1RealState.items.push({ans:P/per});
    })();
    // 2) Multiples (k-th event)
    (function(){
      const M=p1Scale(lv,4,12), k=rand(6,12);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Timing</div>
        <div class="mt-1">A buzzer sounds every <b>${M}</b> minutes. After how many minutes will the <b>${k}</b>th buzz occur?</div>
        <div class="mt-2">Answer: <input class="rin border rounded px-2 py-1 w-28"> min</div>`;
      box.appendChild(row);
      p1RealState.items.push({ans:M*k});
    })();
    // 3) Divisibility by 3 (enter 1 yes / 0 no)
    (function(){
      let N=p1Scale(lv,120,540);
      if(Math.random()<0.5){ const r= N%3; N+= (3-r)%3; } else { const r= N%3; if(r===0) N+=1; }
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Divisibility</div>
        <div class="mt-1">Is <b>${N}</b> divisible by 3? Enter <b>1</b> for yes, <b>0</b> for no.</div>
        <div class="mt-2">Answer: <input class="rin border rounded px-2 py-1 w-28"></div>`;
      box.appendChild(row);
      p1RealState.items.push({ans: (N%3===0)?1:0});
    })();
    // 4) Next prime after A
    (function(){
      let A=p1Scale(lv,20,90);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Security Key</div>
        <div class="mt-1">Find the <b>next prime</b> after <b>${A}</b>.</div>
        <div class="mt-2">Answer: <input class="rin border rounded px-2 py-1 w-28"></div>`;
      box.appendChild(row);
      let x=A+1; while(!isPrime(x)) x++;
      p1RealState.items.push({ans:x});
    })();

    // Qatar connect card
    const q1=byId('qat_p1');
    q1.innerHTML = `<h4>Qatar Connect — Souq Waqif & Doha Metro</h4>
      <div class="q">A vendor packs <b>${choice([6,8,10,12])}</b> dates per gift box; you have <b>${rand(60,180)}</b> dates. How many boxes?  
      Two Metro lines pause every <b>${choice([6,8,10,12])}</b> and <b>${choice([9,12,15])}</b> minutes at Msheireb. When do they pause together for the first time?</div>
      <div data-key="sc-ans" style="display:none; margin-top:.35rem"><b>Model:</b> Boxes = total ÷ per‑box. First together = LCM of the intervals.</div>`;
    refreshVisibility();
  }
  byId('p1RealNew').addEventListener('click',p1RealNew); p1RealNew();
  byId('p1RealCheck').addEventListener('click',()=>{
    let ok=0; [...byId('p1RealList').querySelectorAll('.rin')].forEach((el,idx)=>{
      const got=Number(el.value); const want=p1RealState.items[idx].ans;
      if(Math.abs(got-want)<1e-10){ ok++; el.style.borderColor='#22c55e'} else el.style.borderColor='#ef4444';
    });
    msg(byId('p1RealFb'), ok===p1RealState.items.length? '✅ Excellent!' : 'Score: '+ok+'/'+p1RealState.items.length);
    if(ok===p1RealState.items.length) confetti();
  });
  byId('p1RealExportCSV').addEventListener('click',()=>{
    const rows=[['prompt','answer','user']]; [...byId('p1RealList').children].forEach((row,idx)=>{
      rows.push([row.innerText.replace(/\s+/g,' ').trim(), p1RealState.items[idx].ans, row.querySelector('.rin').value||'']);
    }); downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_P1_real_world.csv`, rows);
  });
  byId('p1RealExportJSON').addEventListener('click',()=>{
    const data=[...byId('p1RealList').children].map((row,idx)=>({prompt:row.innerText.replace(/\s+/g,' ').trim(), answer:p1RealState.items[idx].ans, user:row.querySelector('.rin').value||''}));
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_P1_real_world.json`, data);
  });

  /* ---------- Factor Tree/Table ---------- */
  const treeCanvas=byId('treeCanvas');
  const treeState={ nodes:new Map(), root:null, nextId:1, steps:[] };
  function newNode(val){ const idv=treeState.nextId++; const node={id:idv,val,left:null,right:null}; treeState.nodes.set(idv,node); return idv; }
  function treeBuild(n){
    treeState.nodes.clear(); treeState.steps=[]; treeState.nextId=1;
    const rootId=newNode(Math.max(2,Math.floor(n))); treeState.root=rootId; drawTree(); updateTreeOut(); renderLeaves(); renderTable();
  }
  function currentLeaves(){ return [...treeState.nodes.values()].filter(nd=>!nd.left && !nd.right); }
  function renderLeaves(){
    const box=byId('leafChips'); box.innerHTML='';
    currentLeaves().forEach(nd=>{
      const sp=document.createElement('span'); sp.className='pill'; sp.textContent=`${nd.id}: ${nd.val}`;
      sp.addEventListener('click',()=>{ byId('leafId').value=nd.id; });
      box.appendChild(sp);
    });
  }
  function splitNodeById(idLeaf,a,b){
    const nd=treeState.nodes.get(+idLeaf); a=+a; b=+b;
    if(!nd || nd.left || nd.right){ treeMsg('Choose a current leaf ID.'); return false; }
    if(a*b!==nd.val || a<2 || b<2){ treeMsg('Invalid split: a×b must equal the leaf and both ≥ 2.'); return false; }
    nd.left=newNode(a); nd.right=newNode(b);
    treeState.steps.push(`${nd.val} → ${a}×${b}`);
    drawTree(); updateTreeOut(); renderLeaves(); renderTable(); treeMsg('');
    return true;
  }
  function autoSplit(){
    let changed=true, guards=0;
    while(changed && guards++<300){
      changed=false;
      for(const nd of currentLeaves()){
        if(isPrime(nd.val)) continue;
        let f=2; while(f<=Math.sqrt(nd.val) && nd.val%f!==0) f++;
        if(nd.val%f===0){ splitNodeById(nd.id,f, nd.val/f); changed=true; break; }
      }
    }
    if(currentLeaves().every(nd=>isPrime(nd.val))) confetti();
  }
  function treeMsg(s){ byId('treeFb').textContent=s; }
  function computePositions(){
    const pos=new Map();
    const W=treeCanvas.clientWidth, H=treeCanvas.clientHeight;
    const leafOrder=[];
    (function inorder(idn){
      const nd=treeState.nodes.get(idn);
      if(nd.left) inorder(nd.left);
      if(!nd.left && !nd.right) leafOrder.push(idn);
      if(nd.right) inorder(nd.right);
    })(treeState.root);
    const leafX=new Map();
    const margin=40; const span=W-2*margin; const step=leafOrder.length>1? span/(leafOrder.length-1): 0;
    leafOrder.forEach((lid,idx)=> leafX.set(lid, margin + idx*step));
    function assign(idn,depth){
      const nd=treeState.nodes.get(idn);
      const y = 40 + depth*((H-80)/Math.max(1, getDepth(treeState.root)-1));
      if(!nd.left && !nd.right){
        pos.set(idn,{x:leafX.get(idn), y});
      } else {
        assign(nd.left, depth+1);
        assign(nd.right, depth+1);
        const xl=pos.get(nd.left).x, xr=pos.get(nd.right).x;
        pos.set(idn,{x:(xl+xr)/2, y});
      }
    }
    assign(treeState.root,0);
    return pos;
  }
  function getDepth(idn){
    const nd=treeState.nodes.get(idn);
    if(!nd.left && !nd.right) return 1;
    return 1+Math.max(getDepth(nd.left), getDepth(nd.right));
  }
  function drawTree(){
    const ctx=treeCanvas.getContext('2d');
    treeCanvas.width=treeCanvas.clientWidth*devicePixelRatio;
    treeCanvas.height=treeCanvas.clientHeight*devicePixelRatio;
    ctx.scale(devicePixelRatio,devicePixelRatio);
    const W=treeCanvas.clientWidth, H=treeCanvas.clientHeight;
    ctx.clearRect(0,0,W,H);
    const pos=computePositions();
    ctx.strokeStyle='#6C1D45'; ctx.lineWidth=2;
    treeState.nodes.forEach(nd=>{
      if(nd.left){ const a=pos.get(nd.id), b=pos.get(nd.left); ctx.beginPath(); ctx.moveTo(a.x,a.y+12); ctx.lineTo(b.x,b.y-12); ctx.stroke(); }
      if(nd.right){ const a=pos.get(nd.id), b=pos.get(nd.right); ctx.beginPath(); ctx.moveTo(a.x,a.y+12); ctx.lineTo(b.x,b.y-12); ctx.stroke(); }
    });
    treeState.nodes.forEach(nd=>{
      const {x,y}=pos.get(nd.id);
      const isLeaf=!nd.left && !nd.right, primeLeaf=isLeaf && isPrime(nd.val);
      ctx.fillStyle=isLeaf? (primeLeaf?'#C7A34F':'#E8D5B7'):'#fff';
      ctx.strokeStyle=isLeaf? (primeLeaf?'#C7A34F':'#999'):'#6C1D45';
      const w=46,h=26; ctx.beginPath(); roundRect(ctx,x-w/2,y-h/2,w,h,6); ctx.fill(); ctx.stroke();
      ctx.fillStyle='#2C2C2E'; ctx.font='13px Inter'; const text=`${nd.val}`; const tw=ctx.measureText(text).width;
      ctx.fillText(text, x-tw/2, y+5);
      ctx.fillStyle='#666'; ctx.font='10px Inter'; const idt=`#${nd.id}`; const tw2=ctx.measureText(idt).width;
      ctx.fillText(idt, x-tw2/2, y-10);
    });
  }
  function roundRect(ctx,x,y,w,h,r){ ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); }
  function updateTreeOut(){
    const leaves=currentLeaves();
    const allPrime=leaves.every(nd=>isPrime(nd.val));
    const prod = leaves.reduce((a,nd)=>a*nd.val,1);
    const exp = mapToObj(primeFactorMap(prod));
    byId('treeOut').innerHTML = allPrime? `\$begin:math:text$ ${fmtExp(exp)} \\$end:math:text$` : '(in progress)';
    runKaTeX(byId('treeSlide'));
  }
  function renderTable(){
    const rows=byId('tableRows'); rows.innerHTML='';
    treeState.steps.forEach((s,idx)=>{
      const div=document.createElement('div'); div.className='workline'; div.innerHTML=`${idx+1}) \$begin:math:text$ ${s} \\$end:math:text$`; rows.appendChild(div);
    });
    runKaTeX(byId('treeSlide'));
  }
  byId('treeSplit').addEventListener('click',()=>{ splitNodeById(byId('leafId').value, byId('splitA').value, byId('splitB').value); });
  byId('treeAuto').addEventListener('click',autoSplit);
  byId('treeReset').addEventListener('click',()=>treeBuild(Number(byId('treeN').value||180)));
  byId('treeNewNum').addEventListener('click',()=>{
    const lv=byId('treeLevel').value;
    const n = (lv==='easy')? rand(60,200) : (lv==='med'? rand(120,600) : rand(200,2000));
    byId('treeN').value=n; treeBuild(n);
  });
  byId('treeExportCSV').addEventListener('click',()=>{
    const rows=[['root','steps','leaves','final_exp']];
    const leaves=currentLeaves(); const prod=leaves.reduce((a,nd)=>a*nd.val,1); const exp=mapToObj(primeFactorMap(prod));
    rows.push([treeState.nodes.get(treeState.root).val, treeState.steps.join(' | '), leaves.map(nd=>nd.val).join(' '), fmtExp(exp)]);
    downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_factor_tree.csv`, rows);
  });
  byId('treeExportJSON').addEventListener('click',()=>{
    const leaves=currentLeaves(); const prod=leaves.reduce((a,nd)=>a*nd.val,1); const exp=mapToObj(primeFactorMap(prod));
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_factor_tree.json`, {root:treeState.nodes.get(treeState.root).val, steps:treeState.steps, leaves:leaves.map(nd=>({id:nd.id,val:nd.val})), finalExp:exp});
  });
  byId('viewTree').addEventListener('click',()=>{ byId('viewTree').classList.add('active'); byId('viewTable').classList.remove('active'); byId('treeView').classList.remove('hidden'); byId('tableView').classList.add('hidden'); drawTree(); });
  byId('viewTable').addEventListener('click',()=>{ byId('viewTable').classList.add('active'); byId('viewTree').classList.remove('active'); byId('tableView').classList.remove('hidden'); byId('treeView').classList.add('hidden'); renderTable(); });
  treeBuild(180);

  /* ---------- PF Exponent Form ---------- */
  const pfState={set:[], primes:[]};
  function pfPrimeList(level){ return level==='easy'?[2,3,5,7,11,13] : level==='med'?[2,3,5,7,11,13,17] : [2,3,5,7,11,13,17,19] }
  function pfRange(level){ return level==='easy'?[40,200] : level==='med'?[80,600] : [120,2000] }
  function pfBuildN(exps){ return pfState.primes.reduce((acc,p)=>acc*Math.pow(p,exps[p]||0),1) }
  function pfNew(){
    const level=byId('pfLevel').value;
    pfState.primes=pfPrimeList(level);
    const [lo,hi]=pfRange(level);
    const list=[];
    while(list.length<4){
      const exps={}; pfState.primes.forEach(p=>{
        let e=0;
        if(p<=5) e=rand(0,2); else if(p<=11) e=(Math.random()<0.75?0:1); else e=(Math.random()<0.85?0:1);
        exps[p]=e;
      });
      if(Object.values(exps).every(e=>e===0)) exps[2]=1;
      const n=pfBuildN(exps);
      if(n>=lo && n<=hi) list.push({n,exps});
    }
    pfState.set=list;
    const box=byId('pfList'); box.innerHTML='';
    pfState.set.forEach((o,idx)=>{
      const primesRow=pfState.primes.map(p=>`<label class="chip">${p}: <input class="pfexp border rounded px-2 py-1 w-16" id="pf_${idx}_${p}" placeholder="exp" aria-label="exp ${p}"></label>`).join('');
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-xl mb-1">\\( ${o.n} = ${pfState.primes.map(p=>`${p}^{\\square}`).join('\\cdot ')} \\)</div>
        <div class="flex flex-wrap gap-2 text-sm">${primesRow}</div>`;
      box.appendChild(row);
    });
    runKaTeX(byId('pfSlide'));
  }
  function pfCheck(){
    let total=0,ok=0;
    pfState.set.forEach((o,idx)=>{
      total++; let good=true;
      pfState.primes.forEach(p=>{
        const inp=byId(`pf_${idx}_${p}`); const g=Number(inp.value||0); const want=o.exps[p]||0;
        if(g===want){ inp.style.borderColor='#22c55e'; } else { inp.style.borderColor='#ef4444'; good=false; }
      });
      if(good) ok++;
    });
    byId('pfFb').textContent= ok===total ? '✅ All correct!' : 'Score: '+ok+'/'+total; if(ok===total) confetti();
  }
  byId('pfNew').addEventListener('click',pfNew); byId('pfCheck').addEventListener('click',pfCheck); pfNew();
  byId('pfExportCSV').addEventListener('click',()=>{
    const rows=[['n',...pfState.primes.map(p=>`exp_${p}`), ...pfState.primes.map(p=>`user_${p}`)]];
    pfState.set.forEach((o,idx)=>{
      const want=pfState.primes.map(p=>o.exps[p]||0);
      const got=pfState.primes.map(p=>Number((byId(`pf_${idx}_${p}`).value||0)));
      rows.push([o.n, ...want, ...got]);
    });
    downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_prime_factorization.csv`, rows);
  });
  byId('pfExportJSON').addEventListener('click',()=>{
    const data=pfState.set.map((o,idx)=>({n:o.n, want:o.exps, got:Object.fromEntries(pfState.primes.map(p=>[p,Number((byId(`pf_${idx}_${p}`).value||0))]))}));
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_prime_factorization.json`, data);
  });

  // Qatar card P2
  const q2 = byId('qat_p2');
  q2.innerHTML = `<h4>Qatar Connect — Flag Mosaic</h4>
      <div class="q">Design a square maroon‑and‑white mosaic of <b>${choice([180,198,220,252,300,396])}</b> tiles² without cutting tiles. What’s the <b>largest</b> possible square side length?</div>
      <div data-key="sc-ans" style="display:none; margin-top:.35rem"><b>Model:</b> Side length = product of primes to \$begin:math:text$\\\\lfloor e/2\\\\rfloor\\$end:math:text$ in the factorization (largest square factor).</div>`;
  refreshVisibility();

  /* ---------- Part 2 Real ---------- */
  const p2RealState={items:[]};
  function p2PickN(lv){ return lv==='easy'? rand(60,180) : lv==='med'? rand(150,600) : rand(300,1800) }
  function p2RealNew(){
    const lv=byId('p2RealLevel').value; p2RealState.items=[]; const box=byId('p2RealList'); box.innerHTML='';
    // 1) Divisor count
    (function(){
      const N=p2PickN(lv);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Layouts</div>
        <div class="mt-1">A banner has area <b>${N}</b> units². How many <b>positive factors</b> does ${N} have?</div>
        <div class="mt-2">Answer: <input class="rin border rounded px-2 py-1 w-28"></div>`;
      box.appendChild(row); p2RealState.items.push({ans:divCount(N)});
    })();
    // 2) Highest power of 2
    (function(){
      let N=p2PickN(lv);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Halving Stacks</div>
        <div class="mt-1">You can split <b>${N}</b> items into two equal stacks repeatedly until odd. How many times can you halve?</div>
        <div class="mt-2">Answer: <input class="rin border rounded px-2 py-1 w-28"></div>`;
      box.appendChild(row); p2RealState.items.push({ans:v_p(N,2)});
    })();
    // 3) Largest square tile side
    (function(){
      const N=p2PickN(lv);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Square Tiles</div>
        <div class="mt-1">A square art panel of side <i>s</i> tiles must cover area <b>${N}</b> tiles² without cutting. What is the <b>largest</b> possible <i>s</i>?</div>
        <div class="mt-2">Answer: <input class="rin border rounded px-2 py-1 w-28"> tiles</div>`;
      box.appendChild(row); p2RealState.items.push({ans:largestSquareSide(N)});
    })();
  }
  byId('p2RealNew').addEventListener('click',p2RealNew); p2RealNew();
  byId('p2RealCheck').addEventListener('click',()=>{
    let ok=0; [...byId('p2RealList').querySelectorAll('.rin')].forEach((el,idx)=>{
      const got=Number(el.value); const want=p2RealState.items[idx].ans;
      if(Math.abs(got-want)<1e-10){ ok++; el.style.borderColor='#22c55e'} else el.style.borderColor='#ef4444';
    });
    msg(byId('p2RealFb'), ok===p2RealState.items.length? '✅ Good use of exponents!' : 'Score: '+ok+'/'+p2RealState.items.length);
    if(ok===p2RealState.items.length) confetti();
  });
  byId('p2RealExportCSV').addEventListener('click',()=>{
    const rows=[['prompt','answer','user']]; [...byId('p2RealList').children].forEach((row,idx)=>{
      rows.push([row.innerText.replace(/\s+/g,' ').trim(), p2RealState.items[idx].ans, row.querySelector('.rin').value||'']);
    }); downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_P2_real_world.csv`, rows);
  });
  byId('p2RealExportJSON').addEventListener('click',()=>{
    const data=[...byId('p2RealList').children].map((row,idx)=>({prompt:row.innerText.replace(/\s+/g,' ').trim(), answer:p2RealState.items[idx].ans, user:row.querySelector('.rin').value||''}));
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_P2_real_world.json`, data);
  });

  /* ---------- Worked Examples GCF/LCM ---------- */
  function listGCLExample(){
    const a=rand(12,40), b=rand(12,40);
    const La=multiples(a,200), Lb=multiples(b,200);
    const LCM= La.find(x=>Lb.includes(x));
    const GCF=gcd(a,b);
    byId('gclListEx').innerHTML = `
      <div class="workline">Multiples of \$begin:math:text$${a}\\$end:math:text$: ${La.slice(0,10).join(', ')} ...</div>
      <div class="workline">Multiples of \$begin:math:text$${b}\\$end:math:text$: ${Lb.slice(0,10).join(', ')} ...</div>
      <div class="workline"><b>LCM</b> = first common multiple = <b>${LCM}</b>; <b>GCF</b> (by factors) = <b>${GCF}</b>.</div>`;
    runKaTeX(byId('gclExplainSlide'));
  }
  function primeGCLExample(){
    const a=rand(20,60), b=rand(30,80);
    const A=mapToObj(primeFactorMap(a)), B=mapToObj(primeFactorMap(b));
    const {gExp,lExp,gVal,lVal}=gcfLCMByPrimes([a,b]);
    byId('gclPrimeEx').innerHTML = `
      <div class="workline">\$begin:math:text$ ${a} = ${fmtExp(A)} \\$end:math:text$, \$begin:math:text$ ${b} = ${fmtExp(B)} \\$end:math:text$</div>
      <div class="workline">\$begin:math:text$ \\\\mathrm{GCF} = ${fmtExp(gExp)} = ${gVal} \\$end:math:text$; \$begin:math:text$ \\\\mathrm{LCM} = ${fmtExp(lExp)} = ${lVal} \\$end:math:text$</div>`;
    runKaTeX(byId('gclExplainSlide'));
  }
  byId('gclListNext').addEventListener('click',listGCLExample); listGCLExample();
  byId('gclPrimeNext').addEventListener('click',primeGCLExample); primeGCLExample();

  /* ---------- GCF/LCM Explorer ---------- */
  const modePills={list:byId('mList'), prime:byId('mPrime'), euclid:byId('mEuclid')};
  Object.values(modePills).forEach(p=>p.addEventListener('click',()=>{ Object.values(modePills).forEach(x=>x.classList.remove('active')); p.classList.add('active'); updateMethodTitle(); }));
  function updateMethodTitle(){
    const t = modePills.list.classList.contains('active')? 'Listing Trace' :
              modePills.prime.classList.contains('active')? 'Prime Exponents Trace' : 'Euclidean Algorithm Trace';
    byId('methodTitle').textContent=t;
  }
  function gRand(){
    const lv=byId('gclLevel').value;
    byId('gA').value = (lv==='easy')? rand(6,40) : (lv==='med'? rand(10,120) : rand(10,200));
    byId('gB').value = (lv==='easy')? rand(6,40) : (lv==='med'? rand(10,120) : rand(10,200));
    byId('gC').value = (lv==='hard')? rand(10,200) : '';
  }
  byId('gRand').addEventListener('click',()=>{ gRand(); gRun(); }); gRand();
  function gRun(){
    const a=+byId('gA').value||0, b=+byId('gB').value||0, c=+byId('gC').value||0;
    const arr=[a,b, ...(c? [c]: [])].filter(x=>x>0);
    if(arr.length<2){ byId('gMethodOut').innerHTML='Enter at least two positive integers.'; byId('gGCF').textContent='—'; byId('gLCM').textContent='—'; return; }
    const mode = modePills.list.classList.contains('active')? 'list' : modePills.prime.classList.contains('active')? 'prime' : 'euclid';
    if(mode==='list'){
      const Ls = arr.map(n=>multiples(n,400));
      let common=Ls[0].filter(x=>Ls.slice(1).every(L=>L.includes(x)))[0];
      if(!common) common = lcmArr(arr);
      const g = gcdArr(arr);
      byId('gMethodOut').innerHTML = Ls.map((L,idx)=>`<div class="workline">Multiples of \$begin:math:text$${arr[idx]}\\$end:math:text$: ${L.slice(0,12).join(', ')} ...</div>`).join('')
        + `<div class="workline"><b>LCM</b> = first common multiple ≈ <b>${common}</b></div>`
        + `<div class="workline"><b>GCF</b> (by factors) = <b>${g}</b></div>`;
      byId('gGCF').textContent=g; byId('gLCM').textContent=common;
    } else if(mode==='prime'){
      const {gExp,lExp,gVal,lVal}=gcfLCMByPrimes(arr);
      const factLines = arr.map(n=>`<div class="workline">\$begin:math:text$ ${n} = ${fmtExp(mapToObj(primeFactorMap(n)))} \\$end:math:text$</div>`).join('');
      byId('gMethodOut').innerHTML = factLines + `<div class="workline">\$begin:math:text$ \\\\mathrm{GCF} = ${fmtExp(gExp)} = ${gVal} \\$end:math:text$; \$begin:math:text$ \\\\mathrm{LCM} = ${fmtExp(lExp)} = ${lVal} \\$end:math:text$</div>`;
      byId('gGCF').textContent=gVal; byId('gLCM').textContent=lVal;
    } else {
      let trace='';
      function euclid(a,b){
        a=Math.abs(a); b=Math.abs(b); const steps=[];
        while(b){ steps.push(`${a} = ${b}\\cdot ${Math.floor(a/b)} + ${a%b}`); [a,b]=[b,a%b]; }
        return {g:a, trace:steps};
      }
      let g=arr[0]; let EuLines=[];
      for(let k=1;k<arr.length;k++){
        const res=euclid(g,arr[k]); g=res.g; EuLines.push(...res.trace);
      }
      const L=lcmArr(arr);
      trace = EuLines.map((t,idx)=>`<div class="workline">${idx+1}) \$begin:math:text$ ${t} \\$end:math:text$</div>`).join('');
      byId('gMethodOut').innerHTML=trace;
      byId('gGCF').textContent=g; byId('gLCM').textContent=L;
    }
    runKaTeX(byId('gclSlide'));
  }
  byId('gRun').addEventListener('click',gRun); gRun();

  byId('gExportCSV').addEventListener('click',()=>{
    downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_gcf_lcm_explorer.csv`, [['a','b','c','GCF','LCM'], [byId('gA').value,byId('gB').value,byId('gC').value||'', byId('gGCF').textContent, byId('gLCM').textContent]]);
  });
  byId('gExportJSON').addEventListener('click',()=>{
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_gcf_lcm_explorer.json`, {a:byId('gA').value,b:byId('gB').value,c:byId('gC').value||null,gcf:byId('gGCF').textContent,lcm:byId('gLCM').textContent});
  });

  // Qatar card Part 3
  const q3 = byId('qat_p3');
  q3.innerHTML = `<h4>Qatar Connect — Education City Shuttles</h4>
      <div class="q">EC “A” loop bus arrives every <b>${choice([6,8,9,10,12])}</b> min; “B” loop every <b>${choice([12,14,15,18])}</b> min. When together again?  
      You’re placing equal‑size QR code stickers on two columns of \$begin:math:text$A\\$end:math:text$ and \$begin:math:text$B\\$end:math:text$ pillars—what’s the <b>largest</b> sticker height in cm so both columns divide evenly?</div>
      <div data-key="sc-ans" style="display:none; margin-top:.35rem"><b>Model:</b> Together = LCM; largest equal unit for both = GCF.</div>`;
  refreshVisibility();

  /* ---------- Practice GCF/LCM ---------- */
  const glState={items:[]};
  function glNew(){
    const lv=byId('glLevel').value;
    const box=byId('glList'); box.innerHTML=''; glState.items=[];
    for(let k=0;k<4;k++){
      const isHard = (lv==='hard' && Math.random()<0.5);
      const a = (lv==='easy')? rand(6,40) : (lv==='med'? rand(8,120) : rand(10,200));
      const b = (lv==='easy')? rand(6,40) : (lv==='med'? rand(8,120) : rand(10,200));
      const c = isHard? rand(10,200) : null;
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${k+1}</div>
        <div class="text-xl mt-1">\$begin:math:text$ a=${a},\\\\; b=${b} ${c? ',\\\\; c='+c:''} \\$end:math:text$</div>
        <div class="mt-2">GCF = <input class="gcin border rounded px-2 py-1 w-28" aria-label="GCF input"> &nbsp; LCM = <input class="lcmin border rounded px-2 py-1 w-28" aria-label="LCM input"></div>`;
      box.appendChild(row);
      glState.items.push({a,b,c});
    }
    runKaTeX(byId('glPractice'));
  }
  byId('glNew').addEventListener('click',glNew); glNew();
  byId('glCheck').addEventListener('click',()=>{
    let total=0,ok=0; [...byId('glList').children].forEach((row,idx)=>{
      total++; const {a,b,c}=glState.items[idx];
      const arr=[a,b, ...(c?[c]:[])]; const {gVal,lVal}=gcfLCMByPrimes(arr);
      const gIn=row.querySelector('.gcin'), lIn=row.querySelector('.lcmin'); let good=true;
      if(Number(gIn.value)==gVal){ gIn.style.borderColor='#22c55e'; } else { gIn.style.borderColor='#ef4444'; good=false; }
      if(Number(lIn.value)==lVal){ lIn.style.borderColor='#22c55e'; } else { lIn.style.borderColor='#ef4444'; good=false; }
      if(good) ok++;
    });
    byId('glFb').textContent= ok===total? '✅ All correct!' : 'Score: '+ok+'/'+total; if(ok===total) confetti();
  });
  byId('glExportCSV').addEventListener('click',()=>{
    const rows=[['a','b','c','GCF','LCM','user_GCF','user_LCM']];
    [...byId('glList').children].forEach((row,idx)=>{
      const {a,b,c}=glState.items[idx]; const arr=[a,b, ...(c?[c]:[])]; const {gVal,lVal}=gcfLCMByPrimes(arr);
      rows.push([a,b,c||'',gVal,lVal,row.querySelector('.gcin').value||'', row.querySelector('.lcmin').value||'']);
    });
    downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_gcf_lcm_practice.csv`, rows);
  });
  byId('glExportJSON').addEventListener('click',()=>{
    const data=[...byId('glList').children].map((row,idx)=>{
      const {a,b,c}=glState.items[idx]; const arr=[a,b, ...(c?[c]:[])]; const {gVal,lVal}=gcfLCMByPrimes(arr);
      return {a,b,c, correct:{gcf:gVal,lcm:lVal}, user:{gcf:row.querySelector('.gcin').value||'', lcm:row.querySelector('.lcmin').value||''}};
    });
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_gcf_lcm_practice.json`, data);
  });

  /* ---------- Applications examples ---------- */
  function appSimpEx(){
    const d=[6,8,9,10,12,14][rand(0,5)]; const n=rand(1,3*d-1);
    const g=gcd(n,d), N=n/g, D=d/g;
    byId('appSimpEx').innerHTML = `
      <div class="workline">Simplify \$begin:math:text$\\\\tfrac{${n}}{${d}}\\$end:math:text$. GCF\$begin:math:text$( ${n}, ${d})=${g}\\$end:math:text$.</div>
      <div class="workline">Divide top & bottom by ${g}: \$begin:math:text$\\\\tfrac{${n}}{${d}}=\\\\tfrac{${N}}{${D}}\\$end:math:text$.</div>`;
    runKaTeX(byId('appExplainSlide'));
  }
  function appLCDEx(){
    const d1=[3,4,5,6,8][rand(0,4)], d2=[4,5,6,7,8,10][rand(0,5)];
    const a=rand(1,d1-1), b=rand(1,d2-1); const L=lcm2(d1,d2);
    const A=a*(L/d1), B=b*(L/d2);
    byId('appLCDEx').innerHTML = `
      <div class="workline">Find LCD for \$begin:math:text$\\\\tfrac{${a}}{${d1}}\\$end:math:text$ and \$begin:math:text$\\\\tfrac{${b}}{${d2}}\\$end:math:text$: LCM\$begin:math:text$(${d1},${d2})=${L}\\$end:math:text$.</div>
      <div class="workline">Equivalents: \$begin:math:text$\\\\tfrac{${a}}{${d1}}=\\\\tfrac{${A}}{${L}}\\$end:math:text$, \$begin:math:text$\\\\tfrac{${b}}{${d2}}=\\\\tfrac{${B}}{${L}}\\$end:math:text$.</div>`;
    runKaTeX(byId('appExplainSlide'));
  }
  byId('appSimpNext').addEventListener('click',appSimpEx); appSimpEx();
  byId('appLCDNext').addEventListener('click',appLCDEx); appLCDEx();

  /* ---------- Applications Practice ---------- */
  const appState={items:[]};
  function appNew(){
    const lv=byId('appLevel').value; appState.items=[]; const box=byId('appList'); box.innerHTML='';
    // Simplify (2)
    for(let k=0;k<2;k++){
      const maxD = (lv==='easy')? 12 : (lv==='med'? 20 : 30);
      const d=rand(6,maxD), n=rand(1,3*d-1);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Simplify</div>
        <div class="text-xl mt-1">\$begin:math:text$ \\\\frac{${n}}{${d}} = \\$end:math:text$</div>
        <div class="mt-2">Answer: <input class="sfNum border rounded px-2 py-1 w-24" placeholder="num" aria-label="simp num"> / <input class="sfDen border rounded px-2 py-1 w-24" placeholder="den" aria-label="simp den"></div>`;
      box.appendChild(row); appState.items.push({type:'simplify',n,d});
    }
    // LCD (2)
    for(let k=0;k<2;k++){
      const maxD = (lv==='easy')? 10 : (lv==='med'? 14 : 18);
      const pool=[3,4,5,6,7,8,9,10,12,14,15,16,18].filter(x=>x<=maxD);
      const d1=pool[rand(0,pool.length-1)], d2=pool[rand(0,pool.length-1)];
      const a=rand(1,d1-1), b=rand(1,d2-1); const L=lcm2(d1,d2);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Common Denominator</div>
        <div class="text-xl mt-1">\$begin:math:text$ \\\\frac{${a}}{${d1}} \\\\text{ and } \\\\frac{${b}}{${d2}} \\$end:math:text$</div>
        <div class="mt-2">LCM = <input class="lcd border rounded px-2 py-1 w-24" aria-label="lcd">
          &nbsp; \$begin:math:text$ \\\\frac{${a}}{${d1}}= \\$end:math:text$<input class="eqA border rounded px-2 py-1 w-24" aria-label="eqA">/ <input class="edA border rounded px-2 py-1 w-24" aria-label="edA">,
          \$begin:math:text$ \\\\frac{${b}}{${d2}}= \\$end:math:text$<input class="eqB border rounded px-2 py-1 w-24" aria-label="eqB">/ <input class="edB border rounded px-2 py-1 w-24" aria-label="edB"></div>`;
      box.appendChild(row); appState.items.push({type:'lcd',a,d1,b,d2});
    }
    runKaTeX(byId('appSlide'));
  }
  byId('appNew').addEventListener('click',appNew); appNew();
  byId('appCheck').addEventListener('click',()=>{
    let total=0,ok=0; const cards=[...byId('appList').children];
    cards.forEach((row,idx)=>{
      total++; const it=appState.items[idx]; let good=true;
      if(it.type==='simplify'){
        const g=gcd(it.n,it.d), N=it.n/g, D=it.d/g;
        const n=Number(row.querySelector('.sfNum').value), d=Number(row.querySelector('.sfDen').value);
        if(n===N && d===D){ row.querySelector('.sfNum').style.borderColor='#22c55e'; row.querySelector('.sfDen').style.borderColor='#22c55e'; }
        else { row.querySelector('.sfNum').style.borderColor='#ef4444'; row.querySelector('.sfDen').style.borderColor='#ef4444'; good=false; }
      } else {
        const L=lcm2(it.d1,it.d2); const A=it.a*(L/it.d1), B=it.b*(L/it.d2);
        const lIn=row.querySelector('.lcd'); if(Number(lIn.value)==L){ lIn.style.borderColor='#22c55e'; } else { lIn.style.borderColor='#ef4444'; good=false; }
        const eqA=row.querySelector('.eqA'), edA=row.querySelector('.edA'), eqB=row.querySelector('.eqB'), edB=row.querySelector('.edB');
        if(Number(eqA.value)==A && Number(edA.value)==L){ eqA.style.borderColor=edA.style.borderColor='#22c55e'; } else { eqA.style.borderColor=edA.style.borderColor='#ef4444'; good=false; }
        if(Number(eqB.value)==B && Number(edB.value)==L){ eqB.style.borderColor=edB.style.borderColor='#22c55e'; } else { eqB.style.borderColor=edB.style.borderColor='#ef4444'; good=false; }
      }
      if(good) ok++;
    });
    byId('appFb').textContent= ok===total? '✅ Nice work!' : 'Score: '+ok+'/'+total; if(ok===total) confetti();
  });
  byId('appExportCSV').addEventListener('click',()=>{
    const rows=[['type','prompt','correct','user']];
    [...byId('appList').children].forEach((row,idx)=>{
      const it=appState.items[idx];
      if(it.type==='simplify'){
        const g=gcd(it.n,it.d), N=it.n/g, D=it.d/g;
        rows.push(['simplify', `${it.n}/${it.d}`, `${N}/${D}`, `${row.querySelector('.sfNum').value||''}/${row.querySelector('.sfDen').value||''}`]);
      } else {
        const L=lcm2(it.d1,it.d2); const A=it.a*(L/it.d1), B=it.b*(L/it.d2);
        rows.push(['lcd', `${it.a}/${it.d1} & ${it.b}/${it.d2}`, `LCM=${L}; ${A}/${L}; ${B}/${L}`,
          `LCM=${row.querySelector('.lcd').value||''}; ${row.querySelector('.eqA').value||''}/${row.querySelector('.edA').value||''}; ${row.querySelector('.eqB').value||''}/${row.querySelector('.edB').value||''}`]);
      }
    });
    downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_applications.csv`, rows);
  });
  byId('appExportJSON').addEventListener('click',()=>{
    const data=[...byId('appList').children].map((row,idx)=>{
      const it=appState.items[idx];
      if(it.type==='simplify'){
        const g=gcd(it.n,it.d), N=it.n/g, D=it.d/g;
        return {type:'simplify', prompt:`${it.n}/${it.d}`, correct:{n:N,d:D}, user:{n:row.querySelector('.sfNum').value||'', d:row.querySelector('.sfDen').value||''}};
      } else {
        const L=lcm2(it.d1,it.d2); const A=it.a*(L/it.d1), B=it.b*(L/it.d2);
        return {type:'lcd', prompt:{a:it.a,d1:it.d1,b:it.b,d2:it.d2}, correct:{LCM:L,Aeq:[A,L],Beq:[B,L]},
                user:{LCM:row.querySelector('.lcd').value||'', Aeq:[row.querySelector('.eqA').value||'', row.querySelector('.edA').value||''], Beq:[row.querySelector('.eqB').value||'', row.querySelector('.edB').value||'']}}; }
    });
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_applications.json`, data);
  });

  // Qatar card Part 4
  const q4 = byId('qat_p4');
  q4.innerHTML = `<h4>Qatar Connect — Stadium Snack Boxes</h4>
      <div class="q">You’re simplifying \$begin:math:text$\\\\frac{${rand(24,60)}}{${choice([36,42,48,54,60])}}\\$end:math:text$ for box planning at a match. Reduce it and name the factor you divided by.</div>
      <div data-key="sc-ans" style="display:none; margin-top:.35rem"><b>Model:</b> Divide top & bottom by the GCF of numerator and denominator.</div>`;
  refreshVisibility();

  /* ---------- Challenge ---------- */
  const chState={};
  function chNew(){
    const lv=byId('chLevel').value;
    // Mystery number
    const p = choice([2,3,5,7]); const e = choice(lv==='easy'?[1,2]: lv==='med'?[2,3]:[3,4]);
    const q = choice([11,13,17]); const m = p**e * q;
    byId('mystPrompt').innerHTML = `Find a number between <b>${m}</b> and <b>${m+rand(10,40)}</b> that is <b>divisible by ${p}</b> but <b>not</b> by ${q}.`;
    chState.myst = {p,q};
    // Given GCF & LCM
    const g = choice([6,8,9,12]); const L = g * choice([10,12,15,18]);
    byId('gcPairPrompt').innerHTML = `Create numbers $begin:math:text$a,b$end:math:text$ with \$begin:math:text$\\\\gcf(a,b)=${g}\\$end:math:text$ and \$begin:math:text$\\\\operatorname{lcm}(a,b)=${L}\\$end:math:text$.`;
    chState.gc = {g,L};
    runKaTeX(byId('challengeSlide'));
  }
  byId('chNew').addEventListener('click',chNew); chNew();
  byId('chCheck').addEventListener('click',()=>{
    const ans = Number(byId('mystAns').value||NaN);
    const ok1 = Number.isFinite(ans) && ans%chState.myst.p===0 && ans%chState.myst.q!==0;
    const a=Number(byId('gcA').value||NaN), b=Number(byId('gcB').value||NaN);
    const ok2 = Number.isFinite(a)&&Number.isFinite(b) && gcd(a,b)===chState.gc.g && lcm2(a,b)===chState.gc.L;
    byId('chFb').textContent = (ok1 && ok2)? '✅ Both tasks satisfied!' : (!ok1 && !ok2? '❌ Both need revision.' : (!ok1? 'Mystery number not valid.' : 'GCF/LCM pair not valid.'));
    if(ok1 && ok2) confetti();
  });
  byId('chExportCSV').addEventListener('click',()=>{
    downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_challenge.csv`, [['myst_prompt','gc_prompt','myst_ans','gc_a','gc_b'], [byId('mystPrompt').innerText, byId('gcPairPrompt').innerText, byId('mystAns').value||'', byId('gcA').value||'', byId('gcB').value||'']]);
  });
  byId('chExportJSON').addEventListener('click',()=>{
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_challenge.json`, {myst_prompt:byId('mystPrompt').innerText, gc_prompt:byId('gcPairPrompt').innerText, myst_ans:byId('mystAns').value||'', gc_a:byId('gcA').value||'', gc_b:byId('gcB').value||''});
  });

  /* ---------- Error Analysis ---------- */
  function errBank(level){
    const easy=[
      {work:'\\( 21 \\) is prime.', correct:'\\( 21=3\\cdot 7 \\), so composite.', key:'A'},
      {work:'\\( 24=2\\cdot12 \\) (stopped)', correct:'Keep going: \\(12=2\\cdot 6=2\\cdot2\\cdot3\\Rightarrow 24=2^3\\cdot3\\).', key:'B'},
      {work:'\\( \\mathrm{GCF}(12,18)=12\\cdot18 \\)', correct:'GCF is the greatest <em>factor</em> common to both: it is 6.', key:'C'},
      {work:'\\( \\tfrac{14}{21} = \\tfrac{14}{7} = 2 \\)', correct:'Divide both numerator and denominator: \\(\\tfrac{14}{21}=\\tfrac{2}{3}\\).', key:'D'}
    ];
    const med=[
      {work:'\\( 91 \\) is prime.', correct:'\\(91=7\\cdot 13\\).', key:'A'},
      {work:'Stopped tree at \\( 60=2\\cdot3\\cdot10 \\)', correct:'Finish: \\(10=2\\cdot5\\Rightarrow 60=2^2\\cdot3\\cdot5\\).', key:'B'},
      {work:'\\( \\mathrm{LCM}(8,12)=8 \\)', correct:'LCM is smallest common multiple: listing gives 24.', key:'C'},
      {work:'LCD for \\(\\tfrac{3}{4}\\) & \\(\\tfrac{1}{6}\\) is 10', correct:'LCM(4,6)=12 → \\(\\tfrac{3}{4}=\\tfrac{9}{12},\\;\\tfrac{1}{6}=\\tfrac{2}{12}\\).', key:'D'}
    ];
    const hard=[
      {work:'\\( 143 \\) is prime.', correct:'\\(143=11\\cdot13\\).', key:'A'},
      {work:'\\( 180=2\\cdot90=2\\cdot3\\cdot30 \\) (stopped)', correct:'Complete: \\(30=2\\cdot3\\cdot5\\Rightarrow 180=2^2\\cdot3^2\\cdot5\\).', key:'B'},
      {work:'\\( \\mathrm{GCF}(48,180,84)=4 \\)', correct:'Prime exponents → GCF is 12.', key:'C'},
      {work:'\\( \\tfrac{21}{28} = \\tfrac{21}{7}=3 \\)', correct:'Must divide both top & bottom: \\(\\tfrac{21}{28}=\\tfrac{3}{4}\\).', key:'D'}
    ];
    return level==='easy'? easy : level==='med'? med : hard;
  }
  const errState={item:null};
  function errNew(){
    const bank=errBank(byId('errLevel').value); errState.item=bank[rand(0,bank.length-1)];
    byId('errBox').innerHTML=`Incorrect work:<br/><div class="mt-1 text-maroon">${errState.item.work}</div>`;
    byId('errFb').textContent=''; byId('errRevealBox').textContent=''; runKaTeX(byId('errSlide'));
  }
  byId('errNew').addEventListener('click',errNew); errNew();
  byId('errCheck').addEventListener('click',()=>{
    const sel=[...document.querySelectorAll('input[name="errChoice"]')].find(x=>x.checked);
    if(!sel){ byId('errFb').textContent='Choose an option.'; return; }
    if(sel.value===errState.item.key){ byId('errFb').textContent='✅ Correct diagnosis.'; confetti(); }
    else byId('errFb').textContent='❌ Try again.';
  });
  byId('errReveal').addEventListener('click',()=>{ byId('errRevealBox').innerHTML=`<div class="hint">${errState.item.correct}</div>`; runKaTeX(byId('errSlide')); });
  byId('errExportCSV').addEventListener('click',()=>{
    const sel=[...document.querySelectorAll('input[name="errChoice"]')].find(x=>x.checked);
    downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_error_analysis.csv`, [['incorrect_work','explanation','key','user'], [byId('errBox').innerText.trim(), errState.item.correct, errState.item.key, sel?sel.value:'']]);
  });
  byId('errExportJSON').addEventListener('click',()=>{
    const sel=[...document.querySelectorAll('input[name="errChoice"]')].find(x=>x.checked);
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_error_analysis.json`, {incorrect:byId('errBox').innerText.trim(), correct:errState.item.correct, key:errState.item.key, user: sel?sel.value:''});
  });

  /* ---------- Mixed Review ---------- */
  const mixState={cur:null};
  function mixNew(){
    const lv=byId('mixLevel').value; let task='';
    function rInt(a,b){return rand(a,b)}
    const type=rand(0,4);
    if(type===0){
      const n=(lv==='easy')? rInt(2,40) : (lv==='med'? rInt(2,100) : rInt(2,200));
      task=`Classify ${n} as prime or composite.`; mixState.cur={type:'pc',n};
    } else if(type===1){
      const n=(lv==='easy')? rInt(12,36) : (lv==='med'? rInt(20,60) : rInt(30,84));
      task=`List all factors of ${n}.`; mixState.cur={type:'factors',n};
    } else if(type===2){
      const n=(lv==='easy')? rInt(40,200) : (lv==='med'? rInt(80,600) : rInt(120,2000));
      task=`Write ${n} in prime‑exponent form.`; mixState.cur={type:'pfe',n};
    } else if(type===3){
      const a=(lv==='easy')? rInt(6,40) : (lv==='med'? rInt(8,120) : rInt(10,200));
      const b=(lv==='easy')? rInt(6,40) : (lv==='med'? rInt(8,120) : rInt(10,200));
      task=`Find GCF and LCM of ${a} and ${b}.`; mixState.cur={type:'gcflcm',a,b};
    } else {
      const d1=[3,4,5,6,8,9,10][rand(0,6)], d2=[4,5,6,7,8,10,12][rand(0,6)];
      const a=rand(1,d1-1), b=rand(1,d2-1);
      task=`Find LCD and equivalents for ${a}/${d1} and ${b}/${d2}.`; mixState.cur={type:'lcd',a,b,d1,d2};
    }
    byId('mixQ').innerHTML=task; byId('mixHintBox').textContent=''; byId('mixFb').textContent=''; byId('mixAns').value='';
    runKaTeX(byId('mixSlide'));
  }
  byId('mixNew').addEventListener('click',mixNew); mixNew();
  byId('mixHint').addEventListener('click',()=>{
    if(!mixState.cur) return; let m='';
    const t=mixState.cur.type;
    if(t==='pc') m='Check divisibility by 2,3,5,7 up to √n.';
    else if(t==='factors') m='Search factor pairs up to √n.';
    else if(t==='pfe') m='Try dividing by the smallest primes repeatedly.';
    else if(t==='gcflcm') m='Use prime exponents: mins→GCF, maxes→LCM.';
    else if(t==='lcd') m='LCD is LCM of denominators. Build equivalents to that denominator.';
    byId('mixHintBox').innerHTML=`<div class="hint">${m}</div>`;
  });
  byId('mixCheck').addEventListener('click',()=>{
    if(!mixState.cur) return; const ans=byId('mixAns').value.trim(); let ok=false, expect='';
    const t=mixState.cur.type;
    if(t==='pc'){
      const want=isPrime(mixState.cur.n)?'prime':'composite'; ok=ans.toLowerCase().includes(want); expect=want;
    } else if(t==='factors'){
      const want=factors(mixState.cur.n).join(','); ok=ans.split(/[\s,]+/).map(x=>+x).filter(Boolean).sort((a,b)=>a-b).join(',')===want; expect=want;
    } else if(t==='pfe'){
      const exp=mapToObj(primeFactorMap(mixState.cur.n)); expect=fmtExp(exp); ok = ans.replace(/\s/g,'').includes(Object.keys(exp)[0]||'');
    } else if(t==='gcflcm'){
      const {gVal,lVal}=gcfLCMByPrimes([mixState.cur.a,mixState.cur.b]); expect=`GCF=${gVal}, LCM=${lVal}`;
      const g=ans.match(/gcf\s*=?\s*(\d+)/i)?.[1]||ans.match(/hcf\s*=?\s*(\d+)/i)?.[1]; const l=ans.match(/lcm\s*=?\s*(\d+)/i)?.[1];
      ok=(Number(g)===gVal && Number(l)===lVal);
    } else if(t==='lcd'){
      const L=lcm2(mixState.cur.d1,mixState.cur.d2); const A=mixState.cur.a*(L/mixState.cur.d1), B=mixState.cur.b*(L/mixState.cur.d2);
      expect=`LCD=${L}; ${A}/${L}; ${B}/${L}`; ok=ans.includes(String(L));
    }
    if(ok){ byId('mixFb').textContent='✅ Correct! '+expect; byId('mixFb').className='mt-2 h-6 font-semibold text-green-700'; confetti(); }
    else { byId('mixFb').textContent='❌ Not quite. Expected '+expect; byId('mixFb').className='mt-2 h-6 font-semibold text-red-700'; }
  });
  byId('mixExportCSV').addEventListener('click',()=>downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_mixed_current.csv`, [['prompt','user'], [byId('mixQ').textContent, byId('mixAns').value||'']]));
  byId('mixExportJSON').addEventListener('click',()=>downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_mixed_current.json`, {prompt:byId('mixQ').textContent, user:byId('mixAns').value||''}));

  /* ---------- Capstone ---------- */
  const capState={items:[]};
  function capPick(lv, a,b){ return (lv==='easy')? rand(a,Math.floor((a+b)/2)) : (lv==='med'? rand(a,b) : rand(Math.floor((a+b)/2), b*2)); }
  function capNew(){
    const lv=byId('capLevel').value; capState.items=[]; const box=byId('capList'); box.innerHTML='';
    // Item 1: GCF/LCM + simplify fraction
    (function(){
      const a=capPick(lv,12,60), b=capPick(lv,20,84);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Pair Planning</div>
        <div class="text-sm text-gray-600 mb-1">Compute GCF/LCM of \$begin:math:text$a=${a}, b=${b}\\$end:math:text$ and then simplify \$begin:math:text$\\\\frac{a}{b}\\$end:math:text$.</div>
        <div class="mt-1">GCF = <input class="cap1g border rounded px-2 py-1 w-20" aria-label="cap gcf"> &nbsp; LCM = <input class="cap1l border rounded px-2 py-1 w-24" aria-label="cap lcm"></div>
        <div class="mt-2">\$begin:math:text$\\\\frac{${a}}{${b}}\\$end:math:text$ = <input class="cap1n border rounded px-2 py-1 w-16" aria-label="cap n"> / <input class="cap1d border rounded px-2 py-1 w-16" aria-label="cap d"></div>`;
      box.appendChild(row); capState.items.push({type:'pair',a,b});
      runKaTeX(row);
    })();
    // Item 2: Prime or not + number of factors
    (function(){
      const N=capPick(lv,40,200);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Venue Layout</div>
        <div class="text-sm text-gray-600 mb-1">For \$begin:math:text$N=${N}\\$end:math:text$, answer both:</div>
        <div class="mt-1">Is \$begin:math:text$N\\$end:math:text$ prime? (1=yes, 0=no): <input class="cap2p border rounded px-2 py-1 w-16" aria-label="cap prime"></div>
        <div class="mt-2">How many positive factors does \$begin:math:text$N\\$end:math:text$ have? <input class="cap2t border rounded px-2 py-1 w-20" aria-label="cap tau"></div>`;
      box.appendChild(row); capState.items.push({type:'primeTau',N});
      runKaTeX(row);
    })();
  }
  byId('capNew').addEventListener('click',capNew); capNew();
  byId('capCheck').addEventListener('click',()=>{
    let ok=0, total=0;
    const cards=[...byId('capList').children];
    // Pair card
    {
      total+=2;
      const row=cards[0]; const it=capState.items[0]; const {a,b}=it; const {gVal,lVal}=gcfLCMByPrimes([a,b]);
      const gIn=row.querySelector('.cap1g'), lIn=row.querySelector('.cap1l'), nIn=row.querySelector('.cap1n'), dIn=row.querySelector('.cap1d');
      if(Number(gIn.value)==gVal){ ok++; gIn.style.borderColor='#22c55e' } else gIn.style.borderColor='#ef4444';
      if(Number(lIn.value)==lVal){ ok++; lIn.style.borderColor='#22c55e' } else lIn.style.borderColor='#ef4444';
      const g=gcd(a,b), N=a/g, D=b/g;
      if(Number(nIn.value)==N && Number(dIn.value)==D){ nIn.style.borderColor=dIn.style.borderColor='#22c55e' } else { nIn.style.borderColor=dIn.style.borderColor='#ef4444' }
    }
    // Prime/Tau card
    {
      total+=2;
      const row=cards[1]; const it=capState.items[1]; const {N}=it; const pIn=row.querySelector('.cap2p'), tIn=row.querySelector('.cap2t');
      const wantP=isPrime(N)?1:0, wantT=divCount(N);
      if(Number(pIn.value)==wantP){ ok++; pIn.style.borderColor='#22c55e' } else pIn.style.borderColor='#ef4444';
      if(Number(tIn.value)==wantT){ ok++; tIn.style.borderColor='#22c55e' } else tIn.style.borderColor='#ef4444';
    }
    byId('capFb').textContent = (ok===total)? '✅ Capstone: excellent synthesis!' : `Score: ${ok} / ${total}`;
    if(ok===total) confetti();
  });
  byId('capExportCSV').addEventListener('click',()=>{
    const rows=[['task','prompt','correct','user']];
    const it0=capState.items[0], it1=capState.items[1];
    if(it0 && it0.type==='pair'){
      const {a,b}=it0; const {gVal,lVal}=gcfLCMByPrimes([a,b]); const g=gcd(a,b), N=a/g, D=b/g;
      rows.push(['pair', `a=${a}, b=${b}`, `GCF=${gVal}; LCM=${lVal}; ${N}/${D}`,
        `GCF=${byId('capList').children[0].querySelector('.cap1g').value||''}; LCM=${byId('capList').children[0].querySelector('.cap1l').value||''}; ${byId('capList').children[0].querySelector('.cap1n').value||''}/${byId('capList').children[0].querySelector('.cap1d').value||''}`]);
    }
    if(it1 && it1.type==='primeTau'){
      const {N}=it1; const row=byId('capList').children[1];
      rows.push(['primeTau', `N=${N}`, `prime=${isPrime(N)?1:0}; tau=${divCount(N)}`,
        `prime=${row.querySelector('.cap2p').value||''}; tau=${row.querySelector('.cap2t').value||''}`]);
    }
    downloadCSV(`G7_U1_L3_Prime_Toolkit_v2_P4_capstone.csv`, rows);
  });
  byId('capExportJSON').addEventListener('click',()=>{
    const data=[];
    const it0=capState.items[0], it1=capState.items[1];
    if(it0 && it0.type==='pair'){
      const {a,b}=it0; const {gVal,lVal}=gcfLCMByPrimes([a,b]); const g=gcd(a,b), N=a/g, D=b/g;
      data.push({type:'pair', a,b, correct:{GCF:gVal,LCM:lVal,simplified:[N,D]},
                 user:{GCF:byId('capList').children[0].querySelector('.cap1g').value||'', LCM:byId('capList').children[0].querySelector('.cap1l').value||'',
                       simplified:[byId('capList').children[0].querySelector('.cap1n').value||'', byId('capList').children[0].querySelector('.cap1d').value||'']}});
    }
    if(it1 && it1.type==='primeTau'){
      const {N}=it1; const row=byId('capList').children[1];
      data.push({type:'primeTau', N, correct:{prime:isPrime(N)?1:0, tau:divCount(N)},
                 user:{prime:row.querySelector('.cap2p').value||'', tau:row.querySelector('.cap2t').value||''}});
    }
    downloadJSON(`G7_U1_L3_Prime_Toolkit_v2_P4_capstone.json`, data);
  });

  /* ---------- HOT / Challenge banks ---------- */
  const HOT = {
    pc: [
      ()=>({q:`Find a composite number between 90 and 120 with <b>exactly 3 distinct prime factors</b>. Show a factorization.`, a:`e.g., 105 = 3·5·7`}),
      ()=>{ let n=rand(50,100); while(!isPrime(n-2) || !isPrime(n)){ n=rand(50,100) } return {q:`Find two <b>consecutive odd</b> numbers both prime, around ${n}.`, a:`e.g., ${n-2} and ${n} if both prime.`} },
      ()=>({q:`Construct a number \$begin:math:text$N\\$end:math:text$ with \$begin:math:text$\\\\tau(N)=8\\$end:math:text$. Give two different such \$begin:math:text$N\\$end:math:text$.`, a:`e.g., 24 = 2^3·3 and 54 = 2·3^3.`})
    ],
    pc_only: [
      ()=>({q:`Give an example of a number that is not divisible by 2,3,5,7 but is <b>not prime</b>.`, a:`121 = 11^2.`}),
      ()=>({q:`Is 1 prime or composite? Explain using the definition.`, a:`Neither; it has only one positive factor (itself).`})
    ],
    fm: [
      ()=>({q:`Choose \$begin:math:text$T\\$end:math:text$ so that it has <b>exactly six</b> factors. List them.`, a:`Any \$begin:math:text$p^5\\$end:math:text$ or \$begin:math:text$p^2q\\$end:math:text$ with distinct primes p,q.`}),
      ()=>({q:`Create five multiples of \$begin:math:text$18\\$end:math:text$ whose sum is also a multiple of \$begin:math:text$18\\$end:math:text$. Explain why this always happens.`, a:`Sum of multiples of 18 is a multiple of 18.`})
    ],
    pf: [
      ()=>{ const n=rand(200,400); const m=mapToObj(primeFactorMap(n)); return {q:`Prime‑factorize \$begin:math:text$${n}\\$end:math:text$ and justify each split.`, a:`${fmtExp(m)}`}; },
      ()=>({q:`Draw two different factor trees for 180 and explain why leaves match.`, a:`FTA → 2^2·3^2·5.`})
    ],
    pfexp: [
      ()=>({q:`Design \$begin:math:text$A,B\\$end:math:text$ so that \$begin:math:text$\\\\gcf(A,B)=2^2\\\\cdot 3\\$end:math:text$ and \$begin:math:text$\\\\operatorname{lcm}(A,B)=2^4\\\\cdot 3^2\\\\cdot 5\\$end:math:text$.`, a:`Let A take minima and B take maxima, e.g., A=2^2·3, B=2^4·3^2·5.`})
    ],
    gcl: [
      ()=>{ const a=rand(40,80), b=rand(60,120); const g=gcd(a,b), L=lcm2(a,b); return {q:`Given a pair with product ${a*b}, and \$begin:math:text$\\\\gcf=${g}\\$end:math:text$, find \$begin:math:text$\\\\operatorname{lcm}\\$end:math:text$.`, a:`LCM = (a·b)/GCF = ${(a*b)}/${g} = ${L}.`}; },
      ()=>({q:`True or false (justify): For three numbers, \$begin:math:text$abc=\\\\gcf(a,b,c)\\\\cdot\\\\operatorname{lcm}(a,b,c)\\$end:math:text$.`, a:`False in general; the two‑number identity doesn’t extend directly.`})
    ],
    app: [
      ()=>({q:`Invent two denominators with LCD = 60 and show equivalents for \$begin:math:text$\\\\tfrac{3}{\\\\text{first}}\\$end:math:text$ and \$begin:math:text$\\\\tfrac{4}{\\\\text{second}}\\$end:math:text$.`, a:`e.g., 12 and 15 → 15/60 and 16/60.`}),
      ()=>({q:`A fraction simplifies to \$begin:math:text$\\\\tfrac{5}{12}\\$end:math:text$. Create two unsimplified versions and show the GCF used.`, a:`e.g., 10/24 (÷2) and 35/84 (÷7).`})
    ]
  };
  function addHot(buttonSlideKey, hotBoxId){
    const btns = document.querySelectorAll(`[data-hot="${buttonSlideKey}"]`);
    btns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const maker = choice(HOT[buttonSlideKey]);
        const {q,a} = maker();
        const box = byId(hotBoxId);
        box.innerHTML = `<h4>Higher‑Order Task</h4><div class="q">${q}</div><div data-key="sc-ans" style="display:none; margin-top:.4rem"><b>One approach:</b> ${a}</div>`;
        box.style.display='block';
        if(window._rerenderMath) window._rerenderMath(box);
        refreshVisibility();
      });
    });
  }
  addHot('pc','hot_pc');
  addHot('pc_only','hot_pc_only');
  addHot('fm','hot_fm');
  addHot('pf','hot_pf');
  addHot('pfexp','hot_pfexp');
  addHot('gcl','hot_gcl');
  addHot('app','hot_app');

  /* ---------- Worksheet Builder ---------- */
  const wsModal = byId('wsModal');
  byId('btnWS').onclick = ()=>{ wsModal.style.display='flex' };
  byId('wsClose').onclick = ()=>{ wsModal.style.display='none' };
  function genItem(type, level){
    const L = (lo,hi)=>rand(lo,hi), C=(arr)=>choice(arr);
    if(type==='pc'){
      const n = level==='easy'? L(2,40) : level==='med'? L(2,100) : L(2,200);
      return {q:`Classify ${n} as prime or composite.`, a: isPrime(n)?'prime':'composite' };
    } else if(type==='factors'){
      const n = level==='easy'? L(12,36) : level==='med'? L(20,72) : L(30,120);
      return {q:`List all factors of ${n}.`, a: factors(n).join(', ')};
    } else if(type==='pfe'){
      const n = level==='easy'? L(40,200) : level==='med'? L(80,600) : L(120,2000);
      const m = primeFactorMap(n); return {q:`Write ${n} in prime‑exponent form.`, a: fmtExp(mapToObj(m)) };
    } else if(type==='gcflcm'){
      const a = level==='easy'? L(6,40) : level==='med'? L(8,120) : L(10,200);
      const b = level==='easy'? L(6,40) : level==='med'? L(8,120) : L(10,200);
      return {q:`Find GCF and LCM of ${a} and ${b}.`, a:`GCF=${gcd(a,b)}, LCM=${lcm2(a,b)}`};
    } else if(type==='lcd'){
      const d1=C([3,4,5,6,8,9,10,12,14,15]); const d2=C([4,5,6,7,8,10,12,18]);
      const a=L(1,d1-1), b=L(1,d2-1); const LCM=lcm2(d1,d2), A=a*(LCM/d1), B=b*(LCM/d2);
      return {q:`Find LCD and equivalents for ${a}/${d1} and ${b}/${d2}.`, a:`LCD=${LCM}; ${A}/${LCM}; ${B}/${LCM}`};
    } else { // mixed
      const types = ['pc','factors','pfe','gcflcm','lcd']; return genItem(choice(types), level);
    }
  }
  byId('wsGo').onclick = ()=>{
    const t = byId('wsType').value, lv=byId('wsLevel').value, n=parseInt(byId('wsCount').value||'10',10), showA=byId('wsAns').checked;
    const items = Array.from({length:n}, ()=>genItem(t,lv));
    const w = window.open('', '_blank');
    const katexCSS = 'https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css';
    w.document.write(`
      <html><head><meta charset="utf-8"><title>Worksheet</title>
        <link rel="stylesheet" href="${katexCSS}">
        <style>body{font-family:Inter,Arial,sans-serif; padding:20px} h1{margin:4px 0 10px 0}
          .q{margin:.4rem 0; padding:.25rem .5rem; border-left:4px solid #C7A34F; background:#fafafa}
          .ans{margin:.2rem 0 .7rem 1rem; color:#065f46}
          .printbtn{position:fixed; right:20px; top:20px; padding:.35rem .6rem; border:1px solid #ddd; border-radius:8px; cursor:pointer}
        </style>
      </head><body>
        <button class="printbtn" onclick="window.print()">Print</button>
        <h1>Worksheet — ${t.toUpperCase()} • ${lv}</h1>
        <ol>
          ${items.map(it=>`<li><div class="q">${it.q}</div>${showA?`<div class="ans"><b>Answer:</b> ${it.a}</div>`:''}</li>`).join('')}
        </ol>
      </body></html>`);
    w.document.close();
  };

  /* ---------- Auto‑level streak watcher ---------- */
  const fbIds = ['pcFb','fmFb','pfFb','appFb','p1RealFb','p2RealFb','p3RealFb','glFb','capFb','chFb'];
  setInterval(()=>{
    const winTexts = ['✅','Excellent','Nice work','Good use','Capstone','All correct'];
    const hit = fbIds.some(id=>{ const el=byId(id); return el && winTexts.some(w=>el.textContent.includes(w)); });
    if(hit){
      STATE.streak = Math.min(STATE.streak+1, 4);
      if(STATE.autolvl && STATE.streak>=2){
        // promote levels where present
        ['pcLevel','fmLevel','pfLevel','gclLevel','glLevel','appLevel','p1RealLevel','p2RealLevel','p3RealLevel','chLevel','errLevel','mixLevel','capLevel'].forEach(lvId=>{
          const el=byId(lvId); if(!el) return; const order=['easy','med','hard']; const k=order.indexOf(el.value);
          if(k>=0 && k<order.length-1){ el.value = order[k+1]; }
        });
        toast('Auto‑level: difficulty increased');
        STATE.streak=0;
      }
    }
  }, 1500);

  /* ---------- HOT buttons already wired above ---------- */

  /* ---------- Initial rendering ---------- */
  show(0);
});
</script>
</body>
</html>