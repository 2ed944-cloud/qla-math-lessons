<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lesson Template ‚Äî QLA Mathematics</title>

<!-- Fonts & Tailwind -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const run = (root=document.body) => {
      if (!window.renderMathInElement) return;
      window.renderMathInElement(root, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '\\[', right: '\\]', display: true },
          { left: '\\(', right: '\\)', display: false }
        ],
        throwOnError: false
      });
    };
    if (window.renderMathInElement) run();
    else {
      const t=setInterval(()=>{ if(window.renderMathInElement){ clearInterval(t); run(); }},25);
      setTimeout(()=>clearInterval(t),6000);
    }
    window._rerenderMath = run;
  });
</script>

<style>
  :root{--maroon:#6C1D45;--gold:#C7A34F;--dark:#2C2C2E;--light:#F5F5F5;--accent:#E8D5B7}
  html,body{height:100%;background:#2d3748;color:#111;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  
  /* Improved deck and slides */
  #deck{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;padding:10px}
  #slides{position:relative;width:100%;max-width:1280px;aspect-ratio:16/9;background:#fff;box-shadow:0 14px 36px rgba(0,0,0,.35);overflow:hidden;border-radius:18px}
  .slide{position:absolute;inset:0;padding:3.5%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;opacity:0;transform:translateY(14px) scale(.985);transition:.55s ease;pointer-events:none}
  .slide.active{opacity:1;transform:none;pointer-events:auto}
  
  /* Skip to slide navigation for accessibility */
  .skip-nav{position:absolute;top:10px;left:10px;z-index:100;background:#fff;padding:8px 12px;border-radius:8px;opacity:0;pointer-events:none}
  .skip-nav:focus{opacity:1;pointer-events:auto}
  
  /* Enhanced controls with better accessibility */
  #controls{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.55);padding:.4rem .6rem;border-radius:999px;z-index:20;backdrop-filter:blur(6px)}
  #controls button{width:42px;height:42px;border-radius:999px;border:none;background:#fff;cursor:pointer;font-weight:700;transition:transform .2s}
  #controls button:hover:not(:disabled){transform:scale(1.06)}
  #controls button:disabled{opacity:.4;cursor:not-allowed}
  #controls button:focus{outline:2px solid var(--gold);outline-offset:2px}
  
  /* Progress indicators */
  #slideProgress{position:fixed;left:0;bottom:0;height:5px;width:0;background:var(--gold);z-index:30;transition:width .35s ease}
  #slideCounter{color:#fff;font-weight:700;min-width:84px;text-align:center}
  
  /* Lesson progress tracker */
  .lesson-progress{position:fixed;top:10px;right:10px;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);color:#fff;padding:8px 12px;border-radius:999px;font-size:12px;font-weight:700;z-index:25;display:flex;align-items:center;gap:8px}
  .progress-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.3);transition:all .3s}
  .progress-dot.visited{background:var(--gold)}
  .progress-dot.current{background:#fff;transform:scale(1.3)}
  
  /* Toast notifications */
  .toast{position:fixed;top:20px;right:20px;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px 16px;box-shadow:0 10px 24px rgba(0,0,0,.15);z-index:1000;transform:translateX(400px);transition:transform .3s ease}
  .toast.show{transform:translateX(0)}
  .toast.success{border-left:4px solid #22c55e}
  .toast.error{border-left:4px solid #ef4444}
  
  /* Improved hints and feedback */
  .hint{background:#fef3c7;border:1px solid #fde047;border-radius:10px;padding:12px 16px;display:flex;align-items:start;gap:10px}
  .hint::before{content:"üí°";font-size:20px;flex-shrink:0}
  
  /* Timer display */
  .timer{position:fixed;top:10px;left:10px;background:rgba(0,0,0,.6);backdrop-filter:blur(6px);color:#fff;padding:8px 12px;border-radius:999px;font-size:12px;font-weight:700;z-index:25;font-variant-numeric:tabular-nums}
  
  /* Notes panel */
  .notes-panel{position:fixed;right:0;top:0;bottom:0;width:300px;background:#fff;box-shadow:-4px 0 12px rgba(0,0,0,.1);transform:translateX(100%);transition:transform .3s ease;z-index:50;padding:20px;overflow-y:auto}
  .notes-panel.open{transform:translateX(0)}
  .notes-toggle{position:fixed;right:10px;top:50%;transform:translateY(-50%);background:var(--maroon);color:#fff;border:none;padding:12px 8px;border-radius:8px 0 0 8px;cursor:pointer;z-index:49;writing-mode:vertical-rl}
  
  /* Print styles */
  @media print{
    #controls, #fsHint, .lesson-progress, .timer, .notes-toggle{display:none}
    #slides{box-shadow:none;max-width:100%;aspect-ratio:auto}
    .slide{page-break-after:always;position:relative;opacity:1;transform:none}
  }
  
  /* Color and theme utilities */
  .bg-maroon{background-color:var(--maroon)} .text-maroon{color:var(--maroon)} .text-gold{color:var(--gold)}
  .banner{width:100%;height:110px;background:#fff center/contain no-repeat;border-bottom:3px solid var(--gold);border-radius:10px}
  .card{border:1px solid #e5e7eb;border-radius:14px;background:#fafafa;padding:20px}
  .chip{display:inline-flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.05);border-radius:9999px;padding:.35rem .75rem;cursor:pointer;transition:all .2s}
  .chip:hover{outline:2px solid var(--gold);transform:scale(1.05)}
  .btn{padding:.55rem 1rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700;cursor:pointer;transition:all .2s}
  .btn.maroon{background:var(--maroon);color:#fff;border-color:var(--maroon)}
  .btn:hover{filter:brightness(0.98);transform:scale(1.02)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  
  .confetti{position:fixed;pointer-events:none;z-index:50}
  
  /* Keyboard shortcuts help */
  .kbd-help{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.7);backdrop-filter:blur(6px);color:#fff;padding:12px 16px;border-radius:12px;font-size:11px;opacity:0;pointer-events:none;transition:opacity .3s;z-index:15}
  .kbd-help.show{opacity:1}
  .kbd{font-variant-numeric:tabular-nums;font-weight:700;padding:.1rem .4rem;border-radius:.3rem;background:rgba(255,255,255,.2);margin:0 2px}
</style>
</head>
<body>

  <!-- Skip navigation -->
  <a href="#slide-0" class="skip-nav">Skip to first slide</a>

  <!-- Timer -->
  <div class="timer" id="timer" aria-live="polite">
    <span id="timeDisplay">00:00</span>
  </div>

  <!-- Lesson progress dots -->
  <div class="lesson-progress" aria-label="Lesson progress" role="progressbar" aria-valuemin="0" aria-valuemax="13" aria-valuenow="1">
    <span class="sr-only">Slide <span id="currentSlideNum">1</span> of <span id="totalSlides">13</span></span>
    <div id="progressDots"></div>
  </div>

  <!-- Notes toggle -->
  <button class="notes-toggle" onclick="toggleNotes()" aria-label="Toggle notes panel">
    Notes
  </button>

  <!-- Notes panel -->
  <aside class="notes-panel" id="notesPanel" role="complementary" aria-label="Lesson notes">
    <div class="flex items-center justify-between mb-4">
      <h2 class="font-bold text-lg">My Notes</h2>
      <button onclick="toggleNotes()" class="btn" aria-label="Close notes">‚úï</button>
    </div>
    <textarea id="notesArea" 
              class="w-full h-96 p-3 border rounded-lg resize-none"
              placeholder="Type your notes here... They'll be saved automatically."
              aria-label="Notes text area"></textarea>
    <div class="mt-3 flex gap-2">
      <button onclick="saveNotes()" class="btn maroon flex-1">Save Notes</button>
      <button onclick="clearNotes()" class="btn">Clear</button>
      <button onclick="downloadNotes()" class="btn">Download</button>
    </div>
    <div class="mt-2 text-xs text-gray-500" id="notesSaved"></div>
  </aside>

  <div id="deck" aria-live="polite" role="main">
    <div id="slides" class="relative">
      <div id="fsHint" style="position:absolute;top:10px;right:12px;color:#fff;background:rgba(0,0,0,.35);padding:.25rem .5rem;border-radius:8px;font-size:.8rem">
        Press <strong>F</strong> for fullscreen
      </div>

      <!-- Slide 0: Title -->
      <section class="slide active bg-maroon text-white" id="slide-0" role="region" aria-labelledby="lesson-title">
        <div class="w-full h-16 banner mb-6 rounded-md" style="background-image:url('../assets/qla_banner.png')" role="img" aria-label="QLA Banner"></div>
        <div class="flex items-center gap-8">
          <img src="../assets/qla_logo.png" alt="" class="h-20 w-auto" aria-hidden="true"/>
          <div class="text-left">
            <h1 id="lesson-title" class="text-5xl md:text-6xl font-extrabold tracking-tight">Lesson Title Here</h1>
            <p class="text-gold text-2xl md:text-3xl mt-2 font-semibold">Subtitle or key concepts</p>
            <p class="mt-2 text-lg">Qatar Leadership Academy ‚Äî Grade X</p>
          </div>
        </div>
        <div class="absolute bottom-6 text-sm text-gray-100">Aligned to AERO standards.</div>
      </section>

      <!-- Add more slides here... -->

    </div>
  </div>

  <!-- Controls -->
  <nav id="controls" role="group" aria-label="Slideshow navigation">
    <button id="first" title="First slide (Home)" aria-label="Go to first slide">‚èÆ</button>
    <button id="prev" title="Previous (‚Üê)" aria-label="Go to previous slide">‚ùÆ</button>
    <button id="fs" title="Toggle Fullscreen (F)" aria-label="Toggle fullscreen">‚§¢</button>
    <div id="slideCounter" aria-live="polite">1 / 13</div>
    <button id="next" title="Next (‚Üí)" aria-label="Go to next slide">‚ùØ</button>
    <button id="last" title="Last slide (End)" aria-label="Go to last slide">‚è≠</button>
  </nav>
  
  <div id="slideProgress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="8"></div>

  <!-- Keyboard shortcuts help -->
  <div class="kbd-help" id="kbdHelp">
    <kbd>‚Üê</kbd>/<kbd>‚Üí</kbd> Navigate ‚Ä¢ <kbd>F</kbd> Fullscreen ‚Ä¢ <kbd>Home</kbd>/<kbd>End</kbd> First/Last ‚Ä¢ <kbd>?</kbd> Help
  </div>

  <!-- Toast container -->
  <div id="toastContainer" aria-live="polite" aria-atomic="true"></div>

  <script>
    /* ==================== Enhanced Lesson Script ==================== */
    (function(){
      const slides = [...document.querySelectorAll('.slide')];
      const controls = {
        prev: document.getElementById('prev'),
        next: document.getElementById('next'),
        first: document.getElementById('first'),
        last: document.getElementById('last'),
        counter: document.getElementById('slideCounter'),
        progress: document.getElementById('slideProgress'),
        fs: document.getElementById('fs')
      };
      
      const lessonId = getLessonId();
      let currentSlide = 0;
      let visitedSlides = new Set([0]);
      let startTime = Date.now();
      let timerInterval;
      
      // ==================== Slide Navigation ====================
      function showSlide(index) {
        currentSlide = Math.max(0, Math.min(index, slides.length - 1));
        visitedSlides.add(currentSlide);
        
        slides.forEach((slide, idx) => {
          slide.classList.toggle('active', idx === currentSlide);
          slide.setAttribute('aria-hidden', idx !== currentSlide);
        });
        
        updateUI();
        saveProgress();
        trackSlideView();
        
        // Re-render math on current slide
        if (window._rerenderMath) window._rerenderMath(slides[currentSlide]);
      }
      
      function updateUI() {
        // Update counter
        controls.counter.textContent = `${currentSlide + 1} / ${slides.length}`;
        document.getElementById('currentSlideNum').textContent = currentSlide + 1;
        document.getElementById('totalSlides').textContent = slides.length;
        
        // Update progress bar
        const progress = ((currentSlide + 1) / slides.length) * 100;
        controls.progress.style.width = progress + '%';
        controls.progress.setAttribute('aria-valuenow', Math.round(progress));
        
        // Update progress dots
        updateProgressDots();
        
        // Update button states
        controls.prev.disabled = currentSlide === 0;
        controls.first.disabled = currentSlide === 0;
        controls.next.disabled = currentSlide === slides.length - 1;
        controls.last.disabled = currentSlide === slides.length - 1;
        
        // Announce to screen readers
        announceSlideChange();
      }
      
      function updateProgressDots() {
        const container = document.getElementById('progressDots');
        if (!container.children.length) {
          slides.forEach((_, idx) => {
            const dot = document.createElement('div');
            dot.className = 'progress-dot';
            dot.setAttribute('data-slide', idx);
            container.appendChild(dot);
          });
        }
        
        container.querySelectorAll('.progress-dot').forEach((dot, idx) => {
          dot.classList.toggle('visited', visitedSlides.has(idx));
          dot.classList.toggle('current', idx === currentSlide);
        });
      }
      
      function announceSlideChange() {
        const announcement = `Slide ${currentSlide + 1} of ${slides.length}`;
        const liveRegion = document.querySelector('[role="status"]') || createLiveRegion();
        liveRegion.textContent = announcement;
      }
      
      function createLiveRegion() {
        const region = document.createElement('div');
        region.setAttribute('role', 'status');
        region.setAttribute('aria-live', 'polite');
        region.className = 'sr-only';
        document.body.appendChild(region);
        return region;
      }
      
      // ==================== Timer ====================
      function startTimer() {
        timerInterval = setInterval(() => {
          const elapsed = Date.now() - startTime;
          const minutes = Math.floor(elapsed / 60000);
          const seconds = Math.floor((elapsed % 60000) / 1000);
          document.getElementById('timeDisplay').textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }, 1000);
      }
      
      // ==================== Progress Tracking ====================
      function getLessonId() {
        const path = window.location.pathname;
        const match = path.match(/grade(\d)\/lesson-(\d+)\.html/);
        return match ? `grade${match[1]}-lesson-${match[2]}` : 'unknown';
      }
      
      function saveProgress() {
        const progress = {
          lessonId,
          currentSlide,
          visitedSlides: [...visitedSlides],
          totalSlides: slides.length,
          timestamp: Date.now(),
          timeSpent: Date.now() - startTime
        };
        
        localStorage.setItem(`qla_lesson_${lessonId}`, JSON.stringify(progress));
        
        // Update portal progress if on last slide
        if (currentSlide === slides.length - 1) {
          updatePortalProgress('completed');
        } else if (currentSlide > 0) {
          updatePortalProgress('in-progress');
        }
      }
      
      function loadProgress() {
        try {
          const saved = localStorage.getItem(`qla_lesson_${lessonId}`);
          if (saved) {
            const progress = JSON.parse(saved);
            visitedSlides = new Set(progress.visitedSlides || [0]);
            return progress.currentSlide || 0;
          }
        } catch {}
        return 0;
      }
      
      function updatePortalProgress(status) {
        try {
          const allProgress = JSON.parse(localStorage.getItem('qla_progress') || '{}');
          allProgress[lessonId] = {
            status,
            timestamp: Date.now(),
            grade: lessonId.match(/grade(\d)/)?.[1]
          };
          localStorage.setItem('qla_progress', JSON.stringify(allProgress));
        } catch {}
      }
      
      function trackSlideView() {
        // Simple analytics
        const analytics = JSON.parse(localStorage.getItem('qla_analytics') || '[]');
        analytics.push({
          event: 'slide_view',
          lessonId,
          slide: currentSlide,
          timestamp: Date.now()
        });
        if (analytics.length > 100) analytics.shift();
        localStorage.setItem('qla_analytics', JSON.stringify(analytics));
      }
      
      // ==================== Notes ====================
      window.toggleNotes = function() {
        document.getElementById('notesPanel').classList.toggle('open');
      };
      
      window.saveNotes = function() {
        const notes = document.getElementById('notesArea').value;
        localStorage.setItem(`qla_notes_${lessonId}`, notes);
        document.getElementById('notesSaved').textContent = 'Saved at ' + new Date().toLocaleTimeString();
        showToast('Notes saved successfully', 'success');
      };
      
      window.clearNotes = function() {
        if (confirm('Clear all notes for this lesson?')) {
          document.getElementById('notesArea').value = '';
          localStorage.removeItem(`qla_notes_${lessonId}`);
          showToast('Notes cleared', 'success');
        }
      };
      
      window.downloadNotes = function() {
        const notes = document.getElementById('notesArea').value;
        const blob = new Blob([notes], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `notes-${lessonId}-${Date.now()}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Notes downloaded', 'success');
      };
      
      function loadNotes() {
        const notes = localStorage.getItem(`qla_notes_${lessonId}`) || '';
        document.getElementById('notesArea').value = notes;
        
        // Auto-save notes every 30 seconds
        setInterval(() => {
          const current = document.getElementById('notesArea').value;
          if (current !== notes) {
            saveNotes();
          }
        }, 30000);
      }
      
      // ==================== Toast Notifications ====================
      function showToast(message, type = 'success') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `
          <div class="flex items-center gap-2">
            <span>${type === 'success' ? '‚úì' : '‚ö†'}</span>
            <span>${message}</span>
          </div>
        `;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }
      
      // ==================== Fullscreen ====================
      function toggleFullscreen() {
        const elem = document.getElementById('slides');
        if (!document.fullscreenElement) {
          (elem.requestFullscreen || elem.webkitRequestFullscreen || elem.msRequestFullscreen)?.call(elem);
        } else {
          (document.exitFullscreen || document.webkitExitFullscreen || document.msExitFullscreen)?.call(document);
        }
      }
      
      // ==================== Event Listeners ====================
      controls.prev.addEventListener('click', () => showSlide(currentSlide - 1));
      controls.next.addEventListener('click', () => showSlide(currentSlide + 1));
      controls.first.addEventListener('click', () => showSlide(0));
      controls.last.addEventListener('click', () => showSlide(slides.length - 1));
      controls.fs.addEventListener('click', toggleFullscreen);
      
      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key) {
          case 'ArrowRight': case ' ': showSlide(currentSlide + 1); break;
          case 'ArrowLeft': showSlide(currentSlide - 1); break;
          case 'Home': showSlide(0); break;
          case 'End': showSlide(slides.length - 1); break;
          case 'f': case 'F': toggleFullscreen(); break;
          case '?': document.getElementById('kbdHelp').classList.toggle('show'); break;
        }
      });
      
      // Show keyboard help briefly on load
      setTimeout(() => {
        const help = document.getElementById('kbdHelp');
        help.classList.add('show');
        setTimeout(() => help.classList.remove('show'), 3000);
      }, 1000);
      
      // ==================== Initialize ====================
      function init() {
        const savedSlide = loadProgress();
        showSlide(savedSlide);
        loadNotes();
        startTimer();
        
        // Mark lesson as started
        updatePortalProgress('in-progress');
        
        console.log('[Lesson] Initialized:', lessonId);
      }
      
      // Save progress on page unload
      window.addEventListener('beforeunload', saveProgress);
      
      // Initialize
      init();
      
    })();
  </script>
</body>
</html>
