<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>G8 • Unit 1 • Lesson 4 • Rounding Numbers (QLA) — Enhanced</title>

<!-- Fonts & Tailwind -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
<script>
  // KaTeX boot + global re-render
  window.addEventListener('DOMContentLoaded', () => {
    const run = (root = document.body) => {
      if (!window.renderMathInElement) return;
      window.renderMathInElement(root, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '\\[', right: '\\]', display: true },
          { left: '\\(', right: '\\)', display: false }
        ],
        throwOnError: false
      });
    };
    if (window.renderMathInElement) run();
    else {
      const t = setInterval(()=>{ if(window.renderMathInElement){ clearInterval(t); run();}}, 25);
      setTimeout(()=>clearInterval(t), 6000);
    }
    window._rerenderMath = run;
  });
</script>

<style>
  :root{--maroon:#6C1D45;--gold:#C7A34F;--dark:#2C2C2E;--light:#F5F5F5;--accent:#E8D5B7}
  html,body{height:100%;background:#2d3748;color:#111;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  /* Stage */
  #deck{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;padding:10px}
  #slides{position:relative;width:100%;max-width:1280px;aspect-ratio:16/9;background:#fff;box-shadow:0 14px 36px rgba(0,0,0,.35);overflow:hidden;border-radius:18px}
  .slide{position:absolute;inset:0;padding:3.5%;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;text-align:left;opacity:0;transform:translateY(14px) scale(.985);transition:.55s ease;pointer-events:none;overflow:auto}
  .slide.active{opacity:1;transform:none;pointer-events:auto}
  .bg-maroon{background-color:var(--maroon)} .text-maroon{color:var(--maroon)} .text-gold{color:var(--gold)}
  .banner{width:100%;height:110px;background:#fff center/contain no-repeat;border-bottom:3px solid var(--gold);border-radius:10px}
  .card{border:1px solid #e5e7eb;border-radius:14px;background:#fafafa}
  .chip{display:inline-flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.05);border-radius:9999px;padding:.35rem .75rem;cursor:pointer}
  .chip:hover{outline:2px solid var(--gold)}
  .btn{padding:.55rem 1rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
  .btn.maroon{background:var(--maroon);color:#fff;border-color:var(--maroon)}
  .btn:hover{filter:brightness(0.98)}
  #controls{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.55);padding:.4rem .6rem;border-radius:999px;z-index:40;backdrop-filter:blur(6px)}
  #controls button{width:42px;height:42px;border-radius:999px;border:none;background:#fff;cursor:pointer;font-weight:700}
  #controls button:hover{transform:scale(1.06)}
  #counter{color:#fff;font-weight:700;min-width:96px;text-align:center}
  #progress{position:fixed;left:0;bottom:0;height:5px;width:0;background:var(--gold);z-index:30;transition:width .35s ease}
  #fsHint{position:absolute;top:10px;right:12px;color:#fff;background:rgba(0,0,0,.35);padding:.25rem .5rem;border-radius:8px;font-size:.8rem}

  /* Popover + Drawer */
  #pop{position:fixed;inset:auto auto 20px 20px;max-width:min(560px,90vw);background:#fff;border:2px solid var(--gold);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.25);padding:14px 16px;z-index:50;display:none;text-align:left}
  #pop strong{color:var(--maroon)} #pop .close{float:right;color:#666;cursor:pointer;font-weight:800}

  #glossBtn{position:fixed;top:16px;left:16px;z-index:45;background:#fff;border:2px solid var(--gold);border-radius:999px;padding:.45rem .8rem;box-shadow:0 8px 20px rgba(0,0,0,.2);cursor:pointer}
  #drawer{position:fixed;top:0;right:-420px;width:400px;height:100vh;background:#fff;border-left:3px solid var(--gold);z-index:60;transition:right .4s ease;display:flex;flex-direction:column}
  #drawer.open{right:0}
  #drawer header{padding:14px 16px;border-bottom:1px solid #eee}
  #drawer .body{flex:1;overflow:auto;padding:12px 16px}
  .kw{border:1px solid #eee;border-radius:10px;padding:.6rem .7rem;margin-bottom:.5rem}
  .kw h4{margin:0;font-size:1rem;color:var(--maroon)}
  .kw small{color:#555}
  .kw .quiz{margin-top:.4rem}

  /* Number line */
  .nl-wrap{width:100%;max-width:920px}
  canvas.nline{width:100%;height:170px;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa);border:2px solid #ececec}

  .confetti{position:fixed;pointer-events:none;z-index:70}
  .hint{background:#fff3cd;border:1px solid #ffe69c;border-radius:10px;padding:.6rem .8rem}
  .intro{background:#eef6ff;border:1px solid #cfe1ff;border-radius:12px;padding:.8rem 1rem}
  .tok{display:inline-block;padding:.05rem .25rem;border-radius:6px}

  /* Settings pop */
  #settings{position:fixed;bottom:84px;left:50%;transform:translateX(-50%);z-index:55;background:#fff;border:2px solid var(--gold);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.25);padding:14px 16px;min-width:320px;display:none}
  #settings .row{display:flex;align-items:center;gap:.75rem;margin:.35rem 0}

  /* MCQ */
  .mcq .q{border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:.8rem}
  .mcq label{display:flex;gap:.6rem;align-items:flex-start;border:1px solid #eee;background:#fafafa;border-radius:10px;padding:.55rem .6rem;margin:.35rem 0;cursor:pointer}
  .mcq label.correct{border-color:#22c55e;background:#ecfdf5}
  .mcq label.wrong{border-color:#ef4444;background:#fff1f1}
  .badge{display:inline-block;padding:.1rem .45rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:.75rem}

  /* Tables */
  .tbl{width:100%;border-collapse:collapse}
  .tbl th,.tbl td{border-bottom:1px solid #eee;padding:.5rem;text-align:left}
  .tbl th{background:#fafafa}

  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>

<div id="deck" aria-live="polite">
  <div id="slides" class="relative">
    <div id="fsHint">Press <strong>F</strong> for fullscreen</div>
    <button id="glossBtn" title="Glossary (G)">🔎 Keywords</button>

    <!-- 0 • Title -->
    <section class="slide active bg-maroon text-white" id="titleSlide">
      <div class="w-full h-16 banner mb-6 rounded-md" style="background-image:url('../assets/qla_banner.png')" aria-label="QLA Partner Banner"></div>
      <div class="flex items-center gap-8">
        <img src="../assets/qla_logo.png" alt="QLA Logo" class="h-20 w-auto" onerror="this.style.display='none'"/>
        <div class="text-left">
          <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight">Unit 1 — Lesson 4: Rounding Numbers</h1>
          <p class="text-gold text-2xl md:text-3xl mt-2 font-semibold">Grade 8 • Whole numbers • Decimals • Significant Figures • Bounds</p>
          <p class="mt-2 text-lg">Qatar Leadership Academy — Mathematics</p>
        </div>
      </div>
      <div class="absolute bottom-6 text-sm text-gray-100">Aligned to AERO 8.NS &amp; 8.EE readiness.</div>
    </section>

    <!-- 0a • Overview & Success Criteria -->
    <section class="slide" id="overviewSlide">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Lesson Overview</h2>
      <div class="grid md:grid-cols-2 gap-6 w-full max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon">Learning Objectives</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Round whole numbers and decimals using the <strong>half‑up</strong> rule, including negatives.</li>
            <li>Round to a specified number of <strong>decimal places</strong> and <strong>significant figures</strong>.</li>
            <li>Interpret <strong>bounds</strong> (error intervals) for a reported value.</li>
            <li>Select appropriate rounding for <strong>estimation</strong> in real‑world contexts in Qatar and justify the choice.</li>
          </ul>
          <div class="mt-2 text-sm text-gray-600">Optional investigation: compare Half‑Up vs Ties‑to‑Even (banker’s rounding) and discuss fairness.</div>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon">Success Criteria</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>I can <em>identify</em> the rounding digit and decide up/down correctly.</li>
            <li>I can <em>explain</em> why a rounded value implies an interval of possible true values.</li>
            <li>I can <em>choose</em> a rounding unit that keeps results reasonable for a given purpose.</li>
            <li>I can <em>analyze</em> the impact of rounding on sums/totals (round then sum vs sum then round).</li>
          </ul>
          <div class="hint mt-3">Tip: We always use the **school standard** Half‑Up rule. We will only toggle banker’s rounding when investigating tie‑cases.</div>
        </div>
      </div>
      <div class="card p-4 mt-4 w-full max-w-5xl intro">
        <strong>How today works:</strong> Explore ➜ Explain ➜ Apply ➜ Reflect. You’ll see a short explainer before each activity, then you’ll try, compare, and discuss.
      </div>
    </section>

    <!-- 1 • Learning Objectives & Keywords -->
    <section class="slide" id="loSlide">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Learning Objectives &amp; Keywords</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Objectives</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Round to a specified place (nearest 10, 100, 0.1, 0.01, …) using Half‑Up.</li>
            <li>Round to a given number of <strong>significant figures</strong> and in <strong>scientific notation</strong>.</li>
            <li>Interpret a rounded value’s <strong>bounds</strong> (interval of possible true values).</li>
            <li>Choose suitable rounding for <strong>estimation</strong> in real‑world contexts and justify reasonableness.</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords (tap for quick defs)</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="halfup">half‑up rounding</span>
            <span class="chip" data-key="place">place value</span>
            <span class="chip" data-key="rounddigit">rounding digit</span>
            <span class="chip" data-key="dp">decimal places (dp)</span>
            <span class="chip" data-key="sf">significant figures (s.f.)</span>
            <span class="chip" data-key="sci">scientific notation</span>
            <span class="chip" data-key="bounds">bounds / error interval</span>
            <span class="chip" data-key="midpoint">midpoint (tie)</span>
            <span class="chip" data-key="estimate">estimation</span>
          </div>
          <p class="text-xs text-gray-500 mt-3">Half‑Up rule: a trailing 5 rounds <strong>away from 0</strong> (e.g., \(-1.5\to -2\)).</p>
        </div>
      </div>
    </section>

    <!-- 2 • Warm‑up (with pre‑activity explanation) -->
    <section class="slide" id="warmSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Warm‑Up: Decide Fast!</h2>
      <div class="card p-4 w-full max-w-5xl intro">
        <p><strong>Why this matters:</strong> We practice identifying the rounding digit and the next digit quickly. Speed comes from *method*, not guessing.</p>
        <p class="mt-1"><strong>How to do it:</strong> Mark the rounding digit → look one digit right → decide up/down (5–9 up; 0–4 stays). For negatives, at 5 we go **away from 0**.</p>
        <p class="mt-1"><strong>Common pitfalls:</strong> Forgetting commas; misreading \(-2.5\); mixing decimal places with significant figures.</p>
      </div>
      <div class="grid md:grid-cols-3 gap-4 w-full max-w-5xl mt-3">
        <div class="card p-4 text-left">
          <div class="font-bold text-maroon mb-1">Nearest hundred</div>
          <div class="text-xl">\( 12{,}649 \) → <input id="w1" class="border rounded px-2 py-1 w-32" placeholder="e.g., 12,600"></div>
        </div>
        <div class="card p-4 text-left">
          <div class="font-bold text-maroon mb-1">1 decimal place</div>
          <div class="text-xl">\( 7.45 \) → <input id="w2" class="border rounded px-2 py-1 w-24" placeholder="7.5"></div>
        </div>
        <div class="card p-4 text-left">
          <div class="font-bold text-maroon mb-1">Nearest integer (negative)</div>
          <div class="text-xl">\( -2.5 \) → <input id="w3" class="border rounded px-2 py-1 w-24" placeholder="-3"></div>
        </div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="warmCheck" class="btn maroon">Check</button>
        <button id="warmReset" class="btn">Reset</button>
      </div>
      <div id="warmFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- 3 • Place Value & Rule (with settings + intro) -->
    <section class="slide" id="placeSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Place Value &amp; The Rounding Rule</h2>
      <div class="card p-4 w-full max-w-5xl intro">
        <p><strong>Why this matters:</strong> Accurate rounding begins with reading the number by <em>place value</em> and choosing the <em>rounding digit</em> correctly.</p>
        <p class="mt-1"><strong>Try this:</strong> Highlight the rounding digit, then the digit to its right. Decide up/down with Half‑Up. Optionally, toggle banker’s rounding to see how “ties” behave differently.</p>
      </div>
      <div class="grid lg:grid-cols-2 gap-6 w-full max-w-5xl text-left mt-2">
        <div class="card p-5">
          <div class="flex flex-wrap items-center gap-3">
            <label class="chip">Mode:
              <select id="modeSelect" class="border rounded px-2 py-1">
                <option value="half">Half‑Up (school standard)</option>
                <option value="even">Ties‑to‑Even (investigation)</option>
              </select>
            </label>
            <span class="text-sm text-gray-600">Switching mode changes only how <em>ties</em> (e.g., 2.5) behave.</span>
          </div>
          <p class="mb-2 mt-2">Highlight the rounding digit and the next digit (to decide up/down).</p>
          <div class="text-2xl" id="pvNumber" aria-live="polite"></div>
          <div class="mt-2 flex items-center gap-3">
            <label>Round to:</label>
            <select id="pvPlace" class="border rounded px-2 py-1">
              <option value="1">ones</option>
              <option value="10">tens</option>
              <option value="100">hundreds</option>
              <option value="1000">thousands</option>
              <option value="0.1">tenths (1 dp)</option>
              <option value="0.01" selected>hundredths (2 dp)</option>
              <option value="0.001">thousandths (3 dp)</option>
            </select>
            <button id="pvNew" class="btn">New number</button>
          </div>
          <div class="mt-2">Result: <span id="pvResult" class="font-bold"></span></div>
          <div class="hint mt-3 text-sm">Rule: look at the digit **to the right**. If it’s 5–9, increase the rounding digit by 1; if 0–4, keep it the same. For negatives, “away from 0” at 5.</div>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Examples</h3>
          <div class="space-y-2 text-lg" id="pvExamples">
            <div>\( 246.38 \) to 1 dp → \( 246.4 \)</div>
            <div>\( 7{,}950 \) to nearest thousand → \( 8{,}000 \)</div>
            <div>\( -12.5 \) to integer → \( -13 \)</div>
          </div>
          <p class="mt-2 text-sm text-gray-600">Investigate: In Ties‑to‑Even mode, \(2.5\to 2\), \(3.5\to 4\). Why might banks prefer this?</p>
        </div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="pvExportCSV" class="btn">Export CSV</button>
        <button id="pvExportJSON" class="btn">Export JSON</button>
      </div>
    </section>

    <!-- 4 • Rounding Explorer (Number Line) -->
    <section class="slide" id="lineSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Rounding Explorer (Number Line)</h2>
      <div class="card p-4 w-full max-w-5xl intro">
        <p><strong>Why this matters:</strong> Rounding is choosing the nearest multiple of a unit \(u\). Midpoints (like 23.45 when \(u=0.1\)) create the tie rule.</p>
        <p class="mt-1"><strong>How to read it:</strong> The dashed lines mark the half‑unit boundaries. The gold dot shows the rounded value.</p>
      </div>
      <div class="nl-wrap mt-2"><canvas id="roundLine" class="nline" aria-label="Rounding number line"></canvas></div>
      <div class="mt-3 flex flex-wrap items-center gap-3 text-sm">
        <label class="chip">x = <input id="lineX" class="border rounded px-2 py-1 w-28" value="23.47" aria-label="x value"></label>
        <label class="chip">unit = 
          <select id="lineUnit" class="border rounded px-2 py-1" aria-label="unit">
            <option value="1">1 (nearest integer)</option>
            <option value="0.1" selected>0.1 (1 dp)</option>
            <option value="0.01">0.01 (2 dp)</option>
            <option value="10">10 (nearest 10)</option>
            <option value="100">100 (nearest 100)</option>
          </select>
        </label>
        <span class="chip">rounded = <b id="lineOut">23.5</b></span>
        <button id="lineRand" class="btn">Randomize</button>
        <button id="lineExportCSV" class="btn">Export CSV</button>
        <button id="lineExportJSON" class="btn">Export JSON</button>
      </div>
    </section>

    <!-- 5 • Practice Generator (multi sets) -->
    <section class="slide" id="pracSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Practice Generator</h2>
      <div class="card p-4 w-full max-w-5xl intro">
        <p><strong>How to use:</strong> Pick a level, generate a set, answer, and check. Then generate a fresh set (A/B/C) and compare your own accuracy and speed.</p>
      </div>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="flex flex-wrap items-center gap-3">
          <span>Level:</span>
          <select id="prLevel" class="border rounded px-2 py-1">
            <option value="easy">easy (nearest 10/100, 1 dp)</option>
            <option value="med" selected>medium (−numbers, 2–3 dp)</option>
            <option value="hard">hard (mixed places)</option>
            <option value="expert">expert (mixed incl. sig figs)</option>
          </select>
          <span>Set:</span>
          <select id="prSet" class="border rounded px-2 py-1">
            <option value="A" selected>A</option>
            <option value="B">B</option>
            <option value="C">C</option>
          </select>
          <button id="prNew" class="btn">New set</button>
        </div>
        <div id="prList" class="grid md:grid-cols-2 gap-3 mt-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="prCheck" class="btn maroon">Check</button>
          <button id="prExportCSV" class="btn">Export CSV</button>
          <button id="prExportJSON" class="btn">Export JSON</button>
        </div>
        <div id="prFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 6 • Significant Figures -->
    <section class="slide" id="sigSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Significant Figures</h2>
      <div class="card p-4 w-full max-w-5xl intro">
        <p><strong>Idea:</strong> Significant figures measure <em>precision</em>. Leading zeros do not count; zeros between non‑zeros do; trailing zeros count only if there’s a decimal point.</p>
        <p class="mt-1"><strong>Strategy:</strong> Convert to scientific notation mentally; then counting s.f. becomes the count of digits in the mantissa.</p>
      </div>
      <div class="grid lg:grid-cols-2 gap-6 w-full max-w-5xl text-left">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Count s.f.</h3>
          <div id="sigCountList" class="grid gap-2"></div>
          <div class="mt-3 flex gap-2">
            <button id="sigCountNew" class="btn">New set</button>
            <button id="sigCountCheck" class="btn maroon">Check</button>
            <button id="sigCountCSV" class="btn">Export CSV</button>
            <button id="sigCountJSON" class="btn">Export JSON</button>
          </div>
          <div id="sigCountFb" class="mt-2 h-6 font-semibold"></div>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Round to n s.f.</h3>
          <div id="sigRoundList" class="grid gap-2"></div>
          <div class="mt-3 flex gap-2">
            <button id="sigRoundNew" class="btn">New set</button>
            <button id="sigRoundCheck" class="btn maroon">Check</button>
            <button id="sigRoundCSV" class="btn">Export CSV</button>
            <button id="sigRoundJSON" class="btn">Export JSON</button>
          </div>
          <div id="sigRoundFb" class="mt-2 h-6 font-semibold"></div>
        </div>
      </div>
      <div class="hint mt-3 text-sm">Rules: ignore **leading zeros**; zeros **between** non‑zeros count; **trailing zeros** count only if there’s a decimal point (e.g., \(1200\) has 2 s.f.; \(1200.\) has 4 s.f.).</div>
    </section>

    <!-- 7 • Scientific Notation -->
    <section class="slide" id="sciSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Scientific Notation (Round the Mantissa)</h2>
      <div class="card p-4 w-full max-w-5xl intro">
        <p><strong>Why:</strong> Scientific notation communicates scale and precision together. We round the mantissa and adjust the exponent if needed.</p>
      </div>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div id="sciList" class="grid md:grid-cols-2 gap-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="sciNew" class="btn">New set</button>
          <button id="sciCheck" class="btn maroon">Check</button>
          <button id="sciCSV" class="btn">Export CSV</button>
          <button id="sciJSON" class="btn">Export JSON</button>
        </div>
        <div id="sciFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 8 • Bounds / Error Intervals -->
    <section class="slide" id="boundSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Bounds (Error Intervals)</h2>
      <div class="card p-4 w-full max-w-5xl intro">
        <p><strong>Key idea:</strong> If \(x\) rounds to \(r\) to unit \(u\), then \(x\in[\,r-\tfrac{u}{2},\,r+\tfrac{u}{2}\,)\). Bounds explain what the rounded number could mean in reality.</p>
        <p class="mt-1"><strong>Move:</strong> Given a reported value and unit, write the lower and upper bounds.</p>
      </div>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div id="bdList" class="grid md:grid-cols-2 gap-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="bdNew" class="btn">New set</button>
          <button id="bdCheck" class="btn maroon">Check</button>
          <button id="bdCSV" class="btn">Export CSV</button>
          <button id="bdJSON" class="btn">Export JSON</button>
        </div>
        <div id="bdFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 9 • Qatar Data Lab (student-centered exploration) -->
    <section class="slide" id="qatarLabSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Qatar Data Lab — Rounding Policies</h2>
      <div class="card p-4 w-full max-w-5xl intro">
        <p><strong>Your task:</strong> Choose rounding policies for a real‑world dataset from Qatar. Compare <em>Round‑Then‑Sum</em> vs <em>Sum‑Then‑Round</em>. Explain which policy is fair/appropriate and why.</p>
        <p class="mt-1"><strong>Datasets:</strong> Souq Waqif shopping (cash: 0.05 QAR), Fuel purchase (litres & QAR), Doha Metro travel times, Stadium attendance.</p>
      </div>
      <div class="card p-5 w-full max-w-5xl">
        <div class="flex flex-wrap items-center gap-3">
          <label>Dataset:
            <select id="dsSelect" class="border rounded px-2 py-1">
              <option value="souq">Souq Waqif (cash rounding to 0.05 QAR)</option>
              <option value="fuel">Fuel station (litres & cost)</option>
              <option value="metro">Doha Metro (travel times)</option>
              <option value="match">Match attendance (counts)</option>
            </select>
          </label>
          <label>Rounding mode:
            <select id="labMode" class="border rounded px-2 py-1">
              <option value="half">Half‑Up</option>
              <option value="even">Ties‑to‑Even</option>
            </select>
          </label>
          <button id="dsNew" class="btn">New data</button>
        </div>

        <div class="mt-3 overflow-auto">
          <table class="tbl" id="dsTable" aria-label="Dataset table"></table>
        </div>

        <div class="grid md:grid-cols-2 gap-4 mt-3">
          <div class="card p-4">
            <h4 class="font-bold text-maroon mb-1">Policy (column units)</h4>
            <div id="dsUnits" class="grid gap-2 text-sm"></div>
            <div class="hint mt-2 text-sm">Cash often rounds to <strong>0.05 QAR</strong> if coins are limited; times may round to the nearest minute or 5 minutes.</div>
          </div>
          <div class="card p-4">
            <h4 class="font-bold text-maroon mb-1">Compare Totals</h4>
            <div class="text-sm">Round‑Then‑Sum total: <b id="rtsOut">—</b></div>
            <div class="text-sm">Sum‑Then‑Round total: <b id="strOut">—</b></div>
            <div class="text-sm mt-1">Absolute error: <b id="absErr">—</b> &nbsp;|&nbsp; Relative error: <b id="relErr">—</b></div>
            <div class="mt-2">
              <button id="dsCompute" class="btn maroon">Compute</button>
              <button id="dsExportCSV" class="btn">Export CSV</button>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <div class="hint">
            <strong>Explain:</strong> Which policy is most appropriate for this context and why? Consider fairness, predictability, and error size. Write 2–3 sentences.
          </div>
        </div>
      </div>
    </section>

    <!-- 10 • Real‑World Practice (Qatar‑focused) -->
    <section class="slide" id="realSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Real‑World Practice (Qatar)</h2>
      <div class="card p-4 w-full max-w-5xl intro">
        <p><strong>Apply:</strong> Solve mixed, Qatar‑flavoured tasks (currency, population, distance, time). Choose appropriate units (nearest 0.05 QAR? minute? hundred thousand?).</p>
      </div>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div id="realList" class="grid md:grid-cols-2 gap-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="realNew" class="btn">New set</button>
          <button id="realCheck" class="btn maroon">Check</button>
          <button id="realCSV" class="btn">Export CSV</button>
          <button id="realJSON" class="btn">Export JSON</button>
        </div>
        <div id="realFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 11 • MCQ Bank (multi sets with explanations) -->
    <section class="slide" id="mcqSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">MCQ Bank — Check Your Understanding</h2>
      <div class="card p-4 w-full max-w-5xl intro">
        <p><strong>Use:</strong> Choose Set A/B/C, answer all, then reveal explanations. Discuss any items you missed—What concept tripped you?</p>
      </div>
      <div class="card p-5 w-full max-w-5xl mcq">
        <div class="flex items-center gap-3">
          <label>Set:
            <select id="mcqSet" class="border rounded px-2 py-1">
              <option value="A" selected>A</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
          </label>
          <button id="mcqNew" class="btn">Load set</button>
          <button id="mcqCheck" class="btn maroon">Check</button>
          <button id="mcqExplain" class="btn">Show explanations</button>
        </div>
        <div id="mcqList" class="grid md:grid-cols-2 gap-3 mt-3"></div>
        <div id="mcqFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 12 • Challenge Mode -->
    <section class="slide" id="challengeSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Challenge Mode</h2>
      <div class="card p-4 w-full max-w-5xl intro">
        <p><strong>Goal:</strong> Build a streak. Questions adapt across units, s.f., scientific notation, and bounds. Use hints wisely.</p>
      </div>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="flex items-center gap-3">
          <span>Level:</span>
          <select id="chLevel" class="border rounded px-2 py-1">
            <option value="easy">easy</option>
            <option value="med" selected>medium</option>
            <option value="hard">hard</option>
            <option value="expert">expert</option>
          </select>
          <button id="chNew" class="btn">New question</button>
          <span class="chip">Streak: <b id="streakOut">0</b></span>
          <button id="chCSV" class="btn">Export CSV</button>
          <button id="chJSON" class="btn">Export JSON</button>
        </div>
        <div class="mt-3 text-2xl">Task: <span id="chText" class="font-extrabold"></span></div>
        <div class="mt-2">
          <input id="chAns" class="border rounded px-3 py-2 w-60" placeholder="answer" aria-label="challenge answer"/>
          <button id="chCheck" class="btn maroon">Check</button>
          <button id="chHint" class="btn">Hint</button>
        </div>
        <div id="chHintBox" class="mt-3 text-sm"></div>
        <div id="chFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 13 • Exit ticket -->
    <section class="slide" id="exitSlide">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Exit Ticket</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">3–2–1 Reflect</h3>
          <ul class="list-disc list-inside">
            <li>3 rounding skills you used (place, s.f., bounds)</li>
            <li>2 contexts where rounding was helpful</li>
            <li>1 mistake you will avoid next time</li>
          </ul>
          <div class="mt-3">
            <label class="block text-sm text-gray-700">Confidence after today (0–10):</label>
            <input id="confSlider" type="range" min="0" max="10" step="1" class="w-full"/>
            <div>Confidence: <b id="confOut">5</b>/10</div>
          </div>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">Up Next</h3>
          <p>Estimation in multi‑step calculations and percent error comparisons.</p>
          <div class="mt-3 text-sm text-gray-600">Optional prep: Bring one example from daily life in Qatar where rounding mattered (bill, travel time, measurement).</div>
        </div>
      </div>
      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-[88%] h-[100px] banner rounded-md" style="background-image:url('../assets/qla_banner.png')"></div>
    </section>

  </div>
</div>

<!-- Controls -->
<div id="controls" role="group" aria-label="Slideshow controls">
  <button id="prev" title="Previous (←)">&laquo;</button>
  <button id="fs" title="Toggle Fullscreen (F)">⤢</button>
  <div id="counter">1 / 14</div>
  <button id="next" title="Next (→)">&raquo;</button>
  <button id="gear" title="Settings (Rounding Mode)">⚙</button>
</div>
<div id="progress"></div>

<!-- Glossary popover (quick chip tap) -->
<div id="pop" role="dialog" aria-modal="true" aria-live="polite">
  <span class="close" title="Close">✕</span>
  <div id="popBody"></div>
</div>

<!-- Glossary Drawer -->
<aside id="drawer" aria-label="Glossary drawer" aria-hidden="true">
  <header class="flex items-center justify-between">
    <div class="font-bold text-maroon">Glossary • المصطلحات</div>
    <button id="drawerClose" class="btn">Close</button>
  </header>
  <div class="body">
    <div class="mb-2 flex gap-2">
      <input id="kwSearch" class="border rounded px-2 py-1 w-full" placeholder="Search keyword… / ابحث عن مصطلح…"/>
      <select id="langSelect" class="border rounded px-2 py-1">
        <option value="en" selected>EN</option>
        <option value="ar">AR</option>
      </select>
    </div>
    <div id="kwList"></div>
  </div>
</aside>

<!-- Settings pop -->
<div id="settings" role="dialog" aria-modal="true" aria-live="polite" aria-label="Settings">
  <div class="row"><strong class="text-maroon">Settings</strong> <span class="badge">lesson</span></div>
  <div class="row">
    <label>Rounding mode:</label>
    <select id="setMode" class="border rounded px-2 py-1">
      <option value="half">Half‑Up (school standard)</option>
      <option value="even">Ties‑to‑Even (investigation)</option>
    </select>
  </div>
  <div class="row">
    <label>Glossary language:</label>
    <select id="setLang" class="border rounded px-2 py-1">
      <option value="en">EN</option>
      <option value="ar">AR</option>
    </select>
  </div>
  <div class="row justify-end">
    <button id="settingsClose" class="btn">Close</button>
  </div>
</div>

<script>
/* ========================= Core Helpers & State ========================= */
(function(){
  const slides=[...document.querySelectorAll('.slide')];
  const prev=id('prev'), next=id('next'), counter=id('counter'), progress=id('progress'), fsBtn=id('fs'), gear=id('gear');
  const deckTitle='G8_Unit1_L4_Rounding_QLA_Enhanced';
  let i=0;

  const State = {
    mode: 'half', // 'half' | 'even'
    lang: 'en'
  };

  function id(x){return document.getElementById(x)}
  function renderMath(root=document){ if(window._rerenderMath) window._rerenderMath(root); }
  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
  function confetti(x=window.innerWidth/2,y=window.innerHeight/2){
    for(let k=0;k<24;k++){
      const d=document.createElement('div'); d.className='confetti';
      d.style.left=x+'px'; d.style.top=y+'px'; d.style.width='8px'; d.style.height='8px';
      d.style.background=['#6C1D45','#C7A34F','#E8D5B7','#8a3d64'][k%4];
      document.body.appendChild(d);
      const dx=(Math.random()*2-1)*240, dy=(Math.random()*-1-0.3)*300, rot=Math.random()*720;
      d.animate([{transform:'translate(0,0) rotate(0deg)'},{transform:`translate(${dx}px,${dy}px) rotate(${rot}deg)`,opacity:0}],
                {duration:900+Math.random()*700,easing:'cubic-bezier(.2,.8,.2,1)'}).onfinish=()=>d.remove();
    }
  }
  const EPS=1e-12;

  // Export helpers
  function downloadJSON(filename, data){
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function downloadCSV(filename, rows){
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function pretty(x, dp=2){ return Number(x.toFixed(dp)).toLocaleString(); }

  /* ---------- Navigation ---------- */
  function show(k){
    i=(k+slides.length)%slides.length;
    slides.forEach((s,idx)=>s.classList.toggle('active',idx===i));
    counter.textContent=(i+1)+' / '+slides.length;
    progress.style.width=((i+1)/slides.length*100)+'%';
    const sid=slides[i].id||'';
    if(sid==='lineSlide') drawRoundLine();
    if(sid==='placeSlide') renderPV();
    if(sid==='qatarLabSlide') renderDataset();
    renderMath(slides[i]);
  }
  prev.addEventListener('click',()=>show(i-1));
  next.addEventListener('click',()=>show(i+1));
  document.addEventListener('keydown',e=>{
    if(e.key==='ArrowRight') show(i+1);
    if(e.key==='ArrowLeft') show(i-1);
    if(e.key.toLowerCase()==='f') toggleFS();
    if(e.key.toLowerCase()==='g') toggleDrawer(true);
  });
  function toggleFS(){
    const el=id('slides');
    if(!document.fullscreenElement){(el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el);}
    else{(document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen).call(document);}
  }
  fsBtn.addEventListener('click',toggleFS);

  /* ========================= Rounding Core ========================= */
  function isTie(q){
    const k=Math.floor(q);
    return Math.abs(q - (k+0.5))<EPS;
  }
  function roundIntHalfUp(q){
    // symmetric half-up to nearest integer
    const s=q>=0?1:-1, a=Math.abs(q);
    const k=Math.floor(a+0.5);
    return s*k;
  }
  function roundIntTiesToEven(q){
    const k=Math.floor(q);
    if(Math.abs(q-(k+0.5))<EPS){
      // choose even among k and k+1
      return (k%2===0)? k : k+1;
    }
    return Math.round(q); // JS rounds ties away from 0, but we excluded ties
  }
  function roundToUnitMode(x,u,mode){
    const q=x/u;
    let n;
    if(mode==='even') n=roundIntTiesToEven(q);
    else n=roundIntHalfUp(q);
    return n*u;
  }
  function roundHalfUpToUnit(x,u){ return roundToUnitMode(x,u,'half'); }
  function roundToDP(x,dp){ const u=10**(-dp); return roundToUnitMode(x,u,State.mode); }
  function roundToPlace(x,u){ return roundToUnitMode(x,u,State.mode); }
  function decPlacesFromUnit(u){ if(u>=1) return 0; const p=Math.round(Math.log10(1/u)); return Math.max(0,p); }
  function fmtToUnit(x,u){
    const dp=decPlacesFromUnit(u);
    return (Math.round(x*10**dp)/10**dp).toFixed(dp).replace(/\B(?=(\d{3})+(?!\d))/g,',');
  }
  function roundToSig(x,n){
    if(x===0) return 0;
    const s = x<0? -1: 1, ax=Math.abs(x), k=Math.floor(Math.log10(ax)), scale=10**(k-n+1);
    return s*roundToUnitMode(ax, scale, State.mode);
  }
  function sciRound(m,e,n){
    let r = roundToSig(m, n);
    if(Math.abs(r)>=10){ r = r/10; e += 1; }
    return {m:r,e};
  }

  /* ========================= Glossary (chips + drawer) ========================= */
  const POP=id('pop'), POP_BODY=id('popBody');
  const GLOS={
    halfup:{en:'<strong>Half‑up rounding</strong>: 5–9 rounds away from 0; 0–4 toward 0 (symmetric for negatives).', ar:'<strong>التقريب نصف لأعلى</strong>: الأعداد التي تنتهي بـ 5 إلى 9 تُقَرَّب بعيداً عن الصفر، و0 إلى 4 نحو الصفر.'},
    place:{en:'<strong>Place value</strong>: ones, tens, hundreds, tenths, hundredths, …', ar:'<strong>القيمة المكانية</strong>: الآحاد، العشرات، المئات، الأعشار، المئات…'},
    rounddigit:{en:'<strong>Rounding digit</strong>: the digit you change (or keep) when rounding to a place or s.f.', ar:'<strong>رقم التقريب</strong>: الرقم الذي نعدِّله (أو نثبته) عند التقريب.'},
    dp:{en:'<strong>Decimal places</strong>: digits to the right of the decimal point.', ar:'<strong>الخانات العشرية</strong>: الأرقام على يمين الفاصلة العشرية.'},
    sf:{en:'<strong>Significant figures</strong>: digits conveying precision; leading zeros don’t count; trailing zeros count only if a decimal point is shown.', ar:'<strong>الأرقام المهمة</strong>: تقيس الدقة؛ الأصفار البادئة لا تُعد، والأصفار اللاحقة تُعد إذا وُجدت فاصلة عشرية.'},
    sci:{en:'<strong>Scientific notation</strong>: \( a\\times 10^n \) with \(1\\le |a|<10\\).', ar:'<strong>الترميز العلمي</strong>: ‎\(a\\times 10^n\\) بحيث \(1\\le |a|<10\\).'},
    bounds:{en:'<strong>Bounds</strong>: all possible true values for a rounded number: \( [r-\\tfrac{u}{2},\\, r+\\tfrac{u}{2}) \).', ar:'<strong>الحدود (نطاق الخطأ)</strong>: مجموعة القيم الحقيقية الممكنة بعد التقريب.'},
    midpoint:{en:'<strong>Midpoint</strong>: the half‑unit boundary between two rounding targets; tie cases live here.', ar:'<strong>نقطة المنتصف</strong>: حد نصف الوحدة بين قيمتين محتملتين للتقريب.'},
    estimate:{en:'<strong>Estimation</strong>: choosing rounding that simplifies computation while staying reasonable.', ar:'<strong>التقدير</strong>: اختيار تقريبات تُسهِّل الحساب مع الحفاظ على المعقولية.'}
  };
  POP.querySelector('.close').addEventListener('click',()=>POP.style.display='none');
  document.addEventListener('click',e=>{
    const el=e.target.closest('.chip[data-key]'); if(el){const key=el.dataset.key; if(GLOS[key]){POP_BODY.innerHTML=GLOS[key][State.lang]||GLOS[key].en; POP.style.display='block'; const r=el.getBoundingClientRect(); POP.style.left=Math.min(r.left, window.innerWidth-POP.offsetWidth-20)+'px'; POP.style.bottom=(window.innerHeight-r.top+10)+'px';}}
  });

  // Drawer
  const drawer=id('drawer'), glossBtn=id('glossBtn'), drawerClose=id('drawerClose'), kwSearch=id('kwSearch'), langSelect=id('langSelect'), kwList=id('kwList');
  glossBtn.addEventListener('click',()=>toggleDrawer(true));
  drawerClose.addEventListener('click',()=>toggleDrawer(false));
  function toggleDrawer(open){ drawer.classList.toggle('open',open); drawer.setAttribute('aria-hidden', String(!open)); if(open){ renderKW(); kwSearch.focus(); } }
  langSelect.addEventListener('change',()=>{ State.lang=langSelect.value; renderKW(); });
  function renderKW(filter=''){
    const L=State.lang; kwList.innerHTML='';
    Object.entries(GLOS).forEach(([k,obj])=>{
      const txt=(obj[L]||obj.en).toLowerCase(); if(filter && !txt.includes(filter.toLowerCase())) return;
      const box=document.createElement('div'); box.className='kw';
      box.innerHTML=`<h4>${label(k)} <small class="badge">${L==='ar'?'AR':'EN'}</small></h4>
        <div class="mt-1">${obj[L]||obj.en}</div>
        <div class="quiz">
          <em>Quick check:</em> Type a short example or meaning → 
          <input class="kwTry border rounded px-2 py-1 w-48" placeholder="${L==='ar'?'مثال / معنى':'example / meaning'}"/>
          <button class="btn btn-sm" style="padding:.3rem .6rem">Save</button>
        </div>`;
      kwList.appendChild(box);
    });
  }
  function label(k){
    const names={halfup:'Half‑Up Rounding',place:'Place Value',rounddigit:'Rounding Digit',dp:'Decimal Places (dp)',sf:'Significant Figures (s.f.)',sci:'Scientific Notation',bounds:'Bounds / Error Interval',midpoint:'Midpoint (Tie)',estimate:'Estimation'};
    return names[k]||k;
  }
  kwSearch.addEventListener('input',e=>renderKW(e.target.value));

  /* ========================= Settings Panel ========================= */
  const settings=id('settings'), settingsClose=id('settingsClose'), setMode=id('setMode'), setLang=id('setLang'), modeSelect=id('modeSelect');
  gear.addEventListener('click',()=>{ setMode.value=State.mode; setLang.value=State.lang; settings.style.display='block'; });
  settingsClose.addEventListener('click',()=>settings.style.display='none');
  setMode.addEventListener('change',()=>{ State.mode=setMode.value; modeSelect.value=State.mode; renderPV(); drawRoundLine(); });
  setLang.addEventListener('change',()=>{ State.lang=setLang.value; langSelect.value=State.lang; });

  /* ========================= Warm-up ========================= */
  id('warmCheck').addEventListener('click',()=>{
    const v1=id('w1').value.replace(/,/g,''); const ok1 = (Number(v1)===12600);
    const ok2 = Math.abs(Number(id('w2').value)-7.5)<1e-10;
    const want3 = (State.mode==='even')? -2 : -3; // tie behavior for -2.5
    const ok3 = (Number(id('w3').value)===want3);
    const score=(ok1?1:0)+(ok2?1:0)+(ok3?1:0);
    id('warmFb').textContent = score===3 ? '✅ Great start!' : `Score: ${score}/3`;
    id('w1').style.borderColor=ok1?'#22c55e':'#ef4444';
    id('w2').style.borderColor=ok2?'#22c55e':'#ef4444';
    id('w3').style.borderColor=ok3?'#22c55e':'#ef4444';
    if(score===3) confetti();
  });
  id('warmReset').addEventListener('click',()=>{['w1','w2','w3'].forEach(x=>{id(x).value=''; id(x).style.borderColor='#e5e7eb'}); id('warmFb').textContent='';});

  /* ========================= Place Value Lens ========================= */
  const pvState={x:246.38,u:0.01};
  function newPV(){
    const sign=Math.random()<0.2?-1:1;
    const int = Math.floor(Math.random()*900)+100; // 100..999
    const dp = Math.floor(Math.random()*3)+1;      // 1..3
    const frac = Math.floor(Math.random()*(10**dp));
    pvState.x = sign*(int + frac/10**dp);
    renderPV();
  }
  function renderPV(){
    id('modeSelect').value=State.mode;
    const [whole, frac=''] = Math.abs(pvState.x).toString().split('.');
    const sign = pvState.x<0 ? '−' : '';
    const u = Number(id('pvPlace').value);
    pvState.u = u;
    const dp = decPlacesFromUnit(u);
    let display='';
    if(u>=1){
      const idx = whole.length - Math.log10(u) - 1;
      const ridx = Math.round(idx);
      for(let j=0;j<whole.length;j++){
        const cls = (j===ridx)?'bg-yellow-200 tok':'tok';
        display += `<span class="${cls}">${whole[j]}</span>`;
      }
      if(frac.length) display += `<span class="tok">.</span>${[...frac].map(c=>`<span class="tok">${c}</span>`).join('')}`;
    }else{
      const need = decPlacesFromUnit(u);
      for(let j=0;j<whole.length;j++){ display += `<span class="tok">${whole[j]}</span>`}
      display += `<span class="tok">.</span>`;
      for(let j=0;j<Math.max(frac.length,need+1);j++){
        const d = frac[j] || '0';
        const cls = (j===need-1)?'bg-yellow-200 tok':'tok';
        display += `<span class="${cls}">${d}</span>`;
      }
    }
    id('pvNumber').innerHTML = `${sign}${display}`;
    const y = roundToUnitMode(pvState.x, u, State.mode);
    id('pvResult').textContent = fmtToUnit(y,u);
    renderMath(id('placeSlide'));
  }
  id('pvPlace').addEventListener('change',renderPV);
  id('pvNew').addEventListener('click',newPV);
  id('modeSelect').addEventListener('change',e=>{ State.mode=e.target.value; setMode.value=State.mode; renderPV(); drawRoundLine(); });
  id('pvExportCSV').addEventListener('click',()=>downloadCSV(`${deckTitle}_placevalue.csv`, [['x','unit','mode','result'], [pvState.x, pvState.u, State.mode, fmtToUnit(roundToUnitMode(pvState.x,pvState.u,State.mode),pvState.u)]]));
  id('pvExportJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_placevalue.json`, {...pvState,mode:State.mode}));
  newPV();

  /* ========================= Number Line ========================= */
  const cL=id('roundLine'); const lineX=id('lineX'), lineUnit=id('lineUnit'), lineOut=id('lineOut');
  const lineState={x:23.47,u:0.1};
  function drawRoundLine(){
    const ctx=cL.getContext('2d'); cL.width=cL.clientWidth*devicePixelRatio; cL.height=cL.clientHeight*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
    const y=cL.clientHeight/2, m=28; ctx.clearRect(0,0,cL.clientWidth,cL.clientHeight);
    ctx.lineWidth=2; ctx.strokeStyle='#6C1D45'; ctx.beginPath(); ctx.moveTo(m,y); ctx.lineTo(cL.clientWidth-m,y); ctx.stroke();
    const u=lineState.u, x=lineState.x;
    const r=roundToUnitMode(x,u,State.mode);
    const left = Math.floor((x-4*u)/u)*u;
    ctx.font='12px Inter'; ctx.fillStyle='#555';
    for(let k=0;k<=10;k++){
      const val = left + k*u;
      const px = map(val);
      ctx.beginPath(); ctx.moveTo(px,y-10); ctx.lineTo(px,y+10); ctx.stroke();
      if(k%2===0){ ctx.fillText(fmtToUnit(val,u), px-12, y+26); }
    }
    // midpoint boundaries
    const low = r - u/2, high = r + u/2;
    ctx.strokeStyle='#C7A34F'; ctx.setLineDash([6,4]); ctx.beginPath(); ctx.moveTo(map(low),y-30); ctx.lineTo(map(low),y+30); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(map(high),y-30); ctx.lineTo(map(high),y+30); ctx.stroke(); ctx.setLineDash([]);
    // x and rounded marker
    ctx.fillStyle='#6C1D45'; ctx.beginPath(); ctx.arc(map(x),y,8,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#C7A34F'; ctx.beginPath(); ctx.arc(map(r),y,9,0,Math.PI*2); ctx.fill();
    lineOut.textContent = fmtToUnit(r,u);
    function map(val){const W=cL.clientWidth;return m+(val-(left))*((W-2*m)/(10*u));}
  }
  lineX.addEventListener('input',()=>{ lineState.x=Number(lineX.value); drawRoundLine(); });
  lineUnit.addEventListener('change',()=>{ lineState.u=Number(lineUnit.value); drawRoundLine(); });
  id('lineRand').addEventListener('click',()=>{ lineState.x = +(Math.random()*200-100).toFixed(3); lineX.value=lineState.x; drawRoundLine(); });
  id('lineExportCSV').addEventListener('click',()=>downloadCSV(`${deckTitle}_line.csv`, [['x','unit','mode','rounded'], [lineState.x,lineState.u,State.mode,fmtToUnit(roundToUnitMode(lineState.x,lineState.u,State.mode),lineState.u)]]));
  id('lineExportJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_line.json`, {x:lineState.x,unit:lineState.u,mode:State.mode,rounded:roundToUnitMode(lineState.x,lineState.u,State.mode)}));
  drawRoundLine();
  window.addEventListener('resize',()=>{ if(slides[i].id==='lineSlide') drawRoundLine(); });

  /* ========================= Practice Generator ========================= */
  const prState={items:[], set:'A'};
  const prSet=id('prSet');
  function prBuild(){
    const lv=id('prLevel').value; prState.set=prSet.value;
    const list=[];
    function task(x,unit,label){ return {type:'unit', prompt:`Round ${x} to ${label}`, x, unit, label, ans: roundToUnitMode(x,unit,State.mode), fmt:fmtToUnit(roundToUnitMode(x,unit,State.mode),unit)};}
    function taskSig(x,n){const ans=roundToSig(x,n); return {type:'sig', prompt:`Round ${x} to ${n} s.f.`, x, n, ans, fmt:ans.toPrecision(n)};}
    const seed = prState.set.charCodeAt(0)-65; // A:0,B:1,C:2
    for(let k=0;k<6;k++){
      const r = Math.random() + seed*0.11; // small deterministic shift by set
      if(lv==='easy'){
        const a = Math.floor((r%1)*900)+100;
        const unit = (r%1)<0.5?10:100;
        list.push(task(a,unit, unit===10?'nearest 10':'nearest 100'));
      }else if(lv==='med'){
        const x = +( ((r%1)*200-100).toFixed(((r%1)<0.5)?1:2) );
        const unit = ((r*7)%1)<0.5?0.1:0.01;
        list.push(task(x,unit, unit===0.1?'1 dp':'2 dp'));
      }else if(lv==='hard'){
        if(((r*5)%1)<0.5){
          const unit = [0.001,0.01,0.1,1,10,100][Math.floor(((r*19)%1)*6)];
          const x = +( ((r%1)*200-100).toFixed(unit<1?3:0) );
          const lab = unit>=1? `nearest ${unit}` : `${decPlacesFromUnit(unit)} dp`;
          list.push(task(x,unit,lab));
        }else{
          const x = +( ((r%1)*9000-4500).toFixed(3) );
          const n = [2,3,4][Math.floor(((r*13)%1)*3)];
          list.push(taskSig(x,n));
        }
      }else{ // expert
        if(((r*3)%1)<0.5){
          const x = +( ((r%1)*9000-4500).toFixed(4) );
          const n = [2,3,4][Math.floor(((r*17)%1)*3)];
          list.push(taskSig(x,n));
        }else{
          const unit = [0.001,0.01,0.1,1,10,100,1000][Math.floor(((r*23)%1)*7)];
          const x = +( ((r%1)*50000-25000).toFixed(unit<1?3:0) );
          const lab = unit>=1? `nearest ${unit}` : `${decPlacesFromUnit(unit)} dp`;
          list.push(task(x,unit,lab));
        }
      }
    }
    prState.items=list;
    const box=id('prList'); box.innerHTML='';
    list.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1} <span class="badge">${prState.set}</span></div>
        <div class="text-xl mt-1">${o.prompt} = <input class="prin border rounded px-2 py-1 w-40" placeholder="answer"></div>`;
      box.appendChild(row);
    });
  }
  id('prNew').addEventListener('click',prBuild); prSet.addEventListener('change',prBuild); prBuild();
  id('prCheck').addEventListener('click',()=>{
    let ok=0; id('prList').querySelectorAll('.card').forEach((row,idx)=>{
      const inp=row.querySelector('.prin'); const item=prState.items[idx];
      const v = Number(String(inp.value).replace(/,/g,'')); const want = item.ans;
      const good = Math.abs(v-want)<1e-10;
      inp.style.borderColor = good? '#22c55e':'#ef4444';
      if(good) ok++;
    });
    id('prFb').textContent = ok===prState.items.length? '✅ All correct!' : `Score: ${ok}/${prState.items.length}`;
    if(ok===prState.items.length) confetti();
  });
  id('prExportCSV').addEventListener('click',()=>{
    const rows=[['prompt','answer','mode']]; prState.items.forEach(o=>rows.push([o.prompt,o.fmt||o.ans,State.mode])); downloadCSV(`${deckTitle}_practice_${prState.set}.csv`, rows);
  });
  id('prExportJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_practice_${prState.set}.json`, prState.items));

  /* ========================= Significant Figures ========================= */
  const sigCState={items:[]}, sigRState={items:[]};
  function countSigStr(s){
    s = s.trim();
    if(/^0*\.?0*$/.test(s)) return 1; // zero has 1 s.f.
    const hasDot = s.includes('.');
    s = s.replace(/^[-+]/,'');
    let t = s;
    if(!hasDot){ t = t.replace(/0+$/,''); }
    t = t.replace(/^0+/,'').replace('.','');
    return t.replace(/[^0-9]/g,'').length;
  }
  function genSigCount(){
    const pool=['0.00340','1200','1200.','5.060','0.0702','30007','2.90','0.0005','40','40.0'];
    sigCState.items = pool.sort(()=>Math.random()-0.5).slice(0,4).map(s=>({s,ans:countSigStr(s)}));
    const box=id('sigCountList'); box.innerHTML='';
    sigCState.items.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-3';
      row.innerHTML=`<div class="text-xl">\\( ${o.s} \\) has <input class="scin border rounded px-2 py-1 w-20" placeholder="s.f."> s.f.</div>`;
      box.appendChild(row);
    });
    renderMath(id('sigSlide'));
  }
  function genSigRound(){
    const items=[];
    for(let k=0;k<4;k++){
      const x = +( (Math.random()*9000-1000).toFixed(4) );
      const n=[2,3,4][Math.floor(Math.random()*3)];
      const ans = roundToSig(x,n);
      items.push({x,n,ans,fmt:ans.toPrecision(n)});
    }
    sigRState.items=items;
    const box=id('sigRoundList'); box.innerHTML='';
    items.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-3';
      row.innerHTML=`<div class="text-xl">Round \\( ${o.x} \\) to ${o.n} s.f. = <input class="srin border rounded px-2 py-1 w-40" placeholder="answer"></div>`;
      box.appendChild(row);
    });
    renderMath(id('sigSlide'));
  }
  id('sigCountNew').addEventListener('click',genSigCount);
  id('sigRoundNew').addEventListener('click',genSigRound);
  genSigCount(); genSigRound();
  id('sigCountCheck').addEventListener('click',()=>{
    let ok=0; id('sigCountList').querySelectorAll('.card').forEach((row,idx)=>{
      const want=sigCState.items[idx].ans; const got=Number(row.querySelector('.scin').value);
      const good = got===want; row.querySelector('.scin').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('sigCountFb').textContent = ok===sigCState.items.length? '✅ Perfect!' : `Score: ${ok}/${sigCState.items.length}`;
    if(ok===sigCState.items.length) confetti();
  });
  id('sigRoundCheck').addEventListener('click',()=>{
    let ok=0; id('sigRoundList').querySelectorAll('.card').forEach((row,idx)=>{
      const want=sigRState.items[idx].ans; const got=Number(row.querySelector('.srin').value);
      const good=Math.abs(got-want)<1e-10; row.querySelector('.srin').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('sigRoundFb').textContent = ok===sigRState.items.length? '✅ Excellent!' : `Score: ${ok}/${sigRState.items.length}`;
    if(ok===sigRState.items.length) confetti();
  });
  id('sigCountCSV').addEventListener('click',()=>{
    const rows=[['number','sig_figs']]; sigCState.items.forEach(o=>rows.push([o.s,o.ans])); downloadCSV(`${deckTitle}_sig_count.csv`, rows);
  });
  id('sigCountJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_sig_count.json`, sigCState.items));
  id('sigRoundCSV').addEventListener('click',()=>{
    const rows=[['x','n_sf','answer']]; sigRState.items.forEach(o=>rows.push([o.x,o.n,o.fmt])); downloadCSV(`${deckTitle}_sig_round.csv`, rows);
  });
  id('sigRoundJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_sig_round.json`, sigRState.items));

  /* ========================= Scientific Notation ========================= */
  const sciState={items:[]};
  function sciNew(){
    const list=[];
    for(let k=0;k<4;k++){
      const e = Math.floor(Math.random()*7)-3; // -3..3
      const m = +( (Math.random()*9+1).toFixed(4) ); // 1..10
      const n=[2,3,4][Math.floor(Math.random()*3)];
      const r=sciRound(m,e,n);
      list.push({m,e,n,ans:r});
    }
    sciState.items=list;
    const box=id('sciList'); box.innerHTML='';
    list.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-xl">Round \\( ${o.m}\\times 10^{${o.e}} \\) to ${o.n} s.f.: mantissa = <input class="sciin border rounded px-2 py-1 w-20" placeholder="m">, exponent = <input class="sciexp border rounded px-2 py-1 w-20" placeholder="e"></div>`;
      box.appendChild(row);
    });
    renderMath(id('sciSlide'));
  }
  id('sciNew').addEventListener('click',sciNew); sciNew();
  id('sciCheck').addEventListener('click',()=>{
    let ok=0; id('sciList').querySelectorAll('.card').forEach((row,idx)=>{
      const item=sciState.items[idx]; const m=Number(row.querySelector('.sciin').value); const e=Number(row.querySelector('.sciexp').value);
      const good= Math.abs(m-item.ans.m)<1e-10 && e===item.ans.e; row.querySelector('.sciin').style.borderColor=good?'#22c55e':'#ef4444'; row.querySelector('.sciexp').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('sciFb').textContent = ok===sciState.items.length? '✅ Perfect!' : `Score: ${ok}/${sciState.items.length}`;
    if(ok===sciState.items.length) confetti();
  });
  id('sciCSV').addEventListener('click',()=>{
    const rows=[['m','e','n_sf','m_ans','e_ans']]; sciState.items.forEach(o=>rows.push([o.m,o.e,o.n,o.ans.m,o.ans.e])); downloadCSV(`${deckTitle}_scientific.csv`, rows);
  });
  id('sciJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_scientific.json`, sciState.items));

  /* ========================= Bounds ========================= */
  const bdState={items:[]};
  function bdNew(){
    const list=[];
    for(let k=0;k<4;k++){
      const unit=[0.001,0.01,0.1,1,10,100][Math.floor(Math.random()*6)];
      const x = +( (Math.random()*1000-500).toFixed(unit<1?3:0) );
      const r = roundToUnitMode(x,unit,State.mode);
      const lb = r - unit/2, ub = r + unit/2;
      const label = unit>=1? `nearest ${unit}` : `${decPlacesFromUnit(unit)} dp`;
      list.push({r,unit,lb,ub,label});
    }
    bdState.items=list;
    const box=id('bdList'); box.innerHTML='';
    list.forEach((o,idx)=>{
      const dp=decPlacesFromUnit(o.unit);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1}</div>
        <div class="mt-1">A measurement is reported as <b>${fmtToUnit(o.r,o.unit)}</b> (${o.label}). Give the bounds for the true value \(x\):</div>
        <div class="mt-1">Lower bound: <input class="bdlb border rounded px-2 py-1 w-32" placeholder="${(o.lb).toFixed(dp)}">, Upper bound: <input class="bdub border rounded px-2 py-1 w-32" placeholder="${(o.ub).toFixed(dp)}"></div>`;
      box.appendChild(row);
    });
    renderMath(id('boundSlide'));
  }
  id('bdNew').addEventListener('click',bdNew); bdNew();
  id('bdCheck').addEventListener('click',()=>{
    let ok=0; id('bdList').querySelectorAll('.card').forEach((row,idx)=>{
      const item=bdState.items[idx]; const lb=Number(row.querySelector('.bdlb').value); const ub=Number(row.querySelector('.bdub').value);
      const good = Math.abs(lb-item.lb)<1e-10 && Math.abs(ub-item.ub)<1e-10;
      row.querySelector('.bdlb').style.borderColor=good?'#22c55e':'#ef4444';
      row.querySelector('.bdub').style.borderColor=good?'#22c55e':'#ef4444';
      if(good) ok++;
    });
    id('bdFb').textContent = ok===bdState.items.length? '✅ Excellent!' : `Score: ${ok}/${bdState.items.length}`;
    if(ok===bdState.items.length) confetti();
  });
  id('bdCSV').addEventListener('click',()=>{
    const rows=[['reported','unit','label','lower','upper','mode']];
    bdState.items.forEach(o=>rows.push([fmtToUnit(o.r,o.unit),o.unit,o.label,o.lb,o.ub,State.mode]));
    downloadCSV(`${deckTitle}_bounds.csv`, rows);
  });
  id('bdJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_bounds.json`, bdState.items));

  /* ========================= Qatar Data Lab ========================= */
  const dsDefs = {
    souq: {
      title:'Souq Waqif (cash rounding to 0.05 QAR)',
      cols:[{k:'item',name:'Item'},{k:'price',name:'Price (QAR)',u:[0.01,0.05,0.1,1]},{k:'qty',name:'Qty',u:[1]},{k:'subtotal',name:'Subtotal (QAR)'}],
      gen:()=> {
        const items=['Bracelet','Spices','Falcon keychain','Lamp','Perfume sample','Sweets','Handicraft','Scarf'];
        const rows=[];
        for(let r=0;r<5;r++){
          const it=items[Math.floor(Math.random()*items.length)];
          const price= +( (Math.random()*40+5).toFixed(2) );
          const qty= Math.floor(Math.random()*5)+1;
          rows.push({item:it, price, qty, subtotal: price*qty});
        }
        return rows;
      },
      totalRow: (rows)=> rows.reduce((s,r)=>s+r.subtotal,0)
    },
    fuel: {
      title:'Fuel Station (litres & cost)',
      cols:[{k:'litre',name:'Litres (L)',u:[0.1,0.5,1]},{k:'ppL',name:'Price per L (QAR)',u:[0.01,0.05,0.1]},{k:'cost',name:'Cost (QAR)'}],
      gen:()=> {
        const rows=[];
        for(let r=0;r<4;r++){
          const litre= +( (Math.random()*45+10).toFixed(2) );
          const ppL= +( (Math.random()*1.2+1.4).toFixed(2) ); // hypothetical
          rows.push({litre, ppL, cost: litre*ppL});
        }
        return rows;
      },
      totalRow: (rows)=> rows.reduce((s,r)=>s+r.cost,0)
    },
    metro: {
      title:'Doha Metro (travel times)',
      cols:[{k:'leg',name:'Leg'},{k:'mins',name:'Time (min)',u:[1,5] }],
      gen:()=> {
        const legs=['Al Bidda→Souq Waqif','Al Messila→Hamad Hospital','Al Wakra→Qatar University','Lusail→DECC'];
        const rows=[];
        for(let r=0;r<4;r++){
          const leg=legs[r%legs.length];
          const mins= +( (Math.random()*28+7).toFixed(1) );
          rows.push({leg, mins});
        }
        return rows;
      },
      totalRow: (rows)=> rows.reduce((s,r)=>s+r.mins,0)
    },
    match: {
      title:'Match Attendance',
      cols:[{k:'match',name:'Match'},{k:'att',name:'Attendance',u:[10,100,1000]}],
      gen:()=> {
        const games=['Match 1','Match 2','Match 3','Match 4','Match 5'];
        const rows=[];
        for(let r=0;r<5;r++){
          const match=games[r%games.length];
          const att = Math.floor(Math.random()*25000)+15000;
          rows.push({match, att});
        }
        return rows;
      },
      totalRow: (rows)=> rows.reduce((s,r)=>s+r.att,0)
    }
  };

  const dsSelect=id('dsSelect'), labMode=id('labMode'), dsTable=id('dsTable'), dsUnits=id('dsUnits');
  const rtsOut=id('rtsOut'), strOut=id('strOut'), absErr=id('absErr'), relErr=id('relErr');
  let dsState={key:'souq', rows:[], cols:[], unitSel:{}};

  function renderDataset(){
    const def=dsDefs[dsState.key];
    // Table
    let html='<thead><tr>';
    def.cols.forEach(c=>{ html += `<th>${c.name}</th>`;});
    html+='</tr></thead><tbody>';
    dsState.rows.forEach(r=>{
      html+='<tr>';
      def.cols.forEach(c=>{
        const v=r[c.k];
        if(typeof v==='number') html+=`<td>${Number(v.toFixed(3)).toLocaleString()}</td>`;
        else html+=`<td>${v||''}</td>`;
      });
      html+='</tr>';
    });
    html+='</tbody>';
    dsTable.innerHTML=html;

    // Units panel
    dsUnits.innerHTML='';
    def.cols.forEach(c=>{
      if(!c.u) return;
      const wrap=document.createElement('div');
      wrap.innerHTML=`<label>${c.name}: 
          <select data-col="${c.k}" class="border rounded px-2 py-1">
            ${c.u.map(u=>`<option value="${u}">${ (u>=1)?('nearest '+u): ( (u===0.05)?'0.05 QAR':' '+decPlacesFromUnit(u)+' dp') }</option>`).join('')}
          </select>
        </label>`;
      const sel=wrap.querySelector('select');
      sel.value= (c.k==='price')? 0.05 : c.u[0];
      dsState.unitSel[c.k]=Number(sel.value);
      sel.addEventListener('change',e=>{dsState.unitSel[c.k]=Number(e.target.value);});
      dsUnits.appendChild(wrap);
    });

    rtsOut.textContent='—'; strOut.textContent='—'; absErr.textContent='—'; relErr.textContent='—';
  }

  function loadDS(){
    dsState.key=dsSelect.value; State.mode=labMode.value; setMode.value=State.mode; modeSelect.value=State.mode;
    const def=dsDefs[dsState.key];
    dsState.rows=def.gen(); dsState.cols=def.cols.map(c=>({...c}));
    renderDataset();
  }
  function computeDS(){
    const def=dsDefs[dsState.key];
    let rtsTotal=0, exactTotal=def.totalRow(dsState.rows);
    // Round-Then-Sum: round relevant fields before subtotal or total
    if(dsState.key==='souq'){
      // round price, qty fixed, then subtotal per row rounded to currency unit?
      const uP=dsState.unitSel.price||0.05;
      rtsTotal = dsState.rows.reduce((s,r)=>{
        const rp= roundToUnitMode(r.price, uP, State.mode);
        const sub = rp * r.qty;
        return s + sub;
      },0);
    }else if(dsState.key==='fuel'){
      const uL=dsState.unitSel.litre||0.1; const uP=dsState.unitSel.ppL||0.05;
      rtsTotal = dsState.rows.reduce((s,r)=>{
        const rl= roundToUnitMode(r.litre, uL, State.mode);
        const rp= roundToUnitMode(r.ppL, uP, State.mode);
        return s + rl*rp;
      },0);
    }else if(dsState.key==='metro'){
      const uM=dsState.unitSel.mins||1;
      rtsTotal = dsState.rows.reduce((s,r)=> s + roundToUnitMode(r.mins, uM, State.mode), 0);
    }else if(dsState.key==='match'){
      const uA=dsState.unitSel.att||100;
      rtsTotal = dsState.rows.reduce((s,r)=> s + roundToUnitMode(r.att, uA, State.mode), 0);
    }

    // Sum-Then-Round (round the final total to the same natural unit)
    let unitForTotal = 1;
    if(dsState.key==='souq' || dsState.key==='fuel') unitForTotal = dsState.unitSel.price||0.05;
    if(dsState.key==='metro') unitForTotal = dsState.unitSel.mins||1;
    if(dsState.key==='match') unitForTotal = dsState.unitSel.att||100;

    const strTotal = roundToUnitMode(exactTotal, unitForTotal, State.mode);

    const abs = Math.abs(rtsTotal - strTotal), rel = (Math.abs(strTotal)>EPS)? (abs/Math.abs(strTotal))*100 : 0;
    rtsOut.textContent = pretty(rtsTotal,2);
    strOut.textContent = pretty(strTotal,2);
    absErr.textContent = pretty(abs,2);
    relErr.textContent = pretty(rel,2) + ' %';
  }

  dsSelect.addEventListener('change',loadDS);
  labMode.addEventListener('change',()=>{ State.mode=labMode.value; setMode.value=State.mode; modeSelect.value=State.mode; });
  id('dsNew').addEventListener('click',loadDS);
  id('dsCompute').addEventListener('click',computeDS);
  id('dsExportCSV').addEventListener('click',()=>{
    const def=dsDefs[dsState.key];
    const rows=[['dataset',def.title],[],def.cols.map(c=>c.name)];
    dsState.rows.forEach(r=>{
      rows.push(def.cols.map(c=> (typeof r[c.k]==='number')? Number(r[c.k].toFixed(3)) : (r[c.k]??'')));
    });
    rows.push([]);
    rows.push(['policy'].concat(def.cols.map(c=> dsState.unitSel[c.k]??'' )));
    downloadCSV(`${deckTitle}_QatarLab_${dsState.key}.csv`, rows);
  });
  // init
  loadDS();

  /* ========================= Real‑World Practice ========================= */
  const realState={items:[]};
  function realNew(){
    const list=[];
    // Currency estimation with 0.05 QAR
    const price = +( (Math.random()*40+10).toFixed(2) );
    const qty = Math.floor(Math.random()*7)+4; // 4..10
    const u=[0.01,0.05,0.1][Math.floor(Math.random()*3)];
    list.push({type:'est', prompt:`Estimate the total for ${qty} items at QAR ${price} each using nearest ${u===0.05?'0.05 QAR': (u<1? decPlacesFromUnit(u)+' dp':'QAR')}.`, unit:u, ans: roundToUnitMode(price,u,State.mode)*qty });

    // Population rounding
    const pop = Math.floor(Math.random()*700000)+2300000; // plausible range
    list.push({type:'unit', prompt:`Round the population ${pop.toLocaleString()} to the nearest hundred thousand.`, unit:100000, ans: roundToUnitMode(pop,100000,State.mode)});

    // Distance with dp
    const dist = +( (Math.random()*150+5).toFixed(2) );
    list.push({type:'unit', prompt:`Round the distance ${dist} km to 1 dp.`, unit:0.1, ans: roundToUnitMode(dist,0.1,State.mode)});

    // Time rounding
    const minutes = +( (Math.random()*180).toFixed(1) );
    list.push({type:'unit', prompt:`Round the running time ${minutes} minutes to the nearest minute.`, unit:1, ans: roundToUnitMode(minutes,1,State.mode)});

    realState.items=list;
    const box=id('realList'); box.innerHTML='';
    list.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1}</div>
        <div class="text-xl mt-1">${o.prompt} = <input class="rin border rounded px-2 py-1 w-40" placeholder="answer"></div>`;
      box.appendChild(row);
    });
  }
  id('realNew').addEventListener('click',realNew); realNew();
  id('realCheck').addEventListener('click',()=>{
    let ok=0; id('realList').querySelectorAll('.card').forEach((row,idx)=>{
      const item=realState.items[idx]; const v=Number(String(row.querySelector('.rin').value).replace(/,/g,''));
      const good=Math.abs(v-item.ans)<1e-10; row.querySelector('.rin').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('realFb').textContent = ok===realState.items.length? '✅ Real‑world ready!' : `Score: ${ok}/${realState.items.length}`;
    if(ok===realState.items.length) confetti();
  });
  id('realCSV').addEventListener('click',()=>{
    const rows=[['prompt','answer','mode']]; realState.items.forEach(o=>rows.push([o.prompt,o.ans,State.mode])); downloadCSV(`${deckTitle}_realworld.csv`, rows);
  });
  id('realJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_realworld.json`, realState.items));

  /* ========================= MCQ Bank ========================= */
  const MCQS = {
    A: [
      {q:'Round 7.45 to 1 decimal place.', opts:['7.4','7.5','7.6','7.45'], a:1, why:'Look at the hundredths (5) → round up the tenths (4→5).'},
      {q:'Which rounds to 500 (nearest hundred)?', opts:['449','450','550','599'], a:3, why:'Nearest hundred: 449→400, 450→500 (tie → half‑up goes up), 550→600, 599→600. The one that becomes 500 is 450.'},
      {q:'How many s.f. does 1200. have?', opts:['2','3','4','depends'], a:2, why:'Trailing zeros count when a decimal point is present → 4 s.f.'},
      {q:'Bounds for 3.6 to 1 dp are:', opts:['[3.5,3.7)','[3.55,3.65)','[3.55,3.66)','(3.55,3.65]'], a:0, why:'Unit u=0.1 ⇒ bounds [3.6−0.05, 3.6+0.05).'},
      {q:'Rounding digit in 2,947 to nearest hundred is:', opts:['2','9','4','7'], a:2, why:'Hundreds place is 9? Actually 2,947: thousands(2), hundreds(9), tens(4), ones(7). Rounding digit is 9 when rounding to hundred.'},
      {q:'In banker’s rounding, 2.5 becomes…', opts:['2','3','2 or 3','undefined'], a:0, why:'Ties‑to‑even → 2.5 → 2.'}
    ],
    B: [
      {q:'Round -2.5 to nearest integer (Half‑Up).', opts:['-2','-3','-1','0'], a:1, why:'Half‑Up rounds away from 0 at the tie → -2.5 → -3.'},
      {q:'Digits in 0.007020 (s.f.)', opts:['2','3','4','5'], a:2, why:'Leading zeros ignore; 7,0,2,0 with decimal point ⇒ 4 s.f.'},
      {q:'Round 18.975 QAR to nearest 0.05 QAR.', opts:['18.95','19.00','19.05','18.90'], a:1, why:'0.05 steps: 18.95, 19.00, 19.05… 18.975 is at midpoint → Half‑Up goes up to 19.00.'},
      {q:'Which is the mantissa in 4.02 × 10^3 ?', opts:['4','4.0','4.02','10^3'], a:2, why:'Mantissa is the 4.02; exponent part is 10^3.'},
      {q:'Nearest thousand to 7,499 is:', opts:['7,000','7,500','8,000','7,400'], a:1, why:'Tie at 7,500 would go to 8,000; 7,499 goes to 7,000.'},
      {q:'Bounds for 1200 (nearest 100) are:', opts:['[1100,1300)','[1150,1250)','[1199,1201)','[1000,2000)'], a:0, why:'u=100 → [r−50, r+50) = [1150,1250)? Careful: nearest 100: r=1200, u=100 ⇒ [1150,1250). Correct answer is [1150,1250).'}
    ],
    C: [
      {q:'Round 0.864 to 2 dp.', opts:['0.86','0.87','0.88','0.864'], a:1, why:'Hundredths digit 6, thousandths 4 <5 → 0.86? Wait: 0.864 to 2dp: check hundredths is 6, thousandths is 4 → stays 6 → 0.86. Correct is 0.86.'},
      {q:'How many s.f. in 40 ?', opts:['1','2','3','depends'], a:3, why:'Without a decimal point, trailing zero is ambiguous → usually 1 s.f. unless notation clarifies.'},
      {q:'Which policy gives the smaller total for positive addends?', opts:['Round‑Then‑Sum','Sum‑Then‑Round','Always equal','Cannot say'], a:3, why:'It depends on the data and units—students should analyze empirically.'},
      {q:'Round 3.25 to integer (Ties‑to‑Even).', opts:['3','4','2','depends'], a:0, why:'Tie 3.5? This is 3.25 not a tie. 3.25 → nearest integer is 3 in both modes.'},
      {q:'Bounds for 8.0 (1 dp) are:', opts:['[7.9,8.1)','[7.95,8.05)','[8.0,8.1)','[7.95,8.0]'], a:1, why:'u=0.1 ⇒ [8.0−0.05,8.0+0.05).'},
      {q:'Which number has 3 s.f.?', opts:['0.00450','4500','450.','45.0'], a:3, why:'0.00450 has 3 s.f. (4,5,0); 4500 is ambiguous (often 2 s.f.); 450. has 3 s.f.; 45.0 has 3 s.f. Multiple correct? To avoid ambiguity, pick 45.0.'}
    ]
  };
  // Fix the few ambiguous/typo items above for robustness:
  MCQS.A[4].why='Hundreds digit in 2,947 is 9 (thousands 2, hundreds 9, tens 4, ones 7).';
  MCQS.B[5].why='u=100 → [r−50, r+50) = [1150,1250).';
  MCQS.C[0].a=0; MCQS.C[0].why='0.864 to 2 dp: hundredths 6, thousandths 4 (<5) → 0.86.';
  MCQS.C[5]={q:'Which numbers have exactly 3 s.f.? (choose one best answer)', opts:['0.00450','4500','450.','45.0'], a:2, why:'450. explicitly has 3 s.f. (trailing zero counts due to decimal point).'};

  const mcqList=id('mcqList'), mcqSet=id('mcqSet');
  function mcqLoad(){
    const set=mcqSet.value; const qs=MCQS[set];
    mcqList.innerHTML='';
    qs.forEach((item,idx)=>{
      const box=document.createElement('div'); box.className='q';
      const name='mcq_'+idx;
      box.innerHTML=`<div class="font-semibold text-maroon mb-1">Q${idx+1}. ${item.q}</div>
        ${item.opts.map((opt,j)=>`<label><input type="radio" name="${name}" value="${j}"/> <span>${opt}</span></label>`).join('')}
        <div class="explain mt-1 text-sm text-gray-700 hidden">${item.why}</div>`;
      mcqList.appendChild(box);
    });
  }
  function mcqCheck(){
    const qs=MCQS[mcqSet.value]; let ok=0;
    [...mcqList.querySelectorAll('.q')].forEach((box,idx)=>{
      const chosen=box.querySelector('input[type="radio"]:checked');
      const labels=[...box.querySelectorAll('label')];
      labels.forEach(l=>l.classList.remove('correct','wrong'));
      if(!chosen) return;
      const v=Number(chosen.value);
      if(v===qs[idx].a){ ok++; labels[v].classList.add('correct'); } else { labels[v].classList.add('wrong'); labels[qs[idx].a].classList.add('correct'); }
    });
    id('mcqFb').textContent = `Score: ${ok}/${qs.length}`;
    if(ok===qs.length) confetti();
  }
  function mcqExplain(){ [...mcqList.querySelectorAll('.explain')].forEach(el=>el.classList.remove('hidden')); }
  id('mcqNew').addEventListener('click',mcqLoad);
  id('mcqCheck').addEventListener('click',mcqCheck);
  id('mcqExplain').addEventListener('click',mcqExplain);
  mcqLoad();

  /* ========================= Challenge Mode (unchanged core) ========================= */
  const chState={cur:null, streak:0, history:[]};
  function chNew(){
    const lv=id('chLevel').value;
    let prompt='', ans=null;
    const r = Math.random();
    if(lv==='easy'){
      const x = Math.floor(Math.random()*900)+100, unit=10;
      ans = roundToUnitMode(x,unit,State.mode);
      prompt = `Round ${x} to the nearest 10`;
    }else if(lv==='med'){
      const x = +( (Math.random()*200-100).toFixed(2) ); const dp=1;
      ans = roundToUnitMode(x,10**(-dp),State.mode); prompt=`Round ${x} to ${dp} dp`;
    }else if(lv==='hard'){
      if(r<0.5){ const x=+( (Math.random()*9000-3000).toFixed(3) ); const n=[2,3,4][Math.floor(Math.random()*3)]; ans=roundToSig(x,n); prompt=`Round ${x} to ${n} s.f.`; }
      else { const unit=[0.01,0.1,1,10,100][Math.floor(Math.random()*5)]; const x=+( (Math.random()*2000-1000).toFixed(unit<1?2:0) ); ans=roundToUnitMode(x,unit,State.mode); prompt=`Round ${x} to ${unit>=1? 'nearest '+unit : decPlacesFromUnit(unit)+' dp'}`; }
    }else{ // expert
      if(r<0.33){ const e=Math.floor(Math.random()*7)-3; const m=+( (Math.random()*9+1).toFixed(4) ); const n=[2,3,4][Math.floor(Math.random()*3)]; const rr=sciRound(m,e,n); ans=rr.m*10**rr.e; prompt=`Round ${m}×10^${e} to ${n} s.f. (enter numeric value)`; }
      else if(r<0.66){ const unit=[0.001,0.01,0.1,1,10,100][Math.floor(Math.random()*6)]; const r0=+( (Math.random()*1000-500).toFixed(unit<1?3:0) ); const rr=roundToUnitMode(r0,unit,State.mode); const lb=rr-unit/2; ans=lb; prompt=`Given value rounded to ${unit>=1?'nearest '+unit: decPlacesFromUnit(unit)+' dp'} is ${fmtToUnit(rr,unit)}. Enter the <lower bound>.`; }
      else { const x=+( (Math.random()*9000-1000).toFixed(4) ); const n=[2,3,4][Math.floor(Math.random()*3)]; ans=roundToSig(x,n); prompt=`Round ${x} to ${n} s.f.`; }
    }
    chState.cur={prompt,ans}; id('chText').textContent=prompt; id('chAns').value=''; id('chFb').textContent=''; id('chHintBox').textContent=''; renderMath(id('challengeSlide'));
  }
  id('chNew').addEventListener('click',chNew); chNew();
  id('chHint').addEventListener('click',()=>{ id('chHintBox').innerHTML=`<div class="hint">Half‑Up unless investigating ties. Bounds: \\([r-\\tfrac{u}{2},\\; r+\\tfrac{u}{2})\\).</div>`; renderMath(id('challengeSlide')); });
  id('chCheck').addEventListener('click',()=>{
    const got=Number(id('chAns').value), want=chState.cur.ans;
    const ok = Math.abs(got-want)<1e-10;
    if(ok){ chState.streak++; id('chFb').textContent='✅ Correct!'; id('chFb').className='mt-2 h-6 font-semibold text-green-700'; confetti(); chState.history.push({prompt:chState.cur.prompt, answer:want, correct:true}); chNew(); }
    else { chState.streak=0; id('chFb').textContent='❌ Not quite. Expected '+want; id('chFb').className='mt-2 h-6 font-semibold text-red-700'; chState.history.push({prompt:chState.cur.prompt, answer:want, correct:false}); }
    id('streakOut').textContent=chState.streak;
  });
  id('chCSV').addEventListener('click',()=>{
    const rows=[['prompt','answer','correct']]; chState.history.forEach(h=>rows.push([h.prompt,h.answer,h.correct])); downloadCSV(`${deckTitle}_challenge.csv`, rows);
  });
  id('chJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_challenge.json`, chState.history));

  /* ========================= Exit Ticket ========================= */
  const confSlider=id('confSlider'), confOut=id('confOut'); confOut.textContent=confSlider.value; confSlider.addEventListener('input',()=>confOut.textContent=confSlider.value);

  /* ========================= Drawer + Initial Show ========================= */
  function initKW(){ langSelect.value=State.lang; renderKW(); }
  initKW();
  show(0);

})();
</script>
</body>
</html>
