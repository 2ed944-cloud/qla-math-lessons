<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>G8 â€¢ Unit 1 â€¢ Lesson 4 â€¢ Rounding Numbers (QLA) â€” Enhanced</title>

<!-- Fonts & Tailwind -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

<script>
  // Boot KaTeX, expose re-typeset
  window.addEventListener('DOMContentLoaded', () => {
    const run = (root = document.body) => {
      if (!window.renderMathInElement) return;
      window.renderMathInElement(root, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '\\[', right: '\\]', display: true },
          { left: '\\(', right: '\\)', display: false }
        ],
        throwOnError: false
      });
    };
    if (window.renderMathInElement) run();
    else {
      const t = setInterval(()=>{ if(window.renderMathInElement){ clearInterval(t); run();}}, 25);
      setTimeout(()=>clearInterval(t), 6000);
    }
    window._rerenderMath = run;
  });
</script>

<style>
  :root{--maroon:#6C1D45;--gold:#C7A34F;--dark:#2C2C2E;--light:#F5F5F5;--accent:#E8D5B7}
  html,body{height:100%;background:#2d3748;color:#111;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  /* Stage */
  #deck{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;padding:10px}
  #slides{position:relative;width:100%;max-width:1280px;aspect-ratio:16/9;background:#fff;box-shadow:0 14px 36px rgba(0,0,0,.35);overflow:hidden;border-radius:18px}
  .slide{position:absolute;inset:0;padding:3.5%;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;text-align:left;opacity:0;transform:translateY(14px) scale(.985);transition:.55s ease;pointer-events:none;overflow:auto}
  .slide.active{opacity:1;transform:none;pointer-events:auto}
  .bg-maroon{background-color:var(--maroon)} .text-maroon{color:var(--maroon)} .text-gold{color:var(--gold)}
  .banner{width:100%;height:110px;background:#fff center/contain no-repeat;border-bottom:3px solid var(--gold);border-radius:10px}
  .card{border:1px solid #e5e7eb;border-radius:14px;background:#fafafa}
  .chip{display:inline-flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.05);border-radius:9999px;padding:.35rem .75rem;cursor:pointer}
  .chip:hover{outline:2px solid var(--gold)}
  .btn{padding:.55rem 1rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
  .btn.maroon{background:var(--maroon);color:#fff;border-color:var(--maroon)}
  .btn.soft{background:#f8fafc}
  .btn:hover{filter:brightness(0.98)}
  #controls{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.55);padding:.4rem .6rem;border-radius:999px;z-index:20;backdrop-filter:blur(6px)}
  #controls button{width:42px;height:42px;border-radius:999px;border:none;background:#fff;cursor:pointer;font-weight:700}
  #controls button:hover{transform:scale(1.06)}
  #counter{color:#fff;font-weight:700;min-width:140px;text-align:center}
  #progress{position:fixed;left:0;bottom:0;height:5px;width:0;background:var(--gold);z-index:30;transition:width .35s ease}
  #fsHint{position:absolute;top:10px;right:12px;color:#fff;background:rgba(0,0,0,.35);padding:.25rem .5rem;border-radius:8px;font-size:.8rem}
  .hint{background:#fff3cd;border:1px solid #ffe69c;border-radius:10px;padding:.5rem .75rem}
  .tok{display:inline-block;padding:.05rem .25rem;border-radius:6px}
  .explain{background:#eef2ff;border:1px solid #c7d2fe;border-radius:12px;padding:.75rem 1rem}
  .exp-title{font-weight:800;color:#4338ca}
  .success-chip{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .5rem;border-radius:999px;border:1px solid #d1fae5;background:#ecfdf5;font-size:.85rem}
  .danger{color:#b91c1c}
  .ok{color:#166534}
  .nl-wrap{width:100%;max-width:920px}
  canvas.nline{width:100%;height:170px;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa);border:2px solid #ececec}
  .confetti{position:fixed;pointer-events:none;z-index:50}
  /* Popover & modal */
  #pop{position:fixed;inset:auto auto 20px 20px;max-width:min(560px,90vw);background:#fff;border:2px solid var(--gold);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.25);padding:14px 16px;z-index:40;display:none;text-align:left}
  #pop strong{color:var(--maroon)} #pop .close{float:right;color:#666;cursor:pointer;font-weight:800}
  #glossaryModal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:60}
  #glossaryCard{background:#fff;border-radius:14px;max-width:min(840px,95vw);max-height:85vh;overflow:auto;border:2px solid var(--gold);padding:14px}
  /* Progress donut */
  .donut{width:64px;height:64px;border-radius:50%;background:conic-gradient(var(--gold) 0deg, var(--gold) 0deg, #e5e7eb 0deg)}
  .donut-inner{position:relative;inset:auto;margin:auto;width:46px;height:46px;border-radius:50%;background:#fff;transform:translate(9px,9px);display:flex;align-items:center;justify-content:center;font-weight:800}
  /* Role toggle */
  #roleBar{position:fixed;top:10px;left:12px;z-index:22;background:rgba(0,0,0,.55);color:#fff;padding:.25rem .5rem;border-radius:999px;display:flex;gap:.5rem;align-items:center;backdrop-filter:blur(6px)}
  /* Timer */
  #tpsTimer{font-weight:800}
</style>
</head>
<body>

<div id="roleBar" aria-label="Mode and language">
  <span>Mode:</span>
  <button class="btn" id="modeStudent" aria-pressed="true">Student</button>
  <button class="btn soft" id="modeTeacher" aria-pressed="false">Teacher</button>
  <span class="ml-2">Lang:</span>
  <button class="btn" id="langEN" aria-pressed="true">EN</button>
  <button class="btn soft" id="langAR" aria-pressed="false">Ø¹</button>
</div>

<div id="deck" aria-live="polite">
  <div id="slides" class="relative">
    <div id="fsHint">Press <strong>F</strong> for fullscreen</div>

    <!-- 0 â€¢ Title -->
    <section class="slide active bg-maroon text-white" id="titleSlide">
      <div class="w-full h-16 banner mb-6 rounded-md" style="background-image:url('../assets/qla_banner.png')" aria-label="QLA Partner Banner"></div>
      <div class="flex items-center gap-8">
        <img src="../assets/qla_logo.png" alt="QLA Logo" class="h-20 w-auto" onerror="this.style.display='none'"/>
        <div class="text-left">
          <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight">Unit 1 â€” Lesson 4: Rounding Numbers</h1>
          <p class="text-gold text-2xl md:text-3xl mt-2 font-semibold">Grade 8 â€¢ Whole numbers â€¢ Decimals â€¢ Significant Figures â€¢ Bounds</p>
          <p class="mt-2 text-lg">Qatar Leadership Academy â€” Mathematics</p>
        </div>
      </div>
      <div class="mt-6 grid md:grid-cols-3 gap-4 w-full">
        <div class="card p-4">
          <div class="text-lg font-bold">Why this lesson matters</div>
          <p>Rounding supports estimation, data reporting, and decisions under uncertainty â€” e.g., QAR prices, travel times, and measurements.</p>
        </div>
        <div class="card p-4">
          <div class="text-lg font-bold">Success criteria (studentâ€‘friendly)</div>
          <ul class="list-disc list-inside">
            <li>I can explain the <b>halfâ€‘up</b> rule in my own words.</li>
            <li>I can choose an <b>appropriate unit</b> (10, 0.1, s.f.) for a context.</li>
            <li>I can find and justify <b>bounds</b> after rounding.</li>
          </ul>
        </div>
        <div class="card p-4 flex items-center gap-3">
          <div class="donut" id="donut"><div class="donut-inner" id="donutLabel">0%</div></div>
          <div>
            <div class="font-bold">LO progress</div>
            <div class="text-sm text-gray-600">Completes as you score tasks tagged LOâ€‘1â€¦LOâ€‘4.</div>
          </div>
        </div>
      </div>
      <div class="absolute bottom-6 text-sm text-gray-100">Aligned to AERO 8.NS &amp; 8.EE readiness.</div>
    </section>

    <!-- 1 â€¢ LOs & Keywords -->
    <section class="slide" id="loSlide">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Learning Objectives &amp; Keywords</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Objectives</h3>
          <ol class="list-decimal list-inside space-y-1 text-lg">
            <li data-lo="1">LOâ€‘1: Round whole numbers/decimals using the <b>halfâ€‘up</b> rule (symmetric for negatives).</li>
            <li data-lo="2">LOâ€‘2: Round to a given number of <b>significant figures</b> and in <b>scientific notation</b>.</li>
            <li data-lo="3">LOâ€‘3: Interpret a rounded valueâ€™s <b>bounds</b> (trueâ€‘value interval).</li>
            <li data-lo="4">LOâ€‘4: Choose suitable rounding for <b>estimation</b> in Qatarâ€‘related contexts and justify.</li>
          </ol>
          <div class="mt-3">
            <span class="success-chip"><input type="checkbox" class="mr-1" data-checklo="1"> I met LOâ€‘1</span>
            <span class="success-chip"><input type="checkbox" class="mr-1" data-checklo="2"> LOâ€‘2</span>
            <span class="success-chip"><input type="checkbox" class="mr-1" data-checklo="3"> LOâ€‘3</span>
            <span class="success-chip"><input type="checkbox" class="mr-1" data-checklo="4"> LOâ€‘4</span>
          </div>
        </div>
        <div class="card p-5">
          <div class="flex items-start justify-between">
            <h3 class="text-2xl font-bold text-maroon mb-1">Keywords (tap for defs)</h3>
            <div class="flex gap-2">
              <button class="btn soft" id="openGlossary">Open glossary</button>
              <button class="btn soft" id="quizGlossary">Glossary quiz</button>
            </div>
          </div>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="halfup">halfâ€‘up rounding</span>
            <span class="chip" data-key="place">place value</span>
            <span class="chip" data-key="dp">decimal places (dp)</span>
            <span class="chip" data-key="sf">significant figures (s.f.)</span>
            <span class="chip" data-key="sci">scientific notation</span>
            <span class="chip" data-key="bounds">bounds / error interval</span>
            <span class="chip" data-key="estimate">estimation</span>
          </div>
          <p class="text-xs text-gray-500 mt-3">We use the <b>school standard</b> halfâ€‘up rule: a trailing 5 rounds <b>away from 0</b> (e.g., \(-1.5\to -2\)).</p>
        </div>
      </div>
      <details class="explain mt-4 max-w-5xl">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> how to decide the right rounding unit</summary>
        <div class="mt-2 grid md:grid-cols-3 gap-4">
          <div><b>Purpose:</b> estimate vs. report. Reporting a distance? Use dp or s.f. Estimating a grocery bill? Nearest riyal or 10 riyals.</div>
          <div><b>Data source precision:</b> donâ€™t claim more precision than your tool (e.g., a scale to 0.1 kg â†’ report to 0.1 kg or 1 s.f.).</div>
          <div><b>Audience:</b> for a notice/poster, round more; for a lab log, round less.</div>
        </div>
      </details>
    </section>

    <!-- 2 â€¢ Qatar Context: Why rounding matters -->
    <section class="slide" id="qatarSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Qatar Applications</h2>
      <details class="explain mb-3">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> where rounding shows up around us</summary>
        <ul class="list-disc list-inside">
          <li><b>Prices (QAR):</b> estimate totals quickly at Carrefour or Souq Waqif.</li>
          <li><b>Travel times:</b> Doha Metro rides and bus timetables often need rounding to the minute.</li>
          <li><b>Stadium capacities:</b> reports use s.f. (e.g., â€œ~80,000â€).</li>
          <li><b>Measurements:</b> science labs (mass, volume) and athletics timing.</li>
        </ul>
      </details>
      <div class="grid md:grid-cols-3 gap-4 w-full max-w-5xl">
        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">QAR checkout estimate (LOâ€‘4)</div>
          <div>3 items: QAR 12.95, 27.20, 8.40. Estimate total by rounding to the nearest riyal.</div>
          <input id="qa1" class="border rounded px-2 py-1 mt-2 w-40" placeholder="e.g., 48">
          <button class="btn maroon mt-2" data-check="qa1" data-ans="48">Check</button>
          <div id="qa1fb" class="mt-1 text-sm"></div>
          <details class="mt-2"><summary>Explain</summary>Round to riyal: 13 + 27 + 8 = <b>48</b> QAR.</details>
        </div>
        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">Metro timing (LOâ€‘1)</div>
          <div>A ride is 13.6 minutes. Round to the <b>nearest minute</b>.</div>
          <input id="qa2" class="border rounded px-2 py-1 mt-2 w-40" placeholder="14">
          <button class="btn maroon mt-2" data-check="qa2" data-ans="14">Check</button>
          <div id="qa2fb" class="mt-1 text-sm"></div>
        </div>
        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">Stadium capacity (LOâ€‘2)</div>
          <div>Report 80250 to <b>2 s.f.</b></div>
          <input id="qa3" class="border rounded px-2 py-1 mt-2 w-40" placeholder="8.0 Ã— 10^4 or 80,000">
          <button class="btn maroon mt-2" id="qa3btn">Check</button>
          <div id="qa3fb" class="mt-1 text-sm"></div>
          <details class="mt-2"><summary>Explain</summary>\(80250 \to 8.0\times10^4 = \) <b>80,000</b>.</details>
        </div>
      </div>
    </section>

    <!-- 3 â€¢ Warmâ€‘up (with preâ€‘explanation) -->
    <section class="slide" id="warmSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Warmâ€‘Up: Decide Fast!</h2>
      <details class="explain mb-3">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> halfâ€‘up rule in 20 seconds</summary>
        <ol class="list-decimal list-inside">
          <li>Mark the rounding <b>place</b> and look one digit to the right.</li>
          <li>Right digit 0â€“4 â†’ keep; 5â€“9 â†’ increase the rounding digit by 1.</li>
          <li>For negatives, still â€œ<b>away from 0</b>â€ at 5 (e.g., \(-2.5\to -3\)).</li>
        </ol>
      </details>
      <div class="grid md:grid-cols-3 gap-4 w-full max-w-5xl">
        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">Nearest hundred (LOâ€‘1)</div>
          <div class="text-xl">\( 12{,}649 \) â†’ <input id="w1" class="border rounded px-2 py-1 w-32" placeholder="12,600"></div>
        </div>
        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">1 decimal place (LOâ€‘1)</div>
          <div class="text-xl">\( 7.45 \) â†’ <input id="w2" class="border rounded px-2 py-1 w-24" placeholder="7.5"></div>
        </div>
        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">Nearest integer (negatives) (LOâ€‘1)</div>
          <div class="text-xl">\( -2.5 \) â†’ <input id="w3" class="border rounded px-2 py-1 w-24" placeholder="-3"></div>
        </div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="warmCheck" class="btn maroon">Check</button>
        <button id="warmReset" class="btn">Reset</button>
        <select id="warmSet" class="border rounded px-2 py-1">
          <option value="A" selected>Set A</option>
          <option value="B">Set B</option>
          <option value="C">Set C</option>
          <option value="D">Set D</option>
        </select>
        <button id="warmLoad" class="btn">Load set</button>
        <button id="tpsStart" class="btn soft">Thinkâ€“Pairâ€“Share Timer</button>
        <span id="tpsTimer" class="ml-2"></span>
      </div>
      <div id="warmFb" class="mt-2 h-6 font-semibold"></div>
      <details class="mt-2"><summary>Common pitfalls</summary>For numbers ending with 5, remember: round away from 0 even for negatives.</details>
    </section>

    <!-- 4 â€¢ Place Value & Rule (with guided steps) -->
    <section class="slide" id="placeSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Place Value &amp; The Rounding Rule</h2>
      <details class="explain mb-3">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> which digit changes?</summary>
        <p>Find the digit at your rounding place (e.g., tens, hundredths). The digit to its right decides: 0â€“4 keep, 5â€“9 add 1. All digits to the right become zeros (or are truncated in decimals).</p>
        <div class="hint mt-2 text-sm">Negative numbers: at a tie (5), move away from 0 â†’ more negative.</div>
      </details>
      <div class="grid lg:grid-cols-2 gap-6 w-full max-w-5xl">
        <div class="card p-5">
          <p class="mb-2">Highlight the rounding digit and the next digit.</p>
          <div class="text-2xl" id="pvNumber"></div>
          <div class="mt-2 flex items-center gap-3">
            <label>Round to:</label>
            <select id="pvPlace" class="border rounded px-2 py-1">
              <option value="1">ones</option>
              <option value="10">tens</option>
              <option value="100">hundreds</option>
              <option value="1000">thousands</option>
              <option value="0.1">tenths (1â€¯dp)</option>
              <option value="0.01" selected>hundredths (2â€¯dp)</option>
              <option value="0.001">thousandths (3â€¯dp)</option>
            </select>
            <button id="pvNew" class="btn">New number</button>
          </div>
          <div class="mt-2">Result: <span id="pvResult" class="font-bold"></span></div>
          <div class="mt-3 flex gap-2">
            <button id="pvExplain" class="btn soft">Show steps</button>
            <button id="pvExportCSV" class="btn">Export CSV</button>
            <button id="pvExportJSON" class="btn">Export JSON</button>
          </div>
          <div id="pvSteps" class="mt-2 text-sm"></div>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Worked examples</h3>
          <div class="space-y-2 text-lg">
            <div>\( 246.38 \) to 1â€¯dp â†’ \( 246.4 \)</div>
            <div>\( 7{,}950 \) to nearest thousand â†’ \( 8{,}000 \)</div>
            <div>\( -12.5 \) to integer â†’ \( -13 \)</div>
          </div>
          <details class="mt-3"><summary>Misconception check</summary>â€œ\(-12.5\) rounds to \(-12\) because 5 goes up.â€ â†’ <b>No</b>. At 5, we go <i>away</i> from 0, so more negative: \(-13\).</details>
        </div>
      </div>
    </section>

    <!-- 5 â€¢ Rounding Explorer (Number Line) -->
    <section class="slide" id="lineSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Rounding Explorer (Number Line)</h2>
      <details class="explain mb-3">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> visualize cutoffs</summary>
        <p>If \(x\) rounds to \(r\) with unit \(u\), the â€œownershipâ€ interval is \([r-\frac{u}{2},\,r+\frac{u}{2})\). Midpoints move to the next tick.</p>
      </details>
      <div class="nl-wrap"><canvas id="roundLine" class="nline" aria-label="Rounding number line"></canvas></div>
      <div class="mt-3 flex flex-wrap items-center gap-3 text-sm">
        <label class="chip">x = <input id="lineX" class="border rounded px-2 py-1 w-28" value="23.47"></label>
        <label class="chip">unit = 
          <select id="lineUnit" class="border rounded px-2 py-1">
            <option value="1">1 (nearest integer)</option>
            <option value="0.1" selected>0.1 (1â€¯dp)</option>
            <option value="0.01">0.01 (2â€¯dp)</option>
            <option value="10">10 (nearest 10)</option>
            <option value="100">100 (nearest 100)</option>
          </select>
        </label>
        <input type="range" id="lineSlider" min="-100" max="100" step="0.01" value="23.47" style="width:240px">
        <span class="chip">rounded = <b id="lineOut">23.5</b></span>
        <button id="lineRand" class="btn">Randomize</button>
        <button id="lineExportCSV" class="btn">Export CSV</button>
        <button id="lineExportJSON" class="btn">Export JSON</button>
      </div>
      <details class="mt-2"><summary>Explore â†’ Conjecture â†’ Justify</summary>
        <ol class="list-decimal list-inside">
          <li>Pick a unit and drag the slider. Where are the jump points?</li>
          <li>Conjecture: â€œNumbers that round to 12.3 (1dp) are exactly from ___ to ___.â€</li>
          <li>Test your intervals with 3 examples and justify using the diagram.</li>
        </ol>
      </details>
    </section>

    <!-- 6 â€¢ Practice Generator (multi sets) -->
    <section class="slide" id="pracSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Practice Generator</h2>
      <details class="explain mb-3">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> which strategy fits?</summary>
        <p>Whole numbers â†’ nearest 10/100/1000; decimals â†’ dp or s.f.; scientific data â†’ s.f. Use the unit that preserves honesty and usefulness.</p>
      </details>
      <div class="card p-5 w-full max-w-5xl">
        <div class="flex flex-wrap items-center gap-3">
          <span>Level:</span>
          <select id="prLevel" class="border rounded px-2 py-1">
            <option value="easy">easy (nearest 10/100, 1â€¯dp)</option>
            <option value="med" selected>medium (âˆ’numbers, 2â€“3â€¯dp)</option>
            <option value="hard">hard (mixed places)</option>
            <option value="expert">expert (incl. significant figures)</option>
          </select>
          <span>Set:</span>
          <select id="prSet" class="border rounded px-2 py-1">
            <option>A</option><option>B</option><option>C</option><option>D</option>
          </select>
          <button id="prNew" class="btn">New set</button>
          <button id="prExplainAll" class="btn soft">Show coaching steps</button>
        </div>
        <div id="prList" class="grid md:grid-cols-2 gap-3 mt-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="prCheck" class="btn maroon" data-lo="1,2">Check</button>
          <button id="prExportCSV" class="btn">Export CSV</button>
          <button id="prExportJSON" class="btn">Export JSON</button>
        </div>
        <div id="prFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 7 â€¢ Significant Figures -->
    <section class="slide" id="sigSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Significant Figures</h2>
      <details class="explain mb-3">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> counting s.f. in 30 seconds</summary>
        <ul class="list-disc list-inside">
          <li>Ignore leading zeros; zeros between nonâ€‘zeros count; trailing zeros count only if thereâ€™s a decimal point.</li>
          <li>Report with s.f. that matches measurement precision.</li>
        </ul>
      </details>
      <div class="grid lg:grid-cols-2 gap-6 w-full max-w-5xl">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Count s.f. (LOâ€‘2)</h3>
          <div id="sigCountList" class="grid gap-2"></div>
          <div class="mt-3 flex gap-2">
            <button id="sigCountNew" class="btn">New set</button>
            <button id="sigCountCheck" class="btn maroon">Check</button>
            <button id="sigCountCSV" class="btn">Export CSV</button>
            <button id="sigCountJSON" class="btn">Export JSON</button>
          </div>
          <div id="sigCountFb" class="mt-2 h-6 font-semibold"></div>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Round to n s.f. (LOâ€‘2)</h3>
          <div id="sigRoundList" class="grid gap-2"></div>
          <div class="mt-3 flex gap-2">
            <button id="sigRoundNew" class="btn">New set</button>
            <button id="sigRoundCheck" class="btn maroon">Check</button>
            <button id="sigRoundCSV" class="btn">Export CSV</button>
            <button id="sigRoundJSON" class="btn">Export JSON</button>
          </div>
          <div id="sigRoundFb" class="mt-2 h-6 font-semibold"></div>
        </div>
      </div>
      <div class="hint mt-3 text-sm">Examples: \(1200\) has 2 s.f.; \(1200.\) has 4 s.f.; \(0.0702\) has 3 s.f.</div>
    </section>

    <!-- 8 â€¢ Scientific Notation -->
    <section class="slide" id="sciSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Scientific Notation (Round Mantissa)</h2>
      <details class="explain mb-3">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> normalize then round</summary>
        <p>Ensure mantissa is in \([1,10)\). Round mantissa to \(n\) s.f.; if it becomes \(\ge 10\), shift one to the exponent.</p>
      </details>
      <div class="card p-5 w-full max-w-5xl">
        <div id="sciList" class="grid md:grid-cols-2 gap-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="sciNew" class="btn">New set</button>
          <button id="sciCheck" class="btn maroon">Check</button>
          <button id="sciCSV" class="btn">Export CSV</button>
          <button id="sciJSON" class="btn">Export JSON</button>
        </div>
        <div id="sciFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 9 â€¢ Bounds / Error Intervals -->
    <section class="slide" id="boundSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Bounds (when a value is rounded)</h2>
      <details class="explain mb-3">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> interval meaning</summary>
        <p>If \( x \) rounds to \( r \) to the unit \(u\), then \( x\in[\,r-\tfrac{u}{2},\; r+\tfrac{u}{2}\,) \). Left endpoint included, right excluded.</p>
      </details>
      <div class="card p-5 w-full max-w-5xl">
        <div id="bdList" class="grid md:grid-cols-2 gap-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="bdNew" class="btn">New set</button>
          <button id="bdCheck" class="btn maroon">Check</button>
          <button id="bdCSV" class="btn">Export CSV</button>
          <button id="bdJSON" class="btn">Export JSON</button>
        </div>
        <div id="bdFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 10 â€¢ Realâ€‘World Practice (Qatar) -->
    <section class="slide" id="realSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Realâ€‘World Practice (Qatar)</h2>
      <details class="explain mb-3">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> match rounding to context</summary>
        <p>Money â†’ nearest riyal; travel time â†’ minute; reporting population â†’ 1â€“2 s.f.; science â†’ s.f./dp consistent with instruments.</p>
      </details>
      <div class="card p-5 w-full max-w-5xl">
        <div id="realList" class="grid md:grid-cols-2 gap-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="realNew" class="btn">New set</button>
          <button id="realCheck" class="btn maroon" data-lo="4">Check</button>
          <button id="realCSV" class="btn">Export CSV</button>
          <button id="realJSON" class="btn">Export JSON</button>
        </div>
        <div id="realFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 11 â€¢ Inquiry Challenge (student-centered stations) -->
    <section class="slide" id="inquirySlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Explore â€¢ Explain â€¢ Apply (Stations)</h2>
      <details class="explain mb-3">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> station flow</summary>
        <ol class="list-decimal list-inside">
          <li><b>Explore:</b> generate examples/counterexamples.</li>
          <li><b>Explain:</b> write a rule or a picture (number line).</li>
          <li><b>Apply:</b> test your rule on new items; refine if needed.</li>
        </ol>
      </details>
      <div class="grid md:grid-cols-3 gap-4 w-full max-w-5xl">
        <div class="card p-4">
          <div class="font-bold text-maroon">Station A â€” Ties at 5 (LOâ€‘1)</div>
          <div>Find 4 numbers that end with 5 at the rounding place (two positive, two negative). Predict & verify results.</div>
          <textarea id="staA" class="border rounded w-full mt-2 p-2" rows="3" placeholder="Your numbers & why..."></textarea>
        </div>
        <div class="card p-4">
          <div class="font-bold text-maroon">Station B â€” Same rounded value (LOâ€‘3)</div>
          <div>List 5 different numbers that round to 350 (nearest 10). What interval do they share?</div>
          <textarea id="staB" class="border rounded w-full mt-2 p-2" rows="3"></textarea>
        </div>
        <div class="card p-4">
          <div class="font-bold text-maroon">Station C â€” Honest reporting (LOâ€‘2/4)</div>
          <div>Choose a measurement (mass, length, time). Decide dp vs. s.f. and justify with the toolâ€™s precision.</div>
          <textarea id="staC" class="border rounded w-full mt-2 p-2" rows="3"></textarea>
        </div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="stationExport" class="btn">Export notes (CSV)</button>
      </div>
    </section>

    <!-- 12 â€¢ Challenge Mode -->
    <section class="slide" id="challengeSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Challenge Mode</h2>
      <div class="card p-5 w-full max-w-5xl">
        <div class="flex items-center gap-3">
          <span>Level:</span>
          <select id="chLevel" class="border rounded px-2 py-1">
            <option value="easy">easy</option>
            <option value="med" selected>medium</option>
            <option value="hard">hard</option>
            <option value="expert">expert</option>
          </select>
          <button id="chNew" class="btn">New question</button>
          <span class="chip">Streak: <b id="streakOut">0</b></span>
          <button id="chCSV" class="btn">Export CSV</button>
          <button id="chJSON" class="btn">Export JSON</button>
        </div>
        <div class="mt-3 text-2xl">Task: <span id="chText" class="font-extrabold"></span></div>
        <div class="mt-2 flex flex-wrap items-center gap-2">
          <input id="chAns" class="border rounded px-3 py-2 w-60" placeholder="answer"/>
          <button id="chCheck" class="btn maroon">Check</button>
          <button id="chHint" class="btn">Hint</button>
          <button id="chExplain" class="btn soft">Show solution</button>
        </div>
        <div id="chHintBox" class="mt-3 text-sm"></div>
        <div id="chSoln" class="mt-2 text-sm"></div>
        <div id="chFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 13 â€¢ Exit ticket -->
    <section class="slide" id="exitSlide">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Exit Ticket</h2>
      <details class="explain mb-3">
        <summary class="cursor-pointer"><span class="exp-title">Read first:</span> reflect & connect</summary>
        <p>Summarize your strategies and name a context in Qatar where youâ€™ll use them next.</p>
      </details>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">3â€“2â€“1 Reflect</h3>
          <ul class="list-disc list-inside">
            <li>3 rounding skills you used (place, s.f., bounds)</li>
            <li>2 contexts where rounding was helpful</li>
            <li>1 mistake you will avoid next time</li>
          </ul>
          <textarea id="exitRef" class="border rounded w-full mt-2 p-2" rows="5"></textarea>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">Up Next</h3>
          <p>Estimation in multiâ€‘step calculations and percent error comparisons.</p>
        </div>
      </div>
      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-[88%] h-[100px] banner rounded-md" style="background-image:url('../assets/qla_banner.png')"></div>
    </section>

  </div>
</div>

<!-- Controls -->
<div id="controls" role="group" aria-label="Slideshow controls">
  <button id="prev" title="Previous (â†)">&laquo;</button>
  <button id="fs" title="Toggle Fullscreen (F)">â¤¢</button>
  <div id="counter">1 / 14</div>
  <button id="next" title="Next (â†’)">&raquo;</button>
</div>
<div id="progress"></div>

<!-- Glossary popover -->
<div id="pop" role="dialog" aria-modal="true" aria-live="polite">
  <span class="close" title="Close">âœ•</span>
  <div id="popBody"></div>
</div>

<!-- Glossary modal -->
<div id="glossaryModal" aria-modal="true" role="dialog" aria-labelledby="glossaryTitle">
  <div id="glossaryCard" class="card">
    <div class="flex items-center justify-between">
      <h3 id="glossaryTitle" class="text-2xl font-bold text-maroon">Glossary</h3>
      <button class="btn" id="closeGlossary">Close</button>
    </div>
    <div class="mt-2 flex items-center gap-2">
      <input id="glossarySearch" class="border rounded px-2 py-1 w-full" placeholder="Search term or Arabic..." />
      <button class="btn soft" id="speakDef">ğŸ”Š Speak</button>
    </div>
    <div id="glossaryList" class="mt-3 grid md:grid-cols-2 gap-3"></div>
  </div>
</div>

<script>
/* ------------------------- Core Helpers & State ------------------------- */
(function(){
  const slides=[...document.querySelectorAll('.slide')];
  const prev=id('prev'), next=id('next'), counter=id('counter'), progress=id('progress'), fsBtn=id('fs');
  const deckTitle='G8_Unit1_L4_Rounding_QLA_Enhanced';
  let i=0;
  let role='student'; // 'teacher'
  let lang='EN';      // 'AR'
  const LO_SCORES = {1:false,2:false,3:false,4:false};

  function id(x){return document.getElementById(x)}
  function renderMath(root=document){ if(window._rerenderMath) window._rerenderMath(root); }
  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
  function confetti(x=window.innerWidth/2,y=window.innerHeight/2){
    for(let k=0;k<20;k++){
      const d=document.createElement('div'); d.className='confetti';
      d.style.left=x+'px'; d.style.top=y+'px'; d.style.width='8px'; d.style.height='8px';
      d.style.background=['#6C1D45','#C7A34F','#E8D5B7','#8a3d64'][k%4];
      document.body.appendChild(d);
      const dx=(Math.random()*2-1)*240, dy=(Math.random()*-1-0.3)*300, rot=Math.random()*720;
      d.animate([{transform:'translate(0,0) rotate(0deg)'},{transform:`translate(${dx}px,${dy}px) rotate(${rot}deg)`,opacity:0}],
                {duration:900+Math.random()*700,easing:'cubic-bezier(.2,.8,.2,1)'}).onfinish=()=>d.remove();
    }
  }
  function downloadJSON(filename, data){
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function downloadCSV(filename, rows){
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function toggleFS(){
    const el=id('slides');
    if(!document.fullscreenElement){(el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el);}
    else{(document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen).call(document);}
  }
  fsBtn.addEventListener('click',toggleFS);

  /* ---------- Navigation ---------- */
  function show(k){
    i=(k+slides.length)%slides.length;
    slides.forEach((s,idx)=>s.classList.toggle('active',idx===i));
    counter.textContent=(i+1)+' / '+slides.length;
    progress.style.width=((i+1)/slides.length*100)+'%';
    const sid=slides[i].id||'';
    if(sid==='lineSlide') drawRoundLine();
    if(sid==='placeSlide') renderPV();
    if(sid==='pracSlide') if(!prState.items.length) prBuild(); // safeguard
    renderMath(slides[i]);
  }
  prev.addEventListener('click',()=>show(i-1));
  next.addEventListener('click',()=>show(i+1));
  document.addEventListener('keydown',e=>{
    if(e.key==='ArrowRight') show(i+1);
    if(e.key==='ArrowLeft') show(i-1);
    if(e.key.toLowerCase()==='f') toggleFS();
  });

  /* ---------- Mode & Language ---------- */
  id('modeStudent').addEventListener('click',()=>setRole('student'));
  id('modeTeacher').addEventListener('click',()=>setRole('teacher'));
  id('langEN').addEventListener('click',()=>setLang('EN'));
  id('langAR').addEventListener('click',()=>setLang('AR'));

  function setRole(r){
    role=r;
    id('modeStudent').setAttribute('aria-pressed',r==='student');
    id('modeTeacher').setAttribute('aria-pressed',r==='teacher');
    document.body.dataset.role=r;
    document.querySelectorAll('[data-solution]').forEach(el=>{
      el.style.display = (r==='teacher') ? 'block':'none';
    });
  }
  function setLang(L){
    lang=L;
    id('langEN').setAttribute('aria-pressed',L==='EN');
    id('langAR').setAttribute('aria-pressed',L==='AR');
    // Glossary re-render if open
    if (glossaryOpen) renderGlossary();
  }
  setRole('student'); setLang('EN');

  /* ---------- LO Progress ---------- */
  document.querySelectorAll('[data-checklo]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const lo=cb.dataset.checklo; LO_SCORES[lo]=cb.checked; updateDonut();
    });
  });
  function updateDonut(){
    const got = Object.values(LO_SCORES).filter(Boolean).length;
    const pct = Math.round(got/4*100);
    id('donut').style.background = `conic-gradient(var(--gold) 0deg, var(--gold) ${pct*3.6}deg, #e5e7eb ${pct*3.6}deg)`;
    id('donutLabel').textContent = pct+'%';
  }

  /* ------------------------- Math Core ------------------------- */
  function roundHalfUpToUnit(x,u){
    const q=x/u;
    const s=q>=0?1:-1, a=Math.abs(q);
    const k = Math.floor(a + 0.5);
    return s*k*u;
  }
  function decPlacesFromUnit(u){
    if(u>=1) return 0;
    const p = Math.round(Math.log10(1/u));
    return Math.max(0,p);
  }
  function fmtToUnit(x,u){
    const dp = decPlacesFromUnit(u);
    return (Math.round((x+0)*10**dp)/10**dp).toFixed(dp);
  }
  function roundToDP(x,dp){ const u=10**(-dp); return roundHalfUpToUnit(x,u); }
  function roundToPlace(x,placeUnit){ return roundHalfUpToUnit(x,placeUnit); }
  function roundToSig(x,n){
    if(x===0) return 0;
    const s = x<0? -1: 1;
    const ax = Math.abs(x);
    const k = Math.floor(Math.log10(ax));
    const scale = 10**(k-n+1);
    return s*roundHalfUpToUnit(ax, scale);
  }
  function countSigStr(s){
    s = s.trim();
    if(/^0*\.?0*$/.test(s)) return 1; // zero has 1 s.f.
    const hasDot = s.includes('.');
    s = s.replace(/^[-+]/,'');
    let t = s;
    if(!hasDot){ t = t.replace(/0+$/,''); }
    t = t.replace(/^0+/,'').replace('.','');
    return t.replace(/[^0-9]/g,'').length;
  }
  function sciRound(m,e,n){
    let r = roundToSig(m, n);
    if(Math.abs(r)>=10){ r = r/10; e += 1; }
    return {m:r,e};
  }

  /* ------------------------- Glossary ------------------------- */
  const POP=id('pop'), POP_BODY=id('popBody');
  const GLOS={
    halfup:{en:'Halfâ€‘up rounding: 5â€“9 rounds away from 0; 0â€“4 toward 0 (symmetric for negatives).', ar:'ØªÙ‚Ø±ÙŠØ¨ Ù†ØµÙ Ù„Ø£Ø¹Ù„Ù‰: Ø§Ù„Ø£Ø±Ù‚Ø§Ù… 5â€“9 ØªÙÙ‚Ø±Ù‘ÙØ¨ Ø¨Ø¹ÙŠØ¯Ù‹Ø§ Ø¹Ù† Ø§Ù„ØµÙØ±ØŒ Ùˆ0â€“4 Ù†Ø­Ùˆ Ø§Ù„ØµÙØ± (Ù…ØªÙ…Ø§Ø«Ù„ Ù„Ù„Ø£Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø§Ù„Ø¨Ø©).', ex:'e.g., âˆ’2.5 â†’ âˆ’3'},
    place:{en:'Place value: ones, tens, hundreds, tenths, hundredths, â€¦', ar:'Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙƒØ§Ù†ÙŠØ©: Ø§Ù„Ø¢Ø­Ø§Ø¯ØŒ Ø§Ù„Ø¹Ø´Ø±Ø§ØªØŒ Ø§Ù„Ù…Ø¦Ø§ØªØŒ Ø§Ù„Ø£Ø¹Ø´Ø§Ø±ØŒ Ø§Ù„Ù…Ø¦Ø§Øªâ€¦', ex:'e.g., in 246.38 the tenths digit is 3'},
    dp:{en:'Decimal places (dp): digits to the right of the decimal point.', ar:'Ø§Ù„Ù…Ø±Ø§ØªØ¨ Ø§Ù„Ø¹Ø´Ø±ÙŠØ©: Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙŠÙ…ÙŠÙ† Ø§Ù„ÙØ§ØµÙ„Ø© Ø§Ù„Ø¹Ø´Ø±ÙŠØ©.', ex:'2 dp means round to 0.01'},
    sf:{en:'Significant figures (s.f.): digits that convey precision. Leading zeros donâ€™t count; trailing zeros count only if thereâ€™s a decimal point.', ar:'Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©: Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªÙŠ ØªØ¹Ø¨Ù‘Ø± Ø¹Ù† Ø§Ù„Ø¯Ù‚Ø©. Ø§Ù„Ø£ØµÙØ§Ø± Ø§Ù„Ø¨Ø§Ø¯Ø¦Ø© Ù„Ø§ ØªÙØ­ØªØ³Ø¨Ø› ÙˆØ§Ù„Ø£ØµÙØ§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ØªÙØ­ØªØ³Ø¨ Ø¥Ø°Ø§ ÙˆÙØ¬Ø¯Øª Ù†Ù‚Ø·Ø© Ø¹Ø´Ø±ÙŠØ©.', ex:'1200 has 2 s.f.; 1200. has 4'},
    sci:{en:'Scientific notation: \(a\\times 10^n\) with \(1\\le |a|<10\).', ar:'Ø§Ù„ØªØ±Ù…ÙŠØ² Ø§Ù„Ø¹Ù„Ù…ÙŠ: \(a\\times 10^n\) Ø­ÙŠØ« \(1\\le |a|<10\).', ex:'8.025Ã—10^4'},
    bounds:{en:'Bounds / error interval: all true values that would round to the reported value (Â± half a unit).', ar:'Ø§Ù„Ø­Ø¯ÙˆØ¯/ÙØªØ±Ø© Ø§Ù„Ø®Ø·Ø£: Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø§Ù„ØªÙŠ ØªÙÙ‚Ø±Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ù„Ù†Ø© (Â± Ù†ØµÙ ÙˆØ­Ø¯Ø©).', ex:'23.5 (1 dp) â†’ [23.45, 23.55)'},
    estimate:{en:'Estimation: quick approximate calculation using rounding.', ar:'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±: Ø­Ø³Ø§Ø¨ ØªÙ‚Ø±ÙŠØ¨ÙŠ Ø³Ø±ÙŠØ¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ¨.', ex:'QAR checkout total'}
  };
  POP.querySelector('.close').addEventListener('click',()=>POP.style.display='none');
  document.addEventListener('click',e=>{
    const el=e.target.closest('.chip[data-key]'); if(el){
      const key=el.dataset.key; if(GLOS[key]){
        const d=GLOS[key];
        POP_BODY.innerHTML=`
          <div><strong>${el.textContent}</strong></div>
          <div class="mt-1">${lang==='AR'?d.ar:d.en}</div>
          <div class="text-sm mt-1 text-gray-600"><em>Example:</em> ${d.ex||''}</div>
          <div class="mt-2"><button class="btn soft" id="speakPop">ğŸ”Š Pronounce</button></div>`;
        POP.style.display='block';
        const r=el.getBoundingClientRect();
        POP.style.left=Math.min(r.left, window.innerWidth-POP.offsetWidth-20)+'px';
        POP.style.bottom=(window.innerHeight-r.top+10)+'px';
        id('speakPop').onclick=()=>speakText((lang==='AR'?d.ar:d.en));
      }
    }
  });
  function speakText(t){ try{ const u=new SpeechSynthesisUtterance(t); if(lang==='AR') u.lang='ar-QA'; else u.lang='en-US'; speechSynthesis.speak(u);}catch{} }

  // Glossary modal
  let glossaryOpen=false;
  id('openGlossary').addEventListener('click',()=>{glossaryOpen=true; renderGlossary(); id('glossaryModal').style.display='flex';});
  id('closeGlossary').addEventListener('click',()=>{glossaryOpen=false; id('glossaryModal').style.display='none';});
  id('glossarySearch').addEventListener('input',renderGlossary);
  id('speakDef').addEventListener('click',()=>{ const term=id('glossarySearch').value.trim(); const items=Object.entries(GLOS); const hit=items.find(([k,v])=>k.includes(term)||v.en.toLowerCase().includes(term.toLowerCase())||v.ar.includes(term)); if(hit) speakText(lang==='AR'?hit[1].ar:hit[1].en); });

  function renderGlossary(){
    const q=id('glossarySearch').value.toLowerCase();
    const box=id('glossaryList'); box.innerHTML='';
    Object.entries(GLOS).forEach(([k,v])=>{
      if(q && !(k.includes(q) || v.en.toLowerCase().includes(q) || v.ar.includes(q))) return;
      const card=document.createElement('div'); card.className='card p-3';
      card.innerHTML = `
        <div class="font-bold text-maroon">${k}</div>
        <div class="mt-1">${lang==='AR'?v.ar:v.en}</div>
        <div class="text-sm mt-1 text-gray-600"><em>Example:</em> ${v.ex||''}</div>
      `;
      box.appendChild(card);
    });
  }

  // Glossary quiz
  id('quizGlossary').addEventListener('click',()=>{
    const keys=Object.keys(GLOS);
    const qKey = keys[Math.floor(Math.random()*keys.length)];
    const options=[qKey];
    while(options.length<4){
      const r=keys[Math.floor(Math.random()*keys.length)];
      if(!options.includes(r)) options.push(r);
    }
    options.sort(()=>Math.random()-0.5);
    const def = (lang==='AR'?GLOS[qKey].ar:GLOS[qKey].en);
    const body = `
      <div><strong>Which term matches this definition?</strong></div>
      <div class="mt-1">${def}</div>
      <div class="mt-2">${options.map(o=>`<button class="btn soft m-1 opt" data-term="${o}">${o}</button>`).join(' ')}</div>
    `;
    POP_BODY.innerHTML=body; POP.style.display='block';
    POP.querySelectorAll('.opt').forEach(b=>{
      b.onclick=()=>{ if(b.dataset.term===qKey){ b.classList.add('maroon'); b.textContent+=' âœ“'; confetti(); } else { b.classList.add('danger'); b.textContent+=' âœ—'; } }
    });
  });

  /* ------------------------- Quick Qatar checks ------------------------- */
  function bindSimpleCheck(inpId, ansId){
    const el = document.querySelector(`[data-check="${inpId}"]`);
    if(!el) return;
    el.addEventListener('click',()=>{
      const v = Number(id(inpId).value.replace(/,/g,''));
      const want = Number(el.dataset.ans);
      const fb = id(inpId+'fb');
      if(Math.abs(v-want)<1e-10){ fb.textContent='âœ… Correct'; fb.className='ok'; scoreLO(4); confetti(); }
      else { fb.textContent='âŒ Try again'; fb.className='danger'; }
    });
  }
  bindSimpleCheck('qa1');
  bindSimpleCheck('qa2');
  id('qa3btn').addEventListener('click',()=>{
    const v=id('qa3').value.trim().replace(/\s+/g,'').toLowerCase();
    const ok = v==='80000' || v==='8.0Ã—10^4' || v==='8.0x10^4' || v==='8.0*10^4' || v==='8.0Â·10^4';
    const fb=id('qa3fb');
    if(ok){ fb.textContent='âœ… Correct'; fb.className='ok'; scoreLO(2); confetti(); } else { fb.textContent='âŒ Try again'; fb.className='danger'; }
  });

  /* ------------------------- Warm-up dynamic sets & TPS timer ------------------------- */
  const warmSets = {
    A: {w1:12600, raw1:'12,649', w2:7.5, raw2:'7.45', w3:-3, raw3:'-2.5'},
    B: {w1:34300, raw1:'34,251', w2:4.2, raw2:'4.19', w3:-5, raw3:'-4.5'},
    C: {w1:9100, raw1:'9,104', w2:6.8, raw2:'6.84', w3:-8, raw3:'-7.5'},
    D: {w1:5800, raw1:'5,776', w2:3.7, raw2:'3.65', w3:-12, raw3:'-12.4'}
  };
  function loadWarmSet(tag){
    const S=warmSets[tag]||warmSets.A;
    document.querySelector('#warmSlide .grid').innerHTML = `
      <div class="card p-4"><div class="font-bold text-maroon mb-1">Nearest hundred (LOâ€‘1)</div>
      <div class="text-xl">\\( ${S.raw1} \\) â†’ <input id="w1" class="border rounded px-2 py-1 w-32" placeholder="${S.w1.toLocaleString()}"></div></div>
      <div class="card p-4"><div class="font-bold text-maroon mb-1">1 decimal place (LOâ€‘1)</div>
      <div class="text-xl">\\( ${S.raw2} \\) â†’ <input id="w2" class="border rounded px-2 py-1 w-24" placeholder="${S.w2}"></div></div>
      <div class="card p-4"><div class="font-bold text-maroon mb-1">Nearest integer (negatives) (LOâ€‘1)</div>
      <div class="text-xl">\\( ${S.raw3} \\) â†’ <input id="w3" class="border rounded px-2 py-1 w-24" placeholder="${S.w3}"></div></div>`;
    renderMath(id('warmSlide'));
    id('warmCheck').onclick=()=>{
      const v1=Number(id('w1').value.replace(/,/g,'')); const ok1=(v1===S.w1);
      const ok2=Math.abs(Number(id('w2').value)-S.w2)<1e-10;
      const ok3=(Number(id('w3').value)===S.w3);
      const score=(ok1?1:0)+(ok2?1:0)+(ok3?1:0);
      id('warmFb').textContent = score===3 ? 'âœ… Great start!' : `Score: ${score}/3`;
      ['w1','w2','w3'].forEach((x,idx)=>{const ok=[ok1,ok2,ok3][idx]; id(x).style.borderColor=ok?'#22c55e':'#ef4444'});
      if(score===3){ scoreLO(1); confetti(); }
    };
    id('warmReset').onclick=()=>{['w1','w2','w3'].forEach(x=>{id(x).value=''; id(x).style.borderColor='#e5e7eb'}); id('warmFb').textContent='';};
  }
  id('warmLoad').addEventListener('click',()=>loadWarmSet(id('warmSet').value));
  loadWarmSet('A');

  // TPS timer 90 seconds
  let tpsInt=null, tpsLeft=0;
  id('tpsStart').addEventListener('click',()=>{
    tpsLeft=90; clearInterval(tpsInt);
    id('tpsTimer').textContent='90s';
    tpsInt=setInterval(()=>{
      tpsLeft--; id('tpsTimer').textContent=tpsLeft+'s';
      if(tpsLeft<=0){ clearInterval(tpsInt); id('tpsTimer').textContent='Done'; confetti(); }
    },1000);
  });

  /* ------------------------- Place Value Lens ------------------------- */
  const pvState={x:246.38,u:0.01};
  function newPV(){
    const sign=Math.random()<0.2?-1:1;
    const int = Math.floor(Math.random()*900)+100; // 100..999
    const dp = Math.floor(Math.random()*3)+1;      // 1..3
    const frac = Math.floor(Math.random()*(10**dp));
    pvState.x = sign*(int + frac/10**dp);
    renderPV();
  }
  function renderPV(){
    const [whole, fracRaw=''] = Math.abs(pvState.x).toString().split('.');
    const frac = fracRaw||'';
    const sign = pvState.x<0 ? 'âˆ’' : '';
    const u = Number(id('pvPlace').value); pvState.u = u;
    const dp = decPlacesFromUnit(u);
    let display='';
    if(u>=1){
      const ridx = whole.length - Math.log10(u) - 1;
      for(let j=0;j<whole.length;j++){
        const cls = (j===Math.round(ridx))?'bg-yellow-200 tok':'tok';
        display += `<span class="${cls}">${whole[j]}</span>`;
      }
      if(frac.length) display += `<span class="tok">.</span>${[...frac].map(c=>`<span class="tok">${c}</span>`).join('')}`;
    }else{
      for(let j=0;j<whole.length;j++){ display += `<span class="tok">${whole[j]}</span>`}
      display += `<span class="tok">.</span>`;
      for(let j=0;j<Math.max(frac.length,dp+1);j++){
        const d = frac[j] || '0';
        const cls = (j===dp-1)?'bg-yellow-200 tok':'tok';
        display += `<span class="${cls}">${d}</span>`;
      }
    }
    id('pvNumber').innerHTML = `${sign}${display}`;
    const y = roundHalfUpToUnit(pvState.x, u);
    id('pvResult').textContent = fmtToUnit(y,u).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    renderMath(id('placeSlide'));
  }
  function pvExplainSteps(){
    const u=pvState.u, x=pvState.x, y=roundHalfUpToUnit(x,u);
    const dp=decPlacesFromUnit(u);
    const s=[
      `Target unit: <b>${u>=1?('nearest '+u): (dp+' dp')}</b>.`,
      `Mark the rounding digit and check the digit to its right.`,
      `Apply halfâ€‘up: 0â€“4 keep, 5â€“9 add 1 (away from 0 for negatives).`,
      `Rewrite digits to the right as zeros (or trim in decimals).`,
      `Answer: <b>${fmtToUnit(y,u)}</b>.`
    ];
    id('pvSteps').innerHTML = `<ol class="list-decimal list-inside text-sm">${s.map(x=>`<li>${x}</li>`).join('')}</ol>`;
  }
  id('pvPlace').addEventListener('change',renderPV);
  id('pvNew').addEventListener('click',newPV);
  id('pvExplain').addEventListener('click',pvExplainSteps);
  id('pvExportCSV').addEventListener('click',()=>downloadCSV(`${deckTitle}_placevalue.csv`, [['x','unit','result'], [pvState.x, pvState.u, fmtToUnit(roundHalfUpToUnit(pvState.x,pvState.u),pvState.u)]]));
  id('pvExportJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_placevalue.json`, pvState));
  newPV();

  /* ------------------------- Rounding Explorer (Number Line) ------------------------- */
  const cL=id('roundLine'); const lineX=id('lineX'), lineUnit=id('lineUnit'), lineOut=id('lineOut'), lineSlider=id('lineSlider');
  const lineState={x:23.47,u:0.1};
  function drawRoundLine(){
    const ctx=cL.getContext('2d'); cL.width=cL.clientWidth*devicePixelRatio; cL.height=cL.clientHeight*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
    const y=cL.clientHeight/2, m=28; ctx.clearRect(0,0,cL.clientWidth,cL.clientHeight);
    ctx.lineWidth=2; ctx.strokeStyle='#6C1D45'; ctx.beginPath(); ctx.moveTo(m,y); ctx.lineTo(cL.clientWidth-m,y); ctx.stroke();
    const u=lineState.u, x=lineState.x;
    const r=roundHalfUpToUnit(x,u);
    const left = Math.floor((x-4*u)/u)*u;
    ctx.font='12px Inter'; ctx.fillStyle='#555';
    for(let k=0;k<=10;k++){
      const val = left + k*u;
      const px = map(val);
      ctx.beginPath(); ctx.moveTo(px,y-10); ctx.lineTo(px,y+10); ctx.stroke();
      if(k%2===0){ ctx.fillText(fmtToUnit(val,u), px-12, y+26); }
    }
    const low = r - u/2, high = r + u/2;
    ctx.strokeStyle='#C7A34F'; ctx.setLineDash([6,4]); ctx.beginPath(); ctx.moveTo(map(low),y-30); ctx.lineTo(map(low),y+30); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(map(high),y-30); ctx.lineTo(map(high),y+30); ctx.stroke(); ctx.setLineDash([]);
    ctx.fillStyle='#6C1D45'; ctx.beginPath(); ctx.arc(map(x),y,8,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#C7A34F'; ctx.beginPath(); ctx.arc(map(r),y,9,0,Math.PI*2); ctx.fill();
    lineOut.textContent = fmtToUnit(r,u);
    function map(val){const W=cL.clientWidth;return m+(val-(left))*((W-2*m)/(10*u));}
  }
  function syncLine(val){
    lineState.x = Number(val); lineX.value=lineState.x; lineSlider.value=lineState.x; drawRoundLine();
  }
  lineX.addEventListener('input',()=>syncLine(lineX.value));
  lineSlider.addEventListener('input',()=>syncLine(lineSlider.value));
  lineUnit.addEventListener('change',()=>{ lineState.u=Number(lineUnit.value); drawRoundLine(); });
  id('lineRand').addEventListener('click',()=>{ syncLine(+(Math.random()*200-100).toFixed(3)); });
  id('lineExportCSV').addEventListener('click',()=>downloadCSV(`${deckTitle}_line.csv`, [['x','unit','rounded'], [lineState.x,lineState.u,fmtToUnit(roundHalfUpToUnit(lineState.x,lineState.u),lineState.u)]]));
  id('lineExportJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_line.json`, {x:lineState.x,unit:lineState.u,rounded:roundHalfUpToUnit(lineState.x,lineState.u)}));
  drawRoundLine();
  window.addEventListener('resize',()=>{ if(slides[i].id==='lineSlide') drawRoundLine(); });

  /* ------------------------- Practice Generator (multi sets + coaching) ------------------------- */
  const prState={items:[]};
  function seededRand(seed){ // simple LCG for reproducible sets
    let s = seed; return ()=>{ s=(s*1664525+1013904223)>>>0; return s/2**32; };
  }
  function prBuild(){
    const lv=id('prLevel').value;
    const setTag=id('prSet').value; const seed=(''+lv+setTag).split('').reduce((a,c)=>a+c.charCodeAt(0),0);
    const rnd=seededRand(seed);
    const list=[];
    function task(x,unit,label){ return {type:'unit', prompt:`Round ${x} to ${label}`, x, unit, label, ans: roundHalfUpToUnit(x,unit), fmt:fmtToUnit(roundHalfUpToUnit(x,unit),unit)};}
    function taskSig(x,n){const ans=roundToSig(x,n); return {type:'sig', prompt:`Round ${x} to ${n} s.f.`, x, n, ans, fmt:ans.toPrecision(n)};}
    const choose=(arr)=>arr[Math.floor(rnd()*arr.length)];
    for(let k=0;k<6;k++){
      if(lv==='easy'){
        const a = Math.floor(rnd()*900)+100;
        const unit = rnd()<0.5?10:100;
        list.push(task(a,unit, unit===10?'nearest 10':'nearest 100'));
      }else if(lv==='med'){
        const dp = rnd()<0.5?1:2; const x = +( (rnd()*200-100).toFixed(dp) );
        const unit = dp===1?0.1:0.01;
        list.push(task(x,unit, dp+'â€¯dp'));
      }else if(lv==='hard'){
        if(rnd()<0.5){
          const all=[0.001,0.01,0.1,1,10,100]; const unit=choose(all);
          const x = +( (rnd()*200-100).toFixed(unit<1?3:0) );
          const lab = unit>=1? `nearest ${unit}` : `${decPlacesFromUnit(unit)}â€¯dp`;
          list.push(task(x,unit,lab));
        }else{
          const x = +( (rnd()*9000-4500).toFixed(3) );
          const n = choose([2,3,4]);
          list.push(taskSig(x,n));
        }
      }else{ // expert
        if(rnd()<0.5){
          const x = +( (rnd()*9000-4500).toFixed(4) );
          const n = choose([2,3,4]);
          list.push(taskSig(x,n));
        }else{
          const unit = choose([0.001,0.01,0.1,1,10,100,1000]);
          const x = +( (rnd()*50000-25000).toFixed(unit<1?3:0) );
          const lab = unit>=1? `nearest ${unit}` : `${decPlacesFromUnit(unit)}â€¯dp`;
          list.push(task(x,unit,lab));
        }
      }
    }
    prState.items=list;
    const box=id('prList'); box.innerHTML='';
    list.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1} ${o.type==='sig'?'(s.f.)':''}</div>
        <div class="text-xl mt-1">${o.prompt} = 
          <input class="prin border rounded px-2 py-1 w-48" placeholder="answer">
          <button class="btn soft sm:ml-2 showStep">Steps</button>
          <span data-solution class="ml-2 text-sm" style="display:none">Ans: <b>${o.fmt||o.ans}</b></span>
        </div>
        <div class="text-sm mt-2 steps" style="display:none"></div>`;
      box.appendChild(row);
      // bind steps
      row.querySelector('.showStep').onclick = ()=>{
        const pane=row.querySelector('.steps'); pane.style.display = pane.style.display==='none'?'block':'none';
        if(pane.innerHTML==='') pane.innerHTML = explainItem(o);
      };
    });
    renderMath(id('pracSlide'));
  }
  id('prNew').addEventListener('click',prBuild); prBuild();
  id('prExplainAll').addEventListener('click',()=>{
    document.querySelectorAll('#prList .steps').forEach(p=>{ p.style.display='block'; if(!p.innerHTML){ /* skip */ }});
    document.querySelectorAll('#prList .card').forEach((row,idx)=>{
      const o=prState.items[idx];
      const pane=row.querySelector('.steps'); if(pane.innerHTML==='') pane.innerHTML=explainItem(o);
    });
  });
  id('prCheck').addEventListener('click',()=>{
    let ok=0; id('prList').querySelectorAll('.card').forEach((row,idx)=>{
      const inp=row.querySelector('.prin'); const item=prState.items[idx];
      const v = Number(inp.value.replace(/,/g,'')); const want = item.ans;
      const good = Math.abs(v-want)<1e-10;
      inp.style.borderColor = good? '#22c55e':'#ef4444';
      if(good) ok++;
    });
    id('prFb').textContent = ok===prState.items.length? 'âœ… All correct!' : `Score: ${ok}/${prState.items.length}`;
    if(ok===prState.items.length){ scoreLO(itemHasSig()?2:1); confetti(); }
    function itemHasSig(){ return prState.items.some(o=>o.type==='sig'); }
  });
  id('prExportCSV').addEventListener('click',()=>{
    const rows=[['prompt','answer']]; prState.items.forEach(o=>rows.push([o.prompt,o.fmt||o.ans])); downloadCSV(`${deckTitle}_practice.csv`, rows);
  });
  id('prExportJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_practice.json`, prState.items));
  function explainItem(o){
    if(o.type==='sig'){
      return `<ol class="list-decimal list-inside">
        <li>Count s.f. and locate the ${o.n}-th significant digit.</li>
        <li>Look one digit to the right â†’ apply halfâ€‘up.</li>
        <li>Rewrite afterward in s.f. form: <b>${o.fmt}</b>.</li>
      </ol>`;
    } else {
      const u=o.unit; const dp=decPlacesFromUnit(u);
      return `<ol class="list-decimal list-inside">
        <li>Unit = <b>${u>=1?('nearest '+u): (dp+' dp')}</b>.</li>
        <li>Mark rounding digit and check next digit.</li>
        <li>Halfâ€‘up: 0â€“4 keep, 5â€“9 add 1.</li>
        <li>Digits to the right â†’ zeros (or truncated for decimals).</li>
        <li>Answer: <b>${o.fmt}</b>.</li>
      </ol>`;
    }
  }

  /* ------------------------- Significant Figures ------------------------- */
  const sigCState={items:[]}, sigRState={items:[]};
  function genSigCount(){
    const pool=['0.00340','1200','1200.','5.060','0.0702','30007','2.90','0.0005','40','40.0'];
    sigCState.items = pool.sort(()=>Math.random()-0.5).slice(0,4).map(s=>({s,ans:countSigStr(s)}));
    const box=id('sigCountList'); box.innerHTML='';
    sigCState.items.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-3';
      row.innerHTML=`<div class="text-xl">\\( ${o.s} \\) has <input class="scin border rounded px-2 py-1 w-20" placeholder="s.f."> s.f. <span data-solution style="display:none" class="ml-2 text-sm">Ans: <b>${o.ans}</b></span></div>`;
      box.appendChild(row);
    });
    renderMath(id('sigSlide'));
  }
  function genSigRound(){
    const items=[];
    for(let k=0;k<4;k++){
      const x = +( (Math.random()*9000-1000).toFixed(4) );
      const n=[2,3,4][Math.floor(Math.random()*3)];
      const ans = roundToSig(x,n);
      items.push({x,n,ans,fmt:ans.toPrecision(n)});
    }
    sigRState.items=items;
    const box=id('sigRoundList'); box.innerHTML='';
    items.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-3';
      row.innerHTML=`<div class="text-xl">Round \\( ${o.x} \\) to ${o.n} s.f. = <input class="srin border rounded px-2 py-1 w-40" placeholder="answer"> <span data-solution style="display:none" class="ml-2 text-sm">Ans: <b>${o.fmt}</b></span></div>`;
      box.appendChild(row);
    });
    renderMath(id('sigSlide'));
  }
  id('sigCountNew').addEventListener('click',genSigCount);
  id('sigRoundNew').addEventListener('click',genSigRound);
  genSigCount(); genSigRound();
  id('sigCountCheck').addEventListener('click',()=>{
    let ok=0; id('sigCountList').querySelectorAll('.card').forEach((row,idx)=>{
      const want=sigCState.items[idx].ans; const got=Number(row.querySelector('.scin').value);
      const good = got===want; row.querySelector('.scin').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('sigCountFb').textContent = ok===sigCState.items.length? 'âœ… Perfect!' : `Score: ${ok}/${sigCState.items.length}`;
    if(ok===sigCState.items.length){ scoreLO(2); confetti(); }
  });
  id('sigRoundCheck').addEventListener('click',()=>{
    let ok=0; id('sigRoundList').querySelectorAll('.card').forEach((row,idx)=>{
      const want=sigRState.items[idx].fmt; const got=(row.querySelector('.srin').value||'').trim();
      const good = (got===want) || Math.abs(Number(got)-Number(want))<1e-10;
      row.querySelector('.srin').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('sigRoundFb').textContent = ok===sigRState.items.length? 'âœ… Excellent!' : `Score: ${ok}/${sigRState.items.length}`;
    if(ok===sigRState.items.length){ scoreLO(2); confetti(); }
  });
  id('sigCountCSV').addEventListener('click',()=>{
    const rows=[['number','sig_figs']]; sigCState.items.forEach(o=>rows.push([o.s,o.ans])); downloadCSV(`${deckTitle}_sig_count.csv`, rows);
  });
  id('sigCountJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_sig_count.json`, sigCState.items));
  id('sigRoundCSV').addEventListener('click',()=>{
    const rows=[['x','n_sf','answer']]; sigRState.items.forEach(o=>rows.push([o.x,o.n,o.fmt])); downloadCSV(`${deckTitle}_sig_round.csv`, rows);
  });
  id('sigRoundJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_sig_round.json`, sigRState.items));

  /* ------------------------- Scientific Notation ------------------------- */
  const sciState={items:[]};
  function sciNew(){
    const list=[];
    for(let k=0;k<4;k++){
      const e = Math.floor(Math.random()*7)-3; // -3..3
      const m = +( (Math.random()*9+1).toFixed(4) ); // 1..10
      const n=[2,3,4][Math.floor(Math.random()*3)];
      const r=sciRound(m,e,n);
      list.push({m,e,n,ans:r});
    }
    sciState.items=list;
    const box=id('sciList'); box.innerHTML='';
    list.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-xl">Round \\( ${o.m}\\times 10^{${o.e}} \\) to ${o.n} s.f.: mantissa = <input class="sciin border rounded px-2 py-1 w-20" placeholder="m">, exponent = <input class="sciexp border rounded px-2 py-1 w-20" placeholder="e"> <span data-solution style="display:none" class="ml-2 text-sm">Ans: <b>${o.ans.m}</b>, <b>${o.ans.e}</b></span></div>`;
      box.appendChild(row);
    });
    renderMath(id('sciSlide'));
  }
  id('sciNew').addEventListener('click',sciNew); sciNew();
  id('sciCheck').addEventListener('click',()=>{
    let ok=0; id('sciList').querySelectorAll('.card').forEach((row,idx)=>{
      const item=sciState.items[idx]; const m=Number(row.querySelector('.sciin').value); const e=Number(row.querySelector('.sciexp').value);
      const good= Math.abs(m-item.ans.m)<1e-10 && e===item.ans.e; row.querySelector('.sciin').style.borderColor=good?'#22c55e':'#ef4444'; row.querySelector('.sciexp').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('sciFb').textContent = ok===sciState.items.length? 'âœ… Perfect!' : `Score: ${ok}/${sciState.items.length}`;
    if(ok===sciState.items.length){ scoreLO(2); confetti(); }
  });
  id('sciCSV').addEventListener('click',()=>{
    const rows=[['m','e','n_sf','m_ans','e_ans']]; sciState.items.forEach(o=>rows.push([o.m,o.e,o.n,o.ans.m,o.ans.e])); downloadCSV(`${deckTitle}_scientific.csv`, rows);
  });
  id('sciJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_scientific.json`, sciState.items));

  /* ------------------------- Bounds ------------------------- */
  const bdState={items:[]};
  function bdNew(){
    const list=[];
    for(let k=0;k<4;k++){
      const unit=[0.001,0.01,0.1,1,10,100][Math.floor(Math.random()*6)];
      const x = +( (Math.random()*1000-500).toFixed(unit<1?3:0) );
      const r = roundHalfUpToUnit(x,unit);
      const lb = r - unit/2, ub = r + unit/2;
      const label = unit>=1? `nearest ${unit}` : `${decPlacesFromUnit(unit)}â€¯dp`;
      list.push({r,unit,lb,ub,label});
    }
    bdState.items=list;
    const box=id('bdList'); box.innerHTML='';
    list.forEach((o,idx)=>{
      const dp=decPlacesFromUnit(o.unit);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1}</div>
        <div class="mt-1">A measurement is reported as <b>${fmtToUnit(o.r,o.unit)}</b> (${o.label}). Give the bounds for the true value \(x\):</div>
        <div class="mt-1">Lower bound: <input class="bdlb border rounded px-2 py-1 w-32" placeholder="${(o.lb).toFixed(dp)}">, Upper bound: <input class="bdub border rounded px-2 py-1 w-32" placeholder="${(o.ub).toFixed(dp)}"> <span data-solution style="display:none" class="ml-2 text-sm">Ans: <b>${o.lb}</b> to <b>${o.ub}</b></span></div>`;
      box.appendChild(row);
    });
    renderMath(id('boundSlide'));
  }
  id('bdNew').addEventListener('click',bdNew); bdNew();
  id('bdCheck').addEventListener('click',()=>{
    let ok=0; id('bdList').querySelectorAll('.card').forEach((row,idx)=>{
      const item=bdState.items[idx]; const lb=Number(row.querySelector('.bdlb').value); const ub=Number(row.querySelector('.bdub').value);
      const good = Math.abs(lb-item.lb)<1e-10 && Math.abs(ub-item.ub)<1e-10;
      row.querySelector('.bdlb').style.borderColor=good?'#22c55e':'#ef4444';
      row.querySelector('.bdub').style.borderColor=good?'#22c55e':'#ef4444';
      if(good) ok++;
    });
    id('bdFb').textContent = ok===bdState.items.length? 'âœ… Excellent!' : `Score: ${ok}/${bdState.items.length}`;
    if(ok===bdState.items.length){ scoreLO(3); confetti(); }
  });
  id('bdCSV').addEventListener('click',()=>{
    const rows=[['reported','unit','label','lower','upper']];
    bdState.items.forEach(o=>rows.push([fmtToUnit(o.r,o.unit),o.unit,o.label,o.lb,o.ub]));
    downloadCSV(`${deckTitle}_bounds.csv`, rows);
  });
  id('bdJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_bounds.json`, bdState.items));

  /* ------------------------- Real-world (Qatar) ------------------------- */
  const realState={items:[]};
  function realNew(){
    const list=[];
    // Currency estimation
    const price = +( (Math.random()*40+10).toFixed(2) );
    const qty = Math.floor(Math.random()*7)+4; // 4..10
    list.push({type:'est', prompt:`Estimate the total cost of ${qty} items at QAR ${price} each by rounding to the nearest riyal (QAR).`, ans: Math.round(price)*qty, lo:4});
    // Population rounding
    const pop = Math.floor(Math.random()*7e6)+3e6;
    list.push({type:'unit', prompt:`Round the population ${pop.toLocaleString()} to the nearest hundred thousand.`, unit:100000, ans: roundHalfUpToUnit(pop,100000), lo:4});
    // Distance with dp
    const dist = +( (Math.random()*150+5).toFixed(2) );
    list.push({type:'unit', prompt:`Round the distance ${dist} km to 1â€¯dp.`, unit:0.1, ans: roundHalfUpToUnit(dist,0.1), lo:1});
    // Time rounding
    const minutes = +( (Math.random()*180).toFixed(1) );
    list.push({type:'unit', prompt:`Round the running time ${minutes} minutes to the nearest minute.`, unit:1, ans: roundHalfUpToUnit(minutes,1), lo:1});
    realState.items=list;
    const box=id('realList'); box.innerHTML='';
    list.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1} <span class="text-xs text-gray-500">(LOâ€‘${o.lo})</span></div>
        <div class="text-xl mt-1">${o.prompt} = <input class="rin border rounded px-2 py-1 w-40" placeholder="answer"> <span data-solution style="display:none" class="ml-2 text-sm">Ans: <b>${o.ans}</b></span></div>`;
      box.appendChild(row);
    });
  }
  id('realNew').addEventListener('click',realNew); realNew();
  id('realCheck').addEventListener('click',()=>{
    let ok=0; id('realList').querySelectorAll('.card').forEach((row,idx)=>{
      const item=realState.items[idx]; const v=Number(row.querySelector('.rin').value);
      const good=Math.abs(v-item.ans)<1e-10; row.querySelector('.rin').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('realFb').textContent = ok===realState.items.length? 'âœ… Realâ€‘world ready!' : `Score: ${ok}/${realState.items.length}`;
    if(ok===realState.items.length){ scoreLO(4); confetti(); }
  });
  id('realCSV').addEventListener('click',()=>{
    const rows=[['prompt','answer']]; realState.items.forEach(o=>rows.push([o.prompt,o.ans])); downloadCSV(`${deckTitle}_realworld.csv`, rows);
  });
  id('realJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_realworld.json`, realState.items));

  /* ------------------------- Inquiry stations export ------------------------- */
  id('stationExport').addEventListener('click',()=>{
    downloadCSV(`${deckTitle}_stations.csv`, [
      ['Station','Notes'],
      ['A', id('staA').value],
      ['B', id('staB').value],
      ['C', id('staC').value]
    ]);
  });

  /* ------------------------- Challenge Mode ------------------------- */
  const chState={cur:null, streak:0, history:[]};
  function chNew(){
    const lv=id('chLevel').value;
    let prompt='', ans=null, soln='';
    const r = Math.random();
    if(lv==='easy'){
      const x = Math.floor(Math.random()*900)+100, unit=10;
      ans = roundHalfUpToUnit(x,unit); prompt = `Round ${x} to the nearest 10`; soln = `Check the ones digit; 5â€“9 â†’ up.`;
    }else if(lv==='med'){
      const x = +( (Math.random()*200-100).toFixed(2) ); const dp=1;
      ans = roundToDP(x,dp); prompt=`Round ${x} to ${dp}â€¯dp`; soln=`Unit is 0.1; look at hundredths.`;
    }else if(lv==='hard'){
      if(r<0.5){ const x=+( (Math.random()*9000-3000).toFixed(3) ); const n=[2,3,4][Math.floor(Math.random()*3)]; ans=roundToSig(x,n); prompt=`Round ${x} to ${n} s.f.`; soln=`Locate ${n}-th s.f.; apply halfâ€‘up.`; }
      else { const unit=[0.01,0.1,1,10,100][Math.floor(Math.random()*5)]; const x=+( (Math.random()*2000-1000).toFixed(unit<1?2:0) ); ans=roundHalfUpToUnit(x,unit); prompt=`Round ${x} to ${unit>=1? 'nearest '+unit : decPlacesFromUnit(unit)+'â€¯dp'}`; soln=`Unit=${unit}.`; }
    }else{ // expert
      if(r<0.33){ const e=Math.floor(Math.random()*7)-3; const m=+( (Math.random()*9+1).toFixed(4) ); const n=[2,3,4][Math.floor(Math.random()*3)]; const rr=sciRound(m,e,n); ans=rr.m*10**rr.e; prompt=`Round ${m}Ã—10^${e} to ${n} s.f. (enter numeric value)`; soln=`Round mantissa; adjust exponent if â‰¥10.`; }
      else if(r<0.66){ const unit=[0.001,0.01,0.1,1,10,100][Math.floor(Math.random()*6)]; const r0=+( (Math.random()*1000-500).toFixed(unit<1?3:0) ); const rr=roundHalfUpToUnit(r0,unit); const lb=rr-unit/2; ans=lb; prompt=`Given value rounded to ${unit>=1?'nearest '+unit: decPlacesFromUnit(unit)+'â€¯dp'} is ${fmtToUnit(rr,unit)}. Enter the <lower bound>.`; soln=`Interval [râˆ’u/2, r+u/2).`; }
      else { const x=+( (Math.random()*9000-1000).toFixed(4) ); const n=[2,3,4][Math.floor(Math.random()*3)]; ans=roundToSig(x,n); prompt=`Round ${x} to ${n} s.f.`; soln=`As before.`; }
    }
    chState.cur={prompt,ans,soln}; id('chText').textContent=prompt; id('chAns').value=''; id('chFb').textContent=''; id('chHintBox').textContent=''; id('chSoln').textContent=''; renderMath(id('challengeSlide'));
  }
  id('chNew').addEventListener('click',chNew); chNew();
  id('chHint').addEventListener('click',()=>{ id('chHintBox').innerHTML=`<div class="hint">Recall halfâ€‘up rounding. For bounds use \\([r-\\tfrac{u}{2},\\; r+\\tfrac{u}{2})\\).</div>`; renderMath(id('challengeSlide')); });
  id('chExplain').addEventListener('click',()=>{ if(role==='teacher'){ id('chSoln').innerHTML = `<div class="explain"><b>Solution sketch:</b> ${chState.cur.soln}</div>`;} else { id('chSoln').innerHTML = `<div class="hint">Teacher mode shows full solutions.</div>`; }});
  id('chCheck').addEventListener('click',()=>{
    const got=Number(id('chAns').value), want=chState.cur.ans;
    const ok = Math.abs(got-want)<1e-10;
    if(ok){ chState.streak++; id('chFb').textContent='âœ… Correct!'; id('chFb').className='mt-2 h-6 font-semibold text-green-700'; confetti(); chState.history.push({prompt:chState.cur.prompt, answer:want, correct:true}); chNew(); }
    else { chState.streak=0; id('chFb').textContent='âŒ Not quite. Expected '+want; id('chFb').className='mt-2 h-6 font-semibold text-red-700'; chState.history.push({prompt:chState.cur.prompt, answer:want, correct:false}); }
    id('streakOut').textContent=chState.streak;
  });
  id('chCSV').addEventListener('click',()=>{
    const rows=[['prompt','answer','correct']]; chState.history.forEach(h=>rows.push([h.prompt,h.answer,h.correct])); downloadCSV(`${deckTitle}_challenge.csv`, rows);
  });
  id('chJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_challenge.json`, chState.history));

  /* ------------------------- Teacher mode: show solutions toggles ------------------------- */
  function applyRoleToSolutions(){
    const show = (role==='teacher');
    document.querySelectorAll('[data-solution]').forEach(el=>{ el.style.display=show?'inline':'none';});
  }
  const roleObserver=new MutationObserver(applyRoleToSolutions);
  roleObserver.observe(document.body,{attributes:true,attributeFilter:['data-role']});
  applyRoleToSolutions();

  /* ------------------------- LO scoring helper ------------------------- */
  function scoreLO(n){ LO_SCORES[n]=true; document.querySelector(`[data-checklo="${n}"]`).checked=true; updateDonut(); }

  /* ------------------------- Init ------------------------- */
  window.addEventListener('resize',()=>{ if(slides[i].id==='lineSlide') drawRoundLine(); });
  show(0);

})();
</script>
</body>
</html>
