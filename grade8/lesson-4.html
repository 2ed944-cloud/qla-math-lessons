<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>G8 • Unit 1 • Lesson 4 • Rounding Numbers (QLA) — Final</title>

<!-- Fonts & Tailwind -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>

<script>
  // Boot KaTeX + expose re-typeset helper
  window.addEventListener('DOMContentLoaded', () => {
    const run = (root = document.body) => {
      if (!window.renderMathInElement) return;
      window.renderMathInElement(root, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '\\[', right: '\\]', display: true },
          { left: '\\(', right: '\\)', display: false }
        ],
        throwOnError: false
      });
    };
    if (window.renderMathInElement) run();
    else {
      const t = setInterval(()=>{ if(window.renderMathInElement){ clearInterval(t); run();}}, 25);
      setTimeout(()=>clearInterval(t), 6000);
    }
    window._rerenderMath = run;
  });
</script>

<style>
  :root{--maroon:#6C1D45;--gold:#C7A34F;--dark:#2C2C2E;--light:#F5F5F5;--accent:#E8D5B7}
  html,body{height:100%;background:#2d3748;color:#111;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  /* Stage */
  #deck{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;padding:10px}
  #slides{position:relative;width:100%;max-width:1280px;aspect-ratio:16/9;background:#fff;box-shadow:0 14px 36px rgba(0,0,0,.35);overflow:hidden;border-radius:18px}
  .slide{position:absolute;inset:0;padding:3.5%;display:flex;flex-direction:column;justify-content:flex-start;align-items:center;text-align:left;opacity:0;transform:translateY(14px) scale(.985);transition:.55s ease;pointer-events:none;overflow:auto}
  .slide.active{opacity:1;transform:none;pointer-events:auto}
  .bg-maroon{background-color:var(--maroon)} .text-maroon{color:var(--maroon)} .text-gold{color:var(--gold)}
  .banner{width:100%;height:110px;background:#fff center/contain no-repeat;border-bottom:3px solid var(--gold);border-radius:10px}
  .card{border:1px solid #e5e7eb;border-radius:14px;background:#fafafa}
  .chip{display:inline-flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.05);border-radius:9999px;padding:.35rem .75rem;cursor:pointer}
  .chip:hover{outline:2px solid var(--gold)}
  .btn{padding:.55rem 1rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
  .btn.maroon{background:var(--maroon);color:#fff;border-color:var(--maroon)}
  .btn:hover{filter:brightness(0.98)}
  .btn.sm{padding:.35rem .75rem;font-weight:600}
  #controls{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.55);padding:.4rem .6rem;border-radius:999px;z-index:20;backdrop-filter:blur(6px)}
  #controls button{width:42px;height:42px;border-radius:999px;border:none;background:#fff;cursor:pointer;font-weight:700}
  #controls button:hover{transform:scale(1.06)}
  #counter{color:#fff;font-weight:700;min-width:94px;text-align:center}
  #progress{position:fixed;left:0;bottom:0;height:5px;width:0;background:var(--gold);z-index:30;transition:width .35s ease}
  #fsHint{position:absolute;top:10px;right:12px;color:#fff;background:rgba(0,0,0,.35);padding:.25rem .5rem;border-radius:8px;font-size:.8rem}

  /* Popover */
  #pop{position:fixed;inset:auto auto 20px 20px;max-width:min(560px,90vw);background:#fff;border:2px solid var(--gold);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.25);padding:14px 16px;z-index:40;display:none;text-align:left}
  #pop strong{color:var(--maroon)} #pop .close{float:right;color:#666;cursor:pointer;font-weight:800}

  /* Number line */
  .nl-wrap{width:100%;max-width:980px}
  canvas.nline{width:100%;height:190px;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa);border:2px solid #ececec}

  .confetti{position:fixed;pointer-events:none;z-index:50}
  .hint{background:#fff3cd;border:1px solid #ffe69c;border-radius:10px;padding:.5rem .75rem}
  .tok{display:inline-block;padding:.05rem .25rem;border-radius:6px}
  .lead{font-size:1.05rem;line-height:1.45}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace;background:#edf2f7;border:1px solid #cbd5e0;border-radius:6px;padding:.05rem .35rem}
</style>
</head>
<body>

<div id="deck" aria-live="polite">
  <div id="slides" class="relative">
    <div id="fsHint">Press <strong>F</strong> for fullscreen</div>

    <!-- 0 • Title -->
    <section class="slide active bg-maroon text-white" id="titleSlide">
      <div class="w-full h-16 banner mb-4 rounded-md" style="background-image:url('../assets/qla_banner.png')" aria-label="QLA Partner Banner"></div>
      <div class="flex items-center gap-8">
        <img src="../assets/qla_logo.png" alt="QLA Logo" class="h-20 w-auto" onerror="this.style.display='none'"/>
        <div class="text-left">
          <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">Unit 1 — Lesson 4: Rounding Numbers</h1>
          <p class="text-gold text-xl md:text-2xl mt-2 font-semibold">Grade 8 • Whole Numbers • Decimals (0–6 dp) • Significant Figures • Scientific Notation • Bounds</p>
          <p class="mt-1">Qatar Leadership Academy — Mathematics</p>
        </div>
      </div>
      <div class="mt-4 grid md:grid-cols-3 gap-3 w-full">
        <div class="card p-3 text-black">
          <div class="font-bold text-maroon">Today we will…</div>
          <ul class="list-disc list-inside text-sm">
            <li>Explain rounding <em>before</em> we do it</li>
            <li>Explore patterns using a number line</li>
            <li>Choose appropriate precision in Qatar contexts</li>
          </ul>
        </div>
        <div class="card p-3 text-black">
          <div class="font-bold text-maroon">Success Criteria</div>
          <ul class="list-disc list-inside text-sm">
            <li>I identify the rounding digit & the decision digit</li>
            <li>I justify my choice of dp / s.f. in context</li>
            <li>I state error bounds for any rounded figure</li>
          </ul>
        </div>
        <div class="card p-3 text-black">
          <div class="font-bold text-maroon">Misconceptions to avoid</div>
          <ul class="list-disc list-inside text-sm">
            <li>“5 rounds toward 0” (we use half‑up: away from 0)</li>
            <li>Counting leading zeros as significant</li>
            <li>Forgetting bounds are half a unit on each side</li>
          </ul>
        </div>
      </div>
      <div class="absolute bottom-3 text-sm text-gray-100">Aligned to AERO 8.NS &amp; 8.EE readiness.</div>
    </section>

    <!-- 1 • LOs & Keywords (Bilingual) -->
    <section class="slide" id="loSlide">
      <div class="w-full max-w-5xl">
        <h2 class="text-3xl font-extrabold text-maroon mb-2">Learning Objectives &amp; Keywords</h2>
        <div class="grid md:grid-cols-2 gap-6">
          <div class="card p-5">
            <h3 class="text-2xl font-bold text-maroon mb-1">Learning Objectives</h3>
            <ul class="list-disc list-inside space-y-1 lead">
              <li>Round whole numbers & decimals (0–6 dp) using the <strong>half‑up</strong> rule (symmetric for negatives).</li>
              <li>Round to a given number of <strong>significant figures</strong> and in <strong>scientific notation</strong>.</li>
              <li>Interpret a rounded value’s <strong>bounds</strong> (error interval).</li>
              <li>Choose appropriate precision for <strong>Qatar‑related applications</strong> and justify reasonableness.</li>
            </ul>
          </div>
          <div class="card p-5">
            <div class="flex items-center justify-between">
              <h3 class="text-2xl font-bold text-maroon">Keywords</h3>
              <div class="flex items-center gap-2">
                <label class="text-sm">Glossary language</label>
                <select id="kwLang" class="border rounded px-2 py-1 text-sm">
                  <option value="en" selected>English</option>
                  <option value="ar">العربية</option>
                </select>
              </div>
            </div>
            <div id="kwChips" class="flex flex-wrap gap-2 text-lg mt-2"></div>
            <p class="text-xs text-gray-500 mt-3">We use the **school standard** half‑up rule: a trailing 5 rounds <em>away from 0</em> (e.g., \(-1.5\to -2\)).</p>
            <div class="mt-3">
              <button id="kwQuizBtn" class="btn sm">Start Glossary Quick Quiz</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 2 • Glossary Quick Quiz -->
    <section class="slide" id="kwQuizSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Glossary Quick Quiz</h2>
      <p class="lead mb-3">Choose the correct match. Language: <span id="kwQuizLangOut" class="font-bold">English</span>. Change from the Keywords slide.</p>
      <div id="kwQuizList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div class="mt-3 flex gap-2">
        <button id="kwQuizCheck" class="btn maroon">Check</button>
        <button id="kwQuizNew" class="btn">New Quiz</button>
      </div>
      <div id="kwQuizFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- 3 • Warm‑up -->
    <section class="slide" id="warmSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Warm‑Up (Explain → Try)</h2>
      <div class="card p-4 w-full max-w-5xl mb-3">
        <p class="lead"><strong>Before doing:</strong> Identify (1) the <em>rounding digit</em>; (2) the digit to its right (decision digit). If the decision digit is 5–9, increase the rounding digit by 1; if 0–4, keep it. For negatives, a 5 goes <em>away from 0</em>.</p>
      </div>
      <div class="grid md:grid-cols-3 gap-4 w-full max-w-5xl">
        <div class="card p-4 text-left">
          <div class="font-bold text-maroon mb-1">Nearest hundred</div>
          <div class="text-xl">\( 12{,}649 \) → <input id="w1" class="border rounded px-2 py-1 w-32" placeholder="e.g., 12,600"></div>
        </div>
        <div class="card p-4 text-left">
          <div class="font-bold text-maroon mb-1">1 decimal place</div>
          <div class="text-xl">\( 7.45 \) → <input id="w2" class="border rounded px-2 py-1 w-24" placeholder="7.5"></div>
        </div>
        <div class="card p-4 text-left">
          <div class="font-bold text-maroon mb-1">Nearest integer (negative)</div>
          <div class="text-xl">\( -2.5 \) → <input id="w3" class="border rounded px-2 py-1 w-24" placeholder="-3"></div>
        </div>
      </div>
      <div class="mt-3 flex gap-2">
        <button id="warmCheck" class="btn maroon">Check</button>
        <button id="warmReset" class="btn">Reset</button>
      </div>
      <div id="warmFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- 4 • Place Value & Rule (dp mode guarantees decision digit) -->
    <section class="slide" id="placeSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Place Value &amp; The Rounding Rule</h2>
      <div class="card p-4 w-full max-w-5xl mb-3">
        <p class="lead"><strong>Read first:</strong> Choose the target precision (place value or \(n\) dp). Highlight the rounding digit and the next digit. Make a prediction, then test.</p>
      </div>
      <div class="grid lg:grid-cols-2 gap-6 w-full max-w-5xl">
        <div class="card p-5">
          <div class="flex flex-wrap items-center gap-3 text-sm mb-2">
            <label class="chip"><input type="radio" name="pvMode" value="place" checked> place (… tens, hundreds …)</label>
            <label class="chip"><input type="radio" name="pvMode" value="dp"> decimal places (dp)</label>
            <label>integer digits:
              <input id="pvIntDigits" type="number" min="3" max="11" value="6" class="border rounded px-2 py-1 w-20">
            </label>
            <label>max dp:
              <input id="pvMaxDp" type="number" min="0" max="6" value="3" class="border rounded px-2 py-1 w-16">
            </label>
            <button id="pvNew" class="btn sm">New number</button>
          </div>

          <div class="text-2xl" id="pvNumber"></div>

          <div class="mt-2 flex items-center gap-3">
            <label id="pvLabelPlace">Round to:
              <select id="pvPlace" class="border rounded px-2 py-1">
                <option value="1">ones</option>
                <option value="10">tens</option>
                <option value="100" selected>hundreds</option>
                <option value="1000">thousands</option>
                <option value="10000">ten‑thousands</option>
                <option value="100000">hundred‑thousands</option>
                <option value="1000000">millions</option>
              </select>
            </label>
            <label id="pvLabelDp" style="display:none">Round to:
              <select id="pvDp" class="border rounded px-2 py-1">
                <option value="0">0 dp</option>
                <option value="1">1 dp</option>
                <option value="2">2 dp</option>
                <option value="3" selected>3 dp</option>
                <option value="4">4 dp</option>
                <option value="5">5 dp</option>
                <option value="6">6 dp</option>
              </select>
            </label>
            <button id="pvExplain" class="btn sm">Show step‑by‑step</button>
          </div>

          <div class="mt-2">Prediction: <input id="pvPred" class="border rounded px-2 py-1 w-40" placeholder="your guess"></div>
          <div class="mt-2">Rounded result: <span id="pvResult" class="font-bold"></span></div>
          <div id="pvSteps" class="hint mt-3 text-sm" style="display:none"></div>
        </div>

        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Sample Worked Examples</h3>
          <div class="space-y-2 text-lg">
            <div>\( 246.38 \) to 1 dp → \( 246.4 \)</div>
            <div>\( 7{,}950 \) to nearest thousand → \( 8{,}000 \)</div>
            <div>\( -12.5 \) to integer → \( -13 \)</div>
            <div>\( 3{,}456{,}789.4321 \) to 3 dp → \( 3{,}456{,}789.432 \)</div>
          </div>
        </div>
      </div>

      <div class="mt-3 flex gap-2">
        <button id="pvExportCSV" class="btn">Export CSV</button>
        <button id="pvExportJSON" class="btn">Export JSON</button>
      </div>
    </section>

    <!-- 5 • Rounding Explorer (Number Line with dp 0–6) -->
    <section class="slide" id="lineSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Rounding Explorer (Number Line)</h2>
      <div class="card p-4 w-full max-w-5xl mb-3">
        <p class="lead"><strong>Explore:</strong> Choose dp (0–6). Gold dashed lines show the half‑unit cutoffs. Use <span class="kbd">Randomize</span> to get an \(x\) with extra decimals so the decision digit is visible.</p>
      </div>
      <div class="nl-wrap"><canvas id="roundLine" class="nline" aria-label="Rounding number line"></canvas></div>
      <div class="mt-3 flex flex-wrap items-center gap-3 text-sm">
        <label class="chip">x = <input id="lineX" class="border rounded px-2 py-1 w-40" value="23.47"></label>
        <label class="chip">dp =
          <select id="lineDp" class="border rounded px-2 py-1">
            <option value="0">0 dp (nearest integer)</option>
            <option value="1" selected>1 dp</option>
            <option value="2">2 dp</option>
            <option value="3">3 dp</option>
            <option value="4">4 dp</option>
            <option value="5">5 dp</option>
            <option value="6">6 dp</option>
          </select>
        </label>
        <span class="chip">rounded = <b id="lineOut">23.5</b></span>
        <button id="lineRand" class="btn sm">Randomize</button>
        <button id="lineExportCSV" class="btn sm">Export CSV</button>
        <button id="lineExportJSON" class="btn sm">Export JSON</button>
      </div>
    </section>

    <!-- 6 • Exploration Stations -->
    <section class="slide" id="stationsSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Exploration Stations</h2>
      <p class="lead mb-3"><strong>Rotate in groups.</strong> At each station: predict → test → explain. Write: “We rounded to … because …”.</p>
      <div class="grid md:grid-cols-2 gap-4 w-full max-w-5xl">
        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">S1 • Place Value Big Numbers</div>
          <p>Round \( \text{QAR } 12{,}678{,}999 \) to:</p>
          <ul class="list-disc list-inside">
            <li>nearest hundred‑thousand</li>
            <li>nearest million</li>
          </ul>
          <input class="s1a border rounded px-2 py-1 w-40 mt-2" placeholder="hundred‑thousand">
          <input class="s1b border rounded px-2 py-1 w-40 mt-2" placeholder="million">
          <button class="btn sm mt-2 s1check">Check</button>
          <div class="s1fb mt-1 font-semibold"></div>
        </div>

        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">S2 • Decimals (Fuel)</div>
          <p>Fuel price: \( \text{QAR } 2.1379\,/\,\text{L} \). Round to 2 dp and 3 dp.</p>
          <input class="s2a border rounded px-2 py-1 w-28 mt-2" placeholder="2 dp">
          <input class="s2b border rounded px-2 py-1 w-28 mt-2" placeholder="3 dp">
          <button class="btn sm mt-2 s2check">Check</button>
          <div class="s2fb mt-1 font-semibold"></div>
        </div>

        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">S3 • Significant Figures</div>
          <p>\( 0.004\,987\,1 \) → 2 s.f. and 4 s.f.</p>
          <input class="s3a border rounded px-2 py-1 w-40 mt-2" placeholder="2 s.f.">
          <input class="s3b border rounded px-2 py-1 w-40 mt-2" placeholder="4 s.f.">
          <button class="btn sm mt-2 s3check">Check</button>
          <div class="s3fb mt-1 font-semibold"></div>
        </div>

        <div class="card p-4">
          <div class="font-bold text-maroon mb-1">S4 • Bounds</div>
          <p>Reported: \( 7.3 \) km (to 1 dp). Give lower & upper bounds.</p>
          <input class="s4a border rounded px-2 py-1 w-28 mt-2" placeholder="lower">
          <input class="s4b border rounded px-2 py-1 w-28 mt-2" placeholder="upper">
          <button class="btn sm mt-2 s4check">Check</button>
          <div class="s4fb mt-1 font-semibold"></div>
        </div>
      </div>
    </section>

    <!-- 7 • Practice Generator (final) -->
    <section class="slide" id="pracSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Practice Generator (Differentiated)</h2>
      <div class="card p-5 w-full max-w-5xl">
        <div class="grid md:grid-cols-2 gap-3">
          <div class="flex flex-wrap items-center gap-3">
            <label>Level
              <select id="prLevel" class="border rounded px-2 py-1">
                <option value="easy">Easy (nearest 10/100, ≤2 dp)</option>
                <option value="med" selected>Medium (negatives, 1–3 dp)</option>
                <option value="hard">Hard (0–4 dp, s.f.)</option>
                <option value="expert">Expert (0–6 dp, s.f., sci, bounds)</option>
              </select>
            </label>
            <label>Set size
              <input id="prCount" type="number" min="4" max="16" value="8" class="border rounded px-2 py-1 w-20">
            </label>
            <label>Min dp
              <input id="prMinDp" type="number" min="0" max="6" value="0" class="border rounded px-2 py-1 w-16">
            </label>
            <label>Max dp
              <input id="prMaxDp" type="number" min="0" max="6" value="3" class="border rounded px-2 py-1 w-16">
            </label>
            <label>Max int digits
              <input id="prMaxDigits" type="number" min="3" max="11" value="8" class="border rounded px-2 py-1 w-20">
            </label>
            <button id="prNew" class="btn">New set</button>
          </div>
          <div class="hint text-sm">
            Numbers rounded to \(n\) dp are generated with at least \(n+1\) decimals, so you must examine the decision digit.
          </div>
        </div>
        <div id="prList" class="grid md:grid-cols-2 gap-3 mt-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="prCheck" class="btn maroon">Check</button>
          <button id="prExportCSV" class="btn">Export CSV</button>
          <button id="prExportJSON" class="btn">Export JSON</button>
        </div>
        <div id="prFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 8 • Significant Figures -->
    <section class="slide" id="sigSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Significant Figures</h2>
      <div class="card p-4 w-full max-w-5xl mb-3">
        <p class="lead"><strong>Read first:</strong> Leading zeros never count; zeros between non‑zeros always count; trailing zeros count only if there is a decimal point. Use s.f. to communicate precision.</p>
      </div>
      <div class="grid lg:grid-cols-2 gap-6 w-full max-w-5xl">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Count s.f.</h3>
          <div id="sigCountList" class="grid gap-2"></div>
          <div class="mt-3 flex gap-2">
            <button id="sigCountNew" class="btn">New set</button>
            <button id="sigCountCheck" class="btn maroon">Check</button>
            <button id="sigCountCSV" class="btn">Export CSV</button>
            <button id="sigCountJSON" class="btn">Export JSON</button>
          </div>
          <div id="sigCountFb" class="mt-2 h-6 font-semibold"></div>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon mb-2">Round to n s.f.</h3>
          <div id="sigRoundList" class="grid gap-2"></div>
          <div class="mt-3 flex gap-2">
            <button id="sigRoundNew" class="btn">New set</button>
            <button id="sigRoundCheck" class="btn maroon">Check</button>
            <button id="sigRoundCSV" class="btn">Export CSV</button>
            <button id="sigRoundJSON" class="btn">Export JSON</button>
          </div>
          <div id="sigRoundFb" class="mt-2 h-6 font-semibold"></div>
        </div>
      </div>
      <div class="hint mt-3 text-sm">Examples: \(1200\) has 2 s.f.; \(1200.\) has 4 s.f.; \(0.00450\) has 3 s.f.</div>
    </section>

    <!-- 9 • Scientific Notation -->
    <section class="slide" id="sciSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Scientific Notation (Round the Mantissa)</h2>
      <div class="card p-4 w-full max-w-5xl mb-3">
        <p class="lead"><strong>Read first:</strong> Scientific form is \(a\times10^n\) with \(1\le |a| &lt; 10\). Round the mantissa \(a\) to \(n\) s.f. Re‑normalize if rounding pushes \(a\) to 10.</p>
      </div>
      <div class="card p-5 w-full max-w-5xl">
        <div id="sciList" class="grid md:grid-cols-2 gap-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="sciNew" class="btn">New set</button>
          <button id="sciCheck" class="btn maroon">Check</button>
          <button id="sciCSV" class="btn">Export CSV</button>
          <button id="sciJSON" class="btn">Export JSON</button>
        </div>
        <div id="sciFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 10 • Bounds -->
    <section class="slide" id="boundSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Bounds (Error Intervals)</h2>
      <div class="card p-4 w-full max-w-5xl mb-3">
        <p class="lead"><strong>Read first:</strong> If \(x\) rounds to \(r\) to the nearest unit \(u\), then \(x\in [\,r-\tfrac{u}{2},\,r+\tfrac{u}{2})\). Use this to justify measurement precision.</p>
      </div>
      <div class="card p-5 w-full max-w-5xl">
        <div id="bdList" class="grid md:grid-cols-2 gap-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="bdNew" class="btn">New set</button>
          <button id="bdCheck" class="btn maroon">Check</button>
          <button id="bdCSV" class="btn">Export CSV</button>
          <button id="bdJSON" class="btn">Export JSON</button>
        </div>
        <div id="bdFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 11 • Qatar Applications -->
    <section class="slide" id="realSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Qatar Applications (Estimation & Rounding)</h2>
      <div class="card p-4 w-full max-w-5xl mb-3">
        <p class="lead"><strong>Read first:</strong> In context, choose a precision that makes sense (money → 1 riyal, distances → 0.1 km, populations → 10^5 or 10^6). Explain your choice.</p>
      </div>
      <div class="card p-5 w-full max-w-5xl">
        <div class="flex flex-wrap items-center gap-3">
          <label>Set size
            <input id="realCount" type="number" min="4" max="12" value="6" class="border rounded px-2 py-1 w-20">
          </label>
          <button id="realNew" class="btn">New set</button>
        </div>
        <div id="realList" class="grid md:grid-cols-2 gap-3 mt-3"></div>
        <div class="mt-3 flex gap-2">
          <button id="realCheck" class="btn maroon">Check</button>
          <button id="realCSV" class="btn">Export CSV</button>
          <button id="realJSON" class="btn">Export JSON</button>
        </div>
        <div id="realFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 12 • Challenge Mode -->
    <section class="slide" id="challengeSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Challenge Mode</h2>
      <div class="card p-4 w-full max-w-5xl mb-3">
        <p class="lead">Try one higher‑order task. Explain your reasoning to a partner.</p>
      </div>
      <div class="card p-5 w-full max-w-5xl">
        <div class="flex flex-wrap items-center gap-3">
          <label>Level
            <select id="chLevel" class="border rounded px-2 py-1">
              <option value="easy">Easy</option>
              <option value="med" selected>Medium</option>
              <option value="hard">Hard</option>
              <option value="expert">Expert</option>
            </select>
          </label>
          <button id="chNew" class="btn">New question</button>
          <span class="chip">Streak: <b id="streakOut">0</b></span>
          <button id="chCSV" class="btn">Export CSV</button>
          <button id="chJSON" class="btn">Export JSON</button>
        </div>
        <div class="mt-3 text-2xl">Task: <span id="chText" class="font-extrabold"></span></div>
        <div class="mt-2">
          <input id="chAns" class="border rounded px-3 py-2 w-60" placeholder="answer"/>
          <button id="chCheck" class="btn maroon">Check</button>
          <button id="chHint" class="btn">Hint</button>
        </div>
        <div id="chHintBox" class="mt-3 text-sm"></div>
        <div id="chFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 13 • Exit ticket -->
    <section class="slide" id="exitSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Exit Ticket</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">3–2–1 Reflect</h3>
          <ul class="list-disc list-inside">
            <li>3 rounding skills you used (place, dp, s.f., bounds)</li>
            <li>2 Qatar contexts where rounding was helpful</li>
            <li>1 mistake you will avoid next time</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">Up Next</h3>
          <p>Estimation in multi‑step calculations and percent error comparisons.</p>
        </div>
      </div>
      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-[88%] h-[100px] banner rounded-md" style="background-image:url('../assets/qla_banner.png')"></div>
    </section>

  </div>
</div>

<!-- Controls -->
<div id="controls" role="group" aria-label="Slideshow controls">
  <button id="prev" title="Previous (←)">&laquo;</button>
  <button id="fs" title="Toggle Fullscreen (F)">⤢</button>
  <div id="counter">1 / 14</div>
  <button id="next" title="Next (→)">&raquo;</button>
</div>
<div id="progress"></div>

<!-- Glossary popover -->
<div id="pop" role="dialog" aria-modal="true" aria-live="polite">
  <span class="close" title="Close">✕</span>
  <div id="popBody"></div>
</div>

<script>
/* ------------------------- Core Helpers & Math ------------------------- */
(function(){
  const slides=[...document.querySelectorAll('.slide')];
  const prev=id('prev'), next=id('next'), counter=id('counter'), progress=id('progress'), fsBtn=id('fs');
  const deckTitle='G8_Unit1_L4_Rounding_QLA_Final';
  let i=0;

  function id(x){return document.getElementById(x)}
  function renderMath(root=document){ if(window._rerenderMath) window._rerenderMath(root); }
  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
  function confetti(x=window.innerWidth/2,y=window.innerHeight/2){
    for(let k=0;k<24;k++){
      const d=document.createElement('div'); d.className='confetti';
      d.style.left=x+'px'; d.style.top=y+'px'; d.style.width='8px'; d.style.height='8px';
      d.style.background=['#6C1D45','#C7A34F','#E8D5B7','#8a3d64'][k%4];
      document.body.appendChild(d);
      const dx=(Math.random()*2-1)*240, dy=(Math.random()*-1-0.3)*300, rot=Math.random()*720;
      d.animate([{transform:'translate(0,0) rotate(0deg)'},{transform:`translate(${dx}px,${dy}px) rotate(${rot}deg)`,opacity:0}],
                {duration:900+Math.random()*700,easing:'cubic-bezier(.2,.8,.2,1)'}).onfinish=()=>d.remove();
    }
  }
  function downloadJSON(filename, data){
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function downloadCSV(filename, rows){
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  // Rounding logic
  function roundHalfUpToUnit(x,u){
    const q=x/u;
    const s=q>=0?1:-1, a=Math.abs(q);
    const k = Math.floor(a + 0.5);
    return s*k*u;
  }
  function unitFromDp(dp){ return 10**(-dp); }
  function decPlacesFromUnit(u){ return u>=1?0:Math.max(0, Math.round(Math.log10(1/u))); }
  function fmtToUnit(x,u){ const dp = decPlacesFromUnit(u); return (Math.round(x*10**dp)/10**dp).toFixed(dp); }
  function roundToDP(x,dp){ return roundHalfUpToUnit(x,unitFromDp(dp)); }
  function roundToPlace(x,placeUnit){ return roundHalfUpToUnit(x,placeUnit); }

  // Significant figures
  function roundToSig(x,n){
    if(x===0) return 0;
    const s = x<0? -1: 1;
    const ax = Math.abs(x);
    const k = Math.floor(Math.log10(ax));
    const scale = 10**(k-n+1);
    return s*roundHalfUpToUnit(ax, scale);
  }
  function countSigStr(s){
    s = s.trim();
    if(/^[-+]?0*\.?0*$/.test(s)) return 1; // zero has 1 s.f.
    const hasDot = s.includes('.');
    s = s.replace(/^[-+]/,'');
    let t = s;
    if(!hasDot){ t = t.replace(/0+$/,''); }
    t = t.replace(/^0+/,'').replace('.','');
    return t.replace(/[^0-9]/g,'').length;
  }
  function sciRound(m,e,n){
    let r = roundToSig(m, n);
    if(Math.abs(r)>=10){ r = r/10; e += 1; }
    return {m:r,e};
  }

  /* ---------- Navigation ---------- */
  function show(k){
    i=(k+slides.length)%slides.length;
    slides.forEach((s,idx)=>s.classList.toggle('active',idx===i));
    counter.textContent=(i+1)+' / '+slides.length;
    progress.style.width=((i+1)/slides.length*100)+'%';
    const sid=slides[i].id||'';
    if(sid==='lineSlide') drawRoundLine();
    if(sid==='placeSlide') renderPV();
    if(sid==='kwQuizSlide') kwQuizNew();
    renderMath(slides[i]);
  }
  prev.addEventListener('click',()=>show(i-1));
  next.addEventListener('click',()=>show(i+1));
  document.addEventListener('keydown',e=>{
    if(e.key==='ArrowRight') show(i+1);
    if(e.key==='ArrowLeft') show(i-1);
    if(e.key.toLowerCase()==='f') toggleFS();
  });
  function toggleFS(){
    const el=id('slides');
    if(!document.fullscreenElement){(el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el);}
    else{(document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen).call(document);}
  }
  fsBtn.addEventListener('click',toggleFS);

  /* ------------------------- Bilingual Glossary ------------------------- */
  const KW = {
    en: {
      halfup: {term:"half‑up rounding", def:"If the next digit is 5–9, round away from 0; if 0–4, keep the digit.", ex:"-1.5 → -2"},
      place:  {term:"place value",      def:"The position of a digit (ones, tens, hundreds, tenths, …) which determines its value.", ex:"In 3,482, the 4 is hundreds."},
      dp:     {term:"decimal places (dp)", def:"Digits to the right of the decimal point used for rounding.", ex:"2.137 to 2 dp → 2.14"},
      sf:     {term:"significant figures (s.f.)", def:"Digits that convey precision; leading zeros don’t count; trailing zeros count only with a decimal point.", ex:"0.00450 has 3 s.f."},
      sci:    {term:"scientific notation", def:"Write numbers as a×10^n with 1≤|a|<10.", ex:"12500 = 1.25×10^4"},
      bounds: {term:"bounds / error interval", def:"Range of true values a rounded number can represent (± half a unit).", ex:"7.3 (to 1 dp) → [7.25, 7.35)"},
      estimate:{term:"estimation", def:"Using rounding to simplify a calculation while keeping it reasonable.", ex:"QAR 27.9≈28"}
    },
    ar: {
      halfup: {term:"التقريب بنصف صاعد", def:"إذا كان الرقم التالي 5–9 نقرب بعيداً عن الصفر، وإذا كان 0–4 نبقي الرقم كما هو.", ex:"−1.5 ← −2"},
      place:  {term:"القيمة المكانية",   def:"موضع الرقم (آحاد، عشرات، مئات، أعشار …) الذي يحدد قيمته.", ex:"في 3,482 الرقم 4 في خانة المئات."},
      dp:     {term:"المنازل العشرية",   def:"الأرقام يمين الفاصلة العشرية المستخدمة في التقريب.", ex:"2.137 إلى منزلتين → 2.14"},
      sf:     {term:"الأرقام المهمة",    def:"الأرقام الدالة على الدقة؛ الأصفار الأولية لا تُحسب؛ الأصفار النهائية تُحسب فقط مع وجود فاصلة عشرية.", ex:"0.00450 فيها 3 أرقام مهمة"},
      sci:    {term:"الترميز العلمي",     def:"كتابة العدد على صورة a×10^n بحيث 1≤|a|<10.", ex:"12500 = 1.25×10^4"},
      bounds: {term:"الحدود / مجال الخطأ", def:"نطاق القيم الحقيقية الممكنة بعد التقريب (± نصف وحدة).", ex:"7.3 (بدقة منزلة) → [7.25, 7.35)"},
      estimate:{term:"التقدير",        def:"استخدام التقريب لتبسيط الحساب مع بقاء النتيجة معقولة.", ex:"27.9 ≈ 28 ر.ق"}
    }
  };
  let kwLang='en';
  const POP=id('pop'), POP_BODY=id('popBody');
  POP.querySelector('.close').addEventListener('click',()=>POP.style.display='none');

  function renderKwChips(){
    const box=id('kwChips'); box.innerHTML='';
    Object.keys(KW[kwLang]).forEach(key=>{
      const sp=document.createElement('span'); sp.className='chip'; sp.dataset.key=key;
      sp.textContent = KW[kwLang][key].term;
      box.appendChild(sp);
    });
  }
  function showGlossary(key, anchorEl){
    const d = KW[kwLang][key]; if(!d) return;
    POP_BODY.innerHTML = `<div><strong>${d.term}</strong></div><div class="mt-1">${d.def}</div><div class="mt-1 text-sm text-gray-600"><em>Example:</em> ${d.ex}</div>`;
    POP.style.display='block';
    const r=anchorEl.getBoundingClientRect();
    POP.style.left=Math.min(r.left, window.innerWidth-POP.offsetWidth-20)+'px';
    POP.style.bottom=(window.innerHeight-r.top+10)+'px';
  }
  document.addEventListener('click',e=>{
    const el=e.target.closest('.chip[data-key]'); if(el){showGlossary(el.dataset.key, el);}
  });
  id('kwLang').addEventListener('change', (e)=>{
    kwLang=e.target.value; renderKwChips();
  });
  id('kwQuizBtn').addEventListener('click',()=>{ show(slides.findIndex(s=>s.id==='kwQuizSlide')); });

  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
  function kwQuizNew(){
    id('kwQuizLangOut').textContent = (kwLang==='en'?'English':'العربية');
    const entries = Object.entries(KW[kwLang]);
    const picked = shuffle(entries.slice()).slice(0,6);
    const box=id('kwQuizList'); box.innerHTML='';
    picked.forEach(([k,v],idx)=>{
      const asTerm = Math.random()<0.5;
      const options = shuffle(entries.slice()).slice(0,4).map(e=>asTerm? e[1].def : e[1].term);
      if(!options.includes(asTerm? v.def : v.term)){
        options[Math.floor(Math.random()*options.length)] = asTerm? v.def : v.term;
      }
      const select = document.createElement('select'); select.className='border rounded px-2 py-1 w-full mt-1 kwqsel';
      select.dataset.answer = (asTerm? v.def : v.term);
      select.innerHTML = ['<option value="">— choose —</option>', ...options.map(o=>`<option>${o}</option>`)].join('');
      const card = document.createElement('div'); card.className='card p-3';
      card.innerHTML = `<div class="font-semibold text-maroon">${asTerm? v.term : v.def}</div>`;
      card.appendChild(select);
      box.appendChild(card);
    });
  }
  id('kwQuizNew').addEventListener('click',kwQuizNew);
  id('kwQuizCheck').addEventListener('click',()=>{
    let ok=0; document.querySelectorAll('.kwqsel').forEach(sel=>{
      const good = sel.value === sel.dataset.answer;
      sel.style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('kwQuizFb').textContent = `Score: ${ok}/${document.querySelectorAll('.kwqsel').length}`;
    if(ok===document.querySelectorAll('.kwqsel').length) confetti();
  });

  /* ------------------------- Warm-up ------------------------- */
  id('warmCheck').addEventListener('click',()=>{
    const v1=id('w1').value.replace(/,/g,''); const ok1 = (Number(v1)===12600);
    const ok2 = Math.abs(Number(id('w2').value)-7.5)<1e-10;
    const ok3 = (Number(id('w3').value)===-3);
    const score=(ok1?1:0)+(ok2?1:0)+(ok3?1:0);
    id('warmFb').textContent = score===3 ? '✅ Great start!' : `Score: ${score}/3`;
    id('w1').style.borderColor=ok1?'#22c55e':'#ef4444';
    id('w2').style.borderColor=ok2?'#22c55e':'#ef4444';
    id('w3').style.borderColor=ok3?'#22c55e':'#ef4444';
    if(score===3) confetti();
  });
  id('warmReset').addEventListener('click',()=>{['w1','w2','w3'].forEach(x=>{id(x).value=''; id(x).style.borderColor='#e5e7eb'}); id('warmFb').textContent='';});

  /* ------------------------- Place Value & DP (extended) ------------------------- */
  const pvState={x:246.38, s:'246.38', mode:'place', u:100, intDigits:6, maxDp:3};

  // Create a number string with at least targetDp+1 decimals (decision digit visible)
  function buildNumberStringForDp(targetDp, intDigits, maxDp){
    const extra = 1 + Math.floor(Math.random()*2); // +1 or +2
    const dp = Math.max(targetDp+1, Math.min(maxDp, targetDp + extra));
    const sign = Math.random()<0.2? '-' : '';
    const int = randIntDigits(intDigits);
    // fractional digits as array
    const frac = new Array(dp).fill(0).map(()=>Math.floor(Math.random()*10));
    // force informative decision digit at index targetDp
    if(dp>targetDp){
      frac[targetDp] = (Math.random()<0.35) ? 5 : (1 + Math.floor(Math.random()*9)); // 5 or 1..9
    }
    return `${sign}${int}.${frac.join('')}`;
  }
  function randIntDigits(n){ const lo = 10**(n-1), hi = 10**n - 1; return Math.floor(Math.random()*(hi-lo+1))+lo; }

  function newPV(){
    if(pvState.mode==='dp'){
      const target = Number(id('pvDp').value);
      const s = buildNumberStringForDp(target, pvState.intDigits, pvState.maxDp);
      pvState.s = s; pvState.x = Number(s);
    }else{
      const sign=Math.random()<0.2?-1:1;
      const int = randIntDigits(pvState.intDigits);
      const dp = Math.floor(Math.random()*(pvState.maxDp+1));
      const frac = dp? Math.floor(Math.random()*(10**dp)) : 0;
      pvState.x = sign*(int + frac/10**dp);
      pvState.s = pvState.x.toString();
    }
    renderPV();
  }

  function renderPV(){
    const {mode,u} = pvState;
    // parse from preserved string to keep trailing zeros
    const raw = pvState.s || pvState.x.toString();
    const isNeg = raw.startsWith('-');
    const core = isNeg ? raw.slice(1) : raw;
    const parts = core.split('.');
    const whole = parts[0].split('');
    const frac = (parts[1]||'').split('');

    // Target unit
    let unit = 1, label='';
    if(mode==='place'){
      unit = Number(id('pvPlace').value);
      label = `nearest ${unit.toLocaleString()}`;
    }else{
      const dp = Number(id('pvDp').value);
      unit = unitFromDp(dp); label = `${dp}\u202Fdp`;
    }
    pvState.u = unit;

    // Render with rounding digit highlighted
    let display='';
    if(unit>=1){
      const k = Math.round(Math.log10(unit)); // 10^k
      const ridx = whole.length - k - 1;
      for(let j=0;j<whole.length;j++){
        const cls = (j===ridx)?'bg-yellow-200 tok':'tok';
        display += `<span class="${cls}">${whole[j]}</span>`;
      }
      if(frac.length) display += `<span class="tok">.</span>${frac.map(c=>`<span class="tok">${c}</span>`).join('')}`;
    }else{
      const dpReq = decPlacesFromUnit(unit); // e.g., 3 dp -> highlight frac[2]
      for(let j=0;j<whole.length;j++){ display += `<span class="tok">${whole[j]}</span>`}
      display += `<span class="tok">.</span>`;
      const need = Math.max(frac.length, dpReq+1);
      for(let j=0;j<need;j++){
        const d = frac[j] || '0';
        const cls = (j===dpReq-1)?'bg-yellow-200 tok':'tok';
        display += `<span class="${cls}">${d}</span>`;
      }
    }
    id('pvNumber').innerHTML = `${isNeg?'−':''}${display}`;

    // Step explanation
    const y = roundHalfUpToUnit(pvState.x, unit);
    id('pvResult').textContent = fmtToUnit(y,unit).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    // compute decision digit shown
    let nextDigit=0;
    if(unit>=1){
      const k=Math.round(Math.log10(unit));
      const idx = whole.length - k; // next right position
      nextDigit = idx<whole.length? Number(whole[idx]) : (frac.length? Number(frac[0]):0);
    }else{
      const dp=decPlacesFromUnit(unit);
      const idx=dp; // right after rounding digit
      nextDigit = frac.length>idx? Number(frac[idx]) : 0;
    }
    id('pvSteps').innerHTML =
      `<div><strong>Steps:</strong> (1) Mark rounding digit for ${label}. (2) Decision digit = <b>${nextDigit}</b>. (3) ${nextDigit>=5?'Increase by 1 (5–9).':'Keep the digit (0–4).'} (4) Rewrite remaining digits as 0s (place) or keep up to dp.</div>`;
    renderMath(id('placeSlide'));
  }

  document.getElementsByName('pvMode').forEach(r=>{
    r.addEventListener('change',e=>{
      pvState.mode = e.target.value;
      id('pvLabelPlace').style.display = pvState.mode==='place'? 'inline-block':'none';
      id('pvLabelDp').style.display = pvState.mode==='dp'? 'inline-block':'none';
      newPV(); // regenerate to guarantee decision digit in dp mode
    })
  });
  id('pvExplain').addEventListener('click',()=>{ const box=id('pvSteps'); box.style.display= box.style.display==='none'? 'block':'none'; });
  id('pvPlace').addEventListener('change',renderPV);
  id('pvDp').addEventListener('change',()=>{ if(pvState.mode==='dp') newPV(); else renderPV(); });
  id('pvIntDigits').addEventListener('input', (e)=>{ pvState.intDigits = clamp(parseInt(e.target.value||6),3,11); newPV(); });
  id('pvMaxDp').addEventListener('input', (e)=>{ pvState.maxDp = clamp(parseInt(e.target.value||3),0,6); newPV(); });
  id('pvNew').addEventListener('click',newPV);
  id('pvExportCSV').addEventListener('click',()=>downloadCSV(`${deckTitle}_placevalue.csv`, [['x','unit','result'], [pvState.x, pvState.u, fmtToUnit(roundHalfUpToUnit(pvState.x,pvState.u),pvState.u)]]));
  id('pvExportJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_placevalue.json`, pvState));
  newPV();

  /* ------------------------- Number Line (dp 0–6, extra decimals) ------------------------- */
  const cL=id('roundLine'); const lineX=id('lineX'), lineDp=id('lineDp'), lineOut=id('lineOut');
  const lineState={x:23.47,dp:1};

  function drawRoundLine(){
    const ctx=cL.getContext('2d'); cL.width=cL.clientWidth*devicePixelRatio; cL.height=cL.clientHeight*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
    const y=cL.clientHeight/2, m=28; ctx.clearRect(0,0,cL.clientWidth,cL.clientHeight);
    ctx.lineWidth=2; ctx.strokeStyle='#6C1D45'; ctx.beginPath(); ctx.moveTo(m,y); ctx.lineTo(cL.clientWidth-m,y); ctx.stroke();

    const u = unitFromDp(lineState.dp), x=lineState.x;
    const r=roundHalfUpToUnit(x,u);
    const span = 10*u;
    const left = Math.floor((x-4*u)/u)*u;
    ctx.font='12px Inter'; ctx.fillStyle='#555';
    for(let k=0;k<=10;k++){
      const val = +(left + k*u).toFixed(lineState.dp);
      const px = map(val);
      ctx.beginPath(); ctx.moveTo(px,y-10); ctx.lineTo(px,y+10); ctx.stroke();
      if(k%2===0){ ctx.fillText(val.toFixed(lineState.dp), px-18, y+26); }
    }
    // cutoffs
    const low = r - u/2, high = r + u/2;
    ctx.strokeStyle='#C7A34F'; ctx.setLineDash([6,4]); ctx.beginPath(); ctx.moveTo(map(low),y-34); ctx.lineTo(map(low),y+34); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(map(high),y-34); ctx.lineTo(map(high),y+34); ctx.stroke(); ctx.setLineDash([]);

    // markers
    ctx.fillStyle='#6C1D45'; ctx.beginPath(); ctx.arc(map(x),y,8,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#C7A34F'; ctx.beginPath(); ctx.arc(map(r),y,9,0,Math.PI*2); ctx.fill();
    lineOut.textContent = r.toFixed(lineState.dp);

    function map(val){const W=cL.clientWidth;return m+(val-(left))*((W-2*m)/(span));}
  }

  // Randomize with extra decimals so decision digit is visible
  id('lineRand').addEventListener('click',()=>{
    const dp = Math.floor(Math.random()*7); // 0..6
    lineState.dp = dp; lineDp.value = dp;
    const extra = 1 + Math.floor(Math.random()*2); // +1 or +2 extra
    const s = (Math.random()*200 - 100).toFixed(dp + extra);
    lineState.x = Number(s);
    lineX.value = s; // keep trailing zeros visible in the input
    drawRoundLine();
  });

  lineX.addEventListener('input',()=>{ lineState.x=Number(lineX.value); drawRoundLine(); });
  lineDp.addEventListener('change',()=>{ lineState.dp=Number(lineDp.value); drawRoundLine(); });
  id('lineExportCSV').addEventListener('click',()=>downloadCSV(`${deckTitle}_line.csv`, [['x','dp','rounded'], [lineState.x,lineState.dp,roundToDP(lineState.x,lineState.dp).toFixed(lineState.dp)]]));
  id('lineExportJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_line.json`, {x:lineState.x,dp:lineState.dp,rounded:roundToDP(lineState.x,lineState.dp)}));
  drawRoundLine();
  window.addEventListener('resize',()=>{ if(slides[i].id==='lineSlide') drawRoundLine(); });

  /* ------------------------- Stations ------------------------- */
  document.querySelector('.s1check').addEventListener('click',()=>{
    const a = roundToPlace(12678999,100000);
    const b = roundToPlace(12678999,1000000);
    const ga = Number(document.querySelector('.s1a').value.replace(/,/g,'')); const gb = Number(document.querySelector('.s1b').value.replace(/,/g,''));
    const ok = (ga===a) && (gb===b);
    document.querySelector('.s1fb').textContent = ok? '✅ Correct' : `Ans: ${a.toLocaleString()}, ${b.toLocaleString()}`;
    if(ok) confetti();
  });
  document.querySelector('.s2check').addEventListener('click',()=>{
    const a = roundToDP(2.1379,2).toFixed(2);
    const b = roundToDP(2.1379,3).toFixed(3);
    const ga = document.querySelector('.s2a').value; const gb = document.querySelector('.s2b').value;
    const ok = (ga===a)&&(gb===b);
    document.querySelector('.s2fb').textContent = ok? '✅ Correct' : `Ans: ${a}, ${b}`;
    if(ok) confetti();
  });
  document.querySelector('.s3check').addEventListener('click',()=>{
    const a = roundToSig(0.0049871,2).toPrecision(2);
    const b = roundToSig(0.0049871,4).toPrecision(4);
    const ga = document.querySelector('.s3a').value; const gb = document.querySelector('.s3b').value;
    const ok = (ga===a)&&(gb===b);
    document.querySelector('.s3fb').textContent = ok? '✅ Correct' : `Ans: ${a}, ${b}`;
    if(ok) confetti();
  });
  document.querySelector('.s4check').addEventListener('click',()=>{
    const r=7.3, u=0.1, lb = r - u/2, ub = r + u/2;
    const ga = Number(document.querySelector('.s4a').value); const gb = Number(document.querySelector('.s4b').value);
    const ok = Math.abs(ga-lb)<1e-10 && Math.abs(gb-ub)<1e-10;
    document.querySelector('.s4fb').textContent = ok? '✅ Correct' : `Ans: ${lb} , ${ub}`;
    if(ok) confetti();
  });

  /* ------------------------- Practice Generator (guarantee decision digit) ------------------------- */
  const prState={items:[]};

  function randIntDigitsUpTo(maxDigits){
    const d = Math.floor(Math.random()*(maxDigits-2))+3; // 3..maxDigits
    return randIntDigits(d);
  }

  // Build decimal with ≥ targetDp+1 decimals; decision digit non-zero, often 5
  function randNumForTargetDp(targetDp, maxDigits, allowNeg=true){
    const extra = 1 + Math.floor(Math.random()*3); // 1..3 extra
    const actualDp = targetDp + extra;
    const sign = (allowNeg && Math.random()<0.5) ? -1 : 1;
    const int = randIntDigitsUpTo(maxDigits);
    const frac = new Array(actualDp).fill(0).map(()=>Math.floor(Math.random()*10));
    const di = targetDp;
    frac[di] = (Math.random()<0.35) ? 5 : (1 + Math.floor(Math.random()*9));
    for(let j=di+1;j<actualDp;j++){ frac[j] = Math.floor(Math.random()*10); }
    const fracStr = frac.join('');
    const s = (sign<0?'-':'') + int.toString() + '.' + fracStr;
    return { x: Number(s), display: s };
  }

  function prBuild(){
    const lv=id('prLevel').value;
    const count = clamp(parseInt(id('prCount').value||8),4,16);
    const minDp = clamp(parseInt(id('prMinDp').value||0),0,6);
    const maxDp = clamp(parseInt(id('prMaxDp').value||3),minDp,6);
    const maxDigits = clamp(parseInt(id('prMaxDigits').value||8),3,11);

    const list=[];
    function taskPlace(x,unit,label){
      return {type:'unit', prompt:`Round ${x.toLocaleString()} to ${label}`, x, unit, label,
              ans: roundHalfUpToUnit(x,unit), fmt:fmtToUnit(roundHalfUpToUnit(x,unit),unit)};
    }
    function taskDp(targetDp, allowNeg){
      const {x, display} = randNumForTargetDp(targetDp, maxDigits, allowNeg);
      const u = unitFromDp(targetDp);
      return {type:'unit', prompt:`Round ${display} to ${targetDp}\u202Fdp`, x, unit:u, label:`${targetDp}\u202Fdp`,
              ans: roundHalfUpToUnit(x,u), fmt:fmtToUnit(roundHalfUpToUnit(x,u),u)};
    }
    function taskSig(x,n){
      const ans=roundToSig(x,n);
      return {type:'sig', prompt:`Round ${x} to ${n} s.f.`, x, n, ans, fmt:ans.toPrecision(n)};
    }
    function taskSci(m,e,n){ const r=sciRound(m,e,n); return {type:'sci', prompt:`Round ${m}×10^${e} to ${n} s.f.: give mantissa & exponent`, m,e,n, ans:r}; }
    function taskBounds(r,u,label){ const lb=r-u/2, ub=r+u/2; return {type:'bnd', prompt:`Reported ${fmtToUnit(r,u)} (${label}). Give [lower, upper).`, r,u,label, lb, ub}; }

    function chooseDp(){ return Math.floor(Math.random()*(maxDp-minDp+1))+minDp; }
    function randDecimalForSig(maxDpLocal){
      return +((Math.random()*9.9e6-1e5).toFixed(Math.min(4, maxDpLocal)));
    }

    for(let k=0;k<count;k++){
      const r = Math.random();
      if(lv==='easy'){
        if(r<0.5){
          const x = randIntDigitsUpTo(Math.min(7,maxDigits));
          const unit = Math.random()<0.5?10:100;
          list.push(taskPlace(x,unit, unit===10?'nearest 10':'nearest 100'));
        }else{
          const t = Math.min(2, maxDp);
          list.push(taskDp(t, /*allowNeg*/ false));
        }
      }else if(lv==='med'){
        const t = clamp(chooseDp(),1,3);
        list.push(taskDp(t, /*allowNeg*/ true));
      }else if(lv==='hard'){
        if(r<0.4){
          const t = chooseDp();
          list.push(taskDp(t, /*allowNeg*/ true));
        }else if(r<0.75){
          const n = [2,3,4][Math.floor(Math.random()*3)];
          const x = randDecimalForSig(maxDp);
          list.push(taskSig(x,n));
        }else{
          const unit = 10**[1,2,3,4][Math.floor(Math.random()*4)];
          const x = randIntDigitsUpTo(maxDigits);
          list.push(taskPlace(x,unit, `nearest ${unit.toLocaleString()}`));
        }
      }else{ // expert
        if(r<0.33){
          const n=[2,3,4][Math.floor(Math.random()*3)]; const e = Math.floor(Math.random()*11)-5; const m = +( (Math.random()*9+1).toFixed(Math.min(4,maxDp)) );
          list.push(taskSci(m,e,n));
        }else if(r<0.66){
          const t = chooseDp();
          list.push(taskDp(t, /*allowNeg*/ true));
        }else{
          const unit = 10**[1,2,3,4,5,6][Math.floor(Math.random()*6)];
          const r0 = randIntDigitsUpTo(maxDigits);
          const rr=roundHalfUpToUnit(r0,unit);
          list.push(taskBounds(rr,unit, unit>=1?`nearest ${unit.toLocaleString()}`:`${decPlacesFromUnit(unit)} dp`));
        }
      }
    }

    prState.items=list;
    const box=id('prList'); box.innerHTML='';
    list.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-4';
      if(o.type==='unit' || o.type==='sig'){
        row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1}</div>
          <div class="text-xl mt-1">${o.prompt} = <input class="prin border rounded px-2 py-1 w-48" placeholder="answer"></div>`;
      }else if(o.type==='sci'){
        row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1}</div>
          <div class="text-xl mt-1">${o.prompt}<br/>mantissa: <input class="prisci-m border rounded px-2 py-1 w-24" placeholder="a">, exponent: <input class="prisci-e border rounded px-2 py-1 w-24" placeholder="n"></div>`;
      }else{
        row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1}</div>
          <div class="mt-1">${o.prompt}</div>
          <div class="mt-1">Lower: <input class="prb-l border rounded px-2 py-1 w-32">, Upper: <input class="prb-u border rounded px-2 py-1 w-32"></div>`;
      }
      box.appendChild(row);
    });
  }
  id('prNew').addEventListener('click',prBuild); prBuild();

  id('prCheck').addEventListener('click',()=>{
    const cards=[...id('prList').querySelectorAll('.card')];
    let ok=0;
    cards.forEach((row,idx)=>{
      const item=prState.items[idx];
      if(item.type==='unit'){
        const v = Number(row.querySelector('.prin').value.replace(/,/g,'')); const want = item.ans;
        const good = Math.abs(v-want)<1e-10; row.querySelector('.prin').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
      }else if(item.type==='sig'){
        const v = Number(row.querySelector('.prin').value); const want = item.ans;
        const good = Math.abs(v-want)<1e-10; row.querySelector('.prin').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
      }else if(item.type==='sci'){
        const m=Number(row.querySelector('.prisci-m').value); const e=Number(row.querySelector('.prisci-e').value);
        const good = Math.abs(m-item.ans.m)<1e-10 && e===item.ans.e;
        row.querySelector('.prisci-m').style.borderColor=good?'#22c55e':'#ef4444';
        row.querySelector('.prisci-e').style.borderColor=good?'#22c55e':'#ef4444';
        if(good) ok++;
      }else{
        const lb=Number(row.querySelector('.prb-l').value); const ub=Number(row.querySelector('.prb-u').value);
        const good = Math.abs(lb-item.lb)<1e-10 && Math.abs(ub-item.ub)<1e-10;
        row.querySelector('.prb-l').style.borderColor=good?'#22c55e':'#ef4444';
        row.querySelector('.prb-u').style.borderColor=good?'#22c55e':'#ef4444';
        if(good) ok++;
      }
    });
    id('prFb').textContent = ok===prState.items.length? '✅ All correct!' : `Score: ${ok}/${prState.items.length}`;
    if(ok===prState.items.length) confetti();
  });

  id('prExportCSV').addEventListener('click',()=>{
    const rows=[['type','prompt','answer']]; prState.items.forEach(o=>{
      if(o.type==='unit' || o.type==='sig'){ rows.push([o.type,o.prompt,o.fmt||o.ans]); }
      else if(o.type==='sci'){ rows.push([o.type,o.prompt, `${o.ans.m}×10^${o.ans.e}`]); }
      else { rows.push([o.type,o.prompt, `[${o.lb}, ${o.ub})`]); }
    });
    downloadCSV(`${deckTitle}_practice.csv`, rows);
  });
  id('prExportJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_practice.json`, prState.items));

  /* ------------------------- Sig. Figures ------------------------- */
  const sigCState={items:[]}, sigRState={items:[]};
  function genSigCount(){
    const pool=['0.00340','1200','1200.','5.060','0.0702','30007','2.90','0.0005','40','40.0','3.141590','0.01020','987000'];
    sigCState.items = pool.sort(()=>Math.random()-0.5).slice(0,5).map(s=>({s,ans:countSigStr(s)}));
    const box=id('sigCountList'); box.innerHTML='';
    sigCState.items.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-3';
      row.innerHTML=`<div class="text-xl">\\( ${o.s} \\) has <input class="scin border rounded px-2 py-1 w-20" placeholder="s.f."> s.f.</div>`;
      box.appendChild(row);
    });
    renderMath(id('sigSlide'));
  }
  function genSigRound(){
    const items=[];
    for(let k=0;k<5;k++){
      const x = +( (Math.random()*9.9e6-1e5).toFixed(4) );
      const n=[2,3,4][Math.floor(Math.random()*3)];
      const ans = roundToSig(x,n);
      items.push({x,n,ans,fmt:ans.toPrecision(n)});
    }
    sigRState.items=items;
    const box=id('sigRoundList'); box.innerHTML='';
    items.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-3';
      row.innerHTML=`<div class="text-xl">Round \\( ${o.x} \\) to ${o.n} s.f. = <input class="srin border rounded px-2 py-1 w-48" placeholder="answer"></div>`;
      box.appendChild(row);
    });
    renderMath(id('sigSlide'));
  }
  id('sigCountNew').addEventListener('click',genSigCount);
  id('sigRoundNew').addEventListener('click',genSigRound);
  genSigCount(); genSigRound();
  id('sigCountCheck').addEventListener('click',()=>{
    let ok=0; id('sigCountList').querySelectorAll('.card').forEach((row,idx)=>{
      const want=sigCState.items[idx].ans; const got=Number(row.querySelector('.scin').value);
      const good = got===want; row.querySelector('.scin').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('sigCountFb').textContent = ok===sigCState.items.length? '✅ Perfect!' : `Score: ${ok}/${sigCState.items.length}`;
    if(ok===sigCState.items.length) confetti();
  });
  id('sigRoundCheck').addEventListener('click',()=>{
    let ok=0; id('sigRoundList').querySelectorAll('.card').forEach((row,idx)=>{
      const want=sigRState.items[idx].ans; const got=Number(row.querySelector('.srin').value);
      const good=Math.abs(got-want)<1e-10; row.querySelector('.srin').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('sigRoundFb').textContent = ok===sigRState.items.length? '✅ Excellent!' : `Score: ${ok}/${sigRState.items.length}`;
    if(ok===sigRState.items.length) confetti();
  });
  id('sigCountCSV').addEventListener('click',()=>{
    const rows=[['number','sig_figs']]; sigCState.items.forEach(o=>rows.push([o.s,o.ans])); downloadCSV(`${deckTitle}_sig_count.csv`, rows);
  });
  id('sigCountJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_sig_count.json`, sigCState.items));
  id('sigRoundCSV').addEventListener('click',()=>{
    const rows=[['x','n_sf','answer']]; sigRState.items.forEach(o=>rows.push([o.x,o.n,o.fmt])); downloadCSV(`${deckTitle}_sig_round.csv`, rows);
  });
  id('sigRoundJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_sig_round.json`, sigRState.items));

  /* ------------------------- Scientific Notation ------------------------- */
  const sciState={items:[]};
  function sciNew(){
    const list=[];
    for(let k=0;k<4;k++){
      const e = Math.floor(Math.random()*11)-5; // -5..5
      const m = +( (Math.random()*9+1).toFixed(4) ); // 1..10
      const n = [2,3,4][Math.floor(Math.random()*3)];
      const r=sciRound(m,e,n);
      list.push({m,e,n,ans:r});
    }
    sciState.items=list;
    const box=id('sciList'); box.innerHTML='';
    list.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-xl">Round \\( ${o.m}\\times 10^{${o.e}} \\) to ${o.n} s.f.: mantissa = <input class="sciin border rounded px-2 py-1 w-24" placeholder="m">, exponent = <input class="sciexp border rounded px-2 py-1 w-20" placeholder="e"></div>`;
      box.appendChild(row);
    });
    renderMath(id('sciSlide'));
  }
  id('sciNew').addEventListener('click',sciNew); sciNew();
  id('sciCheck').addEventListener('click',()=>{
    let ok=0; id('sciList').querySelectorAll('.card').forEach((row,idx)=>{
      const item=sciState.items[idx]; const m=Number(row.querySelector('.sciin').value); const e=Number(row.querySelector('.sciexp').value);
      const good= Math.abs(m-item.ans.m)<1e-10 && e===item.ans.e; row.querySelector('.sciin').style.borderColor=good?'#22c55e':'#ef4444'; row.querySelector('.sciexp').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('sciFb').textContent = ok===sciState.items.length? '✅ Perfect!' : `Score: ${ok}/${sciState.items.length}`;
    if(ok===sciState.items.length) confetti();
  });
  id('sciCSV').addEventListener('click',()=>{
    const rows=[['m','e','n_sf','m_ans','e_ans']]; sciState.items.forEach(o=>rows.push([o.m,o.e,o.n,o.ans.m,o.ans.e])); downloadCSV(`${deckTitle}_scientific.csv`, rows);
  });
  id('sciJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_scientific.json`, sciState.items));

  /* ------------------------- Bounds ------------------------- */
  const bdState={items:[]};
  function bdNew(){
    const list=[];
    for(let k=0;k<4;k++){
      const unit=[0.001,0.01,0.1,1,10,100,1000][Math.floor(Math.random()*7)];
      const x = +( (Math.random()*100000-50000).toFixed(unit<1?3:0) );
      const r = roundHalfUpToUnit(x,unit);
      const lb = r - unit/2, ub = r + unit/2;
      const label = unit>=1? `nearest ${unit.toLocaleString()}` : `${decPlacesFromUnit(unit)} dp`;
      list.push({r,unit,lb,ub,label});
    }
    bdState.items=list;
    const box=id('bdList'); box.innerHTML='';
    list.forEach((o,idx)=>{
      const dp=decPlacesFromUnit(o.unit);
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1}</div>
        <div class="mt-1">A measurement is reported as <b>${fmtToUnit(o.r,o.unit)}</b> (${o.label}). Give the bounds for the true value \\(x\\):</div>
        <div class="mt-1">Lower: <input class="bdlb border rounded px-2 py-1 w-32" placeholder="${(o.lb).toFixed(dp)}">, Upper: <input class="bdub border rounded px-2 py-1 w-32" placeholder="${(o.ub).toFixed(dp)}"></div>`;
      box.appendChild(row);
    });
    renderMath(id('boundSlide'));
  }
  id('bdNew').addEventListener('click',bdNew); bdNew();
  id('bdCheck').addEventListener('click',()=>{
    let ok=0; id('bdList').querySelectorAll('.card').forEach((row,idx)=>{
      const item=bdState.items[idx]; const lb=Number(row.querySelector('.bdlb').value); const ub=Number(row.querySelector('.bdub').value);
      const good = Math.abs(lb-item.lb)<1e-10 && Math.abs(ub-item.ub)<1e-10;
      row.querySelector('.bdlb').style.borderColor=good?'#22c55e':'#ef4444';
      row.querySelector('.bdub').style.borderColor=good?'#22c55e':'#ef4444';
      if(good) ok++;
    });
    id('bdFb').textContent = ok===bdState.items.length? '✅ Excellent!' : `Score: ${ok}/${bdState.items.length}`;
    if(ok===bdState.items.length) confetti();
  });
  id('bdCSV').addEventListener('click',()=>{
    const rows=[['reported','unit','label','lower','upper']];
    bdState.items.forEach(o=>rows.push([fmtToUnit(o.r,o.unit),o.unit,o.label,o.lb,o.ub]));
    downloadCSV(`${deckTitle}_bounds.csv`, rows);
  });
  id('bdJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_bounds.json`, bdState.items));

  /* ------------------------- Qatar Applications ------------------------- */
  const realState={items:[]};
  function realNew(){
    const count = clamp(parseInt(id('realCount').value||6),4,12);
    const list=[];
    // Currency estimation
    for(let k=0;k<Math.ceil(count/3);k++){
      const price = +( (Math.random()*90+10).toFixed(2) );
      const qty = Math.floor(Math.random()*7)+4;
      list.push({type:'est', prompt:`Estimate total for ${qty} items at QAR ${price} each (round to nearest riyal first).`, ans: Math.round(price)*qty });
    }
    // Distance with extra decimals
    for(let k=0;k<Math.ceil(count/3);k++){
      const dist = +( (Math.random()*180+5).toFixed(3) ); // 3 dp so 1 dp has decision digit
      list.push({type:'unit', prompt:`Round the driving distance ${dist} km to 1 dp.`, unit:0.1, ans: roundHalfUpToUnit(dist,0.1)});
    }
    // Attendance/Populations
    for(let k=0;k<Math.ceil(count/3);k++){
      const pop = Math.floor(Math.random()*9e6)+1e6;
      list.push({type:'unit', prompt:`Round ${pop.toLocaleString()} to the nearest hundred thousand.`, unit:100000, ans: roundHalfUpToUnit(pop,100000)});
    }
    realState.items=list.slice(0,count);
    const box=id('realList'); box.innerHTML='';
    realState.items.forEach((o,idx)=>{
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="text-left font-semibold text-maroon">Item ${idx+1}</div>
        <div class="text-xl mt-1">${o.prompt} = <input class="rin border rounded px-2 py-1 w-48" placeholder="answer"></div>`;
      box.appendChild(row);
    });
  }
  id('realNew').addEventListener('click',realNew); realNew();
  id('realCheck').addEventListener('click',()=>{
    let ok=0; id('realList').querySelectorAll('.card').forEach((row,idx)=>{
      const item=realState.items[idx]; const v=Number(row.querySelector('.rin').value);
      const good=Math.abs(v-item.ans)<1e-10; row.querySelector('.rin').style.borderColor=good?'#22c55e':'#ef4444'; if(good) ok++;
    });
    id('realFb').textContent = ok===realState.items.length? '✅ Real‑world ready!' : `Score: ${ok}/${realState.items.length}`;
    if(ok===realState.items.length) confetti();
  });
  id('realCSV').addEventListener('click',()=>{
    const rows=[['prompt','answer']]; realState.items.forEach(o=>rows.push([o.prompt,o.ans])); downloadCSV(`${deckTitle}_qatar.csv`, rows);
  });
  id('realJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_qatar.json`, realState.items));

  /* ------------------------- Challenge Mode ------------------------- */
  const chState={cur:null, streak:0, history:[]};
  function chNew(){
    const lv=id('chLevel').value;
    let prompt='', ans=null;
    const r = Math.random();
    if(lv==='easy'){
      const x = Math.floor(Math.random()*900)+100, unit=10;
      ans = roundHalfUpToUnit(x,unit);
      prompt = `Round ${x} to the nearest 10`;
    }else if(lv==='med'){
      const dp=1+Math.floor(Math.random()*3);
      const extra = 1 + Math.floor(Math.random()*2);
      const s = (Math.random()*200 - 100).toFixed(dp + extra);
      const x = Number(s);
      ans = roundToDP(x,dp); prompt=`Round ${s} to ${dp} dp`;
    }else if(lv==='hard'){
      if(r<0.5){
        const dp=3; const extra=1+Math.floor(Math.random()*2);
        const s=(Math.random()*9000-3000).toFixed(dp+extra);
        const x=Number(s); const n=[2,3,4][Math.floor(Math.random()*3)];
        ans=roundToSig(x,n); prompt=`Round ${s} to ${n} s.f.`;
      }else{
        const unit=[0.01,0.1,1,10,100][Math.floor(Math.random()*5)];
        const dp=decPlacesFromUnit(unit); const extra = unit<1 ? 1 : 0;
        const s=(Math.random()*2000-1000).toFixed(dp+extra);
        const x=Number(s);
        ans=roundHalfUpToUnit(x,unit); prompt=`Round ${s} to ${unit>=1? 'nearest '+unit : dp+' dp'}`;
      }
    }else{ // expert
      if(r<0.33){
        const e=Math.floor(Math.random()*11)-5; const m=+( (Math.random()*9+1).toFixed(4) );
        const n=[2,3,4][Math.floor(Math.random()*3)]; const rr=sciRound(m,e,n);
        ans=rr.m*10**rr.e; prompt=`Round ${m}×10^${e} to ${n} s.f. (enter numeric value)`;
      }else if(r<0.66){
        const unit=[0.001,0.01,0.1,1,10,100][Math.floor(Math.random()*6)];
        const r0=+( (Math.random()*1000-500).toFixed(unit<1?3:0) ); const rr=roundHalfUpToUnit(r0,unit); const lb=rr-unit/2;
        ans=lb; prompt=`Reported ${fmtToUnit(rr,unit)} (${unit>=1?'nearest '+unit: decPlacesFromUnit(unit)+' dp'}). Enter the <lower bound>.`;
      }else{
        const dp=4; const extra=1+Math.floor(Math.random()*2);
        const s=(Math.random()*9000-1000).toFixed(dp+extra);
        const x=Number(s); const n=[2,3,4][Math.floor(Math.random()*3)];
        ans=roundToSig(x,n); prompt=`Round ${s} to ${n} s.f.`;
      }
    }
    chState.cur={prompt,ans}; id('chText').textContent=prompt; id('chAns').value=''; id('chFb').textContent=''; id('chHintBox').textContent=''; renderMath(id('challengeSlide'));
  }
  id('chNew').addEventListener('click',chNew); chNew();
  id('chHint').addEventListener('click',()=>{ id('chHintBox').innerHTML=`<div class="hint">Use half‑up rounding. For bounds: the interval is \\([r-\\tfrac{u}{2},\\; r+\\tfrac{u}{2})\\).</div>`; renderMath(id('challengeSlide')); });
  id('chCheck').addEventListener('click',()=>{
    const got=Number(id('chAns').value), want=chState.cur.ans;
    const ok = Math.abs(got-want)<1e-10;
    if(ok){ chState.streak++; id('chFb').textContent='✅ Correct!'; id('chFb').className='mt-2 h-6 font-semibold text-green-700'; confetti(); chState.history.push({prompt:chState.cur.prompt, answer:want, correct:true}); chNew(); }
    else { chState.streak=0; id('chFb').textContent='❌ Not quite. Expected '+want; id('chFb').className='mt-2 h-6 font-semibold text-red-700'; chState.history.push({prompt:chState.cur.prompt, answer:want, correct:false}); }
    id('streakOut').textContent=chState.streak;
  });
  id('chCSV').addEventListener('click',()=>{
    const rows=[['prompt','answer','correct']]; chState.history.forEach(h=>rows.push([h.prompt,h.answer,h.correct])); downloadCSV(`${deckTitle}_challenge.csv`, rows);
  });
  id('chJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_challenge.json`, chState.history));

  /* ------------------------- Init ------------------------- */
  renderKwChips();
  window.addEventListener('resize',()=>{ if(slides[i].id==='lineSlide') drawRoundLine(); });
  show(0);
})();
</script>
</body>
</html>
