<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Grade 8 — Transformations (Rotations) — Interactive (No Photos)</title>
  <style>
    :root{
      --bg:#0b1020; --card:#111a33; --ink:#eaf0ff; --muted:#b9c5ff;
      --accent:#ffd166; --accent2:#7bdff2; --good:#4ade80; --bad:#fb7185;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);color:var(--ink);
      background: radial-gradient(1200px 800px at 20% 10%, #162457 0%, var(--bg) 55%);}
    header{max-width:1200px;margin:0 auto;padding:22px 16px 10px;}
    .topbar{
      background: linear-gradient(135deg, rgba(255,209,102,.16), rgba(123,223,242,.10));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
    }
    h1{margin:0;font-size:1.1rem}
    .sub{margin:6px 0 0;color:var(--muted);font-size:.95rem}
    .pill{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(17,26,51,.65);
      padding:8px 10px; border-radius:999px; color:var(--muted); font-size:.92rem;
    }
    main{max-width:1200px;margin:10px auto 50px;padding:0 16px;}
    .layout{display:grid;grid-template-columns: 290px 1fr; gap:14px;}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr;} }
    .card{
      background: rgba(17,26,51,.78);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .sideTop{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .sideTop h2{margin:0;font-size:1rem}
    .list{margin-top:10px; display:grid; grid-template-columns: repeat(6, 1fr); gap:8px;}
    .qbtn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--ink);
      padding:10px 0;
      border-radius: 12px;
      text-align:center;
      font-weight:700;
      font-family:var(--mono);
    }
    .qbtn.active{background: rgba(123,223,242,.18); border-color: rgba(123,223,242,.35);}
    .qbtn.done{outline: 2px solid rgba(74,222,128,.30);}
    .hint{margin-top:10px;color:var(--muted);font-size:.9rem;line-height:1.35}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .titleLine{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .tag{
      font-family:var(--mono); font-size:.9rem; color:var(--muted);
      border:1px dashed rgba(255,255,255,.18);
      border-radius:999px; padding:6px 10px; background: rgba(0,0,0,.16);
    }
    .controls{display:flex; gap:8px; flex-wrap:wrap;}
    button{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,209,102,.14);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
    }
    button.secondary{background: rgba(123,223,242,.12);}
    button.ghost{background: rgba(0,0,0,.18);}
    button:active{transform: translateY(1px);}
    .questionBox{margin-top:12px; border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px; background: rgba(0,0,0,.16);}
    .qtext{font-family:var(--mono); font-size:1rem;}
    .muted{color:var(--muted)}
    .small{font-size:.9rem}
    .gridWrap{margin-top:12px; display:grid; grid-template-columns: 1fr 340px; gap:12px;}
    @media (max-width: 980px){ .gridWrap{grid-template-columns:1fr;} }
    .panel{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.16);
      padding:12px;
    }
    .panel h3{margin:0 0 8px; font-size:1rem;}
    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(17,26,51,.55);
      color: var(--ink);
      font-family: var(--mono);
      padding:10px;
      outline:none;
    }
    .statusLine{
      margin-top:10px; font-family:var(--mono); font-size:.92rem;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .ok{color:var(--good); font-weight:900;}
    .no{color:var(--bad); font-weight:900;}
    .note{
      border-left:4px solid rgba(255,209,102,.55);
      padding:10px 12px;
      background: rgba(255,209,102,.08);
      border-radius: 12px;
      color: var(--muted);
      margin-top:12px;
      font-size:.92rem;
      line-height:1.35;
    }
    .svgShell{
      width:100%;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(7,10,20,.65);
    }
    .legend{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px;
      color: var(--muted); font-size:.9rem;
    }
    .dot{width:12px; height:12px; border-radius:999px; display:inline-block;}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div>
      <h1>Grade 8 — Transformations — Rotations (Interactive, No Photos)</h1>
      <div class="sub">Drag the red image points. Rotation center is shown in gold (when given).</div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <span class="pill">Name: <span contenteditable="true" style="outline:none">__________</span></span>
      <span class="pill">Date: <span contenteditable="true" style="outline:none">__________</span></span>
      <span class="pill">Class: <span contenteditable="true" style="outline:none">__________</span></span>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <aside class="card">
      <div class="sideTop">
        <h2>Problems 1–30</h2>
        <button class="ghost" onclick="resetAll()">Reset all</button>
      </div>
      <div class="list" id="qList"></div>
      <div class="hint">
        • Click a number → that problem appears.<br/>
        • Graph problems: drag <b style="color:#fb7185">red</b> points.<br/>
        • Reasoning problems: type in Notes and press <b>Check</b>.<br/>
        • Work auto-saves on this device.
      </div>
    </aside>

    <section class="card">
      <div class="row">
        <div class="titleLine">
          <div class="tag" id="qTag">#1</div>
          <div class="tag" id="qTypeTag">Rotation (graph)</div>
          <div class="tag" id="qRuleTag">Rule</div>
        </div>
        <div class="controls">
          <button class="ghost" onclick="prevQ()">Prev</button>
          <button class="ghost" onclick="nextQ()">Next</button>
          <button onclick="checkQ()">Check</button>
          <button class="secondary" onclick="showAnswer()">Show answer</button>
        </div>
      </div>

      <div class="questionBox">
        <div class="qtext" id="qText"></div>
        <div class="muted small" id="qHelp" style="margin-top:8px"></div>
      </div>

      <div class="gridWrap">
        <div class="panel">
          <h3>Graph</h3>
          <div class="svgShell">
            <svg id="svg" viewBox="0 0 720 520" width="100%" height="520"></svg>
          </div>
          <div class="legend">
            <span class="dot" style="background:#7bdff2"></span> Original (blue)
            <span class="dot" style="background:#fb7185"></span> Image (red)
            <span class="dot" style="background:#ffd166"></span> Center / hint
          </div>
        </div>

        <div class="panel">
          <h3>Notes / Answers</h3>
          <textarea id="notes" placeholder="Write your answers or explanation here…"></textarea>
          <div class="statusLine" id="statusLine">Status: <span class="muted">Not checked yet.</span></div>

          <div class="note">
            About the origin (from the worksheet):<br/>
            90° CCW: <b>(x,y)→(−y,x)</b> • 90° CW: <b>(x,y)→(y,−x)</b> • 180°: <b>(x,y)→(−x,−y)</b><br/>
            About center (a,b): shift to origin → rotate → shift back.
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
/* ===== Questions (Worksheet 3: Rotations) ===== */
const QUESTIONS = [
  // Level 1 (1–10)
  {n:1, type:"drag", text:"1) Rotate A(3,2) 90° counterclockwise about the origin. Write A′.", points:{A:[3,2]}, rot:{angle:90, dir:"ccw", center:[0,0]}},
  {n:2, type:"drag", text:"2) Rotate B(−4,1) 90° clockwise about the origin. Write B′.", points:{B:[-4,1]}, rot:{angle:90, dir:"cw", center:[0,0]}},
  {n:3, type:"drag", text:"3) Rotate C(5,−3) 180° about the origin. Write C′.", points:{C:[5,-3]}, rot:{angle:180, dir:"ccw", center:[0,0]}},
  {n:4, type:"drag", text:"4) Rotate D(−2,−6) 90° counterclockwise about the origin. Write D′.", points:{D:[-2,-6]}, rot:{angle:90, dir:"ccw", center:[0,0]}},
  {n:5, type:"drag", text:"5) Triangle ABC: A(−4,1), B(−1,4), C(2,1). Rotate 90° CCW about origin. List A′, B′, C′.", points:{A:[-4,1],B:[-1,4],C:[2,1]}, rot:{angle:90, dir:"ccw", center:[0,0]}},
  {n:6, type:"drag", text:"6) Triangle DEF: D(3,1), E(6,1), F(4,4). Rotate 180° about origin. List D′, E′, F′.", points:{D:[3,1],E:[6,1],F:[4,4]}, rot:{angle:180, dir:"ccw", center:[0,0]}},
  {n:7, type:"drag", text:"7) Quadrilateral JKLM: J(−6,−1), K(−3,3), L(0,2), M(−2,−2). Rotate 90° clockwise about origin. List new coordinates.",
    points:{J:[-6,-1],K:[-3,3],L:[0,2],M:[-2,-2]}, rot:{angle:90, dir:"cw", center:[0,0]}},
  {n:8, type:"drag", text:"8) Rotate P(6,−2) by 180° about center O(2,−1). Write P′.", points:{P:[6,-2]}, rot:{angle:180, dir:"ccw", center:[2,-1]}},
  {n:9, type:"drag", text:"9) Rotate Q(4,1) by 90° CCW about center C(1,1). Write Q′.", points:{Q:[4,1]}, rot:{angle:90, dir:"ccw", center:[1,1]}},
  {n:10, type:"word", text:"10) R(2,5) is rotated about the origin to R′(−5,2). What rotation (angle & direction)?",
    show:{orig:{R:[2,5]}, img:{R1:[-5,2]}},
    keywords:["90","ccw","counterclockwise","90°ccw"]},

  // Level 2 (11–20)
  {n:11, type:"drag", text:"11) Rotate S(−3,4) 270° counterclockwise about origin. Write S′.", points:{S:[-3,4]}, rot:{angle:270, dir:"ccw", center:[0,0]}},
  {n:12, type:"drag", text:"12) Segment PQ: P(3,2), Q(6,4). Rotate 90° CCW about origin. Give P′ and Q′.", points:{P:[3,2],Q:[6,4]}, rot:{angle:90, dir:"ccw", center:[0,0]}},
  {n:13, type:"word", text:"13) A 180° rotation maps A(1,4) to A′(−5,2). Find the center of rotation.",
    show:{orig:{A:[1,4]}, img:{A1:[-5,2]}},
    keywords:["(-2,3)","-2,3"]},
  {n:14, type:"word", text:"14) A 90° CCW rotation maps B(4,1) to B′(1,4). Find the center of rotation.",
    show:{orig:{B:[4,1]}, img:{B1:[1,4]}},
    keywords:["(1,1)","1,1"]},
  {n:15, type:"drag", text:"15) Square ABCD: A(1,1), B(5,1), C(5,5), D(1,5). Rotate 90° CCW about its center. List new coordinates.",
    points:{A:[1,1],B:[5,1],C:[5,5],D:[1,5]}, rot:{angle:90, dir:"ccw", center:[3,3]}},
  {n:16, type:"word", text:"16) Two rotations about origin: first 90° CCW, then 180°. What single equivalent rotation?",
    keywords:["270","ccw","90cw","90 cw"]},
  {n:17, type:"word", text:"17) Is T(x,y)=(−y,x) a rotation? If yes, state angle, direction, center.",
    keywords:["yes","90","ccw","origin"]},
  {n:18, type:"word", text:"18) P(x,3) rotated 180° about origin becomes P′(−4,y). Find x and y.",
    keywords:["x=4","y=-3","4,-3"]},
  {n:19, type:"drag", text:"19) Triangle ABC: A(2,−1), B(6,−1), C(4,3). Rotate 90° clockwise about origin. List A′, B′, C′.",
    points:{A:[2,-1],B:[6,-1],C:[4,3]}, rot:{angle:90, dir:"cw", center:[0,0]}},
  {n:20, type:"word", text:"20) A rotation maps line y=x onto y=−x. Give one possible rotation (angle, direction, center).",
    keywords:["90cw","90 cw","270ccw","270 ccw","origin"]},

  // Level 3 (21–30)
  {n:21, type:"drag", text:"21) Rotate A(6,2) by 90° CCW about center C(2,−1). Write A′.", points:{A:[6,2]}, rot:{angle:90, dir:"ccw", center:[2,-1]}},
  {n:22, type:"word", text:"22) A 180° rotation about center (1,2) sends P to P′(3,4). Find original point P.",
    keywords:["(-1,0)","-1,0"]},
  {n:23, type:"word", text:"23) A(−1,2)→A′(3,0) and B(2,5)→B′(6,3). a) Single rotation? b) If not, what does it look like?",
    keywords:["no","translation","right4","down2","(4,-2)"]},
  {n:24, type:"word", text:"24) Select all rotations about origin that keep (4,0) fixed: 90° CCW, 180°, 270° CCW, 360°. Explain.",
    keywords:["360","only 360","360°"]},
  {n:25, type:"word", text:"25) Regular hexagon centered at origin: a) smallest positive rotation onto itself b) # rotational symmetries.",
    keywords:["60","6"]},
  {n:26, type:"word", text:"26) Rotate (3,4) by 90° CCW about origin. Compare distance to origin before/after. What do you notice?",
    keywords:["same","unchanged","equal"]},
  {n:27, type:"word", text:"27) Two 90° CCW rotations about origin. What single rotation is equivalent?",
    keywords:["180","180°"]},
  {n:28, type:"word", text:"28) Find all points (x,y) such that after 90° CCW about origin, the image lies on the x-axis.",
    keywords:["x=0","y-axis"]},
  {n:29, type:"word", text:"29) Find all points (x,y) such that after 90° clockwise about origin, the image lies on the y-axis.",
    keywords:["y=0","x-axis"]},
  {n:30, type:"open", text:"30) Create your own example: draw any triangle, then rotate it 180° about the origin. Label original and image clearly."}
];

/* ===== SVG / Grid ===== */
const svg = document.getElementById("svg");
const qList = document.getElementById("qList");
const qText = document.getElementById("qText");
const qHelp = document.getElementById("qHelp");
const qTag = document.getElementById("qTag");
const qTypeTag = document.getElementById("qTypeTag");
const qRuleTag = document.getElementById("qRuleTag");
const notes = document.getElementById("notes");
const statusLine = document.getElementById("statusLine");

let current=1;
let dragState=null;

const GRID={ xmin:-8, xmax:8, ymin:-8, ymax:8, w:720, h:520, pad:45 };

function xToSvg(x){ const {xmin,xmax,w,pad}=GRID; const inner=w-2*pad; return pad+(x-xmin)*inner/(xmax-xmin); }
function yToSvg(y){ const {ymin,ymax,h,pad}=GRID; const inner=h-2*pad; return pad+(ymax-y)*inner/(ymax-ymin); }
function svgToX(px){ const {xmin,xmax,w,pad}=GRID; const inner=w-2*pad; return xmin+(px-pad)*(xmax-xmin)/inner; }
function svgToY(py){ const {ymin,ymax,h,pad}=GRID; const inner=h-2*pad; return ymax-(py-pad)*(ymax-ymin)/inner; }
function snapInt(v){ return Math.round(v); }

function el(name, attrs={}){
  const e=document.createElementNS("http://www.w3.org/2000/svg", name);
  for(const k in attrs) e.setAttribute(k, attrs[k]);
  return e;
}
function clearSvg(){ while(svg.firstChild) svg.removeChild(svg.firstChild); }

function drawGrid(){
  const {xmin,xmax,ymin,ymax} = GRID;
  for(let x=xmin; x<=xmax; x++){
    const X=xToSvg(x);
    svg.appendChild(el("line",{x1:X,y1:yToSvg(ymin),x2:X,y2:yToSvg(ymax),
      stroke:"rgba(255,255,255,.10)","stroke-width": (x===0?2:1)}));
  }
  for(let y=ymin; y<=ymax; y++){
    const Y=yToSvg(y);
    svg.appendChild(el("line",{x1:xToSvg(xmin),y1:Y,x2:xToSvg(xmax),y2:Y,
      stroke:"rgba(255,255,255,.10)","stroke-width": (y===0?2:1)}));
  }
  [-8,-4,4,8].forEach(x=>{
    const t=el("text",{x:xToSvg(x),y:yToSvg(0)+18,fill:"rgba(185,197,255,.80)","font-size":"12","text-anchor":"middle","font-family":"var(--mono)"});
    t.textContent=x; svg.appendChild(t);
  });
  [-8,-4,4,8].forEach(y=>{
    const t=el("text",{x:xToSvg(0)-12,y:yToSvg(y)+4,fill:"rgba(185,197,255,.80)","font-size":"12","text-anchor":"end","font-family":"var(--mono)"});
    t.textContent=y; svg.appendChild(t);
  });
  const tx=el("text",{x:xToSvg(xmax)-6,y:yToSvg(0)-8,fill:"rgba(185,197,255,.9)","font-size":"13","text-anchor":"end","font-family":"var(--mono)"});
  tx.textContent="x"; svg.appendChild(tx);
  const ty=el("text",{x:xToSvg(0)+10,y:yToSvg(ymax)+16,fill:"rgba(185,197,255,.9)","font-size":"13","text-anchor":"start","font-family":"var(--mono)"});
  ty.textContent="y"; svg.appendChild(ty);
}

function labelAt(color, text, x, y){
  const t=el("text",{x:xToSvg(x),y:yToSvg(y),fill:color,"font-size":"13","font-family":"var(--mono)"});
  t.textContent=text; svg.appendChild(t);
}

function drawCenter(center){
  const [cx,cy]=center;
  const color="rgba(255,209,102,.95)";
  // dot
  svg.appendChild(el("circle",{cx:xToSvg(cx),cy:yToSvg(cy),r:5,fill:color}));
  // crosshair
  svg.appendChild(el("line",{x1:xToSvg(cx)-12,y1:yToSvg(cy),x2:xToSvg(cx)+12,y2:yToSvg(cy),stroke:color,"stroke-width":3}));
  svg.appendChild(el("line",{x1:xToSvg(cx),y1:yToSvg(cy)-12,x2:xToSvg(cx),y2:yToSvg(cy)+12,stroke:color,"stroke-width":3}));
  labelAt(color, `center (${cx},${cy})`, cx+0.4, cy+0.8);
}

function pointCircle(name, pt, color, draggable=false){
  const [x,y]=pt;
  const g=el("g",{"data-name":name});
  const c=el("circle",{cx:xToSvg(x),cy:yToSvg(y),r:7,fill:color,stroke:"rgba(255,255,255,.25)","stroke-width":1});
  if(draggable){
    c.style.cursor="grab";
    c.addEventListener("pointerdown",(ev)=>startDrag(ev,name));
  }
  const label=el("text",{x:xToSvg(x)+10,y:yToSvg(y)-10,fill:"rgba(234,240,255,.95)","font-size":"13","font-family":"var(--mono)"});
  label.textContent=name;
  g.appendChild(c); g.appendChild(label);
  return g;
}

function polyline(pts, stroke, fill, id){
  const d=pts.map(p=>`${xToSvg(p[0])},${yToSvg(p[1])}`).join(" ");
  const e=el("polyline",{points:d,fill:fill||"none",stroke, "stroke-width":3, "stroke-linejoin":"round", "stroke-linecap":"round", opacity:0.9});
  if(id) e.setAttribute("id", id);
  return e;
}

function closeShapeFrom(pointsObj, suffix=""){
  const ordered = Object.keys(pointsObj).slice().sort();
  const pts = ordered.map(k=>pointsObj[k+suffix]);
  const closed = pts.concat([pts[0]]);
  return {ordered, closed};
}

function rotatePoint(pt, rot){
  const [x,y]=pt;
  const [a,b]=rot.center;
  const dx=x-a, dy=y-b;
  const ang=rot.angle % 360;
  const dir=rot.dir;

  // normalize: treat 270 CCW as 90 CW etc
  let k=ang;
  if(dir==="cw") k = (360-ang)%360;

  let rx=dx, ry=dy;
  if(k===90){ rx = -dy; ry = dx; }
  else if(k===180){ rx = -dx; ry = -dy; }
  else if(k===270){ rx = dy; ry = -dx; }
  else if(k===0){ rx = dx; ry = dy; }

  return [a+rx, b+ry];
}

function expectedImagePoints(q){
  const out={};
  for(const k in q.points) out[k+"'"]=rotatePoint(q.points[k], q.rot);
  return out;
}

/* ===== UI / State ===== */
function norm(s){ return (s||"").toLowerCase().replaceAll("−","-").replaceAll(" ","").replaceAll("\t","").replaceAll("\n",""); }

function renderSidebar(){
  qList.innerHTML="";
  for(let i=1;i<=QUESTIONS.length;i++){
    const b=document.createElement("div");
    b.className="qbtn";
    b.textContent=i;
    b.onclick=()=>goTo(i);
    if(i===current) b.classList.add("active");
    if(isDone(i)) b.classList.add("done");
    qList.appendChild(b);
  }
}

function goTo(n){
  current=n;
  renderSidebar();
  buildQuestionUI(QUESTIONS[current-1]);
}
function prevQ(){ if(current>1) goTo(current-1); }
function nextQ(){ if(current<QUESTIONS.length) goTo(current+1); }

function setStatus(msg, cls){ statusLine.innerHTML = `Status: <span class="${cls}">${msg}</span>`; }

function ruleLabel(rot){
  const [a,b]=rot.center;
  let rule="";
  if(a===0 && b===0){
    if(rot.dir==="ccw" && rot.angle===90) rule="(x,y)->(-y,x)";
    else if(rot.dir==="cw" && rot.angle===90) rule="(x,y)->(y,-x)";
    else if(rot.angle===180) rule="(x,y)->(-x,-y)";
    else rule=`${rot.angle}° ${rot.dir.toUpperCase()}`;
  } else {
    rule=`${rot.angle}° ${rot.dir.toUpperCase()} about (${a},${b})`;
  }
  return rule;
}

function buildQuestionUI(q){
  clearSvg(); drawGrid();

  qTag.textContent = `#${q.n}`;
  qText.textContent = q.text;

  notes.value = loadNotes(q.n);

  if(q.type==="drag"){
    qTypeTag.textContent="Rotation (drag on graph)";
    qHelp.innerHTML="Drag the <b style='color:#fb7185'>red</b> image points to the rotated location.";
    qRuleTag.textContent = ruleLabel(q.rot);

    if(q.rot && q.rot.center) drawCenter(q.rot.center);

    const names = Object.keys(q.points);
    if(names.length>=3){
      const sorted = names.slice().sort();
      const pts = sorted.map(k=>q.points[k]);
      svg.appendChild(polyline(pts.concat([pts[0]]), "rgba(123,223,242,.9)", "rgba(123,223,242,.10)"));
    }
    for(const k of names) svg.appendChild(pointCircle(k, q.points[k], "rgba(123,223,242,.95)", false));

    const imgPts={};
    for(const k of names) imgPts[k+"'"]=[...q.points[k]];
    window.__imgPts=imgPts;

    if(names.length>=3){
      const {ordered, closed} = closeShapeFrom(imgPts, "");
      const poly = polyline(closed, "rgba(251,113,133,.9)", "rgba(251,113,133,.10)", "imgPoly");
      poly.setAttribute("data-order", ordered.join(","));
      svg.appendChild(poly);
    }
    for(const k of names) svg.appendChild(pointCircle(k+"'", imgPts[k+"'"], "rgba(251,113,133,.95)", true));
  }
  else if(q.type==="word"){
    qTypeTag.textContent="Rotation (written)";
    qRuleTag.textContent="Explain / rule";
    qHelp.innerHTML="Write your answer in Notes, then press <b>Check</b>.";
    window.__imgPts=null;

    if(q.show){
      for(const k in q.show.orig) svg.appendChild(pointCircle("orig_"+k, q.show.orig[k], "rgba(123,223,242,.95)", false));
      for(const k in q.show.img) svg.appendChild(pointCircle("img_"+k, q.show.img[k], "rgba(251,113,133,.95)", false));
    }
  }
  else { // open
    qTypeTag.textContent="Open task";
    qRuleTag.textContent="Teacher check";
    qHelp.innerHTML="Open task — use Notes. (Auto-check is off for this one.)";
    window.__imgPts=null;
  }

  setStatus("Not checked yet.", "muted");
}

function updateImagePolygon(){
  const poly=document.getElementById("imgPoly");
  if(!poly || !window.__imgPts) return;
  const order=(poly.getAttribute("data-order")||"").split(",").filter(Boolean);
  const pts=order.map(k=>window.__imgPts[k+"'"]);
  const closed=pts.concat([pts[0]]);
  poly.setAttribute("points", closed.map(p=>`${xToSvg(p[0])},${yToSvg(p[1])}`).join(" "));
}

function startDrag(ev, name){
  if(!window.__imgPts) return;
  const target=ev.target;
  target.setPointerCapture(ev.pointerId);
  target.style.cursor="grabbing";
  dragState={name, target};
  svg.addEventListener("pointermove", onDragMove);
  svg.addEventListener("pointerup", onDragEnd, {once:true});
}

function onDragMove(ev){
  if(!dragState) return;
  const pt=svg.createSVGPoint();
  pt.x=ev.clientX; pt.y=ev.clientY;
  const ctm=svg.getScreenCTM().inverse();
  const loc=pt.matrixTransform(ctm);

  const x=snapInt(svgToX(loc.x));
  const y=snapInt(svgToY(loc.y));

  const cx=Math.max(GRID.xmin, Math.min(GRID.xmax, x));
  const cy=Math.max(GRID.ymin, Math.min(GRID.ymax, y));

  window.__imgPts[dragState.name]=[cx,cy];
  dragState.target.setAttribute("cx", xToSvg(cx));
  dragState.target.setAttribute("cy", yToSvg(cy));

  const g=dragState.target.parentNode;
  const label=g.querySelector("text");
  label.setAttribute("x", xToSvg(cx)+10);
  label.setAttribute("y", yToSvg(cy)-10);

  updateImagePolygon();
}

function onDragEnd(){
  if(!dragState) return;
  dragState.target.style.cursor="grab";
  svg.removeEventListener("pointermove", onDragMove);
  dragState=null;
}

/* ===== Checking ===== */
function checkQ(){
  const q=QUESTIONS[current-1];
  markDone(q.n);
  saveNotes(q.n, notes.value);

  if(q.type==="drag"){
    const exp=expectedImagePoints(q);
    const got=window.__imgPts;
    let ok=true;
    for(const k in exp){
      const e=exp[k], g=got[k];
      if(!g || g[0]!==e[0] || g[1]!==e[1]) { ok=false; break; }
    }
    setStatus(ok ? "Correct ✓" : "Not correct yet ✗ (move the red points)", ok ? "ok" : "no");
    return;
  }

  if(q.type==="word"){
    const text=norm(notes.value);
    const keys=q.keywords||[];
    const hit=keys.some(k=>text.includes(norm(k)));
    setStatus(hit ? "Looks correct ✓" : "Not sure / missing key idea ✗", hit ? "ok" : "no");
    return;
  }

  setStatus("Saved (teacher check).", "ok");
}

function showAnswer(){
  const q=QUESTIONS[current-1];
  markDone(q.n);

  if(q.type==="drag"){
    const exp=expectedImagePoints(q);
    for(const k in exp){
      window.__imgPts[k]=[...exp[k]];
      const gg=[...svg.querySelectorAll("g")].find(x=>x.getAttribute("data-name")===k);
      if(gg){
        const c=gg.querySelector("circle");
        const t=gg.querySelector("text");
        c.setAttribute("cx", xToSvg(exp[k][0]));
        c.setAttribute("cy", yToSvg(exp[k][1]));
        t.setAttribute("x", xToSvg(exp[k][0])+10);
        t.setAttribute("y", yToSvg(exp[k][1])-10);
      }
    }
    updateImagePolygon();
    setStatus("Answer shown (red points set).", "ok");
    return;
  }

  if(q.type==="word"){
    notes.value = (notes.value||"") + (notes.value ? "\n\n" : "") +
      "— ANSWER GUIDE —\n" +
      "State the rotation clearly (e.g., 90° CCW about origin, center (1,1), etc.).";
    saveNotes(q.n, notes.value);
    setStatus("Answer guide inserted into notes.", "ok");
    return;
  }

  setStatus("Open task — no single answer.", "muted");
}

/* ===== Local save ===== */
const STORE_KEY="g8_rotations_noPhotos_v1";
function loadStore(){ try{return JSON.parse(localStorage.getItem(STORE_KEY)||\"{}\");}catch{return{};} }
function saveStore(obj){ localStorage.setItem(STORE_KEY, JSON.stringify(obj)); }
function loadNotes(n){ const st=loadStore(); return st[\"notes_\"+n]||\"\"; }
function saveNotes(n,val){ const st=loadStore(); st[\"notes_\"+n]=val||\"\"; saveStore(st); }
function markDone(n){ const st=loadStore(); st[\"done_\"+n]=true; saveStore(st); renderSidebar(); }
function isDone(n){ const st=loadStore(); return !!st[\"done_\"+n]; }
function resetAll(){ localStorage.removeItem(STORE_KEY); renderSidebar(); buildQuestionUI(QUESTIONS[current-1]); setStatus(\"Reset complete.\",\"muted\"); }
notes.addEventListener(\"input\", ()=>saveNotes(current, notes.value));

/* init */
renderSidebar();
buildQuestionUI(QUESTIONS[0]);
</script>
</body>
</html>
