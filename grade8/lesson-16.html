<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Grade 8 — Transformations (Reflections) — Interactive (No Photos)</title>
  <style>
    :root{
      --bg:#0b1020; --card:#111a33; --ink:#eaf0ff; --muted:#b9c5ff;
      --accent:#ffd166; --accent2:#7bdff2; --good:#4ade80; --bad:#fb7185;
      --shadow:0 10px 30px rgba(0,0,0,.35); --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--ink);
      background: radial-gradient(1200px 800px at 20% 10%, #162457 0%, var(--bg) 55%);
    }
    header{max-width:1200px;margin:0 auto;padding:22px 16px 10px;}
    .topbar{
      background: linear-gradient(135deg, rgba(255,209,102,.16), rgba(123,223,242,.10));
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      display:flex; gap:14px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
    }
    h1{margin:0;font-size:1.1rem}
    .sub{margin:6px 0 0;color:var(--muted);font-size:.95rem}
    .pill{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(17,26,51,.65);
      padding:8px 10px; border-radius:999px; color:var(--muted); font-size:.92rem;
    }
    main{max-width:1200px;margin:10px auto 50px;padding:0 16px;}
    .layout{display:grid;grid-template-columns: 290px 1fr; gap:14px;}
    @media (max-width: 980px){ .layout{grid-template-columns:1fr;} }
    .card{
      background: rgba(17,26,51,.78);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .sideTop{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .sideTop h2{margin:0;font-size:1rem}
    .list{margin-top:10px; display:grid; grid-template-columns: repeat(6, 1fr); gap:8px;}
    .qbtn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: var(--ink);
      padding:10px 0;
      border-radius: 12px;
      text-align:center;
      font-weight:700;
      font-family:var(--mono);
      user-select:none;
    }
    .qbtn.active{background: rgba(123,223,242,.18); border-color: rgba(123,223,242,.35);}
    .qbtn.done{outline: 2px solid rgba(74,222,128,.30);}
    .hint{margin-top:10px;color:var(--muted);font-size:.9rem;line-height:1.35}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;}
    .titleLine{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .tag{
      font-family:var(--mono); font-size:.9rem; color:var(--muted);
      border:1px dashed rgba(255,255,255,.18);
      border-radius:999px; padding:6px 10px; background: rgba(0,0,0,.16);
    }
    .controls{display:flex; gap:8px; flex-wrap:wrap;}
    button{
      cursor:pointer;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,209,102,.14);
      color: var(--ink);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
    }
    button.secondary{background: rgba(123,223,242,.12);}
    button.ghost{background: rgba(0,0,0,.18);}
    button:active{transform: translateY(1px);}
    .questionBox{margin-top:12px; border:1px solid rgba(255,255,255,.10); border-radius:14px; padding:12px; background: rgba(0,0,0,.16);}
    .qtext{font-family:var(--mono); font-size:1rem;}
    .muted{color:var(--muted)}
    .small{font-size:.9rem}
    .gridWrap{margin-top:12px; display:grid; grid-template-columns: 1fr 340px; gap:12px;}
    @media (max-width: 980px){ .gridWrap{grid-template-columns:1fr;} }
    .panel{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      background: rgba(0,0,0,.16);
      padding:12px;
    }
    .panel h3{margin:0 0 8px; font-size:1rem;}
    textarea{
      width:100%;
      min-height: 120px;
      resize: vertical;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(17,26,51,.55);
      color: var(--ink);
      font-family: var(--mono);
      padding:10px;
      outline:none;
    }
    .statusLine{
      margin-top:10px; font-family:var(--mono); font-size:.92rem;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .ok{color:var(--good); font-weight:900;}
    .no{color:var(--bad); font-weight:900;}
    .note{
      border-left:4px solid rgba(255,209,102,.55);
      padding:10px 12px;
      background: rgba(255,209,102,.08);
      border-radius: 12px;
      color: var(--muted);
      margin-top:12px;
      font-size:.92rem;
      line-height:1.35;
    }
    .svgShell{
      width:100%;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(7,10,20,.65);
    }
    .legend{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px;
      color: var(--muted); font-size:.9rem;
    }
    .dot{width:12px; height:12px; border-radius:999px; display:inline-block;}
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div>
      <h1>Grade 8 — Transformations — Reflections (Interactive, No Photos) — FIXED</h1>
      <div class="sub">Drag the red image points. Mirror line is shown in gold where applicable.</div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <span class="pill">Name: <span contenteditable="true" style="outline:none">__________</span></span>
      <span class="pill">Date: <span contenteditable="true" style="outline:none">__________</span></span>
      <span class="pill">Class: <span contenteditable="true" style="outline:none">__________</span></span>
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <aside class="card">
      <div class="sideTop">
        <h2>Problems 1–30</h2>
        <button class="ghost" onclick="resetAll()">Reset all</button>
      </div>
      <div class="list" id="qList"></div>
      <div class="hint">
        • Click a number → that problem appears.<br/>
        • Graph problems: drag <b style="color:#fb7185">red</b> points (snap-to-grid).<br/>
        • Notes auto-save on this device.
      </div>
    </aside>

    <section class="card">
      <div class="row">
        <div class="titleLine">
          <div class="tag" id="qTag">#1</div>
          <div class="tag" id="qTypeTag">Reflection</div>
          <div class="tag" id="qRuleTag">Rule</div>
        </div>
        <div class="controls">
          <button class="ghost" onclick="prevQ()">Prev</button>
          <button class="ghost" onclick="nextQ()">Next</button>
          <button onclick="checkQ()">Check</button>
          <button class="secondary" onclick="showAnswer()">Show answer</button>
        </div>
      </div>

      <div class="questionBox">
        <div class="qtext" id="qText"></div>
        <div class="muted small" id="qHelp" style="margin-top:8px"></div>
      </div>

      <div class="gridWrap">
        <div class="panel">
          <h3>Graph</h3>
          <div class="svgShell">
            <svg id="svg" viewBox="0 0 720 520" width="100%" height="520"></svg>
          </div>
          <div class="legend">
            <span class="dot" style="background:#7bdff2"></span> Original (blue)
            <span class="dot" style="background:#fb7185"></span> Image (red)
            <span class="dot" style="background:#ffd166"></span> Mirror line (gold)
          </div>
        </div>

        <div class="panel">
          <h3>Notes / Answers</h3>
          <textarea id="notes" placeholder="Write your answers or explanation here…"></textarea>
          <div class="statusLine" id="statusLine">Status: <span class="muted">Not checked yet.</span></div>

          <div class="note">
            Quick rules:<br/>
            x-axis: <b>(x,y)→(x,−y)</b> • y-axis: <b>(x,y)→(−x,y)</b><br/>
            origin: <b>(x,y)→(−x,−y)</b> • y=x: <b>(x,y)→(y,x)</b><br/>
            x=a: <b>x′=2a−x</b> • y=b: <b>y′=2b−y</b> • y=x+c: <b>(x,y)→(y−c, x+c)</b>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
/* ===========================
   Question bank (Reflections)
   =========================== */
const QUESTIONS = [
  // 1–11 are clean coordinate problems
  {n:1,  type:"drag", text:"1) Reflect A(−3, 4) across the x-axis. Place A′.", points:{A:[-3,4]}, reflect:{kind:"xAxis"}},
  {n:2,  type:"drag", text:"2) Reflect B(5, −2) across the y-axis. Place B′.", points:{B:[5,-2]}, reflect:{kind:"yAxis"}},
  {n:3,  type:"drag", text:"3) Reflect C(−4, −1) across the origin. Place C′.", points:{C:[-4,-1]}, reflect:{kind:"origin"}},
  {n:4,  type:"drag", text:"4) Reflect D(2, 7) across the line y = x. Place D′.", points:{D:[2,7]}, reflect:{kind:"yEqX"}},
  {n:5,  type:"drag", text:"5) Reflect E(−6, 1) across the line y = −x. Place E′.", points:{E:[-6,1]}, reflect:{kind:"yEqNegX"}},
  {n:6,  type:"drag", text:"6) Reflect P(6, −5) across x = −3. Place P′.", points:{P:[6,-5]}, reflect:{kind:"xEqA", a:-3}},
  {n:7,  type:"drag", text:"7) Reflect Q(−2, 6) across y = 2. Place Q′.", points:{Q:[-2,6]}, reflect:{kind:"yEqB", b:2}},
  {n:8,  type:"drag", text:"8) Triangle ABC: A(−4,1), B(−1,4), C(2,1). Reflect across x-axis. Place A′B′C′.", points:{A:[-4,1],B:[-1,4],C:[2,1]}, reflect:{kind:"xAxis"}},
  {n:9,  type:"drag", text:"9) Rectangle JKLM: J(−5,5), K(−1,5), L(−1,3), M(−5,3). Reflect across y-axis. Place J′K′L′M′.", points:{J:[-5,5],K:[-1,5],L:[-1,3],M:[-5,3]}, reflect:{kind:"yAxis"}},
  {n:10, type:"drag", text:"10) Reflect R(−7, −1) across x = 2. Place R′.", points:{R:[-7,-1]}, reflect:{kind:"xEqA", a:2}},
  {n:11, type:"drag", text:"11) Triangle ABC: A(−5,5), B(−2,6), C(−1,3). Reflect across y = 2. Place A′B′C′.", points:{A:[-5,5],B:[-2,6],C:[-1,3]}, reflect:{kind:"yEqB", b:2}},

  // 12: pentagon from worksheet (you can change coords to match your exact PDF)
  {n:12, type:"drag", text:"12) Reflect pentagon ABCDE across x = 1. Place A′B′C′D′E′.",
    points:{A:[-2,1],B:[0,4],C:[3,3],D:[2,0],E:[0,-1]}, reflect:{kind:"xEqA", a:1}},

  // Word/reasoning items (light keyword checks)
  {n:13, type:"word", text:"13) A(−4,1)→(4,1) and B(−1,−3)→(1,−3). Find the line of reflection.", keywords:["x=0","y-axis"]},
  {n:14, type:"word", text:"14) A(2,3)→(2,−5) and B(−4,0)→(−4,−2). Is it a reflection? If yes, line of reflection.", keywords:["y=-1","yes"]},
  {n:15, type:"drag", text:"15) Triangle PQR: P(2,1), Q(5,3), R(3,6). Reflect across y=x. Place P′Q′R′.", points:{P:[2,1],Q:[5,3],R:[3,6]}, reflect:{kind:"yEqX"}},
  {n:16, type:"word", text:"16) T(x,y) = (4 − x, y). Is it a reflection? If yes, mirror line?", keywords:["x=2","yes"]},
  {n:17, type:"drag", text:"17) Reflect S(7, −1) across y = −3. Place S′.", points:{S:[7,-1]}, reflect:{kind:"yEqB", b:-3}},
  {n:18, type:"word", text:"18) P(1,5) reflects to (7,5). Find the mirror line.", keywords:["x=4"]},
  {n:19, type:"drag", text:"19) Segment AB: A(−6,2), B(−2,6). Reflect across y-axis. Place A′B′.", points:{A:[-6,2],B:[-2,6]}, reflect:{kind:"yAxis"}},
  {n:20, type:"word", text:"20) Reflect across x-axis then y-axis. Give rule and name single transformation.", keywords:["(-x,-y)","180","rotation"]},

  {n:21, type:"word", text:"21) Which points stay fixed under reflection across y=2?", keywords:["y=2","on y=2"]},
  {n:22, type:"word", text:"22) Reflect across x=−1 then x=3. What single transformation results?", keywords:["translation","right8","8"]},
  {n:23, type:"word", text:"23) A(1,4)→(5,4) and B(2,−1)→(6,−1). Find mirror line.", keywords:["x=3"]},
  {n:24, type:"word", text:"24) Reflect across y=x then across y-axis. Name the resulting rotation.", keywords:["90","ccw","counterclockwise"]},
  {n:25, type:"word", text:"25) Q(−2,6) reflects to (4,0). Find midpoint and mirror line.", keywords:["(1,3)","y=x+2"]},

  {n:26, type:"drag", text:"26) Reflect P(4,−2) across y=x+2. Place P′.", points:{P:[4,-2]}, reflect:{kind:"yEqXPlusC", c:2}},
  {n:27, type:"word", text:"27) A(0,3)→(0,−1) and B(5,3)→(5,−1). Reflection? If yes, mirror line.", keywords:["y=1","yes"]},
  {n:28, type:"word", text:"28) Decide if red is a reflection of blue (diagram). Explain.", keywords:["no","translation"]},
  {n:29, type:"word", text:"29) Why can’t two different points reflect to the same image point?", keywords:["one-to-one","injective","unique"]},
  {n:30, type:"open", text:"30) Create your own shape and reflect it across the y-axis. Label original and image."}
];

/* ===========================
   SVG + coordinate system
   =========================== */
const svg = document.getElementById("svg");
const qList = document.getElementById("qList");
const qText = document.getElementById("qText");
const qHelp = document.getElementById("qHelp");
const qTag = document.getElementById("qTag");
const qTypeTag = document.getElementById("qTypeTag");
const qRuleTag = document.getElementById("qRuleTag");
const notes = document.getElementById("notes");
const statusLine = document.getElementById("statusLine");

let current = 1;
let dragState = null;

// Grid matches the worksheet vibe (edit if you want)
const GRID = { xmin:-8, xmax:8, ymin:-8, ymax:8, w:720, h:520, pad:45 };

function xToSvg(x){ const {xmin,xmax,w,pad}=GRID; const inner=w-2*pad; return pad+(x-xmin)*inner/(xmax-xmin); }
function yToSvg(y){ const {ymin,ymax,h,pad}=GRID; const inner=h-2*pad; return pad+(ymax-y)*inner/(ymax-ymin); }
function svgToX(px){ const {xmin,xmax,w,pad}=GRID; const inner=w-2*pad; return xmin+(px-pad)*(xmax-xmin)/inner; }
function svgToY(py){ const {ymin,ymax,h,pad}=GRID; const inner=h-2*pad; return ymax-(py-pad)*(ymax-ymin)/inner; }
function snapInt(v){ return Math.round(v); }

function el(name, attrs={}){
  const e=document.createElementNS("http://www.w3.org/2000/svg", name);
  for(const k in attrs) e.setAttribute(k, attrs[k]);
  return e;
}
function clearSvg(){ while(svg.firstChild) svg.removeChild(svg.firstChild); }

function drawGrid(){
  const {xmin,xmax,ymin,ymax} = GRID;
  for(let x=xmin; x<=xmax; x++){
    const X=xToSvg(x);
    svg.appendChild(el("line",{x1:X,y1:yToSvg(ymin),x2:X,y2:yToSvg(ymax),
      stroke:"rgba(255,255,255,.10)","stroke-width": (x===0?2:1)}));
  }
  for(let y=ymin; y<=ymax; y++){
    const Y=yToSvg(y);
    svg.appendChild(el("line",{x1:xToSvg(xmin),y1:Y,x2:xToSvg(xmax),y2:Y,
      stroke:"rgba(255,255,255,.10)","stroke-width": (y===0?2:1)}));
  }
  [-8,-4,4,8].forEach(x=>{
    const t=el("text",{x:xToSvg(x),y:yToSvg(0)+18,fill:"rgba(185,197,255,.80)","font-size":"12","text-anchor":"middle","font-family":"var(--mono)"});
    t.textContent=x; svg.appendChild(t);
  });
  [-8,-4,4,8].forEach(y=>{
    const t=el("text",{x:xToSvg(0)-12,y:yToSvg(y)+4,fill:"rgba(185,197,255,.80)","font-size":"12","text-anchor":"end","font-family":"var(--mono)"});
    t.textContent=y; svg.appendChild(t);
  });
  const tx=el("text",{x:xToSvg(xmax)-6,y:yToSvg(0)-8,fill:"rgba(185,197,255,.9)","font-size":"13","text-anchor":"end","font-family":"var(--mono)"});
  tx.textContent="x"; svg.appendChild(tx);
  const ty=el("text",{x:xToSvg(0)+10,y:yToSvg(ymax)+16,fill:"rgba(185,197,255,.9)","font-size":"13","text-anchor":"start","font-family":"var(--mono)"});
  ty.textContent="y"; svg.appendChild(ty);
}

function labelAt(color, text, x, y){
  const t=el("text",{x:xToSvg(x),y:yToSvg(y),fill:color,"font-size":"13","font-family":"var(--mono)"});
  t.textContent=text; svg.appendChild(t);
}

function drawMirror(ref){
  if(!ref) return;
  const stroke="rgba(255,209,102,.95)";
  const dash="8 6";
  if(ref.kind==="xAxis"){
    svg.appendChild(el("line",{x1:xToSvg(GRID.xmin),y1:yToSvg(0),x2:xToSvg(GRID.xmax),y2:yToSvg(0),stroke,"stroke-width":3,"stroke-dasharray":dash}));
    labelAt(stroke, "mirror y=0", -7.6, 0.6);
  } else if(ref.kind==="yAxis"){
    svg.appendChild(el("line",{x1:xToSvg(0),y1:yToSvg(GRID.ymin),x2:xToSvg(0),y2:yToSvg(GRID.ymax),stroke,"stroke-width":3,"stroke-dasharray":dash}));
    labelAt(stroke, "mirror x=0", 0.4, 7.2);
  } else if(ref.kind==="yEqX"){
    svg.appendChild(el("line",{x1:xToSvg(-8),y1:yToSvg(-8),x2:xToSvg(8),y2:yToSvg(8),stroke,"stroke-width":3,"stroke-dasharray":dash}));
    labelAt(stroke, "mirror y=x", 3.8, 6.8);
  } else if(ref.kind==="yEqNegX"){
    svg.appendChild(el("line",{x1:xToSvg(-8),y1:yToSvg(8),x2:xToSvg(8),y2:yToSvg(-8),stroke,"stroke-width":3,"stroke-dasharray":dash}));
    labelAt(stroke, "mirror y=-x", 3.5, -6.8);
  } else if(ref.kind==="xEqA"){
    const a=ref.a;
    svg.appendChild(el("line",{x1:xToSvg(a),y1:yToSvg(GRID.ymin),x2:xToSvg(a),y2:yToSvg(GRID.ymax),stroke,"stroke-width":3,"stroke-dasharray":dash}));
    labelAt(stroke, `mirror x=${a}`, a+0.2, 7.2);
  } else if(ref.kind==="yEqB"){
    const b=ref.b;
    svg.appendChild(el("line",{x1:xToSvg(GRID.xmin),y1:yToSvg(b),x2:xToSvg(GRID.xmax),y2:yToSvg(b),stroke,"stroke-width":3,"stroke-dasharray":dash}));
    labelAt(stroke, `mirror y=${b}`, -7.6, b+0.6);
  } else if(ref.kind==="yEqXPlusC"){
    const c=ref.c;
    svg.appendChild(el("line",{x1:xToSvg(-8),y1:yToSvg(-8+c),x2:xToSvg(8),y2:yToSvg(8+c),stroke,"stroke-width":3,"stroke-dasharray":dash}));
    labelAt(stroke, `mirror y=x+${c}`, 2.6, 7.4);
  }
}

function pointGroup(name, pt, color, draggable=false){
  const [x,y]=pt;
  const g=el("g",{"data-name":name});
  const c=el("circle",{cx:xToSvg(x),cy:yToSvg(y),r:7,fill:color,stroke:"rgba(255,255,255,.25)","stroke-width":1});
  if(draggable){
    c.style.cursor="grab";
    c.addEventListener("pointerdown",(ev)=>startDrag(ev,name));
  }
  const label=el("text",{x:xToSvg(x)+10,y:yToSvg(y)-10,fill:"rgba(234,240,255,.95)","font-size":"13","font-family":"var(--mono)"});
  label.textContent=name;
  g.appendChild(c); g.appendChild(label);
  return g;
}

function polylineFrom(pts, stroke, fill, id){
  const d=pts.map(p=>`${xToSvg(p[0])},${yToSvg(p[1])}`).join(" ");
  const e=el("polyline",{points:d,fill:fill||"none",stroke, "stroke-width":3, "stroke-linejoin":"round", "stroke-linecap":"round", opacity:0.9});
  if(id) e.setAttribute("id", id);
  return e;
}

/* ===========================
   Reflection math
   =========================== */
function reflectPoint([x,y], ref){
  switch(ref.kind){
    case "xAxis": return [x, -y];
    case "yAxis": return [-x, y];
    case "origin": return [-x, -y];
    case "yEqX": return [y, x];
    case "yEqNegX": return [-y, -x];
    case "xEqA": return [2*ref.a - x, y];
    case "yEqB": return [x, 2*ref.b - y];
    case "yEqXPlusC": // y = x + c  => (x,y)->(y-c, x+c)
      return [y - ref.c, x + ref.c];
    default: return [x,y];
  }
}

function expectedImagePoints(q){
  const out={};
  for(const base in q.points){
    out[base+"'"] = reflectPoint(q.points[base], q.reflect);
  }
  return out;
}

function ruleLabel(ref){
  if(!ref) return "Rule";
  switch(ref.kind){
    case "xAxis": return "(x,y)->(x,-y)";
    case "yAxis": return "(x,y)->(-x,y)";
    case "origin": return "(x,y)->(-x,-y)";
    case "yEqX": return "(x,y)->(y,x)";
    case "yEqNegX": return "(x,y)->(-y,-x)";
    case "xEqA": return `x' = 2(${ref.a}) - x`;
    case "yEqB": return `y' = 2(${ref.b}) - y`;
    case "yEqXPlusC": return `(x,y)->(y-${ref.c}, x+${ref.c})`;
    default: return "Rule";
  }
}

/* ===========================
   Drag + polygon update
   =========================== */
function startDrag(ev, name){
  if(!window.__imgPts) return;
  const target=ev.target;
  target.setPointerCapture(ev.pointerId);
  target.style.cursor="grabbing";
  dragState={name, target};
  svg.addEventListener("pointermove", onDragMove);
  svg.addEventListener("pointerup", onDragEnd, {once:true});
}

function onDragMove(ev){
  if(!dragState) return;
  const pt=svg.createSVGPoint();
  pt.x=ev.clientX; pt.y=ev.clientY;
  const ctm=svg.getScreenCTM().inverse();
  const loc=pt.matrixTransform(ctm);

  const x=snapInt(svgToX(loc.x));
  const y=snapInt(svgToY(loc.y));

  const cx=Math.max(GRID.xmin, Math.min(GRID.xmax, x));
  const cy=Math.max(GRID.ymin, Math.min(GRID.ymax, y));

  window.__imgPts[dragState.name]=[cx,cy];
  dragState.target.setAttribute("cx", xToSvg(cx));
  dragState.target.setAttribute("cy", yToSvg(cy));

  const g=dragState.target.parentNode;
  const label=g.querySelector("text");
  label.setAttribute("x", xToSvg(cx)+10);
  label.setAttribute("y", yToSvg(cy)-10);

  updateImagePolygon();
}

function onDragEnd(){
  if(!dragState) return;
  dragState.target.style.cursor="grab";
  svg.removeEventListener("pointermove", onDragMove);
  dragState=null;
}

function updateImagePolygon(){
  const poly=document.getElementById("imgPoly");
  if(!poly || !window.__baseOrder || !window.__imgPts) return;

  const pts = window.__baseOrder.map(b => window.__imgPts[b+"'"]);
  if(pts.length < 3) return;

  const closed = pts.concat([pts[0]]);
  poly.setAttribute("points", closed.map(p=>`${xToSvg(p[0])},${yToSvg(p[1])}`).join(" "));
}

/* ===========================
   UI building
   =========================== */
function setStatus(msg, cls){
  statusLine.innerHTML = `Status: <span class="${cls}">${msg}</span>`;
}

function buildQuestionUI(q){
  clearSvg(); drawGrid();
  qTag.textContent = `#${q.n}`;
  qText.textContent = q.text;
  notes.value = loadNotes(q.n);

  if(q.type==="drag"){
    qTypeTag.textContent="Reflection (drag on graph)";
    qRuleTag.textContent=ruleLabel(q.reflect);
    qHelp.innerHTML="Drag the <b style='color:#fb7185'>red</b> image points to the reflected location.";
    drawMirror(q.reflect);

    const bases = Object.keys(q.points).slice().sort();
    window.__baseOrder = bases;

    // original poly (if 3+)
    if(bases.length>=3){
      const pts = bases.map(b => q.points[b]);
      svg.appendChild(polylineFrom(pts.concat([pts[0]]), "rgba(123,223,242,.9)", "rgba(123,223,242,.10)"));
    }
    // original points
    for(const b of bases) svg.appendChild(pointGroup(b, q.points[b], "rgba(123,223,242,.95)", false));

    // image points start on top of originals (student drags)
    const imgPts = {};
    for(const b of bases) imgPts[b+"'"] = [...q.points[b]];
    window.__imgPts = imgPts;

    if(bases.length>=3){
      const pts = bases.map(b => imgPts[b+"'"]);
      const poly = polylineFrom(pts.concat([pts[0]]), "rgba(251,113,133,.9)", "rgba(251,113,133,.10)", "imgPoly");
      svg.appendChild(poly);
    }

    for(const b of bases) svg.appendChild(pointGroup(b+"'", imgPts[b+"'"], "rgba(251,113,133,.95)", true));
  }
  else if(q.type==="word"){
    qTypeTag.textContent="Reflection (written)";
    qRuleTag.textContent="Explain / rule";
    qHelp.innerHTML="Type your answer in Notes, then press <b>Check</b>.";
    window.__imgPts = null;
    window.__baseOrder = null;
  }
  else {
    qTypeTag.textContent="Open task";
    qRuleTag.textContent="Teacher check";
    qHelp.innerHTML="Open task — use Notes. (Auto-check is off.)";
    window.__imgPts = null;
    window.__baseOrder = null;
  }

  setStatus("Not checked yet.", "muted");
}

/* ===========================
   Checking / reveal
   =========================== */
function norm(s){
  return (s||"").toLowerCase().replaceAll("−","-").replaceAll(" ","").replaceAll("\t","").replaceAll("\n","");
}

function checkQ(){
  const q = QUESTIONS[current-1];
  markDone(q.n);
  saveNotes(q.n, notes.value);

  if(q.type==="drag"){
    const exp = expectedImagePoints(q);
    const got = window.__imgPts;
    let ok = true;
    for(const k in exp){
      const e=exp[k], g=got[k];
      if(!g || g[0]!==e[0] || g[1]!==e[1]) { ok=false; break; }
    }
    setStatus(ok ? "Correct ✓" : "Not correct yet ✗ (move the red points)", ok ? "ok" : "no");
    return;
  }

  if(q.type==="word"){
    const text = norm(notes.value);
    const keys = (q.keywords||[]).map(norm);
    const hit = keys.length ? keys.some(k=>text.includes(k)) : true;
    setStatus(hit ? "Looks correct ✓" : "Not sure / missing key idea ✗", hit ? "ok" : "no");
    return;
  }

  setStatus("Saved (teacher check).", "ok");
}

function showAnswer(){
  const q = QUESTIONS[current-1];
  markDone(q.n);

  if(q.type==="drag"){
    const exp = expectedImagePoints(q);
    for(const k in exp){
      window.__imgPts[k] = [...exp[k]];
      const gg=[...svg.querySelectorAll("g")].find(x=>x.getAttribute("data-name")===k);
      if(gg){
        const c=gg.querySelector("circle");
        const t=gg.querySelector("text");
        c.setAttribute("cx", xToSvg(exp[k][0]));
        c.setAttribute("cy", yToSvg(exp[k][1]));
        t.setAttribute("x", xToSvg(exp[k][0])+10);
        t.setAttribute("y", yToSvg(exp[k][1])-10);
      }
    }
    updateImagePolygon();
    setStatus("Answer shown (red points set).", "ok");
    return;
  }

  if(q.type==="word"){
    notes.value = (notes.value||"") + (notes.value ? "\n\n" : "") +
      "— ANSWER GUIDE —\n" +
      "State the mirror line clearly (e.g., x=3, y=-1, y=x+2), or the correct reflection rule.";
    saveNotes(q.n, notes.value);
    setStatus("Answer guide inserted into notes.", "ok");
    return;
  }

  setStatus("Open task — no single answer.", "muted");
}

/* ===========================
   Navigation / sidebar
   =========================== */
function renderSidebar(){
  qList.innerHTML="";
  for(let i=1;i<=QUESTIONS.length;i++){
    const b=document.createElement("div");
    b.className="qbtn";
    b.textContent=i;
    b.onclick=()=>goTo(i);
    if(i===current) b.classList.add("active");
    if(isDone(i)) b.classList.add("done");
    qList.appendChild(b);
  }
}

function goTo(n){
  current = n;
  renderSidebar();
  buildQuestionUI(QUESTIONS[current-1]);
}
function prevQ(){ if(current>1) goTo(current-1); }
function nextQ(){ if(current<QUESTIONS.length) goTo(current+1); }

/* ===========================
   Local save
   =========================== */
const STORE_KEY="g8_reflections_noPhotos_FIXED_v1";
function loadStore(){ try{return JSON.parse(localStorage.getItem(STORE_KEY)||"{}");}catch{return{};} }
function saveStore(obj){ localStorage.setItem(STORE_KEY, JSON.stringify(obj)); }
function loadNotes(n){ const st=loadStore(); return st["notes_"+n]||""; }
function saveNotes(n,val){ const st=loadStore(); st["notes_"+n]=val||""; saveStore(st); }
function markDone(n){ const st=loadStore(); st["done_"+n]=true; saveStore(st); renderSidebar(); }
function isDone(n){ const st=loadStore(); return !!st["done_"+n]; }
function resetAll(){ localStorage.removeItem(STORE_KEY); renderSidebar(); buildQuestionUI(QUESTIONS[current-1]); setStatus("Reset complete.","muted"); }
notes.addEventListener("input", ()=>saveNotes(current, notes.value));

/* init */
renderSidebar();
buildQuestionUI(QUESTIONS[0]);
</script>
</body>
</html>
