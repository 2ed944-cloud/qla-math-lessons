<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>G8 • Unit 2 • Angle Facts — Synchronized Diagrams Edition</title>

<!-- Fonts & Tailwind -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const run = (root = document.body) => {
      if (!window.renderMathInElement) return;
      window.renderMathInElement(root, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '\\[', right: '\\]', display: true },
          { left: '\\(', right: '\\)', display: false }
        ],
        throwOnError: false
      });
    };
    if (window.renderMathInElement) run();
    else {
      const t = setInterval(() => { if (window.renderMathInElement) { clearInterval(t); run(); } }, 25);
      setTimeout(() => clearInterval(t), 6000);
    }
    window._rerenderMath = run;
  });
</script>

<style>
  :root{--maroon:#6C1D45;--gold:#C7A34F;--dark:#2C2C2E;--light:#F5F5F5;--accent:#E8D5B7}
  html,body{height:100%;background:#2d3748;color:#111;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  #deck{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;padding:10px}
  #slides{position:relative;width:100%;max-width:1280px;aspect-ratio:16/9;background:#fff;box-shadow:0 14px 36px rgba(0,0,0,.35);overflow:hidden;border-radius:18px}
  .slide{position:absolute;inset:0;padding:3.5%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;opacity:0;transform:translateY(14px) scale(.985);transition:.55s ease;pointer-events:none}
  .slide.active{opacity:1;transform:none;pointer-events:auto}
  .bg-maroon{background-color:var(--maroon)} .text-maroon{color:var(--maroon)} .text-gold{color:var(--gold)}
  .banner{width:100%;height:120px;background:#fff center/contain no-repeat;border-bottom:3px solid var(--gold);border-radius:10px}
  .card{border:1px solid #e5e7eb;border-radius:14px;background:#fafafa}
  .chip{display:inline-flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.05);border-radius:9999px;padding:.35rem .75rem;cursor:pointer}
  .chip:hover{outline:2px solid var(--gold)}
  .pill{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #e5e7eb;border-radius:999px;padding:.35rem .75rem;background:#fff;cursor:pointer}
  .pill.active{border-color:#22c55e;box-shadow:0 0 0 2px rgba(34,197,94,.15)}
  .btn{padding:.55rem 1rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
  .btn.maroon{background:var(--maroon);color:#fff;border-color:var(--maroon)}
  .btn:hover{filter:brightness(0.98)}
  #controls{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.55);padding:.4rem .6rem;border-radius:999px;z-index:20;backdrop-filter:blur(6px)}
  #controls button{width:42px;height:42px;border-radius:999px;border:none;background:#fff;cursor:pointer;font-weight:700}
  #controls button:hover{transform:scale(1.06)}
  #counter{color:#fff;font-weight:700;min-width:84px;text-align:center}
  #progress{position:fixed;left:0;bottom:0;height:5px;width:0;background:var(--gold);z-index:30;transition:width .35s ease}
  #fsHint{position:absolute;top:10px;right:12px;color:#fff;background:rgba(0,0,0,.35);padding:.25rem .5rem;border-radius:8px;font-size:.8rem}

  #pop{position:fixed;inset:auto auto 20px 20px;max-width:min(560px,90vw);background:#fff;border:2px solid var(--gold);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.25);padding:14px 16px;z-index:40;display:none;text-align:left}
  #pop strong{color:var(--maroon)} #pop .close{float:right;color:#666;cursor:pointer;font-weight:800}

  .hint{background:#fff3cd;border:1px solid #ffe69c;border-radius:10px;padding:.5rem .75rem}
  .workline{padding:.25rem .5rem;border-left:4px solid var(--gold);margin:.3rem 0;background:#fff}
  .confetti{position:fixed;pointer-events:none;z-index:50}

  #partNav{position:fixed;top:18px;left:18px;z-index:35;display:flex;gap:.4rem;background:rgba(255,255,255,.85);padding:.35rem;border-radius:999px;border:2px solid var(--gold);backdrop-filter:blur(4px)}
  #partNav button{font-weight:800}

  /* SVG canvases */
  .miniWrap{display:grid;grid-template-columns:1fr;gap:.5rem}
  @media (min-width: 720px){ .miniWrap{grid-template-columns:360px 1fr} }
  .miniSvg{width:100%;height:230px;border:2px solid #ececec;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa)}
  .boardSvg{width:100%;max-width:760px;height:360px;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa);border:2px solid #ececec}
  .notScale{font-size:.72rem;fill:#6b7280}
  .tag{display:inline-block;font-size:.65rem;border:1px solid #e5e7eb;border-radius:999px;padding:.08rem .45rem;background:#fff;color:#374151}
</style>
</head>
<body>

<div id="deck" aria-live="polite">
  <div id="slides" class="relative">
    <div id="fsHint">Press <strong>F</strong> for fullscreen</div>

    <!-- 0 • Title -->
    <section class="slide active bg-maroon text-white">
      <div class="w-full h-16 banner mb-6 rounded-md" style="background-image:url('qla_banner.png')" aria-label="QLA Partner Banner"></div>
      <div class="flex items-center gap-8">
        <img src="qla_logo.png" alt="QLA Logo" class="h-24 w-auto" onerror="this.style.display='none'"/>
        <div class="text-left">
          <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight">Unit 2 — Geometry of Polygons</h1>
          <p class="text-gold text-2xl md:text-3xl mt-2 font-semibold">Angle Facts: Complementary, Supplementary, Vertical & Adjacent</p>
          <p class="mt-2 text-lg">Qatar Leadership Academy — Grade 8</p>
        </div>
      </div>
      <div class="absolute bottom-6 text-sm text-gray-100">Aligned to AERO 8.G foundations &amp; 8.EE connections.</div>
    </section>

    <!-- PART 1 -->
    <section class="slide" id="p1Intro">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 1 — Angle Vocabulary & Relationships</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P1)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Define and identify <strong>adjacent</strong>, <strong>vertical</strong>, <strong>complementary</strong>, <strong>supplementary</strong> angles and <strong>linear pairs</strong>.</li>
            <li>Use angle‑sum facts: \(90^\circ\), \(180^\circ\), and angles around a point \(360^\circ\).</li>
            <li>Classify angle pairs and find missing measures with accurate visual representations.</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords (tap for definitions)</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="adj">adjacent</span>
            <span class="chip" data-key="vert">vertical</span>
            <span class="chip" data-key="comp">complementary</span>
            <span class="chip" data-key="supp">supplementary</span>
            <span class="chip" data-key="lp">linear pair</span>
            <span class="chip" data-key="around">angles around a point</span>
          </div>
          <p class="text-xs text-gray-500 mt-3">Click a keyword to view a quick definition.</p>
        </div>
      </div>
    </section>

    <!-- Angle Builder -->
    <section class="slide" id="builderSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Angle Builder (Live & Accurate)</h2>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="flex flex-wrap items-center gap-3 mb-3 text-sm">
          <label class="pill">Angle \(A\): <input id="angA" type="range" min="5" max="175" value="40" class="w-56"> <b id="angALabel" class="ml-1">40°</b></label>
          <span class="pill">Complement: <b id="compOut">50°</b></span>
          <span class="pill">Supplement: <b id="suppOut">140°</b></span>
          <span class="pill">Linear‑pair partner: <b id="lpOut">140°</b></span>
          <span class="pill">Vertical to \(A\): <b id="vertOut">40°</b></span>
        </div>
        <svg id="angleSvg" viewBox="0 0 760 360" class="boardSvg" aria-label="Interactive angle canvas"></svg>
        <div class="hint mt-3 text-sm">Slider changes the **actual aperture** of the green arc. All outputs update from that value—no placeholders.</div>
      </div>
    </section>

    <!-- Classify -->
    <section class="slide" id="classifySlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Classify Angle Pairs (Diagrams match values)</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="clfLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="clfNew" class="btn">New set</button>
        <button id="clfCheck" class="btn maroon">Check</button>
        <button id="clfExportCSV" class="btn">Export CSV</button>
        <button id="clfExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="clfList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="clfFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- Missing -->
    <section class="slide" id="missSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Find the Missing Angle (Diagrams from exact data)</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="missLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="missNew" class="btn">New set</button>
        <button id="missCheck" class="btn maroon">Check</button>
        <button id="missExportCSV" class="btn">Export CSV</button>
        <button id="missExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="missList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="missFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- Real‑Life P1 -->
    <section class="slide" id="p1RealSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Part 1 Real‑Life Mini‑Tasks</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="p1RealLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="p1RealNew" class="btn">New set</button>
        <button id="p1RealCheck" class="btn maroon">Check</button>
        <button id="p1RealExportCSV" class="btn">Export CSV</button>
        <button id="p1RealExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="p1RealList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="p1RealFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- PART 2 -->
    <section class="slide" id="p2Intro">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 2 — Angle Equations & Solving (Synced Figures)</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P2)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Translate angle facts into equations (e.g., complementary \(\to x+y=90\)).</li>
            <li>Solve for unknowns in vertical, linear‑pair, complementary, and supplementary settings.</li>
            <li>Check solutions and ensure diagrams match the algebra.</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="equiv">equation</span>
            <span class="chip" data-key="subs">substitution</span>
            <span class="chip" data-key="check">reasonableness check</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Solve A -->
    <section class="slide" id="solveSlide1">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Solve for \(x\) — Set A</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="solALevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="solANew" class="btn">New set</button>
        <button id="solACheck" class="btn maroon">Check</button>
        <button id="solAReveal" class="btn">Reveal steps</button>
        <button id="solAExportCSV" class="btn">Export CSV</button>
        <button id="solAExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="solAList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="solAFb" class="mt-2 h-6 font-semibold"></div>
      <div id="solASteps" class="mt-2 text-sm"></div>
    </section>

    <!-- Solve B -->
    <section class="slide" id="solveSlide2">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Solve for \(x\) — Set B</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="solBLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="solBNew" class="btn">New set</button>
        <button id="solBCheck" class="btn maroon">Check</button>
        <button id="solBReveal" class="btn">Reveal steps</button>
        <button id="solBExportCSV" class="btn">Export CSV</button>
        <button id="solBExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="solBList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="solBFb" class="mt-2 h-6 font-semibold"></div>
      <div id="solBSteps" class="mt-2 text-sm"></div>
    </section>

    <!-- Real‑Life P2 -->
    <section class="slide" id="p2RealSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Part 2 Real‑Life Mini‑Tasks</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="p2RealLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="p2RealNew" class="btn">New set</button>
        <button id="p2RealCheck" class="btn maroon">Check</button>
        <button id="p2RealExportCSV" class="btn">Export CSV</button>
        <button id="p2RealExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="p2RealList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="p2RealFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- PART 3 -->
    <section class="slide" id="p3Intro">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 3 — Polygons: Interior & Exterior Angles</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P3)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Use \(S=(n-2)\cdot180^\circ\) to find interior angle sums.</li>
            <li>For regular polygons, compute one interior and one exterior angle; use exterior sum \(=360^\circ\).</li>
            <li>Find a missing interior angle given the rest, with labels that match the given data.</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="poly">polygon</span>
            <span class="chip" data-key="reg">regular polygon</span>
            <span class="chip" data-key="sum">interior sum</span>
            <span class="chip" data-key="ext">exterior angle</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Polygon Explorer -->
    <section class="slide" id="polySlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Polygon Explorer (Regular)</h2>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="flex items-center gap-3 mb-2">
          <label class="pill">Sides \(n\): <input id="polyN" type="range" min="3" max="12" value="6" class="w-56"> <b id="polyNLabel">6</b></label>
          <span class="pill">Interior Sum: <b id="polySum">720°</b></span>
          <span class="pill">Regular \(\\angle_{\\text{int}}\): <b id="polyInt">120°</b></span>
          <span class="pill">Regular \(\\angle_{\\text{ext}}\): <b id="polyExt">60°</b></span>
        </div>
        <svg id="polySvg" viewBox="0 0 640 320" class="miniSvg"></svg>
        <div class="hint text-sm">This polygon is truly regular for the chosen \(n\); the labeled exterior/interior values are exact.</div>
      </div>
    </section>

    <!-- Missing Interior -->
    <section class="slide" id="polyMissSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Find the Missing Interior Angle</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="pmLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy (n=3–5)</option>
          <option value="med">medium (n=5–7)</option>
          <option value="hard">hard (n=6–8)</option>
        </select>
        <button id="pmNew" class="btn">New set</button>
        <button id="pmCheck" class="btn maroon">Check</button>
        <button id="pmExportCSV" class="btn">Export CSV</button>
        <button id="pmExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="pmList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="pmFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- Exterior -->
    <section class="slide" id="extSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Exterior Angles & Number of Sides</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Mode:</span>
        <span id="exModeA" class="pill active">Given \(n\) → \(\\angle_{ext}\)</span>
        <span id="exModeB" class="pill">Given \(\\angle_{ext}\) → \(n\)</span>
        <button id="exNew" class="btn">New set</button>
        <button id="exCheck" class="btn maroon">Check</button>
        <button id="exExportCSV" class="btn">Export CSV</button>
        <button id="exExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="exList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="exFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- PART 4 -->
    <section class="slide" id="p4Intro">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 4 — Integrate: Angle Chases, Errors & Mixed</h2>
    </section>

    <!-- Angle Chase -->
    <section class="slide" id="chaseSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Angle Chase Playground (All values synced)</h2>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="flex items-center gap-3 mb-2">
          <span>Level:</span>
          <select id="acLevel" class="border rounded px-2 py-1">
            <option value="easy" selected>easy</option>
            <option value="med">medium</option>
            <option value="hard">hard</option>
          </select>
          <button id="acNew" class="btn">New set</button>
          <button id="acCheck" class="btn maroon">Check</button>
          <button id="acExportCSV" class="btn">Export CSV</button>
          <button id="acExportJSON" class="btn">Export JSON</button>
        </div>
        <div id="acList" class="grid md:grid-cols-2 gap-3"></div>
        <div id="acFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- Error Analysis -->
    <section class="slide" id="errSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Error Analysis (Diagrams reflect the claim)</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="errLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="errNew" class="btn">New example</button>
        <button id="errReveal" class="btn">Reveal correct work</button>
      </div>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="miniWrap">
          <svg id="errSvg" class="miniSvg" viewBox="0 0 360 230"></svg>
          <div>
            <div id="errBox" class="text-lg"></div>
            <div class="mt-2">
              <label class="mr-2"><input type="radio" name="errChoice" value="A"> Wrong definition/relation</label><br/>
              <label class="mr-2"><input type="radio" name="errChoice" value="B"> Incorrect equation setup</label><br/>
              <label class="mr-2"><input type="radio" name="errChoice" value="C"> Algebra/Arithmetic slip</label><br/>
              <label class="mr-2"><input type="radio" name="errChoice" value="D"> Polygon formula misuse</label>
            </div>
            <div class="mt-2 flex gap-2">
              <button id="errCheck" class="btn maroon">Check</button>
              <button id="errExportCSV" class="btn">Export CSV</button>
              <button id="errExportJSON" class="btn">Export JSON</button>
            </div>
            <div id="errFb" class="mt-2 h-6 font-semibold"></div>
            <div id="errRevealBox" class="mt-2 text-sm"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Mixed Review -->
    <section class="slide" id="mixSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Mixed Review Generator (Synced)</h2>
      <div class="card p-5 w-full max-w-3xl text-left">
        <div class="miniWrap">
          <svg id="mixSvg" class="miniSvg" viewBox="0 0 360 230"></svg>
          <div>
            <div class="flex items-center gap-3">
              <span>Level:</span>
              <select id="mixLevel" class="border rounded px-2 py-1">
                <option value="easy" selected>easy</option>
                <option value="med">medium</option>
                <option value="hard">hard</option>
              </select>
              <button id="mixNew" class="btn">New question</button>
            </div>
            <div class="mt-3 text-2xl">Task: <span id="mixQ" class="font-extrabold"></span></div>
            <div class="mt-2">
              <input id="mixAns" class="border rounded px-3 py-2 w-80" placeholder="e.g., supplementary; 54°; x=18; n=8">
              <button id="mixCheck" class="btn maroon">Check</button>
              <button id="mixHint" class="btn">Hint</button>
              <button id="mixExportCSV" class="btn">Export CSV</button>
              <button id="mixExportJSON" class="btn">Export JSON</button>
            </div>
            <div id="mixHintBox" class="mt-3 text-sm"></div>
            <div id="mixFb" class="mt-2 h-6 font-semibold"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Exit -->
    <section class="slide" id="exitSlide">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Exit Ticket</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">3–2–1 Reflect</h3>
          <ul class="list-disc list-inside">
            <li>3 angle facts you can use instantly</li>
            <li>2 algebra steps you must show when solving</li>
            <li>1 polygon insight that surprised you</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">Up Next</h3>
          <p>We will extend angle facts to parallel lines & transversals and similarity proofs.</p>
        </div>
      </div>
      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-[88%] h-[110px] banner rounded-md" style="background-image:url('qla_banner.png')"></div>
    </section>

  </div>
</div>

<!-- Controls -->
<div id="controls" role="group" aria-label="Slideshow controls">
  <button id="prev" title="Previous (←)">&laquo;</button>
  <button id="fs" title="Toggle Fullscreen (F)">⤢</button>
  <div id="counter">1 / 20</div>
  <button id="next" title="Next (→)">&raquo;</button>
</div>
<div id="progress"></div>

<!-- Part Navigator -->
<div id="partNav" aria-label="Part navigator" style="position:fixed;top:18px;left:18px;z-index:35;display:flex;gap:.4rem;background:rgba(255,255,255,.85);padding:.35rem;border-radius:999px;border:2px solid var(--gold);backdrop-filter:blur(4px)">
  <button id="navP1" class="btn">Part&nbsp;1</button>
  <button id="navP2" class="btn">Part&nbsp;2</button>
  <button id="navP3" class="btn">Part&nbsp;3</button>
  <button id="navP4" class="btn">Part&nbsp;4</button>
</div>

<!-- Glossary popover -->
<div id="pop" role="dialog" aria-modal="true" aria-live="polite">
  <span class="close" title="Close">✕</span>
  <div id="popBody"></div>
</div>

<script>
/* ============================================================
   CORE SHELL + UTILITIES
   ============================================================ */
(function(){
  const slides=[...document.querySelectorAll('.slide')];
  const prev=id('prev'), next=id('next'), counter=id('counter'), progress=id('progress'), fsBtn=id('fs');
  const deckTitle='G8_U2_Angle_Facts_Synced';
  let i=0;

  function show(k){
    i=(k+slides.length)%slides.length;
    slides.forEach((s,idx)=>s.classList.toggle('active',idx===i));
    counter.textContent=(i+1)+' / '+slides.length;
    progress.style.width=((i+1)/slides.length*100)+'%';
    renderMath(slides[i]);
    if(slides[i].id==='builderSlide') DiagramBoard.drawBuilder();
    if(slides[i].id==='polySlide') PolyExplorer.draw();
  }
  prev.addEventListener('click',()=>show(i-1));
  next.addEventListener('click',()=>show(i+1));
  document.addEventListener('keydown',e=>{
    if(e.key==='ArrowRight') show(i+1);
    if(e.key==='ArrowLeft') show(i-1);
    if(e.key.toLowerCase()==='f') toggleFS();
  });
  function toggleFS(){
    const el=id('slides');
    if(!document.fullscreenElement){(el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el);}
    else{(document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen).call(el);}
  }
  fsBtn.addEventListener('click',toggleFS);

  const partStarts=['p1Intro','p2Intro','p3Intro','p4Intro'];
  id('navP1').addEventListener('click',()=>goPart(0));
  id('navP2').addEventListener('click',()=>goPart(1));
  id('navP3').addEventListener('click',()=>goPart(2));
  id('navP4').addEventListener('click',()=>goPart(3));
  function goPart(idx){ const targetId=partStarts[idx]; const pos=slides.findIndex(s=>s.id===targetId); if(pos>=0) show(pos); }

  function id(x){return document.getElementById(x)}
  function renderMath(root=document){ if(window._rerenderMath) window._rerenderMath(root); }
  function confetti(x=window.innerWidth/2,y=window.innerHeight/2){
    for(let k=0;k<18;k++){
      const d=document.createElement('div'); d.className='confetti';
      d.style.left=x+'px'; d.style.top=y+'px'; d.style.width='8px'; d.style.height='8px';
      d.style.background=['#6C1D45','#C7A34F','#E8D5B7','#8a3d64'][k%4];
      document.body.appendChild(d);
      const dx=(Math.random()*2-1)*240, dy=(Math.random()*-1-0.3)*300, rot=Math.random()*720;
      d.animate([{transform:'translate(0,0) rotate(0deg)'},{transform:`translate(${dx}px,${dy}px) rotate(${rot}deg)`,opacity:0}],
                {duration:900+Math.random()*700,easing:'cubic-bezier(.2,.8,.2,1)'}).onfinish=()=>d.remove();
    }
  }
  function downloadJSON(filename, data){
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function downloadCSV(filename, rows){
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function choice(arr){ return arr[rand(0,arr.length-1)] }

  /* ---------- Glossary ---------- */
  const POP=id('pop'), POP_BODY=id('popBody');
  const GLOS={
    adj:'<strong>Adjacent</strong>: share a vertex and a side; interiors do not overlap.',
    vert:'<strong>Vertical (opposite) angles</strong>: formed by two intersecting lines; opposite angles are equal.',
    comp:'<strong>Complementary</strong>: two angles whose measures sum to \\(90^\\circ\\).',
    supp:'<strong>Supplementary</strong>: two angles whose measures sum to \\(180^\\circ\\).',
    lp:'<strong>Linear pair</strong>: adjacent angles forming a straight line (sum \\(180^\\circ\\)).',
    around:'<strong>Angles around a point</strong>: sum to \\(360^\\circ\\).',
    equiv:'<strong>Equation</strong>: an equality relating unknowns.',
    subs:'<strong>Substitution</strong>: replace a variable with an equivalent value/expression.',
    check:'<strong>Reasonableness check</strong>: verify solution fits geometry.',
    poly:'<strong>Polygon</strong>: closed figure with straight sides.',
    reg:'<strong>Regular polygon</strong>: all sides and interior angles equal.',
    sum:'<strong>Interior sum</strong>: \\(S=(n-2)\\cdot180^\\circ\\).',
    ext:'<strong>Exterior angle</strong>: for a regular \\(n\\)-gon, each exterior angle is \\(360^\\circ/n\\).'
  };
  function showPop(html,anchor){
    POP_BODY.innerHTML=html; POP.style.display='block';
    const r=anchor?anchor.getBoundingClientRect():{left:20,top:window.innerHeight-120};
    POP.style.left=Math.min(r.left, window.innerWidth-POP.offsetWidth-20)+'px';
    POP.style.bottom=(window.innerHeight - r.top + 10)+'px';
  }
  POP.querySelector('.close').addEventListener('click',()=>POP.style.display='none');
  document.addEventListener('click',e=>{
    const el=e.target.closest('.chip[data-key]'); if(el){const key=el.dataset.key; if(GLOS[key]) showPop(GLOS[key], el);}
  });

  /* ============================================================
     DIAGRAM ENGINE — SPEC‑DRIVEN, NO PLACEHOLDERS
     ============================================================ */
  const SVG = {
    el(tag, attrs={}){ const e=document.createElementNS('http://www.w3.org/2000/svg',tag); for(const k in attrs){ e.setAttribute(k, attrs[k]); } return e; },
    clear(s){ while(s.firstChild) s.removeChild(s.firstChild); },
    line(s,x1,y1,x2,y2,opt={}){ s.appendChild(SVG.el('line',{x1,y1,x2,y2,stroke:opt.stroke||'#374151','stroke-width':opt.w||2,'stroke-dasharray':opt.d||''})); },
    path(s,d,opt={}){ s.appendChild(SVG.el('path',{d,fill:opt.fill||'none',stroke:opt.stroke||'#6C1D45','stroke-width':opt.w||2,'stroke-dasharray':opt.d||''})); },
    text(s,x,y,str,opt={}){ const t=SVG.el('text',{x,y,'text-anchor':opt.anchor||'middle','font-size':opt.size||12,fill:opt.fill||'#111'}); t.textContent=str; s.appendChild(t); return t; },
    circle(s,cx,cy,r,opt={}){ s.appendChild(SVG.el('circle',{cx,cy,r,fill:opt.fill||'none',stroke:opt.stroke||'#374151','stroke-width':opt.w||2})); }
  };
  const deg2rad = d => d*Math.PI/180;
  const polar = (cx,cy,r,deg) => [cx + r*Math.cos(deg2rad(deg)), cy - r*Math.sin(deg2rad(deg))];
  function arcPath(cx,cy,r,a0,a1){
    const A0=deg2rad(a0), A1=deg2rad(a1);
    const x0=cx+r*Math.cos(A0), y0=cy-r*Math.sin(A0);
    const x1=cx+r*Math.cos(A1), y1=cy-r*Math.sin(A1);
    const large = (Math.abs(a1-a0)%360)>180 ? 1:0;
    const sweep = (a1>=a0)? 0:1;
    return `M${x0},${y0} A${r},${r} 0 ${large} ${sweep} ${x1},${y1}`;
  }
  function angleArc(s, cx,cy, r, a0,a1, col='#C7A34F', w=3, dash){ SVG.path(s, arcPath(cx,cy,r,a0,a1), {stroke:col, w, d:dash}); }
  function rightMarker(s, cx,cy, size, baseDeg){
    const a=deg2rad(baseDeg), dx=Math.cos(a), dy=Math.sin(a);
    const p1=[cx+10*dx, cy-10*dy];
    const p2=[p1[0]+size*(-dy), p1[1]-size*(-dx)];
    const p3=[p2[0]+size*(dx), p2[1]-size*(dy)];
    const p4=[p3[0]+size*(dy), p3[1]+size*(dx)];
    const d=`M${p1[0]},${p1[1]} L${p2[0]},${p2[1]} L${p3[0]},${p3[1]} L${p4[0]},${p4[1]} Z`;
    SVG.path(s,d,{fill:'#e5e7eb',stroke:'#9ca3af',w:1.5});
  }
  function tagNotToScale(s){ const t=SVG.el('text',{'font-size':10,fill:'#6b7280',x:10,y:16}); t.textContent='not to scale'; s.appendChild(t); }

  const Diagram = {
    /* Right corner: exact a and (90-a) */
    rightComplement(svg, {a, showUnknown=false}){
      SVG.clear(svg);
      const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
      const cx=W/2-8, cy=H/2+36;
      SVG.line(svg,cx,cy, cx+160,cy,{w:2.2});
      SVG.line(svg,cx,cy, cx,cy-160,{w:2.2});
      rightMarker(svg,cx,cy,14,0);
      const r=76;
      angleArc(svg,cx,cy,r,0,a,'#C7A34F',3);
      SVG.text(svg,cx+88*Math.cos(deg2rad(a/2)), cy-88*Math.sin(deg2rad(a/2)), `${a}°`,{fill:'#6C1D45'});
      const b=90-a, mid=a+(90-a)/2;
      angleArc(svg,cx,cy,r,a,90,'#f59e0b',3);
      SVG.text(svg,cx+86*Math.cos(deg2rad(mid)), cy-86*Math.sin(deg2rad(mid)), showUnknown?'?':`${b}°`,{});
    },
    /* Linear pair: exact a and (180-a) */
    linearPairExact(svg, {a, showUnknown=false}){
      SVG.clear(svg);
      const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
      const cx=W/2, cy=H/2+14;
      SVG.line(svg,cx-160,cy, cx+160,cy,{w:2.2});
      const [rx,ry]=polar(cx,cy,150,a);
      SVG.line(svg,cx,cy, rx,ry,{w:2.2});
      const r=72;
      angleArc(svg,cx,cy,r,0,a,'#C7A34F',3);
      SVG.text(svg,cx+84*Math.cos(deg2rad(a/2)), cy-84*Math.sin(deg2rad(a/2)), `${a}°`,{fill:'#6C1D45'});
      angleArc(svg,cx,cy,r,a,180,'#f59e0b',3);
      const b=180-a, mid=a+(180-a)/2;
      SVG.text(svg,cx+86*Math.cos(deg2rad(mid)), cy-86*Math.sin(deg2rad(mid)), showUnknown?'?':`${b}°`,{});
    },
    /* Vertical: exact equal apertures a and a opposite */
    verticalExact(svg, {a, showUnknown=false}){
      SVG.clear(svg);
      const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
      const cx=W/2, cy=H/2;
      SVG.line(svg,cx-160,cy, cx+160,cy,{w:2.2});
      const tilt=a; // ensure the marked angle has aperture a
      const [x1,y1]=polar(cx,cy,160,tilt), [x2,y2]=polar(cx,cy,160,tilt+180);
      SVG.line(svg,x1,y1,x2,y2,{w:2.2});
      const r=70;
      angleArc(svg,cx,cy,r,0,a,'#C7A34F',3);
      SVG.text(svg,cx+86*Math.cos(deg2rad(a/2)), cy-86*Math.sin(deg2rad(a/2)), `${a}°`,{fill:'#6C1D45'});
      angleArc(svg,cx,cy,r,180,180+a,'#f59e0b',3);
      SVG.text(svg,cx+84*Math.cos(deg2rad(180+a/2)), cy-84*Math.sin(deg2rad(180+a/2)), showUnknown?'?':`${a}°`,{});
    },
    /* Adjacent: two angles a and b sharing a side */
    adjacentExact(svg, {a,b}){
      SVG.clear(svg);
      const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
      const cx=W/2, cy=H/2+14;
      SVG.line(svg,cx-160,cy, cx+160,cy,{w:2.2});
      const r=70;
      angleArc(svg,cx,cy,r,0,a,'#C7A34F',3);
      SVG.text(svg,cx+84*Math.cos(deg2rad(a/2)), cy-84*Math.sin(deg2rad(a/2)), `${a}°`,{fill:'#6C1D45'});
      angleArc(svg,cx,cy,r,a,a+b,'#f59e0b',3);
      SVG.text(svg,cx+84*Math.cos(deg2rad(a+b/2)), cy-84*Math.sin(deg2rad(a+b/2)), `${b}°`,{});
      const [rx,ry]=polar(cx,cy,150,a);
      const [sx,sy]=polar(cx,cy,150,a+b);
      SVG.line(svg,cx,cy, rx,ry,{w:2.2}); SVG.line(svg,cx,cy, sx,sy,{w:2.2});
    },
    /* Around point: list of angles (some may be '?') shown consecutively */
    aroundPointExact(svg, {values, unknownIndex}){
      SVG.clear(svg);
      const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
      const cx=W/2, cy=H/2;
      const r=70; let start=-20;
      SVG.circle(svg,cx,cy,2,{fill:'#374151',stroke:'#374151'});
      values.forEach((v,idx)=>{
        const d = typeof v==='number'? v : v.value;
        angleArc(svg,cx,cy,r,start,start+d, idx===unknownIndex?'#ef4444':(idx%2?'#f59e0b':'#C7A34F'),3);
        const mid=start + d/2;
        const label = idx===unknownIndex? '?' : `${d}°`;
        SVG.text(svg,cx+(r+16)*Math.cos(deg2rad(mid)), cy-(r+16)*Math.sin(deg2rad(mid)), label,{});
        start+=d;
      });
    },
    /* Symbolic pairs (not to scale) */
    linearPairSymbolic(svg, {label1,label2}){
      SVG.clear(svg); tagNotToScale(svg);
      const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
      const cx=W/2, cy=H/2+14; const a=120; // arbitrary aperture for display only
      SVG.line(svg,cx-160,cy, cx+160,cy,{w:2.2});
      const [rx,ry]=polar(cx,cy,150,a); SVG.line(svg,cx,cy, rx,ry,{w:2.2});
      const r=70;
      angleArc(svg,cx,cy,r,0,a,'#C7A34F',3);
      SVG.text(svg,cx+84*Math.cos(deg2rad(a/2)), cy-84*Math.sin(deg2rad(a/2)), label1,{});
      angleArc(svg,cx,cy,r,a,180,'#f59e0b',3);
      SVG.text(svg,cx+86*Math.cos(deg2rad((a+180)/2)), cy-86*Math.sin(deg2rad((a+180)/2)), label2,{});
    },
    complementSymbolic(svg, {label1,label2}){
      SVG.clear(svg); tagNotToScale(svg);
      const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
      const cx=W/2-8, cy=H/2+36;
      SVG.line(svg,cx,cy, cx+160,cy,{w:2.2});
      SVG.line(svg,cx,cy, cx,cy-160,{w:2.2});
      rightMarker(svg,cx,cy,14,0);
      const r=76; const a=40;
      angleArc(svg,cx,cy,r,0,a,'#C7A34F',3);
      SVG.text(svg,cx+88*Math.cos(deg2rad(a/2)), cy-88*Math.sin(deg2rad(a/2)), label1,{});
      angleArc(svg,cx,cy,r,a,90,'#f59e0b',3);
      SVG.text(svg,cx+86*Math.cos(deg2rad(a+25)), cy-86*Math.sin(deg2rad(a+25)), label2,{});
    },
    verticalSymbolic(svg, {label1,label2}){
      SVG.clear(svg); tagNotToScale(svg);
      const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
      const cx=W/2, cy=H/2; SVG.line(svg,cx-160,cy,cx+160,cy,{w:2.2});
      SVG.line(svg,cx-120,cy-100,cx+120,cy+100,{w:2.2});
      const r=66;
      angleArc(svg,cx,cy,r,20,80,'#C7A34F',3);
      SVG.text(svg,cx+82*Math.cos(deg2rad(50)), cy-82*Math.sin(deg2rad(50)), label1,{});
      angleArc(svg,cx,cy,r,200,260,'#f59e0b',3);
      SVG.text(svg,cx+82*Math.cos(deg2rad(230)), cy-82*Math.sin(deg2rad(230)), label2,{});
    },
    /* Polygons */
    regularPolygon(svg, {n, labels=null, highlightIndex=-1}){
      SVG.clear(svg);
      const W=svg.viewBox.baseVal.width||640, H=svg.viewBox.baseVal.height||320;
      const cx=W/2, cy=H/2+4, R=Math.min(W,H)/3, rot=-90;
      const pts=[]; for(let k=0;k<n;k++){ pts.push(polar(cx,cy,R, rot+360*k/n)); }
      const d='M'+pts.map(p=>p[0]+','+p[1]).join(' L ')+' Z'; SVG.path(svg,d,{stroke:'#374151',w:2});
      for(let k=0;k<n;k++){
        const P=pts[k]; const a0=rot+360*(k-0.24)/n, a1=rot+360*(k+0.24)/n;
        angleArc(svg,P[0],P[1],22,a0,a1,'#C7A34F',2);
        let lab = labels? labels[k] : null;
        if(lab==null){ const intr=((n-2)*180/n).toFixed(0)+'°'; lab = (k===highlightIndex? '?' : intr); }
        SVG.text(svg, P[0]+28*Math.cos(deg2rad((a0+a1)/2)), P[1]-28*Math.sin(deg2rad((a0+a1)/2)), lab,{size:12});
      }
    },
    exteriorRegular(svg,{n, showValue=true, value=null}){
      SVG.clear(svg);
      const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
      const cx=W/2, cy=H/2+8, R=Math.min(W,H)/3, rot=-90;
      const pts=[]; for(let k=0;k<n;k++){ pts.push(polar(cx,cy,R, rot+360*k/n)); }
      SVG.path(svg,'M'+pts.map(p=>p[0]+','+p[1]).join(' L ')+' Z',{stroke:'#374151',w:2});
      const P0=pts[0], P1=pts[1], Pn=pts[n-1];
      const a0=Math.atan2(P0[1]-Pn[1],P0[0]-Pn[0])*180/Math.PI;
      const a1=Math.atan2(P1[1]-P0[1],P1[0]-P0[0])*180/Math.PI;
      const r=24; angleArc(svg,P0[0],P0[1],r,a0,a1,'#C7A34F',3);
      const mid=(a0+a1)/2; const ext=(360/n).toFixed(0)+'°';
      SVG.text(svg, P0[0]+36*Math.cos(deg2rad(mid)), P0[1]-36*Math.sin(deg2rad(mid)), showValue?(value??ext):'ext',{size:12});
    }
  };

  /* ============================================================
     BUILDER & EXPLORER
     ============================================================ */
  const DiagramBoard = (()=>{
    const angA=id('angA'), angALabel=id('angALabel'), compOut=id('compOut'), suppOut=id('suppOut'), lpOut=id('lpOut'), vertOut=id('vertOut'), svg=id('angleSvg');
    function drawBuilder(){
      const A=Number(angA.value);
      angALabel.textContent=A+'°';
      compOut.textContent=(90-A>0?(90-A)+'°':'—');
      const supp=180-A; suppOut.textContent=supp+'°'; lpOut.textContent=supp+'°'; vertOut.textContent=A+'°';
      Diagram.linearPairExact(svg,{a:A,showUnknown:false}); // base view shows A and its linear partner
    }
    angA.addEventListener('input',drawBuilder);
    return {drawBuilder};
  })();

  const PolyExplorer = (()=>{
    const polySvg=id('polySvg'), polyN=id('polyN'), polyNLabel=id('polyNLabel'), polySum=id('polySum'), polyInt=id('polyInt'), polyExt=id('polyExt');
    function draw(){
      const n=Number(polyN.value); polyNLabel.textContent=n;
      const S=(n-2)*180, ext=360/n, Int=S/n;
      polySum.textContent=S+'°'; polyInt.textContent=Int.toFixed(2).replace(/\.00$/,'')+'°'; polyExt.textContent=ext.toFixed(2).replace(/\.00$/,'')+'°';
      Diagram.regularPolygon(polySvg,{n});
    }
    polyN.addEventListener('input',draw);
    return {draw};
  })();

  /* ============================================================
     PART 1 — CLASSIFY & MISSING (SYNCED)
     ============================================================ */
  const TYPES=['complementary','supplementary','vertical','adjacent','linear pair','neither'];

  const Classify = (()=>{
    const state={items:[]};
    function buildPrompt(t, lv){
      if(t==='complementary'){ const a=rand(10,80), b=90-a; return {t,a,b, text:`Right corner split into <b>${a}°</b> and <b>${b}°</b>. Relationship?`,
        draw:(s)=>Diagram.rightComplement(s,{a,showUnknown:false})}; }
      if(t==='supplementary' || t==='linear pair'){ const a=rand(20,160), b=180-a; return {t:'linear pair',a,b,text:`Adjacent angles on a straight line: <b>${a}°</b> and <b>${b}°</b>. Relationship?`,
        draw:(s)=>Diagram.linearPairExact(s,{a,showUnknown:false})}; }
      if(t==='vertical'){ const a=rand(20,140); return {t,a,text:`Two lines intersect. Angle A is <b>${a}°</b>. Relationship between A and the opposite angle?`,
        draw:(s)=>Diagram.verticalExact(s,{a,showUnknown:false})}; }
      if(t==='adjacent'){ const a=rand(15,80), b=rand(10,80); return {t,a,b,text:`Two angles share a side at a point: <b>${a}°</b> and <b>${b}°</b>. Relationship?`,
        draw:(s)=>Diagram.adjacentExact(s,{a,b})}; }
      // neither — draw two disjoint angles with labels that are not 90/180/complements/supplements or vertical/adjacent
      const u=40, v=60;
      return {t:'neither',text:`Two separate angles of <b>${u}°</b> and <b>${v}°</b> (no shared sides, not opposite). Relationship?`,
        draw:(s)=>{ SVG.clear(s); const cx=180, cy=115; angleArc(s,cx-60,cy,48,0,u,'#C7A34F',3); SVG.text(s,cx-60+62*Math.cos(deg2rad(u/2)), cy-62*Math.sin(deg2rad(u/2)), `${u}°`,{}); angleArc(s,cx+60,cy,48,0,v,'#f59e0b',3); SVG.text(s,cx+60+62*Math.cos(deg2rad(v/2)), cy-62*Math.sin(deg2rad(v/2)), `${v}°`,{});} };
    }
    function newSet(){
      const lv=id('clfLevel').value; state.items=[]; const box=id('clfList'); box.innerHTML='';
      const k=(lv==='easy'?6:(lv==='med'?8:10));
      for(let i=0;i<k;i++){
        const t=choice(TYPES); const P=buildPrompt(t,lv); state.items.push(P);
        const row=document.createElement('div'); row.className='card p-4 text-left';
        row.innerHTML=`<div class="miniWrap">
          <svg id="clfSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
          <div>
            <div class="text-maroon font-semibold mb-1">Item ${i+1}</div>
            <div class="mb-2">${P.text}</div>
            <div class="flex flex-wrap gap-2 text-sm">
              ${TYPES.map(s=>`<label class="pill"><input type="radio" name="clf_${i}" value="${s}" class="mr-1">${s}</label>`).join('')}
            </div>
          </div></div>`;
        box.appendChild(row);
        P.draw(row.querySelector(`#clfSVG_${i}`));
      }
    }
    function check(){
      let ok=0;
      [...id('clfList').children].forEach((row,idx)=>{
        const sel=[...row.querySelectorAll('input[type="radio"]')].find(x=>x.checked)?.value||'';
        const want=state.items[idx].t;
        row.style.borderColor=(sel===want)?'#22c55e':'#ef4444'; if(sel===want) ok++;
      });
      id('clfFb').textContent= ok===state.items.length? '✅ All correct!' : `Score: ${ok}/${state.items.length}`;
      if(ok===state.items.length) confetti();
    }
    id('clfNew').addEventListener('click',newSet); newSet();
    id('clfCheck').addEventListener('click',check);
    id('clfExportCSV').addEventListener('click',()=>{
      const rows=[['prompt','correct','user']];
      [...id('clfList').children].forEach((row,idx)=>{
        const user=[...row.querySelectorAll('input[type="radio"]')].find(x=>x.checked)?.value||'';
        rows.push([row.querySelector('.text-maroon ~ div').innerText.trim(), state.items[idx].t, user]);
      });
      downloadCSV(`${deckTitle}_P1_classify.csv`, rows);
    });
    id('clfExportJSON').addEventListener('click',()=>{
      const data=[...id('clfList').children].map((row,idx)=>({prompt:row.querySelector('.text-maroon ~ div').innerText.trim(), correct:state.items[idx].t, user:[...row.querySelectorAll('input[type="radio"]')].find(x=>x.checked)?.value||''}));
      downloadJSON(`${deckTitle}_P1_classify.json`, data);
    });
  })();

  const Missing = (()=>{
    const state={items:[]};
    function make(kind){
      if(kind==='comp'){ const a=rand(10,80); return {kind, ans:90-a, draw:(s)=>Diagram.rightComplement(s,{a,showUnknown:true}), prompt:`Find the complement of <b>${a}°</b>.`}; }
      if(kind==='supp'){ const a=rand(25,170); return {kind, ans:180-a, draw:(s)=>Diagram.linearPairExact(s,{a,showUnknown:true}), prompt:`∠1 and ∠2 are a linear pair. If \(m∠1=${a}°\), find \(m∠2\).`}; }
      if(kind==='vert'){ const a=rand(15,165); return {kind, ans:a, draw:(s)=>Diagram.verticalExact(s,{a,showUnknown:true}), prompt:`Lines intersect. If \(m∠A=${a}°\), find the vertical angle \(m∠A'\).`}; }
      if(kind==='lp'){ const a=rand(25,155); return {kind, ans:180-a, draw:(s)=>Diagram.linearPairExact(s,{a,showUnknown:true}), prompt:`Adjacent ∠X and ∠Y form a straight line. If \(m∠X=${a}°\), find \(m∠Y\).`}; }
      // around
      const A=rand(40,140), B=rand(30,120), C=rand(30,110), D=360-(A+B+C);
      return {kind:'around', ans:D, draw:(s)=>Diagram.aroundPointExact(s,{values:[A,B,C,D], unknownIndex:3}), prompt:`Angles around a point: ${A}°, ${B}°, ${C}°, and ∠?. Find ∠?.`};
    }
    function newSet(){
      const lv=id('missLevel').value; state.items=[]; const box=id('missList'); box.innerHTML='';
      const k=(lv==='easy'?6:(lv==='med'?8:10));
      const kinds=['comp','supp','vert','lp','around'];
      for(let i=0;i<k;i++){
        const K=choice(kinds); const P=make(K); state.items.push(P);
        const row=document.createElement('div'); row.className='card p-4 text-left';
        row.innerHTML=`<div class="miniWrap">
          <svg id="missSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
          <div>
            <div class="font-semibold text-maroon mb-1">Item ${i+1}</div>
            <div class="mb-2">${P.prompt}</div>
            <div>Answer: <input class="minp border rounded px-2 py-1 w-24"> °</div>
          </div></div>`;
        box.appendChild(row);
        P.draw(row.querySelector(`#missSVG_${i}`));
      }
    }
    function check(){
      let ok=0; [...id('missList').children].forEach((row,idx)=>{
        const v=Number(row.querySelector('.minp').value); const want=state.items[idx].ans;
        row.style.borderColor=(Math.abs(v-want)<1e-10)?'#22c55e':'#ef4444'; if(Math.abs(v-want)<1e-10) ok++;
      });
      id('missFb').textContent= ok===state.items.length? '✅ Great!' : `Score: ${ok}/${state.items.length}`;
      if(ok===state.items.length) confetti();
    }
    id('missNew').addEventListener('click',newSet); newSet();
    id('missCheck').addEventListener('click',check);
    id('missExportCSV').addEventListener('click',()=>{
      const rows=[['prompt','answer','user']]; [...id('missList').children].forEach((row,idx)=>rows.push([row.querySelector('.font-semibold ~ div').innerText.trim(), state.items[idx].ans, row.querySelector('.minp').value||'']));
      downloadCSV(`${deckTitle}_P1_missing.csv`, rows);
    });
    id('missExportJSON').addEventListener('click',()=>{
      const data=[...id('missList').children].map((row,idx)=>({prompt:row.querySelector('.font-semibold ~ div').innerText.trim(), answer:state.items[idx].ans, user:row.querySelector('.minp').value||''}));
      downloadJSON(`${deckTitle}_P1_missing.json`, data);
    });
  })();

  /* Real‑Life P1 (synced) */
  const RealP1 = (()=>{
    const state={items:[]};
    function addRow(box,prompt,unit,drawFn,ans){
      const idx=box.children.length;
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="miniWrap">
        <svg id="p1RSVG_${idx}" class="miniSvg" viewBox="0 0 360 230"></svg>
        <div><div class="text-left">${prompt}</div>
        <div class="mt-2">Answer: <input class="rin border rounded px-2 py-1 w-28"> ${unit||''}</div></div></div>`;
      box.appendChild(row); drawFn(row.querySelector(`#p1RSVG_${idx}`)); state.items.push({ans});
    }
    function newSet(){
      state.items=[]; const box=id('p1RealList'); box.innerHTML='';
      const a=rand(20,70); addRow(box,`Frame corner is right angle. One miter is <b>${a}°</b> from the edge. Other cut?`,'°',(s)=>Diagram.rightComplement(s,{a,showUnknown:true}), 90-a);
      const d=rand(35,85); addRow(box,`Door opened to <b>${d}°</b>. How many more degrees to reach 90°?`,'°',(s)=>Diagram.rightComplement(s,{a:d,showUnknown:true}), 90-d);
      const b=rand(30,150); addRow(box,`Support makes <b>${b}°</b> with the wall; bracket forms a straight line with it. Bracket’s angle?`,'°',(s)=>Diagram.linearPairExact(s,{a:b,showUnknown:true}), 180-b);
      const A=rand(60,150), B=rand(40,120), C=rand(30,110); const rem=360-(A+B+C);
      addRow(box,`Spotlights around a center: ${A}°, ${B}°, ${C}°, and ◻︎. Find ◻︎.`,'°',(s)=>Diagram.aroundPointExact(s,{values:[A,B,C,rem],unknownIndex:3}), rem);
    }
    function check(){
      let ok=0; [...id('p1RealList').querySelectorAll('.rin')].forEach((el,idx)=>{
        const got=Number(el.value); const want=state.items[idx].ans; el.style.borderColor=(Math.abs(got-want)<1e-10)?'#22c55e':'#ef4444'; if(Math.abs(got-want)<1e-10) ok++;
      });
      id('p1RealFb').textContent= ok===state.items.length? '✅ Excellent!' : `Score: ${ok}/${state.items.length}`;
      if(ok===state.items.length) confetti();
    }
    id('p1RealNew').addEventListener('click',newSet); newSet();
    id('p1RealCheck').addEventListener('click',check);
    id('p1RealExportCSV').addEventListener('click',()=>{
      const rows=[['prompt','answer','user']]; [...id('p1RealList').children].forEach((row,idx)=>rows.push([row.querySelector('.text-left').innerText.trim(), state.items[idx].ans, row.querySelector('.rin').value||'']));
      downloadCSV(`${deckTitle}_P1_real.csv`, rows);
    });
    id('p1RealExportJSON').addEventListener('click',()=>{
      const data=[...id('p1RealList').children].map((row,idx)=>({prompt:row.querySelector('.text-left').innerText.trim(), answer:state.items[idx].ans, user:row.querySelector('.rin').value||''}));
      downloadJSON(`${deckTitle}_P1_real.json`, data);
    });
  })();

  /* ============================================================
     PART 2 — SOLVERS (SYNCED)
     ============================================================ */
  function solveCompSupp(type, lv){
    const target=(type==='comp'?90:180);
    for(let g=0; g<400; g++){
      const a1=rand(1,4), b1=rand(0,30), a2=rand(1,4), b2=rand(0,30);
      const A=a1+a2, B=b1+b2, rhs=target-B;
      if(A!==0 && rhs%A===0){ const x=rhs/A; if(x>0 && x<= (lv==='hard'?60:50)) return {type, a1,b1,a2,b2,x,target}; }
    }
    return solveCompSupp(type, lv);
  }
  function solveVertical(lv){
    for(let g=0; g<400; g++){
      const a1=rand(1,4), b1=rand(0,40), a2=rand(1,4), b2=rand(0,40);
      const num=b2-b1, den=a1-a2;
      if(den!==0 && num%den===0){ const x=num/den; if(x>0 && x<= (lv==='hard'?60:50)) return {type:'vert',a1,b1,a2,b2,x}; }
    }
    return solveVertical(lv);
  }
  function exprVal(a,b,x){ return a*x+b; }

  function buildSolveSet(containerId, levelSelId, state){
    const lv=id(levelSelId).value; const box=id(containerId); box.innerHTML=''; state.items=[];
    const kinds=['comp','supp','vert','lp']; // lp treated like supp to 180
    for(let i=0;i<4;i++){
      let P = (kinds[i]==='vert') ? solveVertical(lv) :
              (kinds[i]==='lp')   ? solveCompSupp('supp',lv) :
                                    solveCompSupp(kinds[i],lv);
      state.items.push(P);
      const title = (P.type==='comp'?'Complementary (sum 90°)': (P.type==='supp'?'Supplementary / Linear Pair (sum 180°)': 'Vertical (equal)'));
      const rel = (P.type==='vert'? `\\( ${P.a1}x+${P.b1} = ${P.a2}x+${P.b2} \\)` : `\\( (${P.a1}x+${P.b1}) + (${P.a2}x+${P.b2}) = ${P.target} \\)`);
      const row=document.createElement('div'); row.className='card p-4 text-left';
      row.innerHTML=`<div class="miniWrap">
        <svg id="${containerId}_svg_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
        <div>
          <div class="text-maroon font-semibold mb-1">${title} <span class="tag">diagram</span></div>
          <div class="mb-2">Equation: ${rel}</div>
          <div>Solution: \(x=\) <input class="xin border rounded px-2 py-1 w-20">
               &nbsp; ∠1 = <input class="a1in border rounded px-2 py-1 w-20">° &nbsp; ∠2 = <input class="a2in border rounded px-2 py-1 w-20">°</div>
        </div></div>`;
      box.appendChild(row); renderMath(row);
      const s=row.querySelector(`#${containerId}_svg_${i}`);
      if(P.type==='vert'){
        Diagram.verticalSymbolic(s,{label1:`${P.a1}x+${P.b1}°`, label2:`${P.a2}x+${P.b2}°`});
      } else if(P.type==='comp'){
        Diagram.complementSymbolic(s,{label1:`${P.a1}x+${P.b1}°`, label2:`${P.a2}x+${P.b2}°`});
      } else { // supp/lp
        Diagram.linearPairSymbolic(s,{label1:`${P.a1}x+${P.b1}°`, label2:`${P.a2}x+${P.b2}°`});
      }
    }
  }
  function checkSolve(containerId, state, fbId){
    let ok=0; const box=id(containerId);
    [...box.children].forEach((row,idx)=>{
      const P=state.items[idx], x=Number(row.querySelector('.xin').value);
      const wantX=P.x, want1=exprVal(P.a1,P.b1,wantX), want2=exprVal(P.a2,P.b2,wantX);
      const goodX=Math.abs(x-wantX)<1e-10;
      const good1=Math.abs(Number(row.querySelector('.a1in').value)-want1)<1e-10;
      const good2=Math.abs(Number(row.querySelector('.a2in').value)-want2)<1e-10;
      row.style.borderColor=(goodX&&good1&&good2)?'#22c55e':'#ef4444'; if(goodX&&good1&&good2) ok++;
    });
    id(fbId).textContent= ok===state.items.length? '✅ All correct!' : `Score: ${ok}/${state.items.length}`;
    if(ok===state.items.length) confetti();
  }
  function revealSolveSteps(state, stepsId){
    const wrap=id(stepsId); wrap.innerHTML='';
    state.items.forEach((P,idx)=>{
      if(P.type==='vert'){
        wrap.insertAdjacentHTML('beforeend', `<div class="workline">${idx+1}) \\(${P.a1}x+${P.b1} = ${P.a2}x+${P.b2}\\) → \\(${P.a1-P.a2}x=${P.b2-P.b1}\\) → \\(x=${P.x}\\).</div>`);
      } else {
        const A=P.a1+P.a2, B=P.b1+P.b2, S=P.target;
        wrap.insertAdjacentHTML('beforeend', `<div class="workline">${idx+1}) \\((${P.a1}x+${P.b1})+(${P.a2}x+${P.b2})=${S}\\) → \\(${A}x+${B}=${S}\\) → \\(${A}x=${S-B}\\) → \\(x=${P.x}\\).</div>`);
      }
    });
    renderMath(wrap);
  }

  const SolveA = {state:{items:[]}};
  const SolveB = {state:{items:[]}};
  id('solANew').addEventListener('click',()=>buildSolveSet('solAList','solALevel',SolveA.state)); buildSolveSet('solAList','solALevel',SolveA.state);
  id('solBNew').addEventListener('click',()=>buildSolveSet('solBList','solBLevel',SolveB.state)); buildSolveSet('solBList','solBLevel',SolveB.state);
  id('solACheck').addEventListener('click',()=>checkSolve('solAList',SolveA.state,'solAFb'));
  id('solBCheck').addEventListener('click',()=>checkSolve('solBList',SolveB.state,'solBFb'));
  id('solAReveal').addEventListener('click',()=>revealSolveSteps(SolveA.state,'solASteps'));
  id('solBReveal').addEventListener('click',()=>revealSolveSteps(SolveB.state,'solBSteps'));
  id('solAExportCSV').addEventListener('click',()=>exportSolve(SolveA.state,'solAList','solveA'));
  id('solAExportJSON').addEventListener('click',()=>exportSolveJSON(SolveA.state,'solAList','solveA'));
  id('solBExportCSV').addEventListener('click',()=>exportSolve(SolveB.state,'solBList','solveB'));
  id('solBExportJSON').addEventListener('click',()=>exportSolveJSON(SolveB.state,'solBList','solveB'));
  function exportSolve(state, boxId, base){
    const rows=[['type','expr1','expr2','target/equality','x','a1','a2','user_x','user_a1','user_a2']];
    const box=id(boxId);
    [...box.children].forEach((row,idx)=>{
      const P=state.items[idx];
      rows.push([P.type, `${P.a1}x+${P.b1}`, `${P.a2}x+${P.b2}`, (P.type==='vert'?'=':P.target), P.x, exprVal(P.a1,P.b1,P.x), exprVal(P.a2,P.b2,P.x),
                 row.querySelector('.xin').value||'', row.querySelector('.a1in').value||'', row.querySelector('.a2in').value||'']);
    });
    downloadCSV(`${deckTitle}_${base}.csv`, rows);
  }
  function exportSolveJSON(state, boxId, base){
    const data=[...id(boxId).children].map((row,idx)=>{
      const P=state.items[idx];
      return {type:P.type, expr1:`${P.a1}x+${P.b1}`, expr2:`${P.a2}x+${P.b2}`, target:(P.type==='vert'?null:P.target),
        solution:{x:P.x, a1:exprVal(P.a1,P.b1,P.x), a2:exprVal(P.a2,P.b2,P.x)},
        user:{x:row.querySelector('.xin').value||'', a1:row.querySelector('.a1in').value||'', a2:row.querySelector('.a2in').value||''}};
    });
    downloadJSON(`${deckTitle}_${base}.json`, data);
  }

  /* Real‑Life P2 */
  const RealP2 = (()=>{
    const state={items:[]};
    function addRow(box,prompt,unit,drawFn,ans){
      const idx=box.children.length;
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="miniWrap">
        <svg id="p2RSVG_${idx}" class="miniSvg" viewBox="0 0 360 230"></svg>
        <div><div class="text-left">${prompt}</div>
        <div class="mt-2">Answer: <input class="rin border rounded px-2 py-1 w-28"> ${unit||''}</div></div></div>`;
      box.appendChild(row); drawFn(row.querySelector(`#p2RSVG_${idx}`)); state.items.push({ans});
    }
    function newSet(){
      state.items=[]; const box=id('p2RealList'); box.innerHTML='';
      // Builder hinge to 90°, etc.
      const open=rand(20,85); addRow(box,`A hinge must open to 90°. It is currently at <b>${open}°</b>. Required additional rotation?`,'°',(s)=>Diagram.rightComplement(s,{a:open,showUnknown:true}),90-open);
      // Two supports forming linear pair
      const a=rand(40,150); addRow(box,`Two structural members form a straight line. One makes <b>${a}°</b> with the beam. What is the other?`,'°',(s)=>Diagram.linearPairExact(s,{a,showUnknown:true}),180-a);
    }
    function check(){
      let ok=0; [...id('p2RealList').querySelectorAll('.rin')].forEach((el,idx)=>{
        const got=Number(el.value); const want=state.items[idx].ans; el.style.borderColor=(Math.abs(got-want)<1e-10)?'#22c55e':'#ef4444'; if(Math.abs(got-want)<1e-10) ok++;
      });
      id('p2RealFb').textContent= ok===state.items.length? '✅ Nicely reasoned.' : `Score: ${ok}/${state.items.length}`;
      if(ok===state.items.length) confetti();
    }
    id('p2RealNew').addEventListener('click',newSet); newSet();
    id('p2RealCheck').addEventListener('click',check);
    id('p2RealExportCSV').addEventListener('click',()=>{
      const rows=[['prompt','answer','user']]; [...id('p2RealList').children].forEach((row,idx)=>rows.push([row.querySelector('.text-left').innerText.trim(), state.items[idx].ans, row.querySelector('.rin').value||'']));
      downloadCSV(`${deckTitle}_P2_real.csv`, rows);
    });
    id('p2RealExportJSON').addEventListener('click',()=>{
      const data=[...id('p2RealList').children].map((row,idx)=>({prompt:row.querySelector('.text-left').innerText.trim(), answer:state.items[idx].ans, user:row.querySelector('.rin').value||''}));
      downloadJSON(`${deckTitle}_P2_real.json`, data);
    });
  })();

  /* ============================================================
     PART 3 — POLYGONS (SYNCED)
     ============================================================ */
  const PolyMissing = (()=>{
    const state={items:[]};
    function randomAngles(n){
      const S=(n-2)*180;
      const arr=[]; let remain=S;
      for(let i=0;i<n-1;i++){
        const min=40, max=Math.min(160, remain - 40*(n-1-i));
        const v=rand(min,Math.max(min,max)); arr.push(v); remain-=v;
      }
      arr.push(remain);
      return arr;
    }
    function newSet(){
      const lv=id('pmLevel').value; const n=(lv==='easy'? rand(3,5): (lv==='med'? rand(5,7): rand(6,8)));
      state.items=[]; const box=id('pmList'); box.innerHTML='';
      for(let i=0;i<4;i++){
        const angles=randomAngles(n); const miss=rand(0,n-1); const ans=angles[miss];
        const labels=angles.map((v,k)=> k===miss? '?': (v+''));
        const row=document.createElement('div'); row.className='card p-4 text-left';
        row.innerHTML=`<div class="miniWrap">
          <svg id="pmSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
          <div>
            <div class="text-maroon font-semibold mb-1">n=${n}</div>
            <div class="mb-2">Interior angles shown; one is missing. Find it.</div>
            <div>Answer: <input class="pmIn border rounded px-2 py-1 w-28"> °</div>
          </div></div>`;
        box.appendChild(row);
        // use not-to-scale polygon with labels at vertices
        Diagram.regularPolygon(row.querySelector(`#pmSVG_${i}`),{n, labels, highlightIndex:miss});
        state.items.push({ans});
      }
    }
    function check(){
      let ok=0; [...id('pmList').children].forEach((row,idx)=>{
        const got=Number(row.querySelector('.pmIn').value), want=state.items[idx].ans;
        row.style.borderColor=(Math.abs(got-want)<1e-10)?'#22c55e':'#ef4444'; if(Math.abs(got-want)<1e-10) ok++;
      });
      id('pmFb').textContent= ok===state.items.length? '✅ Nice!' : `Score: ${ok}/${state.items.length}`;
      if(ok===state.items.length) confetti();
    }
    id('pmNew').addEventListener('click',newSet); newSet();
    id('pmCheck').addEventListener('click',check);
    id('pmExportCSV').addEventListener('click',()=>{
      const rows=[['answer','user']]; [...id('pmList').children].forEach((row,idx)=>rows.push([state.items[idx].ans, row.querySelector('.pmIn').value||'']));
      downloadCSV(`${deckTitle}_P3_missing_interior.csv`, rows);
    });
    id('pmExportJSON').addEventListener('click',()=>{
      const data=[...id('pmList').children].map((row,idx)=>({answer:state.items[idx].ans, user:row.querySelector('.pmIn').value||''}));
      downloadJSON(`${deckTitle}_P3_missing_interior.json`, data);
    });
  })();

  const Exterior = (()=>{
    const state={mode:'A', items:[]};
    id('exModeA').addEventListener('click',()=>{ state.mode='A'; id('exModeA').classList.add('active'); id('exModeB').classList.remove('active'); });
    id('exModeB').addEventListener('click',()=>{ state.mode='B'; id('exModeB').classList.add('active'); id('exModeA').classList.remove('active'); });
    function newSet(){
      const mode=state.mode; const box=id('exList'); box.innerHTML=''; state.items=[];
      for(let i=0;i<6;i++){
        if(mode==='A'){
          const n=rand(3,12), ans=360/n;
          const row=document.createElement('div'); row.className='card p-4 text-left';
          row.innerHTML=`<div class="miniWrap">
            <svg id="exSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
            <div>Regular polygon with <b>${n}</b> sides. Exterior angle = <input class="exIn border rounded px-2 py-1 w-24"> °</div>
          </div>`;
          box.appendChild(row); Diagram.exteriorRegular(row.querySelector(`#exSVG_${i}`),{n,showValue:false});
          state.items.push({ans});
        } else {
          const n=choice([3,4,5,6,8,9,10,12]), ext=360/n;
          const row=document.createElement('div'); row.className='card p-4 text-left';
          row.innerHTML=`<div class="miniWrap">
            <svg id="exSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
            <div>Regular polygon with exterior angle <b>${ext}°</b>. Number of sides n = <input class="exIn border rounded px-2 py-1 w-24"></div>
          </div>`;
          box.appendChild(row); Diagram.exteriorRegular(row.querySelector(`#exSVG_${i}`),{n,showValue:true,value:ext});
          state.items.push({ans:n});
        }
      }
    }
    function check(){
      let ok=0; [...id('exList').children].forEach((row,idx)=>{
        const got=Number(row.querySelector('.exIn').value); const want=state.items[idx].ans;
        row.style.borderColor=(Math.abs(got-want)<1e-10)?'#22c55e':'#ef4444'; if(Math.abs(got-want)<1e-10) ok++;
      });
      id('exFb').textContent= ok===state.items.length? '✅ Perfect.' : `Score: ${ok}/${state.items.length}`;
      if(ok===state.items.length) confetti();
    }
    id('exNew').addEventListener('click',newSet); newSet();
    id('exCheck').addEventListener('click',check);
    id('exExportCSV').addEventListener('click',()=>{
      const rows=[['answer','user']]; [...id('exList').children].forEach((row,idx)=>rows.push([state.items[idx].ans, row.querySelector('.exIn').value||'']));
      downloadCSV(`${deckTitle}_P3_exterior.csv`, rows);
    });
    id('exExportJSON').addEventListener('click',()=>{
      const data=[...id('exList').children].map((row,idx)=>({answer:state.items[idx].ans, user:row.querySelector('.exIn').value||''}));
      downloadJSON(`${deckTitle}_P3_exterior.json`, data);
    });
  })();

  /* ============================================================
     PART 4 — CHASE, ERROR, MIXED (SYNCED)
     ============================================================ */
  const Chase = (()=>{
    const state={items:[]};
    function cross(){
      const a=rand(25,140);
      return {ans:a, draw:(s)=>Diagram.verticalExact(s,{a,showUnknown:true}), prompt:`Two lines intersect. One angle is <b>${a}°</b>. Find the vertical angle.`};
    }
    function line(){
      const a=rand(25,155); return {ans:180-a, draw:(s)=>Diagram.linearPairExact(s,{a,showUnknown:true}), prompt:`∠A and ∠B form a linear pair. If \(m∠A=${a}°\), find \(m∠B\).`};
    }
    function around(){
      const A=rand(40,140), B=rand(30,120), C=rand(30,110), D=360-(A+B+C);
      return {ans:D, draw:(s)=>Diagram.aroundPointExact(s,{values:[A,B,C,D],unknownIndex:3}), prompt:`Around a point: ${A}°, ${B}°, ${C}°, and ◻︎. Find ◻︎.`};
    }
    function newSet(){
      const lv=id('acLevel').value; const box=id('acList'); box.innerHTML=''; state.items=[];
      const builders=[cross,line,around];
      for(let i=0;i<(lv==='easy'?6:(lv==='med'?8:10)); i++){
        const prob=choice(builders)(); state.items.push(prob);
        const row=document.createElement('div'); row.className='card p-4 text-left';
        row.innerHTML=`<div class="miniWrap">
          <svg id="acSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
          <div>
            <div class="text-maroon font-semibold mb-1">Item ${i+1}</div>
            <div class="mb-2">${prob.prompt}</div>
            <div>Answer: <input class="acIn border rounded px-2 py-1 w-24"> °</div>
          </div></div>`;
        box.appendChild(row); prob.draw(row.querySelector(`#acSVG_${i}`));
      }
    }
    function check(){
      let ok=0; [...id('acList').children].forEach((row,idx)=>{
        const got=Number(row.querySelector('.acIn').value); const want=state.items[idx].ans;
        row.style.borderColor=(Math.abs(got-want)<1e-10)?'#22c55e':'#ef4444'; if(Math.abs(got-want)<1e-10) ok++;
      });
      id('acFb').textContent= ok===state.items.length? '✅ Angle chase mastered!' : `Score: ${ok}/${state.items.length}`;
      if(ok===state.items.length) confetti();
    }
    id('acNew').addEventListener('click',newSet); newSet();
    id('acCheck').addEventListener('click',check);
    id('acExportCSV').addEventListener('click',()=>{
      const rows=[['prompt','answer','user']]; [...id('acList').children].forEach((row,idx)=>rows.push([row.querySelector('.text-maroon ~ div').innerText.trim(), state.items[idx].ans, row.querySelector('.acIn').value||'']));
      downloadCSV(`${deckTitle}_P4_chase.csv`, rows);
    });
    id('acExportJSON').addEventListener('click',()=>{
      const data=[...id('acList').children].map((row,idx)=>({prompt:row.querySelector('.text-maroon ~ div').innerText.trim(), answer:state.items[idx].ans, user:row.querySelector('.acIn').value||''}));
      downloadJSON(`${deckTitle}_P4_chase.json`, data);
    });
  })();

  const ErrorAnalysis = (()=>{
    const bank = {
      easy:[
        {work:'“Vertical angles add to 180°.”', key:'A', explain:'Vertical angles are equal, not necessarily supplementary.', fig:(s)=>Diagram.verticalExact(s,{a:60,showUnknown:false})},
        {work:'Complementary: \\(x+(2x+30)=180\\).', key:'B', explain:'Complementary sum is 90°, not 180°.', fig:(s)=>Diagram.rightComplement(s,{a:35,showUnknown:true})},
        {work:'\\(3x+12=2x+32\\) ⇒ \\(x=44\\).', key:'C', explain:'Subtract \(2x\): \(x+12=32→x=20\).', fig:(s)=>Diagram.verticalSymbolic(s,{label1:'3x+12°',label2:'2x+32°'})},
        {work:'Pentagon interior sum is \\((n-1)\\cdot180\\).', key:'D', explain:'Use \\((n-2)\\cdot180\\). For \(n=5\): 540°.', fig:(s)=>Diagram.regularPolygon(s,{n:5})}
      ],
      med:[
        {work:'Adjacent angles that sum to 180° are complementary.', key:'A', explain:'They are supplementary; complementary sum to 90°.', fig:(s)=>Diagram.linearPairExact(s,{a:110,showUnknown:false})},
        {work:'Linear pair: \\((4x+10)+(x+20)=90\\).', key:'B', explain:'Linear pair sums to 180°, not 90°.', fig:(s)=>Diagram.linearPairSymbolic(s,{label1:'4x+10°',label2:'x+20°'})},
        {work:'If \(2x+15=2x+5\), then \(x=10\).', key:'C', explain:'Subtract \(2x\): \(15=5\) → no solution.', fig:(s)=>Diagram.verticalSymbolic(s,{label1:'2x+15°',label2:'2x+5°'})},
        {work:'Regular nonagon exterior angle is 20°.', key:'D', explain:'Exterior \(=360/9=40°\).', fig:(s)=>Diagram.exteriorRegular(s,{n:9,showValue:true,value:40})}
      ],
      hard:[
        {work:'Around a point: \(x+(x+30)+(2x-20)=180\\).', key:'B', explain:'Around a point totals 360°, not 180°.', fig:(s)=>Diagram.aroundPointExact(s,{values:[60,90,80,130],unknownIndex:-1})},
        {work:'“Complementary angles must be adjacent.”', key:'A', explain:'Only the sum matters; adjacency not required.', fig:(s)=>Diagram.rightComplement(s,{a:50,showUnknown:true})},
        {work:'From \\((3x+5)+(4x+25)=180\\) ⇒ \(7x=180\\).', key:'C', explain:'Forgot constants: \(7x+30=180→x=150/7\\).', fig:(s)=>Diagram.linearPairSymbolic(s,{label1:'3x+5°',label2:'4x+25°'})},
        {work:'Regular polygon has interior angle \(=200°\\). Then \(n=9\\).', key:'D', explain:'Interior \(=180-360/n\). 200° impossible (convex).', fig:(s)=>Diagram.regularPolygon(s,{n:9})}
      ]
    };
    const state={item:null};
    function newItem(){
      const lv=id('errLevel').value; const b=bank[lv]; state.item=choice(b);
      id('errBox').innerHTML=`Student claim:<br/><div class="mt-1 text-maroon">${state.item.work}</div>`;
      const s=id('errSvg'); SVG.clear(s); state.item.fig(s); renderMath(id('errSlide'));
      id('errFb').textContent=''; id('errRevealBox').textContent='';
    }
    id('errNew').addEventListener('click',newItem); newItem();
    id('errCheck').addEventListener('click',()=>{
      const sel=[...document.querySelectorAll('input[name="errChoice"]')].find(x=>x.checked);
      if(!sel){ id('errFb').textContent='Choose a reason.'; return; }
      id('errFb').textContent=(sel.value===state.item.key)?'✅ Correct diagnosis.':'❌ Try again.';
      if(sel.value===state.item.key) confetti();
    });
    id('errReveal').addEventListener('click',()=>{ id('errRevealBox').innerHTML=`<div class="hint">${state.item.explain}</div>`; renderMath(id('errSlide')); });
    id('errExportCSV').addEventListener('click',()=>{
      const sel=[...document.querySelectorAll('input[name="errChoice"]')].find(x=>x.checked)?.value||'';
      downloadCSV(`${deckTitle}_error.csv`, [['claim','explanation','key','user'], [id('errBox').innerText.trim(), state.item.explain, state.item.key, sel]]);
    });
    id('errExportJSON').addEventListener('click',()=>{
      const sel=[...document.querySelectorAll('input[name="errChoice"]')].find(x=>x.checked)?.value||'';
      downloadJSON(`${deckTitle}_error.json`, {claim:id('errBox').innerText.trim(), explanation:state.item.explain, key:state.item.key, user: sel});
    });
  })();

  const Mixed = (()=>{
    const state={cur:null};
    function newQ(){
      const lv=id('mixLevel').value; const t=rand(0,5); const s=id('mixSvg'); SVG.clear(s);
      if(t===0){ // classify
        const types=TYPES; const want=choice(types);
        let P;
        if(want==='complementary'){ const a=rand(15,70), b=90-a; P={want, prompt:'Name the relationship.', draw:()=>Diagram.rightComplement(s,{a,showUnknown:false})}; }
        else if(want==='supplementary' || want==='linear pair'){ const a=rand(25,150); P={want:'linear pair', prompt:'Name the relationship.', draw:()=>Diagram.linearPairExact(s,{a,showUnknown:false})}; }
        else if(want==='vertical'){ const a=rand(25,140); P={want, prompt:'Name the relationship.', draw:()=>Diagram.verticalExact(s,{a,showUnknown:false})}; }
        else if(want==='adjacent'){ const a=rand(15,80), b=rand(10,80); P={want, prompt:'Name the relationship.', draw:()=>Diagram.adjacentExact(s,{a,b})}; }
        else { P={want:'neither', prompt:'Name the relationship.', draw:()=>{ angleArc(s,180,115,48,0,40,'#C7A34F',3); angleArc(s,260,115,48,0,60,'#f59e0b',3); }}; }
        P.draw(); id('mixQ').innerHTML=P.prompt; state.cur={type:'class',want:P.want};
      } else if(t===1){ // missing angle
        const kinds=['comp','supp','vert','lp','around']; const K=choice(kinds);
        let P;
        if(K==='comp'){ const a=rand(10,80), ans=90-a; P={ans, draw:()=>Diagram.rightComplement(s,{a,showUnknown:true}), prompt:`Find the complement of ${a}°.`}; }
        else if(K==='supp'){ const a=rand(25,170), ans=180-a; P={ans, draw:()=>Diagram.linearPairExact(s,{a,showUnknown:true}), prompt:`Linear pair with one angle ${a}°. Find the other.`}; }
        else if(K==='vert'){ const a=rand(15,165), ans=a; P={ans, draw:()=>Diagram.verticalExact(s,{a,showUnknown:true}), prompt:`Find the vertical angle to ${a}°.`}; }
        else if(K==='lp'){ const a=rand(25,155), ans=180-a; P={ans, draw:()=>Diagram.linearPairExact(s,{a,showUnknown:true}), prompt:`∠X and ∠Y form a straight line; ∠X=${a}°. Find ∠Y.`}; }
        else { const A=rand(40,140), B=rand(30,120), C=rand(30,110), D=360-(A+B+C); P={ans:D, draw:()=>Diagram.aroundPointExact(s,{values:[A,B,C,D],unknownIndex:3}), prompt:`Around a point: ${A}, ${B}, ${C}, and ?`}; }
        P.draw(); id('mixQ').innerHTML=P.prompt; state.cur={type:'miss',want:P.ans};
      } else if(t===2){ // solve for x
        const mode=choice(['comp','supp','vert']); let P = (mode==='vert')? solveVertical(lv) : solveCompSupp(mode,lv);
        const eq = (P.type==='vert')? `\\( ${P.a1}x+${P.b1} = ${P.a2}x+${P.b2} \\)` : `\\( (${P.a1}x+${P.b1})+(${P.a2}x+${P.b2})=${P.target} \\)`;
        id('mixQ').innerHTML=eq; renderMath(id('mixSlide'));
        if(P.type==='vert') Diagram.verticalSymbolic(s,{label1:`${P.a1}x+${P.b1}°`,label2:`${P.a2}x+${P.b2}°`});
        else if(P.type==='comp') Diagram.complementSymbolic(s,{label1:`${P.a1}x+${P.b1}°`,label2:`${P.a2}x+${P.b2}°`});
        else Diagram.linearPairSymbolic(s,{label1:`${P.a1}x+${P.b1}°`,label2:`${P.a2}x+${P.b2}°`});
        state.cur={type:'solve',want:P.x};
      } else if(t===3){ // polygon missing
        const n=(lv==='easy'? rand(3,5): (lv==='med'? rand(5,7): rand(6,8)));
        const S=(n-2)*180; const arr=[]; let rem=S; for(let k=0;k<n-1;k++){ const v=rand(40,Math.min(160,rem-40*(n-1-k))); arr.push(v); rem-=v; } arr.push(rem);
        const miss=rand(0,n-1), ans=arr[miss], labels=arr.map((v,k)=>k===miss?'?':(v+''));
        Diagram.regularPolygon(s,{n,labels,highlightIndex:miss}); id('mixQ').innerHTML=`n=${n}, find the missing interior angle.`; state.cur={type:'polyMiss',want:ans};
      } else if(t===4){ // ext->n
        const n=choice([3,4,5,6,8,9,10,12]), ext=360/n; Diagram.exteriorRegular(s,{n,showValue:true,value:ext});
        id('mixQ').innerHTML=`Exterior angle = ${ext}°. Find n.`; state.cur={type:'ext2n',want:n};
      } else { // n->ext
        const n=rand(3,12), ext=360/n; Diagram.exteriorRegular(s,{n,showValue:false});
        id('mixQ').innerHTML=`Regular polygon with n=${n}. Find exterior angle.`; state.cur={type:'n2ext',want:ext};
      }
      id('mixHintBox').textContent=''; id('mixFb').textContent=''; id('mixAns').value='';
    }
    function hint(){
      const t=state.cur?.type; let msg='';
      if(t==='class') msg='Complementary → 90°, Supplementary/Linear Pair → 180°, Vertical → equal, Adjacent → share a side.';
      else if(t==='miss') msg='Use 90°, 180°, or 360° sums as appropriate.';
      else if(t==='solve') msg='Write the equation from the diagram, solve for x, then evaluate angles.';
      else if(t==='polyMiss') msg='Sum of interior angles is (n−2)·180°.';
      else if(t==='ext2n' || t==='n2ext') msg='Exterior angle of a regular n‑gon equals 360°/n.';
      id('mixHintBox').innerHTML=`<div class="hint">${msg}</div>`;
    }
    function check(){
      const ans=id('mixAns').value.trim(); const t=state.cur?.type; if(!t) return;
      let ok=false, expect='';
      if(t==='class'){ const want=state.cur.want; ok=ans.toLowerCase().includes(want); expect=want; }
      else{ const want=Number(state.cur.want); ok=(Math.abs(Number(ans)-want)<1e-10); expect=want; }
      id('mixFb').textContent = ok? '✅ Correct! '+expect : '❌ Expected '+expect;
      if(ok) confetti();
    }
    id('mixNew').addEventListener('click',newQ); newQ();
    id('mixHint').addEventListener('click',hint);
    id('mixCheck').addEventListener('click',check);
    id('mixExportCSV').addEventListener('click',()=>downloadCSV(`${deckTitle}_mixed.csv`, [['prompt','user'], [id('mixQ').textContent, id('mixAns').value||'']]));
    id('mixExportJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_mixed.json`, {prompt:id('mixQ').textContent, user:id('mixAns').value||''}));
  })();

  /* ------------------------------------------------------------
     INIT + RESIZE
     ------------------------------------------------------------ */
  window.addEventListener('resize',()=>{ if(slides[i].id==='builderSlide') DiagramBoard.drawBuilder(); if(slides[i].id==='polySlide') PolyExplorer.draw(); });
  show(0);

})();
</script>
</body>
</html>
