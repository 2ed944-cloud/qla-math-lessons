<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>G8 • Unit 2 • Angle Facts — Fully Visual (with Protractor & Teacher Mode)</title>

<!-- Fonts & Tailwind -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- KaTeX -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
<script>
  window.addEventListener('DOMContentLoaded', () => {
    const run = (root = document.body) => {
      if (!window.renderMathInElement) return;
      window.renderMathInElement(root, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '\\[', right: '\\]', display: true },
          { left: '\\(', right: '\\)', display: false }
        ],
        throwOnError: false
      });
    };
    if (window.renderMathInElement) run();
    else {
      const t = setInterval(() => { if (window.renderMathInElement) { clearInterval(t); run(); } }, 25);
      setTimeout(() => clearInterval(t), 6000);
    }
    window._rerenderMath = run;
  });
</script>

<style>
  :root{--maroon:#6C1D45;--gold:#C7A34F;--dark:#2C2C2E;--light:#F5F5F5;--accent:#E8D5B7}
  html,body{height:100%;background:#2d3748;color:#111;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  #deck{position:relative;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;padding:10px}
  #slides{position:relative;width:100%;max-width:1280px;aspect-ratio:16/9;background:#fff;box-shadow:0 14px 36px rgba(0,0,0,.35);overflow:hidden;border-radius:18px}
  .slide{position:absolute;inset:0;padding:3.5%;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;opacity:0;transform:translateY(14px) scale(.985);transition:.55s ease;pointer-events:none}
  .slide.active{opacity:1;transform:none;pointer-events:auto}
  .bg-maroon{background-color:var(--maroon)} .text-maroon{color:var(--maroon)} .text-gold{color:var(--gold)}
  .banner{width:100%;height:120px;background:#fff center/contain no-repeat;border-bottom:3px solid var(--gold);border-radius:10px}
  .card{border:1px solid #e5e7eb;border-radius:14px;background:#fafafa}
  .chip{display:inline-flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.05);border-radius:9999px;padding:.35rem .75rem;cursor:pointer}
  .chip:hover{outline:2px solid var(--gold)}
  .pill{display:inline-flex;align-items:center;gap:.35rem;border:1px solid #e5e7eb;border-radius:999px;padding:.35rem .75rem;background:#fff;cursor:pointer}
  .pill.active{border-color:#22c55e;box-shadow:0 0 0 2px rgba(34,197,94,.15)}
  .btn{padding:.55rem 1rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-weight:700}
  .btn.maroon{background:var(--maroon);color:#fff;border-color:var(--maroon)}
  .btn:hover{filter:brightness(0.98)}
  #controls{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:.5rem;background:rgba(0,0,0,.55);padding:.4rem .6rem;border-radius:999px;z-index:20;backdrop-filter:blur(6px)}
  #controls button{width:42px;height:42px;border-radius:999px;border:none;background:#fff;cursor:pointer;font-weight:700}
  #controls button:hover{transform:scale(1.06)}
  #counter{color:#fff;font-weight:700;min-width:84px;text-align:center}
  #progress{position:fixed;left:0;bottom:0;height:5px;width:0;background:var(--gold);z-index:30;transition:width .35s ease}
  #fsHint{position:absolute;top:10px;right:12px;color:#fff;background:rgba(0,0,0,.35);padding:.25rem .5rem;border-radius:8px;font-size:.8rem}

  #pop{position:fixed;inset:auto auto 20px 20px;max-width:min(560px,90vw);background:#fff;border:2px solid var(--gold);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.25);padding:14px 16px;z-index:40;display:none;text-align:left}
  #pop strong{color:var(--maroon)} #pop .close{float:right;color:#666;cursor:pointer;font-weight:800}

  .hint{background:#fff3cd;border:1px solid #ffe69c;border-radius:10px;padding:.5rem .75rem}
  .workline{padding:.25rem .5rem;border-left:4px solid var(--gold);margin:.3rem 0;background:#fff}
  .confetti{position:fixed;pointer-events:none;z-index:50}

  #partNav{position:fixed;top:18px;left:18px;z-index:35;display:flex;gap:.4rem;background:rgba(255,255,255,.85);padding:.35rem;border-radius:999px;border:2px solid var(--gold);backdrop-filter:blur(4px)}
  #partNav button{font-weight:800}

  .miniWrap{display:grid;grid-template-columns: 1fr;gap:.5rem}
  @media (min-width: 720px){ .miniWrap{grid-template-columns: 360px 1fr} }
  .miniSvg{width:100%;height:230px;border:2px solid #ececec;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa)}
  .bigSvg{width:100%;max-width:780px;height:360px;border:2px solid #ececec;border-radius:12px;background:linear-gradient(180deg,#fff,#fafafa)}
  .tag{display:inline-block;font-size:.65rem;border:1px solid #e5e7eb;border-radius:999px;padding:.08rem .45rem;background:#fff;color:#374151}
  .ns{font-size:.7rem;color:#6b7280}

  /* Teacher button */
  #teacherBtn{position:fixed;top:18px;right:18px;z-index:36}
  #teacherBtn button{border:2px solid var(--gold);border-radius:999px;padding:.35rem .7rem;background:#fff;font-weight:800}
</style>
</head>
<body>

<div id="deck" aria-live="polite">
  <div id="slides" class="relative">
    <div id="fsHint">Press <strong>F</strong> for fullscreen</div>
    <div id="teacherBtn"><button id="tToggle" title="Teacher Mode">🔒 Teacher</button></div>

    <!-- 0 • Title -->
    <section class="slide active bg-maroon text-white">
      <div class="w-full h-16 banner mb-6 rounded-md" style="background-image:url('qla_banner.png')" aria-label="QLA Partner Banner" onerror="this.style.display='none'"></div>
      <div class="flex items-center gap-8">
        <img src="qla_logo.png" alt="QLA Logo" class="h-24 w-auto" onerror="this.style.display='none'"/>
        <div class="text-left">
          <h1 class="text-5xl md:text-6xl font-extrabold tracking-tight">Unit 2 — Geometry of Polygons</h1>
          <p class="text-gold text-2xl md:text-3xl mt-2 font-semibold">Angle Facts: Complementary, Supplementary, Vertical & Adjacent</p>
          <p class="mt-2 text-lg">Qatar Leadership Academy — Grade 8</p>
        </div>
      </div>
      <div class="absolute bottom-6 text-sm text-gray-100">Aligned to AERO 8.G foundations &amp; 8.EE connections.</div>
    </section>

    <!-- ──────────────────────────────── PART 1 ──────────────────────────────── -->
    <section class="slide" id="p1Intro">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 1 — Angle Vocabulary & Relationships</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P1)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Define and identify <strong>adjacent</strong>, <strong>vertical</strong>, <strong>complementary</strong>, <strong>supplementary</strong>, and <strong>linear pairs</strong>.</li>
            <li>Use sums \(90^\circ\), \(180^\circ\), and \(360^\circ\) (around a point) to find unknowns.</li>
            <li>Explain why relationships hold on a diagram (short justification).</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords (tap)</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="adj">adjacent</span>
            <span class="chip" data-key="vert">vertical</span>
            <span class="chip" data-key="comp">complementary</span>
            <span class="chip" data-key="supp">supplementary</span>
            <span class="chip" data-key="lp">linear pair</span>
            <span class="chip" data-key="around">angles around a point</span>
          </div>
          <p class="text-xs text-gray-500 mt-3">Click a keyword for a concise definition.</p>
        </div>
      </div>
    </section>

    <!-- 2 • Angle Builder (accurate) -->
    <section class="slide" id="builderSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Angle Builder (accurate & measurable)</h2>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="flex flex-wrap items-center gap-3 mb-3 text-sm">
          <label class="chip">Angle \(A\): <input id="angA" type="range" min="5" max="175" value="40" class="w-56"> <span id="angALabel" class="ml-1 font-bold">40°</span></label>
          <span class="pill">Complement: <b id="compOut">50°</b></span>
          <span class="pill">Supplement: <b id="suppOut">140°</b></span>
          <span class="pill">Vertical to \(A\): <b id="vertOut">40°</b></span>
          <label class="pill"><input type="checkbox" id="builderPro" class="mr-2"> Protractor</label>
        </div>
        <svg id="angleSvg" class="bigSvg" viewBox="0 0 780 360" aria-label="Interactive angle canvas"></svg>
        <div class="hint mt-3 text-sm">Slider updates a true ray; arcs are computed from **actual rays**. Protractor overlay aligns to the vertex.</div>
      </div>
    </section>

    <!-- 3 • Classify Angle Pairs (with per-card protractor) -->
    <section class="slide" id="classifySlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Classify Angle Pairs (diagram‑driven)</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="clfLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="clfNew" class="btn">New set</button>
        <button id="clfCheck" class="btn maroon">Check</button>
        <button id="clfExportCSV" class="btn">Export CSV</button>
        <button id="clfExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="clfList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="clfFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- 4 • Find the Missing Angle (diagram‑driven) -->
    <section class="slide" id="missSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Find the Missing Angle (diagram‑driven)</h2>
      <div class="flex items-center gap-3 mb-2">
        <span>Level:</span>
        <select id="missLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="missNew" class="btn">New set</button>
        <button id="missCheck" class="btn maroon">Check</button>
        <button id="missExportCSV" class="btn">Export CSV</button>
        <button id="missExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="missList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="missFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- 5 • Real‑Life mini‑tasks -->
    <section class="slide" id="p1RealSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Real‑Life Mini‑Tasks (with diagrams)</h2>
      <div class="flex items-center gap-3 mb-2">
        <button id="p1RealNew" class="btn">New set</button>
        <button id="p1RealCheck" class="btn maroon">Check</button>
        <button id="p1RealExportCSV" class="btn">Export CSV</button>
        <button id="p1RealExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="p1RealList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="p1RealFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- ──────────────────────────────── PART 2 ──────────────────────────────── -->
    <section class="slide" id="p2Intro">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 2 — Angle Equations & Solving</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P2)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Translate diagrams into equations (equal/90/180/360) correctly.</li>
            <li>Solve for \(x\) and compute angle measures; check reasonableness.</li>
            <li>Justify each algebraic step briefly.</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="equiv">equation</span>
            <span class="chip" data-key="subs">substitution</span>
            <span class="chip" data-key="check">reasonableness</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 7 • Solve for x — Set A -->
    <section class="slide" id="solveSlide1">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Solve for \(x\) — Set A</h2>
      <div class="flex items-center gap-3 mb-2">
        <select id="solALevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="solANew" class="btn">New set</button>
        <button id="solACheck" class="btn maroon">Check</button>
        <button id="solAReveal" class="btn">Reveal steps</button>
        <button id="solAExportCSV" class="btn">Export CSV</button>
        <button id="solAExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="solAList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="solAFb" class="mt-2 h-6 font-semibold"></div>
      <div id="solASteps" class="mt-2 text-sm"></div>
    </section>

    <!-- 8 • Solve for x — Set B -->
    <section class="slide" id="solveSlide2">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Solve for \(x\) — Set B</h2>
      <div class="flex items-center gap-3 mb-2">
        <select id="solBLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="solBNew" class="btn">New set</button>
        <button id="solBCheck" class="btn maroon">Check</button>
        <button id="solBReveal" class="btn">Reveal steps</button>
        <button id="solBExportCSV" class="btn">Export CSV</button>
        <button id="solBExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="solBList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="solBFb" class="mt-2 h-6 font-semibold"></div>
      <div id="solBSteps" class="mt-2 text-sm"></div>
    </section>

    <!-- 9 • Real‑Life (algebra + diagrams) -->
    <section class="slide" id="p2RealSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Real‑Life Mini‑Tasks (Design & Build)</h2>
      <div class="flex items-center gap-3 mb-2">
        <button id="p2RealNew" class="btn">New set</button>
        <button id="p2RealCheck" class="btn maroon">Check</button>
        <button id="p2RealExportCSV" class="btn">Export CSV</button>
        <button id="p2RealExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="p2RealList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="p2RealFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- ──────────────────────────────── PART 3 ──────────────────────────────── -->
    <section class="slide" id="p3Intro">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 3 — Polygons: Interior & Exterior Angles</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P3)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Use \(S=(n-2)\cdot 180^\circ\) for interior sums; compute a missing interior angle.</li>
            <li>For regular \(n\)-gons, interior = \(\frac{(n-2)180^\circ}{n}\), exterior = \(\frac{360^\circ}{n}\).</li>
            <li>Apply polygon angles in contexts.</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="poly">polygon</span>
            <span class="chip" data-key="reg">regular polygon</span>
            <span class="chip" data-key="sum">interior sum</span>
            <span class="chip" data-key="ext">exterior angle</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 11 • Polygon Explorer -->
    <section class="slide" id="polySlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Polygon Explorer (accurate)</h2>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="flex items-center gap-3 mb-2">
          <label class="chip">Sides \(n\): <input id="polyN" type="range" min="3" max="12" value="6" class="w-56"> <b id="polyNLabel">6</b></label>
          <span class="pill">Interior Sum: <b id="polySum">720°</b></span>
          <span class="pill">Regular \(\\angle_{int}\): <b id="polyInt">120°</b></span>
          <span class="pill">Regular \(\\angle_{ext}\): <b id="polyExt">60°</b></span>
          <label class="pill"><input type="checkbox" id="polyPro" class="mr-2"> Protractor</label>
        </div>
        <svg id="polySvg" class="miniSvg" viewBox="0 0 640 320"></svg>
        <div class="hint text-sm">Exterior angles of any convex polygon sum to \(360^\circ\).</div>
      </div>
    </section>

    <!-- 12 • Missing Interior Angle -->
    <section class="slide" id="polyMissSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Find the Missing Interior Angle</h2>
      <div class="flex items-center gap-3 mb-2">
        <select id="pmLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy (n=3–5)</option>
          <option value="med">medium (n=5–7)</option>
          <option value="hard">hard (n=6–8)</option>
        </select>
        <button id="pmNew" class="btn">New set</button>
        <button id="pmCheck" class="btn maroon">Check</button>
        <button id="pmExportCSV" class="btn">Export CSV</button>
        <button id="pmExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="pmList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="pmFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- 13 • Exterior Angles / Find n -->
    <section class="slide" id="extSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Exterior Angles & Number of Sides</h2>
      <div class="flex items-center gap-3 mb-2">
        <span id="exModeA" class="pill active">Given \(n\) → \(\\angle_{ext}\)</span>
        <span id="exModeB" class="pill">Given \(\\angle_{ext}\) → \(n\)</span>
        <button id="exNew" class="btn">New set</button>
        <button id="exCheck" class="btn maroon">Check</button>
        <button id="exExportCSV" class="btn">Export CSV</button>
        <button id="exExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="exList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="exFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- 14 • Real‑Life (Polygons) -->
    <section class="slide" id="p3RealSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Real‑Life (Polygons)</h2>
      <div class="flex items-center gap-3 mb-2">
        <button id="p3RealNew" class="btn">New set</button>
        <button id="p3RealCheck" class="btn maroon">Check</button>
        <button id="p3RealExportCSV" class="btn">Export CSV</button>
        <button id="p3RealExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="p3RealList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="p3RealFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- ──────────────────────────────── PART 4 ──────────────────────────────── -->
    <section class="slide" id="p4Intro">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 4 — Integrate: Angle Chases, Errors & Mixed Review</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P4)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Complete multi‑step “angle chase” problems (combine facts with algebra).</li>
            <li>Diagnose & correct common misconceptions and setup errors.</li>
            <li>Justify steps and check reasonableness.</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="chase">angle chase</span>
            <span class="chip" data-key="reason">justification</span>
            <span class="chip" data-key="trap">trap choice</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 16 • Angle Chase -->
    <section class="slide" id="chaseSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Angle Chase Playground</h2>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="flex items-center gap-3 mb-2">
          <select id="acLevel" class="border rounded px-2 py-1">
            <option value="easy" selected>easy</option>
            <option value="med">medium</option>
            <option value="hard">hard</option>
          </select>
          <button id="acNew" class="btn">New set</button>
          <button id="acCheck" class="btn maroon">Check</button>
          <button id="acExportCSV" class="btn">Export CSV</button>
          <button id="acExportJSON" class="btn">Export JSON</button>
        </div>
        <div id="acList" class="grid md:grid-cols-2 gap-3"></div>
        <div id="acFb" class="mt-2 h-6 font-semibold"></div>
      </div>
    </section>

    <!-- 17 • Error Analysis -->
    <section class="slide" id="errSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Error Analysis</h2>
      <div class="flex items-center gap-3 mb-2">
        <select id="errLevel" class="border rounded px-2 py-1">
          <option value="easy" selected>easy</option>
          <option value="med">medium</option>
          <option value="hard">hard</option>
        </select>
        <button id="errNew" class="btn">New example</button>
        <button id="errReveal" class="btn">Reveal correct work</button>
      </div>
      <div class="card p-5 w-full max-w-5xl text-left">
        <div class="miniWrap">
          <svg id="errSvg" class="miniSvg" viewBox="0 0 360 230"></svg>
          <div>
            <div id="errBox" class="text-lg"></div>
            <div class="mt-2">
              <label class="mr-2"><input type="radio" name="errChoice" value="A"> Wrong relationship/definition</label><br/>
              <label class="mr-2"><input type="radio" name="errChoice" value="B"> Incorrect equation setup</label><br/>
              <label class="mr-2"><input type="radio" name="errChoice" value="C"> Algebra/Arithmetic slip</label><br/>
              <label class="mr-2"><input type="radio" name="errChoice" value="D"> Polygon formula misuse</label>
            </div>
            <div class="mt-2 flex gap-2">
              <button id="errCheck" class="btn maroon">Check</button>
              <button id="errExportCSV" class="btn">Export CSV</button>
              <button id="errExportJSON" class="btn">Export JSON</button>
            </div>
            <div id="errFb" class="mt-2 h-6 font-semibold"></div>
            <div id="errRevealBox" class="mt-2 text-sm"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- 18 • Mixed Review -->
    <section class="slide" id="mixSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Mixed Review Generator</h2>
      <div class="card p-5 w-full max-w-3xl text-left">
        <div class="miniWrap">
          <svg id="mixSvg" class="miniSvg" viewBox="0 0 360 230"></svg>
          <div>
            <div class="flex items-center gap-3">
              <select id="mixLevel" class="border rounded px-2 py-1">
                <option value="easy" selected>easy</option>
                <option value="med">medium</option>
                <option value="hard">hard</option>
              </select>
              <button id="mixNew" class="btn">New question</button>
            </div>
            <div class="mt-3 text-2xl">Task: <span id="mixQ" class="font-extrabold"></span></div>
            <div class="mt-2">
              <input id="mixAns" class="border rounded px-3 py-2 w-80" placeholder="e.g., supplementary; 54°; x=18; n=8">
              <button id="mixCheck" class="btn maroon">Check</button>
              <button id="mixHint" class="btn">Hint</button>
              <button id="mixExportCSV" class="btn">Export CSV</button>
              <button id="mixExportJSON" class="btn">Export JSON</button>
            </div>
            <div id="mixHintBox" class="mt-3 text-sm"></div>
            <div id="mixFb" class="mt-2 h-6 font-semibold"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ──────────────────────────────── PART 5 (Extension) ──────────────────── -->
    <section class="slide" id="p5Intro">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Part 5 — Extension: Parallel Lines & Transversals</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Learning Outcomes (P5)</h3>
          <ul class="list-disc list-inside space-y-1 text-lg">
            <li>Identify corresponding, alternate interior/exterior, and same‑side interior relations.</li>
            <li>Use equality/supplementarity to find missing angles; solve for \(x\) from diagrams.</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-2xl font-bold text-maroon mb-1">Keywords</h3>
          <div class="flex flex-wrap gap-2 text-lg">
            <span class="chip" data-key="pll">parallel lines</span>
            <span class="chip" data-key="trans">transversal</span>
            <span class="chip" data-key="corr">corresponding</span>
            <span class="chip" data-key="altint">alternate interior</span>
            <span class="chip" data-key="sameside">same‑side interior</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 20 • Parallels: Classify & Solve -->
    <section class="slide" id="parSlide">
      <h2 class="text-3xl font-extrabold text-maroon mb-2">Parallels — Classify & Solve (diagram‑driven)</h2>
      <div class="flex items-center gap-3 mb-2">
        <button id="parNew" class="btn">New set</button>
        <button id="parCheck" class="btn maroon">Check</button>
        <button id="parExportCSV" class="btn">Export CSV</button>
        <button id="parExportJSON" class="btn">Export JSON</button>
      </div>
      <div id="parList" class="grid md:grid-cols-2 gap-3 w-full max-w-5xl"></div>
      <div id="parFb" class="mt-2 h-6 font-semibold"></div>
    </section>

    <!-- Exit Ticket -->
    <section class="slide" id="exitSlide">
      <h2 class="text-4xl font-extrabold text-maroon mb-2">Exit Ticket</h2>
      <div class="grid md:grid-cols-2 gap-6 text-left max-w-5xl">
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">3–2–1 Reflect</h3>
          <ul class="list-disc list-inside">
            <li>3 angle facts you can use instantly</li>
            <li>2 algebra steps you must show when solving</li>
            <li>1 polygon or parallel‑lines insight that surprised you</li>
          </ul>
        </div>
        <div class="card p-5">
          <h3 class="text-xl font-bold text-maroon">Up Next</h3>
          <p>We extend to parallel lines with triangle angle sums and similarity proofs.</p>
        </div>
      </div>
      <div class="absolute bottom-4 left-1/2 -translate-x-1/2 w-[88%] h-[110px] banner rounded-md" style="background-image:url('qla_banner.png')" onerror="this.style.display='none'"></div>
    </section>

  </div>
</div>

<!-- Controls -->
<div id="controls" role="group" aria-label="Slideshow controls">
  <button id="prev" title="Previous (←)">&laquo;</button>
  <button id="fs" title="Toggle Fullscreen (F)">⤢</button>
  <div id="counter">1 / 21</div>
  <button id="next" title="Next (→)">&raquo;</button>
</div>
<div id="progress"></div>

<!-- Part Navigator -->
<div id="partNav" aria-label="Part navigator">
  <button id="navP1" class="btn">Part&nbsp;1</button>
  <button id="navP2" class="btn">Part&nbsp;2</button>
  <button id="navP3" class="btn">Part&nbsp;3</button>
  <button id="navP4" class="btn">Part&nbsp;4</button>
  <button id="navP5" class="btn">Part&nbsp;5</button>
</div>

<!-- Glossary popover -->
<div id="pop" role="dialog" aria-modal="true" aria-live="polite">
  <span class="close" title="Close">✕</span>
  <div id="popBody"></div>
</div>

<script>
/* ==============================
   Core shell, glossary & helpers
   ============================== */
(function(){
  const slides=[...document.querySelectorAll('.slide')];
  const prev=id('prev'), next=id('next'), counter=id('counter'), progress=id('progress'), fsBtn=id('fs');
  const deckTitle='G8_U2_Angle_Facts_FULL';
  let i=0;
  let TEACHER=false; // Teacher Mode global
  const REDRAW = {}; // id -> redraw function
  const registerRedraw=(k,fn)=>{ REDRAW[k]=fn; };

  function show(k){
    i=(k+slides.length)%slides.length;
    slides.forEach((s,idx)=>s.classList.toggle('active',idx===i));
    counter.textContent=(i+1)+' / '+slides.length;
    progress.style.width=((i+1)/slides.length*100)+'%';
    renderMath(slides[i]);
    if(slides[i].id==='builderSlide') drawAngle();
    if(slides[i].id==='polySlide') drawPolyExplorer();
  }
  prev.addEventListener('click',()=>show(i-1));
  next.addEventListener('click',()=>show(i+1));
  document.addEventListener('keydown',e=>{
    if(e.key==='ArrowRight') show(i+1);
    if(e.key==='ArrowLeft') show(i-1);
    if(e.key.toLowerCase()==='f') toggleFS();
  });
  function toggleFS(){
    const el=id('slides');
    if(!document.fullscreenElement){(el.requestFullscreen||el.webkitRequestFullscreen||el.msRequestFullscreen).call(el);}
    else{(document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen).call(el);}
  }
  fsBtn.addEventListener('click',toggleFS);

  const partStarts=['p1Intro','p2Intro','p3Intro','p4Intro','p5Intro'];
  function goPart(idx){
    const targetId=partStarts[idx]; const pos=slides.findIndex(s=>s.id===targetId);
    if(pos>=0) show(pos);
  }
  id('navP1').addEventListener('click',()=>goPart(0));
  id('navP2').addEventListener('click',()=>goPart(1));
  id('navP3').addEventListener('click',()=>goPart(2));
  id('navP4').addEventListener('click',()=>goPart(3));
  id('navP5').addEventListener('click',()=>goPart(4));

  // Teacher Mode
  const tBtn=id('tToggle');
  tBtn.addEventListener('click',()=>{
    TEACHER=!TEACHER;
    tBtn.textContent = TEACHER? '🔓 Teacher' : '🔒 Teacher';
    // re-render all registered diagrams with current TEACHER state
    Object.values(REDRAW).forEach(fn=>fn());
  });

  function id(x){return document.getElementById(x)}
  function renderMath(root=document){ if(window._rerenderMath) window._rerenderMath(root); }
  function confetti(x=window.innerWidth/2,y=window.innerHeight/2){
    for(let k=0;k<18;k++){
      const d=document.createElement('div'); d.className='confetti';
      d.style.left=x+'px'; d.style.top=y+'px'; d.style.width='8px'; d.style.height='8px';
      d.style.background=['#6C1D45','#C7A34F','#E8D5B7','#8a3d64'][k%4];
      document.body.appendChild(d);
      const dx=(Math.random()*2-1)*240, dy=(Math.random()*-1-0.3)*300, rot=Math.random()*720;
      d.animate([{transform:'translate(0,0) rotate(0deg)'},{transform:`translate(${dx}px,${dy}px) rotate(${rot}deg)`,opacity:0}],
                {duration:900+Math.random()*700,easing:'cubic-bezier(.2,.8,.2,1)'}).onfinish=()=>d.remove();
    }
  }
  function downloadJSON(filename, data){
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
  function downloadCSV(filename, rows){
    const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  /* ---------- Glossary ---------- */
  const POP=id('pop'), POP_BODY=id('popBody');
  const GLOS={
    adj:'<strong>Adjacent</strong>: share a vertex and a common side; interiors do not overlap.',
    vert:'<strong>Vertical angles</strong>: opposite angles formed by two intersecting lines; they are equal.',
    comp:'<strong>Complementary</strong>: sum to \\(90^\\circ\\).',
    supp:'<strong>Supplementary</strong>: sum to \\(180^\\circ\\).',
    lp:'<strong>Linear pair</strong>: adjacent angles forming a straight line (sum \\(180^\\circ\\)).',
    around:'<strong>Angles around a point</strong>: sum to \\(360^\\circ\\).',
    equiv:'<strong>Equation</strong>: equality relating unknowns, e.g., \\(x+y=90\\).',
    subs:'<strong>Substitution</strong>: replace a variable by an equivalent value/expression.',
    check:'<strong>Reasonableness</strong>: solution fits geometric bounds (e.g., angle between 0° and 180°).',
    poly:'<strong>Polygon</strong>: closed figure with straight sides.',
    reg:'<strong>Regular polygon</strong>: equal sides and angles.',
    sum:'<strong>Interior sum</strong>: \\(S=(n-2)\\cdot180^\\circ\\).',
    ext:'<strong>Exterior angle</strong>: for regular \\(n\\)-gon, each is \\(360^\\circ/n\\).',
    chase:'<strong>Angle chase</strong>: chained deductions with angle facts.',
    reason:'<strong>Justification</strong>: the reason a step is valid.',
    trap:'<strong>Trap</strong>: plausible but incorrect option.',
    pll:'<strong>Parallel</strong>: lines in a plane that never meet.',
    trans:'<strong>Transversal</strong>: a line intersecting two other lines.',
    corr:'<strong>Corresponding</strong>: same relative position at each intersection.',
    altint:'<strong>Alternate interior</strong>: interior, on opposite sides of the transversal.',
    sameside:'<strong>Same‑side interior</strong>: interior, on the same side; they are supplementary.'
  };
  function showPop(html,anchor){
    POP_BODY.innerHTML=html; POP.style.display='block';
    const r=anchor?anchor.getBoundingClientRect():{left:20,top:window.innerHeight-120};
    POP.style.left=Math.min(r.left, window.innerWidth-POP.offsetWidth-20)+'px';
    POP.style.bottom=(window.innerHeight - r.top + 10)+'px';
  }
  POP.querySelector('.close').addEventListener('click',()=>POP.style.display='none');
  document.addEventListener('click',e=>{
    const el=e.target.closest('.chip[data-key]'); if(el){const key=el.dataset.key; if(GLOS[key]) showPop(GLOS[key], el);}
  });

  /* ==============================
     Geometry & SVG utilities
     ============================== */
  const TAU=Math.PI*2;
  const d2r = d=>d*Math.PI/180;
  const r2d = r=>r*180/Math.PI;
  const norm = a=>((a%360)+360)%360;
  const minArc = (a,b)=>{ const d=norm(b-a); return d<=180? d : 360-d; };
  const ccwDiff=(a,b)=>norm(b-a); // CCW difference from a to b (0..359)

  function svgEl(tag, attrs={}){ const e=document.createElementNS('http://www.w3.org/2000/svg',tag); for(const k in attrs){ e.setAttribute(k, attrs[k]); } return e; }
  function clearSvg(s){ while(s.firstChild) s.removeChild(s.firstChild); }
  function line(s, x1,y1,x2,y2, opt={}){ s.appendChild(svgEl('line', {x1,y1,x2,y2, stroke:opt.stroke||'#374151', 'stroke-width':opt.w||2, 'stroke-dasharray':opt.d||''})); }
  function path(s, d, opt={}){ s.appendChild(svgEl('path', {d, fill:opt.fill||'none', stroke:opt.stroke||'#6C1D45', 'stroke-width':opt.w||2, 'stroke-dasharray':opt.d||''})); }
  function text(s, x,y, str, opt={}){ const t=svgEl('text',{x,y, 'text-anchor':opt.anchor||'middle', 'font-size':opt.size||12, fill:opt.fill||'#111'}); t.textContent=str; s.appendChild(t); return t; }
  function polar(cx,cy,r,deg){ const a=d2r(deg); return [cx + r*Math.cos(a), cy - r*Math.sin(a)]; }

  function drawRay(s, cx,cy, angle, len=180, opt={}){ const [x2,y2]=polar(cx,cy,len,angle); line(s,cx,cy,x2,y2,opt); }
  function drawLineThrough(s, cx,cy, angle, len=200, opt={}){ const [x1,y1]=polar(cx,cy,len,angle+180), [x2,y2]=polar(cx,cy,len,angle); line(s,x1,y1,x2,y2,opt); }

  function arcPath(cx,cy,r,a0,a1){ // draw minor arc from a0 to a1 CCW or CW chosen by shorter route
    a0=norm(a0); a1=norm(a1);
    let diff=ccwDiff(a0,a1); let sweep=0; // 0 means draw "CW" (SVG arc sweep-flag), 1 is CCW; but we will control via large-arc + sweep to get minor arc
    let large = diff>180 ? 1:0;
    // We'll always pass the path start at a0 and end at a1, with sweep flag = 1 for CCW
    sweep = 1;
    const x0=cx+r*Math.cos(d2r(a0)), y0=cy-r*Math.sin(d2r(a0));
    const x1=cx+r*Math.cos(d2r(a1)), y1=cy-r*Math.sin(d2r(a1));
    // If CCW diff > 180, large-arc =1; else 0
    return `M${x0},${y0} A${r},${r} 0 ${large} ${sweep} ${x1},${y1}`;
  }
  function drawAngleArc(s, cx,cy, r, aStart, aEnd, col='#C7A34F', w=3, lbl=null){
    path(s, arcPath(cx,cy,r,aStart,aEnd), {stroke:col, w});
    if(lbl!==null){
      // mid along chosen CCW path
      const mid = norm(aStart + ccwDiff(aStart,aEnd)/2);
      const [tx,ty] = [cx + (r+16)*Math.cos(d2r(mid)), cy - (r+16)*Math.sin(d2r(mid))];
      text(s, tx,ty, lbl, {fill:'#6C1D45', size:12});
    }
  }
  function rightMarker(s, cx,cy, size, baseDeg){
    // Draw a small square indicating a right angle between baseDeg and baseDeg+90
    const a=d2r(baseDeg), dx=Math.cos(a), dy=Math.sin(a);
    const p1=[cx+12*dx, cy-12*dy];
    const p2=[p1[0]+size*(-dy), p1[1]-size*(-dx)];
    const p3=[p2[0]+size*(dx), p2[1]-size*(dy)];
    const p4=[p3[0]+size*(dy), p3[1]-size*(dx)];
    const d=`M${p1[0]},${p1[1]} L${p2[0]},${p2[1]} L${p3[0]},${p3[1]} L${p4[0]},${p4[1]} Z`;
    path(s,d,{fill:'#e5e7eb',stroke:'#9ca3af',w:1.5});
  }
  function tagNS(s){ const t=svgEl('text',{'font-size':10,fill:'#6b7280',x:10,y:16}); t.textContent='not to scale'; s.appendChild(t); }

  /* ---------- Protractor overlay (per-svg) ---------- */
  function drawProtractor(s, cx,cy, r=90, startDeg=0){
    const base='#94a3b8';
    // outer semicircle (0..180) from startDeg
    for(let k=0;k<=180;k+=10){
      const ang=norm(startDeg+k);
      const [x1,y1]=polar(cx,cy,r,ang), [x2,y2]=polar(cx,cy,r-10,ang);
      line(s,x1,y1,x2,y2,{stroke:base,w:(k%30===0?2:1)});
      if(k%30===0){
        const [tx,ty]=polar(cx,cy,r-18,ang);
        const lab = (k===180? '180': String(k));
        text(s,tx,ty,lab,{size:9,fill:base});
      }
    }
    // baseline
    drawRay(s,cx,cy,startDeg, r+8, {stroke:base,w:2,d:'4 4'});
    // faint circle
    path(s, `M ${cx+r},${cy} A ${r},${r} 0 1 1 ${cx-r},${cy}`, {stroke:base,w:1,d:'2 6'});
  }

  /* ==============================
     Accurate diagram builders
     ============================== */

  // 1) Complement at a right corner (baseline ray at 0°, vertical ray at 90°)
  function diagComplement(svg, a=30, opts={}){
    const {showUnknown=false, unknownLabel='?', pro=false, teacherVal=null}=opts;
    clearSvg(svg);
    const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
    const cx=W/2-15, cy=H/2+35;
    // axes
    drawRay(svg,cx,cy,0,150,{w:2.2});
    drawRay(svg,cx,cy,90,150,{w:2.2});
    rightMarker(svg,cx,cy,14,0);
    // a from 0 to a
    drawAngleArc(svg,cx,cy,70,0,a,'#C7A34F',3, `${a}°`);
    // complement from a to 90
    drawAngleArc(svg,cx,cy,70,a,90,'#f59e0b',3, showUnknown?(teacherVal??unknownLabel):`${90-a}°`);
    if(pro) drawProtractor(svg,cx,cy,92,0);
    tagNS(svg);
  }

  // 2) Linear pair on a straight baseline (0° and 180°), other ray at angle a
  function diagLinearPair(svg, a=120, opts={}){
    const {showUnknown=false, unknownLabel='?', pro=false, teacherVal=null}=opts;
    clearSvg(svg);
    const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
    const cx=W/2, cy=H/2+20;
    drawLineThrough(svg,cx,cy,0,170,{w:2.2});
    drawRay(svg,cx,cy,a,150,{w:2.2});
    // angle from 0 to a
    drawAngleArc(svg,cx,cy,70,0,a,'#C7A34F',3, `${a}°`);
    // partner from a to 180
    drawAngleArc(svg,cx,cy,70,a,180,'#f59e0b',3, showUnknown?(teacherVal??unknownLabel):`${180-a}°`);
    if(pro) drawProtractor(svg,cx,cy,92,0);
    tagNS(svg);
  }

  // 3) Intersecting lines with exact given angle a (0<a<180)
  //    We construct two lines at angles α and β so that one region has measure exactly 'a'.
  function diagIntersecting(svg, a=40, mode='vertical', opts={}){
    const {showUnknown=false, unknownLabel='?', pro=false, teacherVal=null}=opts;
    clearSvg(svg);
    const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
    const cx=W/2, cy=H/2;
    // Choose α randomly, then β such that one region equals 'a' (possibly obtuse)
    const acute = (a<=90)? a : 180-a;
    const alpha = 10 + Math.random()*40; // base line angle
    const beta = alpha + acute;
    drawLineThrough(svg,cx,cy,alpha,180,{w:2.2});
    drawLineThrough(svg,cx,cy,beta,180,{w:2.2});
    // Now decide which region to label as 'a' (acute or obtuse)
    let start, end; // arc from start to end CCW
    if(a<=90){ start=alpha; end=beta; }
    else{ // obtuse region between beta and alpha+180
      start=beta; end=alpha+180;
    }
    drawAngleArc(svg,cx,cy,64,start,end,'#C7A34F',3, `${a}°`);
    // Opposite (vertical) is the same arc shifted by 180
    if(mode==='vertical'){
      drawAngleArc(svg,cx,cy,64,start+180,end+180,'#f59e0b',3, showUnknown?(teacherVal??unknownLabel):`${a}°`);
    } else if(mode==='adjacent'){
      // Adjacent partner shares a side; pick the other region next to start
      const otherEnd = (a<=90)? alpha+180 : beta; // ensure adjacency but not vertical
      const want = 180 - a; // adjacent but not necessarily linear unless aligned with 180
      drawAngleArc(svg,cx,cy,64,end,otherEnd,'#f59e0b',3, showUnknown?(teacherVal??unknownLabel):`${want}°`);
    }
    if(pro) drawProtractor(svg,cx,cy,90,alpha);
    tagNS(svg);
  }

  // 4) Around a point: three given, one unknown
  function diagAroundPoint(svg, A=120,B=80,C=70, opts={}){
    const {showUnknown=true, unknownLabel='?', pro=false, teacherVal=null}=opts;
    clearSvg(svg);
    const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
    const cx=W/2, cy=H/2;
    const r=74;
    let start = -20;
    const D = 360-(A+B+C);
    const segs = [
      {d:A,c:'#C7A34F',t:`${A}°`},
      {d:B,c:'#f59e0b',t:`${B}°`},
      {d:C,c:'#60a5fa',t:`${C}°`},
      {d:D,c:'#ef4444',t: showUnknown?(teacherVal??unknownLabel):`${D}°`}
    ];
    segs.forEach(seg=>{
      drawAngleArc(svg,cx,cy,r,start,start+seg.d,seg.c,3, seg.t);
      start+=seg.d;
    });
    if(pro) drawProtractor(svg,cx,cy,96,-20);
    tagNS(svg);
  }

  // 5) Regular polygon drawing with label control
  function drawRegularPolygon(svg, n=6, labels=[], highlightIdx=-1, pro=false){
    clearSvg(svg);
    const W=svg.viewBox.baseVal.width||640, H=svg.viewBox.baseVal.height||320;
    const cx=W/2, cy=H/2+5, R=Math.min(W,H)/3;
    const rot=-90;
    const pts=[];
    for(let k=0;k<n;k++){ const ang=rot + 360*k/n; pts.push(polar(cx,cy,R,ang)); }
    // edges
    const d='M'+pts.map(p=>p[0]+','+p[1]).join(' L ')+' Z';
    path(svg,d,{stroke:'#374151',w:2});
    const intr=(n-2)*180/n;
    for(let k=0;k<n;k++){
      const P=pts[k];
      // interior tick
      const a0=rot+360*(k-0.25)/n, a1=rot+360*(k+0.25)/n;
      drawAngleArc(svg,P[0],P[1],22,a0,a1,'#C7A34F',2);
      const lab = labels[k] ?? (k===highlightIdx? '?' : `${Math.round(intr)}°`);
      const mid=(a0+a1)/2;
      text(svg, P[0]+28*Math.cos(d2r(mid)), P[1]-28*Math.sin(d2r(mid)), lab, {size:12});
    }
    if(pro){ // place a protractor at vertex 0 for reference
      const P=pts[0]; drawProtractor(svg, P[0],P[1],40, rot);
    }
  }

  // 6) Exterior angle diagram at one vertex of a regular n‑gon
  function drawExterior(svg, n=6, showValue=false, value=null, pro=false){
    clearSvg(svg);
    const W=svg.viewBox.baseVal.width||360, H=svg.viewBox.baseVal.height||230;
    const cx=W/2, cy=H/2+10, R=Math.min(W,H)/3, rot=-90;
    const pts=[]; for(let k=0;k<n;k++) pts.push(polar(cx,cy,R,rot+360*k/n));
    path(svg, 'M'+pts.map(p=>p[0]+','+p[1]).join(' L ')+' Z', {stroke:'#374151',w:2});
    const P0=pts[0], P1=pts[1], Pn=pts[n-1];
    // sides meeting at P0
    line(svg,Pn[0],Pn[1],P0[0],P0[1],{w:2});
    line(svg,P0[0],P0[1],P1[0],P1[1],{w:2});
    // extension of Pn->P0
    const angEdge = r2d(Math.atan2(P0[1]-Pn[1], P0[0]-Pn[0]));
    const [ex,ey]=polar(P0[0],P0[1],120,angEdge);
    line(svg,P0[0],P0[1], ex,ey, {w:2, d:'6 4'});
    const a1=angEdge, a2=r2d(Math.atan2(P1[1]-P0[1], P1[0]-P0[0]));
    drawAngleArc(svg,P0[0],P0[1],26,a1,a2,'#C7A34F',3, showValue? (value ?? `${Math.round(360/n)}°`) : 'ext');
    if(pro) drawProtractor(svg,P0[0],P0[1],44,a1);
    tagNS(svg);
  }

  /* ---------- Protractor + Teacher helpers per card ---------- */
  function proToggleEl() { const el=document.createElement('label'); el.className='pill'; el.innerHTML='<input type="checkbox" class="mr-2 proChk"> Protractor'; return el; }
  function addProToggle(container, svgId, redrawFn){
    const t = proToggleEl(); container.querySelector('.hdr').appendChild(t);
    const chk = t.querySelector('.proChk');
    chk.addEventListener('change', redrawFn);
    registerRedraw(svgId, redrawFn);
  }
  function teacherOverlayText(svg, x,y, txt){ text(svg,x,y,txt,{size:14,fill:'#0ea5e9'}); }

  /* ==============================
     PART 1 — Builder
     ============================== */
  const builderSvg = id('angleSvg');
  const angA=id('angA'), angALabel=id('angALabel'), compOut=id('compOut'), suppOut=id('suppOut'), vertOut=id('vertOut');
  function drawAngle(){
    const A=Number(angA.value);
    angALabel.textContent=A+'°';
    compOut.textContent=(90-A>0? (90-A)+'°':'—');
    suppOut.textContent=(180-A)+'°';
    vertOut.textContent=A+'°';
    const pro=id('builderPro').checked;
    clearSvg(builderSvg);
    const W=780,H=360,cx=W/2,cy=H/2+20;
    drawLineThrough(builderSvg,cx,cy,0,250,{w:2.6});
    drawRay(builderSvg,cx,cy,A,240,{w:2.6,stroke:'#C7A34F'});
    drawAngleArc(builderSvg,cx,cy,100,0,A,'#C7A34F',4, `A=${A}°`);
    drawAngleArc(builderSvg,cx,cy,78,A,180,'#999',2,'supp');
    drawAngleArc(builderSvg,cx,cy,60,180,180+A,'#bbb',2,'vert');
    if(pro) drawProtractor(builderSvg,cx,cy,120,0);
    tagNS(builderSvg);
  }
  angA.addEventListener('input',drawAngle);
  id('builderPro').addEventListener('change',drawAngle);

  /* ==============================
     PART 1 — Classify & Missing
     ============================== */
  const TYPES=['complementary','supplementary','vertical','adjacent','linear pair','neither'];
  function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function choice(arr){ return arr[rand(0,arr.length-1)] }

  const clfState={items:[]};
  function clfNew(){
    const lv=id('clfLevel').value; const k=(lv==='easy'?6:(lv==='med'?8:10));
    clfState.items=[]; const box=id('clfList'); box.innerHTML='';
    for(let i=0;i<k;i++){
      const kind=choice(TYPES);
      const row=document.createElement('div'); row.className='card p-4 text-left';
      row.innerHTML=`<div class="miniWrap">
        <div>
          <div class="flex items-center justify-between hdr">
            <div class="text-maroon font-semibold mb-1">Item ${i+1} <span class="tag">diagram</span></div>
          </div>
          <svg id="clfSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
        </div>
        <div>
          <div class="mb-2">Classify the highlighted pair.</div>
          <div class="flex flex-wrap gap-2 text-sm">${TYPES.map(s=>`<label class="pill"><input type="radio" name="clf_${i}" value="${s}" class="mr-1">${s}</label>`).join('')}</div>
        </div>
      </div>`;
      box.appendChild(row);
      const svg=row.querySelector(`#clfSVG_${i}`);
      // Build a faithful diagram and remember the correct class
      let correct=kind, redrawFn;
      if(kind==='complementary'){
        const a=rand(15,75);
        redrawFn=()=>diagComplement(svg,a,{showUnknown:false, pro: row.querySelector('.proChk')?.checked || false});
      } else if(kind==='supplementary' || kind==='linear pair'){
        const a=rand(20,160);
        redrawFn=()=>diagLinearPair(svg,a,{showUnknown:false, pro: row.querySelector('.proChk')?.checked || false});
        correct=(kind==='supplementary')?'supplementary':'linear pair'; // both acceptable; we keep as chosen
      } else if(kind==='vertical'){
        const a=rand(15,165);
        redrawFn=()=>diagIntersecting(svg,a,'vertical',{showUnknown:true, unknownLabel:'?', pro: row.querySelector('.proChk')?.checked || false, teacherVal: TEACHER?`${a}°`:null});
      } else if(kind==='adjacent'){
        // ensure shared side but not 90/180
        const a=rand(25,70);
        redrawFn=()=>diagIntersecting(svg, a, 'adjacent', {showUnknown:true, unknownLabel:'?', pro: row.querySelector('.proChk')?.checked || false, teacherVal: TEACHER?`${180-a}°`:null});
      } else { // neither (two disjoint angles)
        redrawFn=()=>{
          clearSvg(svg); const cx=180,cy=115;
          drawRay(svg,cx-80,cy,0,70,{w:2.2}); drawRay(svg,cx-80,cy,40,70,{w:2.2});
          drawAngleArc(svg,cx-80,cy,40,0,40,'#C7A34F',3,'40°');
          drawRay(svg,cx+80,cy,180,70,{w:2.2}); drawRay(svg,cx+80,cy,240,70,{w:2.2});
          drawAngleArc(svg,cx+80,cy,40,180,240,'#f59e0b',3,'60°'); tagNS(svg);
        };
      }
      redrawFn(); addProToggle(row, `clfSVG_${i}`, redrawFn);
      clfState.items.push({kind:correct});
    }
  }
  function clfCheck(){
    let ok=0;
    [...id('clfList').children].forEach((row,idx)=>{
      const sel=[...row.querySelectorAll('input[type="radio"]')].find(x=>x.checked)?.value||'';
      const want=clfState.items[idx].kind;
      row.style.borderColor=(sel===want)? '#22c55e' : '#ef4444';
      if(sel===want) ok++;
    });
    id('clfFb').textContent = ok===clfState.items.length? '✅ All correct!' : `Score: ${ok}/${clfState.items.length}`;
    if(ok===clfState.items.length) confetti();
  }
  id('clfNew').addEventListener('click',clfNew); clfNew();
  id('clfCheck').addEventListener('click',clfCheck);
  id('clfExportCSV').addEventListener('click',()=>{
    const rows=[['correct','user']]; [...id('clfList').children].forEach((row,idx)=>{ const u=[...row.querySelectorAll('input[type="radio"]')].find(x=>x.checked)?.value||''; rows.push([clfState.items[idx].kind,u]); }); downloadCSV(`${deckTitle}_P1_classify.csv`, rows);
  });
  id('clfExportJSON').addEventListener('click',()=>{
    const data=[...id('clfList').children].map((row,idx)=>({correct:clfState.items[idx].kind, user:[...row.querySelectorAll('input[type="radio"]')].find(x=>x.checked)?.value||''})); downloadJSON(`${deckTitle}_P1_classify.json`, data);
  });

  const missState={items:[]};
  function missNew(){
    const lv=id('missLevel').value; const k=(lv==='easy'?6:(lv==='med'?8:10));
    missState.items=[]; const box=id('missList'); box.innerHTML='';
    for(let i=0;i<k;i++){
      const kind=choice(['comp','supp','vert','lp','around']);
      const row=document.createElement('div'); row.className='card p-4 text-left';
      row.innerHTML=`<div class="miniWrap">
        <div>
          <div class="flex items-center justify-between hdr"><div class="text-maroon font-semibold mb-1">Item ${i+1} <span class="tag">diagram</span></div></div>
          <svg id="missSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
        </div>
        <div>
          <div class="mb-2"></div>
          <div>Answer: <input class="minp border rounded px-2 py-1 w-24"> °</div>
        </div>
      </div>`;
      box.appendChild(row);
      const svg=row.querySelector(`#missSVG_${i}`);
      let ans=0, redrawFn;
      if(kind==='comp'){
        const a=rand(15,80); ans=90-a;
        row.querySelector('.mb-2').innerHTML=`Find the complement of <b>${a}°</b>.`;
        redrawFn=()=>diagComplement(svg,a,{showUnknown:true, unknownLabel:'?', pro: row.querySelector('.proChk')?.checked || false, teacherVal: TEACHER?`${ans}°`:null});
      } else if(kind==='supp'){
        const a=rand(25,170); ans=180-a;
        row.querySelector('.mb-2').innerHTML=`Linear pair: if one angle is <b>${a}°</b>, find the other.`;
        redrawFn=()=>diagLinearPair(svg,a,{showUnknown:true, unknownLabel:'?', pro: row.querySelector('.proChk')?.checked || false, teacherVal: TEACHER?`${ans}°`:null});
      } else if(kind==='vert'){
        const a=rand(15,165); ans=a;
        row.querySelector('.mb-2').innerHTML=`Two lines intersect. If \(m∠A=${a}°\), find \(m∠A'\) (vertical).`;
        redrawFn=()=>diagIntersecting(svg,a,'vertical',{showUnknown:true, unknownLabel:'?', pro: row.querySelector('.proChk')?.checked || false, teacherVal: TEACHER?`${ans}°`:null});
      } else if(kind==='lp'){
        const a=rand(25,155); ans=180-a;
        row.querySelector('.mb-2').innerHTML=`Adjacent ∠X and ∠Y form a straight line. If \(m∠X=${a}°\), find \(m∠Y\).`;
        redrawFn=()=>diagLinearPair(svg,a,{showUnknown:true, unknownLabel:'?', pro: row.querySelector('.proChk')?.checked || false, teacherVal: TEACHER?`${ans}°`:null});
      } else {
        const A=rand(40,140), B=rand(40,140), C=rand(40,140); ans=360-(A+B+C);
        row.querySelector('.mb-2').innerHTML=`Angles around a point: ${A}°, ${B}°, ${C}°, and ∠? . Find ∠?.`;
        redrawFn=()=>diagAroundPoint(svg,A,B,C,{showUnknown:true, unknownLabel:'?', pro: row.querySelector('.proChk')?.checked || false, teacherVal: TEACHER?`${ans}°`:null});
      }
      redrawFn(); addProToggle(row, `missSVG_${i}`, redrawFn);
      missState.items.push({ans});
    }
  }
  function missCheck(){
    let ok=0;
    [...id('missList').children].forEach((row,idx)=>{
      const got=Number(row.querySelector('.minp').value); const want=missState.items[idx].ans;
      row.style.borderColor=(Math.abs(got-want)<1e-10)? '#22c55e':'#ef4444';
      if(Math.abs(got-want)<1e-10) ok++;
    });
    id('missFb').textContent = ok===missState.items.length? '✅ Great!' : `Score: ${ok}/${missState.items.length}`;
    if(ok===missState.items.length) confetti();
  }
  id('missNew').addEventListener('click',missNew); missNew();
  id('missCheck').addEventListener('click',missCheck);
  id('missExportCSV').addEventListener('click',()=>{
    const rows=[['answer','user']]; [...id('missList').children].forEach((row,idx)=>rows.push([missState.items[idx].ans, row.querySelector('.minp').value||''])); downloadCSV(`${deckTitle}_P1_missing.csv`, rows);
  });
  id('missExportJSON').addEventListener('click',()=>{
    const data=[...id('missList').children].map((row,idx)=>({answer:missState.items[idx].ans, user:row.querySelector('.minp').value||''})); downloadJSON(`${deckTitle}_P1_missing.json`, data);
  });

  /* ==============================
     PART 1 — Real‑Life
     ============================== */
  const p1RealState={items:[]};
  function drawDoor(svg, opened=60, opts={}){ const {pro=false}=opts; clearSvg(svg); const W=svg.viewBox.baseVal.width||360,H=svg.viewBox.baseVal.height||230; const cx=W/2-40, cy=H/2+40; drawRay(svg,cx,cy-100,0,150,{w:3}); const [dx,dy]=polar(cx,cy-100,140,-opened); line(svg,cx,cy-100,dx,dy,{w:3,stroke:'#6C1D45'}); drawAngleArc(svg,cx,cy-100,50,0,opened,'#C7A34F',3, `${opened}°`); text(svg,cx+100,cy-100,'to 90°?',{anchor:'start',size:11,fill:'#374151'}); if(pro) drawProtractor(svg,cx,cy-100,68,0); tagNS(svg); }
  function drawFrame(svg, a=30, opts={}){ const {pro=false}=opts; diagComplement(svg,a,{showUnknown:true,unknownLabel:String(90-a)+'°', pro}); }
  function drawBracket(svg, a=120, opts={}){ const {pro=false}=opts; diagLinearPair(svg,a,{showUnknown:true,unknownLabel:String(180-a)+'°', pro}); }
  function drawSpotlights(svg, A,B,C, opts={}){ const {pro=false}=opts; diagAroundPoint(svg,A,B,C,{showUnknown:true,unknownLabel:String(360-(A+B+C))+'°', pro}); }

  function p1RealNew(){
    p1RealState.items=[]; const box=id('p1RealList'); box.innerHTML='';
    [
      (row)=>{ const a=rand(20,70), ans=90-a, prompt=`Picture frame corner: one miter cut is <b>${a}°</b>. What must the other be?`; return {prompt, ans, draw:(svg,pro)=>drawFrame(svg,a,{pro})}; },
      (row)=>{ const a=rand(35,85), ans=90-a, prompt=`Door opened to <b>${a}°</b>. How many degrees to reach a right angle?`; return {prompt, ans, draw:(svg,pro)=>drawDoor(svg,a,{pro})}; },
      (row)=>{ const a=rand(30,150), ans=180-a, prompt=`Wall bracket forms a straight line with support. If support angle is <b>${a}°</b>, find bracket’s angle with wall.`; return {prompt, ans, draw:(svg,pro)=>drawBracket(svg,a,{pro})}; },
      (row)=>{ const A=rand(60,150),B=rand(40,120),C=rand(30,110), ans=360-(A+B+C), prompt=`Spotlights around a DJ: ${A}°, ${B}°, ${C}°. What remains to make 360°?`; return {prompt, ans, draw:(svg,pro)=>drawSpotlights(svg,A,B,C,{pro})}; }
    ].forEach((gen,idx)=>{
      const g=gen();
      const row=document.createElement('div'); row.className='card p-4';
      row.innerHTML=`<div class="miniWrap">
        <div>
          <div class="flex items-center justify-between hdr"><div class="text-maroon font-semibold mb-1">Task ${idx+1} <span class="tag">diagram</span></div></div>
          <svg id="p1RSVG_${idx}" class="miniSvg" viewBox="0 0 360 230"></svg>
        </div>
        <div>
          <div class="text-left">${g.prompt}</div>
          <div class="mt-2">Answer: <input class="rin border rounded px-2 py-1 w-28"> °</div>
        </div>
      </div>`;
      box.appendChild(row);
      const svg=row.querySelector(`#p1RSVG_${idx}`);
      const redraw=()=>g.draw(svg, row.querySelector('.proChk')?.checked || false);
      redraw(); addProToggle(row, `p1RSVG_${idx}`, redraw);
      p1RealState.items.push({ans:g.ans});
    });
  }
  id('p1RealNew').addEventListener('click',p1RealNew); p1RealNew();
  id('p1RealCheck').addEventListener('click',()=>{
    let ok=0; [...id('p1RealList').querySelectorAll('.rin')].forEach((el,idx)=>{ const got=Number(el.value); const want=p1RealState.items[idx].ans; el.style.borderColor=(Math.abs(got-want)<1e-10)? '#22c55e':'#ef4444'; if(Math.abs(got-want)<1e-10) ok++; });
    id('p1RealFb').textContent = ok===p1RealState.items.length? '✅ Excellent!' : `Score: ${ok}/${p1RealState.items.length}`; if(ok===p1RealState.items.length) confetti();
  });
  id('p1RealExportCSV').addEventListener('click',()=>{
    const rows=[['answer','user']]; [...id('p1RealList').children].forEach((row,idx)=>rows.push([p1RealState.items[idx].ans, row.querySelector('.rin').value||''])); downloadCSV(`${deckTitle}_P1_real.csv`, rows);
  });
  id('p1RealExportJSON').addEventListener('click',()=>{
    const data=[...id('p1RealList').children].map((row,idx)=>({answer:p1RealState.items[idx].ans, user:row.querySelector('.rin').value||''})); downloadJSON(`${deckTitle}_P1_real.json`, data);
  });

  /* ==============================
     PART 2 — Solve-for-x
     ============================== */
  function makeExpr(aR=[1,4],bR=[0,30]){ return {a:rand(aR[0],aR[1]), b:rand(bR[0],bR[1])}; }
  function exprVal(e,x){ return e.a*x+e.b; }

  function problemComp(lv){ const target=90; for(let g=0;g<300;g++){ const e1=makeExpr(), e2=makeExpr(); const A=e1.a+e2.a,B=e1.b+e2.b,x=(target-B)/A; if(Number.isInteger(x)&&x>0) return {type:'comp',e1,e2,target,x}; } return problemComp(lv); }
  function problemSupp(lv){ const target=180; for(let g=0;g<300;g++){ const e1=makeExpr(), e2=makeExpr(); const A=e1.a+e2.a,B=e1.b+e2.b,x=(target-B)/A; if(Number.isInteger(x)&&x>0) return {type:'supp',e1,e2,target,x}; } return problemSupp(lv); }
  function problemLP(lv){ return problemSupp(lv); }
  function problemVert(lv){ for(let g=0;g<300;g++){ const e1=makeExpr(), e2=makeExpr(); const A=e1.a-e2.a, B=e2.b-e1.b; if(A!==0 && B%A===0){ const x=B/A; if(x>0) return {type:'vert',e1,e2,x}; } } return problemVert(lv); }

  function drawSolve(svg, prob, pro=false){
    clearSvg(svg);
    if(prob.type==='comp'){ // right corner, two arcs sum to 90 with expressions
      const W=svg.viewBox.baseVal.width||360,H=svg.viewBox.baseVal.height||230; const cx=W/2-15, cy=H/2+35;
      drawRay(svg,cx,cy,0,150,{w:2.2}); drawRay(svg,cx,cy,90,150,{w:2.2}); rightMarker(svg,cx,cy,14,0);
      drawAngleArc(svg,cx,cy,70,0,38,'#C7A34F',3, `${prob.e1.a}x+${prob.e1.b}°`);
      drawAngleArc(svg,cx,cy,70,38,90,'#f59e0b',3, `${prob.e2.a}x+${prob.e2.b}°`);
      if(TEACHER){ const a1=exprVal(prob.e1,prob.x), a2=exprVal(prob.e2,prob.x); teacherOverlayText(svg,cx+100,cy-70,`x=${prob.x}, ∠s=${a1}°,${a2}°`); }
      if(pro) drawProtractor(svg,cx,cy,92,0);
    } else if(prob.type==='supp' || prob.type==='lp'){ // straight line
      const W=svg.viewBox.baseVal.width||360,H=svg.viewBox.baseVal.height||230; const cx=W/2, cy=H/2+20;
      drawLineThrough(svg,cx,cy,0,170,{w:2.2}); const a=120; drawRay(svg,cx,cy,a,150,{w:2.2});
      drawAngleArc(svg,cx,cy,70,0,a,'#C7A34F',3, `${prob.e1.a}x+${prob.e1.b}°`);
      drawAngleArc(svg,cx,cy,70,a,180,'#f59e0b',3, `${prob.e2.a}x+${prob.e2.b}°`);
      if(TEACHER){ const a1=exprVal(prob.e1,prob.x), a2=exprVal(prob.e2,prob.x); teacherOverlayText(svg,cx+110,cy-20,`x=${prob.x}, ∠s=${a1}°,${a2}°`); }
      if(pro) drawProtractor(svg,cx,cy,92,0);
    } else { // vertical equality
      const W=svg.viewBox.baseVal.width||360,H=svg.viewBox.baseVal.height||230; const cx=W/2, cy=H/2;
      const alpha=20,beta=100; drawLineThrough(svg,cx,cy,alpha,170,{w:2.2}); drawLineThrough(svg,cx,cy,beta,170,{w:2.2});
      drawAngleArc(svg,cx,cy,64,alpha,beta,'#C7A34F',3, `${prob.e1.a}x+${prob.e1.b}°`);
      drawAngleArc(svg,cx,cy,64,alpha+180,beta+180,'#f59e0b',3, `${prob.e2.a}x+${prob.e2.b}°`);
      if(TEACHER){ const a1=exprVal(prob.e1,prob.x), a2=exprVal(prob.e2,prob.x); teacherOverlayText(svg,cx+0,cy-84,`x=${prob.x}, ∠=${a1}°=${a2}°`); }
      if(pro) drawProtractor(svg,cx,cy,90,alpha);
    }
    tagNS(svg);
  }

  function buildSolveSet(state, boxId, lv){
    const kinds=['comp','supp','vert','lp']; const box=id(boxId); box.innerHTML=''; state.items=[];
    for(let i=0;i<4;i++){
      const t=kinds[i]; const p = (t==='comp')?problemComp(lv): (t==='supp')?problemSupp(lv): (t==='lp')?problemLP(lv):problemVert(lv);
      state.items.push(p);
      const row=document.createElement('div'); row.className='card p-4 text-left';
      row.innerHTML=`<div class="miniWrap">
        <div>
          <div class="flex items-center justify-between hdr"><div class="text-maroon font-semibold mb-1">${t==='comp'?'Complementary':'supp'===t||'lp'===t?'Linear/Supplementary':'Vertical'} <span class="tag">diagram</span></div></div>
          <svg id="${boxId}_svg_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
        </div>
        <div>
          <div class="mb-2">${t==='vert' ? `\\( ${p.e1.a}x+${p.e1.b} = ${p.e2.a}x+${p.e2.b} \\)` : `\\( (${p.e1.a}x+${p.e1.b}) + (${p.e2.a}x+${p.e2.b}) = ${p.target} \\)`}</div>
          <div> \(x=\) <input class="xin border rounded px-2 py-1 w-20"> &nbsp; ∠1 = <input class="a1in border rounded px-2 py-1 w-20">° &nbsp; ∠2 = <input class="a2in border rounded px-2 py-1 w-20">°</div>
        </div>
      </div>`;
      box.appendChild(row);
      const svg=row.querySelector(`#${boxId}_svg_${i}`);
      const redraw=()=>drawSolve(svg,p, row.querySelector('.proChk')?.checked || false);
      redraw(); addProToggle(row, `${boxId}_svg_${i}`, redraw);
      renderMath(row);
    }
  }
  function solCheck(state, boxId, fbId){
    let ok=0; const box=id(boxId);
    [...box.children].forEach((row,idx)=>{
      const p=state.items[idx]; const x=Number(row.querySelector('.xin').value);
      const a1=Number(row.querySelector('.a1in').value), a2=Number(row.querySelector('.a2in').value);
      const wantX=p.x, w1=exprVal(p.e1,wantX), w2=exprVal(p.e2,wantX);
      const good=(x===wantX && a1===w1 && a2===w2);
      row.style.borderColor= good? '#22c55e':'#ef4444';
      if(good) ok++;
    });
    id(fbId).textContent = ok===state.items.length? '✅ All correct!' : `Score: ${ok}/${state.items.length}`;
    if(ok===state.items.length) confetti();
  }
  function solReveal(state, stepsId){
    const box=id(stepsId); box.innerHTML='';
    state.items.forEach((p,idx)=>{
      if(p.type==='vert'){
        box.insertAdjacentHTML('beforeend', `<div class="workline">${idx+1}) \\(${p.e1.a}x+${p.e1.b}=${p.e2.a}x+${p.e2.b}\\) ⇒ \\(${p.e1.a-p.e2.a}x=${p.e2.b-p.e1.b}\\) ⇒ \\(x=${p.x}\\).</div>`);
      }else{
        const A=p.e1.a+p.e2.a, B=p.e1.b+p.e2.b;
        box.insertAdjacentHTML('beforeend', `<div class="workline">${idx+1}) \\((${p.e1.a}x+${p.e1.b})+(${p.e2.a}x+${p.e2.b})=${p.target}\\) ⇒ \\(${A}x+${B}=${p.target}\\) ⇒ \\(${A}x=${p.target-B}\\) ⇒ \\(x=${p.x}\\).</div>`);
      }
    });
    renderMath(box);
  }
  const solAState={items:[]}, solBState={items:[]};
  id('solANew').addEventListener('click',()=>buildSolveSet(solAState,'solAList', id('solALevel').value));
  id('solACheck').addEventListener('click',()=>solCheck(solAState,'solAList','solAFb'));
  id('solAReveal').addEventListener('click',()=>solReveal(solAState,'solASteps'));
  id('solBNew').addEventListener('click',()=>buildSolveSet(solBState,'solBList', id('solBLevel').value));
  id('solBCheck').addEventListener('click',()=>solCheck(solBState,'solBList','solBFb'));
  id('solBReveal').addEventListener('click',()=>solReveal(solBState,'solBSteps'));
  buildSolveSet(solAState,'solAList','easy'); buildSolveSet(solBState,'solBList','easy');

  id('solAExportCSV').addEventListener('click',()=>{ const rows=[['type','x','a1','a2','user_x','user_a1','user_a2']]; [...id('solAList').children].forEach((row,idx)=>{ const p=solAState.items[idx]; rows.push([p.type,p.x,exprVal(p.e1,p.x),exprVal(p.e2,p.x),row.querySelector('.xin').value||'',row.querySelector('.a1in').value||'',row.querySelector('.a2in').value||'']); }); downloadCSV(`${deckTitle}_solveA.csv`, rows); });
  id('solAExportJSON').addEventListener('click',()=>{ const data=[...id('solAList').children].map((row,idx)=>{ const p=solAState.items[idx]; return {type:p.type,solution:{x:p.x,a1:exprVal(p.e1,p.x),a2:exprVal(p.e2,p.x)}, user:{x:row.querySelector('.xin').value||'',a1:row.querySelector('.a1in').value||'',a2:row.querySelector('.a2in').value||''}}; }); downloadJSON(`${deckTitle}_solveA.json`, data); });
  id('solBExportCSV').addEventListener('click',()=>{ const rows=[['type','x','a1','a2','user_x','user_a1','user_a2']]; [...id('solBList').children].forEach((row,idx)=>{ const p=solBState.items[idx]; rows.push([p.type,p.x,exprVal(p.e1,p.x),exprVal(p.e2,p.x),row.querySelector('.xin').value||'',row.querySelector('.a1in').value||'',row.querySelector('.a2in').value||'']); }); downloadCSV(`${deckTitle}_solveB.csv`, rows); });
  id('solBExportJSON').addEventListener('click',()=>{ const data=[...id('solBList').children].map((row,idx)=>{ const p=solBState.items[idx]; return {type:p.type,solution:{x:p.x,a1:exprVal(p.e1,p.x),a2:exprVal(p.e2,p.x)}, user:{x:row.querySelector('.xin').value||'',a1:row.querySelector('.a1in').value||'',a2:row.querySelector('.a2in').value||''}}; }); downloadJSON(`${deckTitle}_solveB.json`, data); });

  /* ==============================
     PART 3 — Polygons
     ============================== */
  const polySvg=id('polySvg'); const polyN=id('polyN'), polyNLabel=id('polyNLabel'), polySum=id('polySum'), polyInt=id('polyInt'), polyExt=id('polyExt');
  function drawPolyExplorer(){ const n=Number(polyN.value); polyNLabel.textContent=n; const S=(n-2)*180, ext=360/n, Int=S/n; polySum.textContent=S+'°'; polyInt.textContent=(Math.round(Int*100)/100)+'°'; polyExt.textContent=(Math.round(ext*100)/100)+'°'; drawRegularPolygon(polySvg,n,[], -1, id('polyPro').checked); }
  polyN.addEventListener('input',drawPolyExplorer); id('polyPro').addEventListener('change',drawPolyExplorer); drawPolyExplorer();

  const pmState={items:[]};
  function makePolygonAngles(n){
    const S=(n-2)*180; const arr=[]; let remain=S;
    for(let i=0;i<n-1;i++){ const min=40,max=Math.min(160, remain-40*(n-1-i)); const val=rand(min,Math.max(min,max)); arr.push(val); remain-=val; }
    arr.push(remain); return arr.sort(()=>Math.random()-0.5);
  }
  function pmNew(){
    const lv=id('pmLevel').value; const n=(lv==='easy'? rand(3,5):(lv==='med'? rand(5,7): rand(6,8)));
    const box=id('pmList'); box.innerHTML=''; pmState.items=[];
    for(let i=0;i<4;i++){
      const angles=makePolygonAngles(n); const missIdx=rand(0,n-1); const ans=angles[missIdx];
      const row=document.createElement('div'); row.className='card p-4 text-left';
      row.innerHTML=`<div class="miniWrap">
        <div>
          <div class="flex items-center justify-between hdr"><div class="text-maroon font-semibold mb-1">n=${n} <span class="tag">diagram</span></div></div>
          <svg id="pmSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
        </div>
        <div>
          <div class="mb-2">Angles: [ ${angles.map((v,j)=> j===missIdx? '?': v).join(', ')} ] — Find the missing angle.</div>
          <div>Answer: <input class="pmIn border rounded px-2 py-1 w-28"> °</div>
        </div>
      </div>`;
      box.appendChild(row);
      const svg=row.querySelector(`#pmSVG_${i}`);
      const labels=angles.map((v,j)=> j===missIdx? '?' : String(v));
      const redraw=()=>drawRegularPolygon(svg,n,labels, missIdx, row.querySelector('.proChk')?.checked || false);
      redraw(); addProToggle(row, `pmSVG_${i}`, redraw);
      pmState.items.push({ans});
    }
  }
  function pmCheck(){
    let ok=0; [...id('pmList').children].forEach((row,idx)=>{ const got=Number(row.querySelector('.pmIn').value); const want=pmState.items[idx].ans; row.style.borderColor=(got===want)? '#22c55e':'#ef4444'; if(got===want) ok++; });
    id('pmFb').textContent = ok===pmState.items.length? '✅ Nice!' : `Score: ${ok}/${pmState.items.length}`; if(ok===pmState.items.length) confetti();
  }
  id('pmNew').addEventListener('click',pmNew); pmNew();
  id('pmCheck').addEventListener('click',pmCheck);
  id('pmExportCSV').addEventListener('click',()=>{ const rows=[['answer','user']]; [...id('pmList').children].forEach((row,idx)=>rows.push([pmState.items[idx].ans,row.querySelector('.pmIn').value||''])); downloadCSV(`${deckTitle}_P3_missing_interior.csv`, rows); });
  id('pmExportJSON').addEventListener('click',()=>{ const data=[...id('pmList').children].map((row,idx)=>({answer:pmState.items[idx].ans,user:row.querySelector('.pmIn').value||''})); downloadJSON(`${deckTitle}_P3_missing_interior.json`, data); });

  const exState={mode:'A',items:[]}; id('exModeA').addEventListener('click',()=>{ exState.mode='A'; id('exModeA').classList.add('active'); id('exModeB').classList.remove('active'); }); id('exModeB').addEventListener('click',()=>{ exState.mode='B'; id('exModeB').classList.add('active'); id('exModeA').classList.remove('active'); });
  function exNew(){
    const box=id('exList'); box.innerHTML=''; exState.items=[];
    for(let i=0;i<6;i++){
      if(exState.mode==='A'){
        const n=rand(3,12), ans=360/n;
        const row=document.createElement('div'); row.className='card p-4 text-left';
        row.innerHTML=`<div class="miniWrap">
          <div>
            <div class="flex items-center justify-between hdr"><div class="text-maroon font-semibold mb-1">Given n=${n} <span class="tag">diagram</span></div></div>
            <svg id="exSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
          </div>
          <div>Exterior angle = <input class="exIn border rounded px-2 py-1 w-24"> °</div>
        </div>`;
        box.appendChild(row);
        const svg=row.querySelector(`#exSVG_${i}`); const redraw=()=>drawExterior(svg,n,false,null,row.querySelector('.proChk')?.checked || false); redraw(); addProToggle(row, `exSVG_${i}`, redraw);
        exState.items.push({ans});
      } else {
        const n=choice([3,4,5,6,8,9,10,12]), ext=360/n, ans=n;
        const row=document.createElement('div'); row.className='card p-4 text-left';
        row.innerHTML=`<div class="miniWrap">
          <div>
            <div class="flex items-center justify-between hdr"><div class="text-maroon font-semibold mb-1">Given exterior ${ext}° <span class="tag">diagram</span></div></div>
            <svg id="exSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
          </div>
          <div>Number of sides n = <input class="exIn border rounded px-2 py-1 w-24"></div>
        </div>`;
        box.appendChild(row);
        const svg=row.querySelector(`#exSVG_${i}`); const redraw=()=>drawExterior(svg,n,true,ext,row.querySelector('.proChk')?.checked || false); redraw(); addProToggle(row, `exSVG_${i}`, redraw);
        exState.items.push({ans});
      }
    }
  }
  function exCheck(){
    let ok=0; [...id('exList').children].forEach((row,idx)=>{ const got=Number(row.querySelector('.exIn').value); const want=exState.items[idx].ans; row.style.borderColor=(Math.abs(got-want)<1e-10)? '#22c55e':'#ef4444'; if(Math.abs(got-want)<1e-10) ok++; }); id('exFb').textContent= ok===exState.items.length? '✅ Perfect.' : `Score: ${ok}/${exState.items.length}`; if(ok===exState.items.length) confetti();
  }
  id('exNew').addEventListener('click',exNew); exNew();
  id('exCheck').addEventListener('click',exCheck);
  id('exExportCSV').addEventListener('click',()=>{ const rows=[['answer','user']]; [...id('exList').children].forEach((row,idx)=>rows.push([exState.items[idx].ans,row.querySelector('.exIn').value||''])); downloadCSV(`${deckTitle}_P3_exterior.csv`, rows); });
  id('exExportJSON').addEventListener('click',()=>{ const data=[...id('exList').children].map((row,idx)=>({answer:exState.items[idx].ans,user:row.querySelector('.exIn').value||''})); downloadJSON(`${deckTitle}_P3_exterior.json`, data); });

  /* ==============================
     PART 3 — Real life (polygons)
     ============================== */
  const p3RealState={items:[]};
  function addPolyReal(prompt, ans, n, mode, extVal=null, labels=null){
    const box=id('p3RealList'); const idx=box.children.length;
    const row=document.createElement('div'); row.className='card p-4';
    row.innerHTML=`<div class="miniWrap">
      <div>
        <div class="flex items-center justify-between hdr"><div class="text-maroon font-semibold mb-1">Task ${idx+1} <span class="tag">diagram</span></div></div>
        <svg id="p3RSVG_${idx}" class="miniSvg" viewBox="0 0 360 230"></svg>
      </div>
      <div><div class="text-left">${prompt}</div><div class="mt-2">Answer: <input class="rin border rounded px-2 py-1 w-28"></div></div>
    </div>`;
    box.appendChild(row);
    const svg=row.querySelector(`#p3RSVG_${idx}`);
    const redraw=()=>{
      if(mode==='int') drawRegularPolygon(svg,n,[], -1, row.querySelector('.proChk')?.checked || false);
      else if(mode==='ext') drawExterior(svg,n,true,extVal,row.querySelector('.proChk')?.checked || false);
      else if(mode==='labels') drawRegularPolygon(svg,n,labels, labels.findIndex(v=>v==='?'), row.querySelector('.proChk')?.checked || false);
    };
    redraw(); addProToggle(row, `p3RSVG_${idx}`, redraw);
    p3RealState.items.push({ans});
  }
  function p3RealNew(){
    const box=id('p3RealList'); box.innerHTML=''; p3RealState.items=[];
    const n1=6; addPolyReal(`A regular hex tile must meet at a point without gaps. What is each interior angle?`, (n1-2)*180/n1, n1,'int');
    const n2=choice([5,6,8,10,12]); const ext=360/n2; addPolyReal(`A logo repeats a ${ext}° turn at each corner. How many sides has the regular polygon?`, n2, n2,'ext',ext);
    const n3=choice([4,5,6,8]); addPolyReal(`A robot traces a regular n‑gon with n=${n3}. What is the exterior turn at each vertex?`, 360/n3, n3,'ext');
    const angles=makePolygonAngles(5), idx=rand(0,4), ans=angles[idx]; angles[idx]='?'; addPolyReal(`A panel has interior angles [${angles.join(', ')}]°. Find the missing angle.`, ans, 5, 'labels', null, angles);
  }
  id('p3RealNew').addEventListener('click',p3RealNew); p3RealNew();
  id('p3RealCheck').addEventListener('click',()=>{
    let ok=0; [...id('p3RealList').querySelectorAll('.rin')].forEach((el,idx)=>{ const got=Number(el.value); const want=p3RealState.items[idx].ans; const good=(Math.abs(got-want)<1e-10); el.style.borderColor=good? '#22c55e':'#ef4444'; if(good) ok++; });
    id('p3RealFb').textContent = ok===p3RealState.items.length? '✅ Great!' : `Score: ${ok}/${p3RealState.items.length}`; if(ok===p3RealState.items.length) confetti();
  });
  id('p3RealExportCSV').addEventListener('click',()=>{ const rows=[['answer','user']]; [...id('p3RealList').children].forEach((row,idx)=>rows.push([p3RealState.items[idx].ans, row.querySelector('.rin').value||''])); downloadCSV(`${deckTitle}_P3_real.csv`, rows); });
  id('p3RealExportJSON').addEventListener('click',()=>{ const data=[...id('p3RealList').children].map((row,idx)=>({answer:p3RealState.items[idx].ans, user:row.querySelector('.rin').value||''})); downloadJSON(`${deckTitle}_P3_real.json`, data); });

  /* ==============================
     PART 4 — Angle chase, Error, Mixed
     ============================== */
  const acState={items:[]};
  function acNew(){
    const lv=id('acLevel').value; acState.items=[]; const box=id('acList'); box.innerHTML='';
    for(let i=0;i<6;i++){
      const t=choice(['cross','line','around']);
      let prob, redraw;
      if(t==='cross'){ // given one, chase another via vertical/linear pair
        const a=rand(25,140), want=(180-a); prob={type:t, a,want, prompt:`Given ∠A = ${a}°, find ∠B adjacent to A on the straight line.`};
        redraw=(svg,pro)=>diagLinearPair(svg,a,{showUnknown:true, unknownLabel:'?', pro, teacherVal:TEACHER?`${want}°`:null});
      } else if(t==='line'){
        const a=rand(30,150), want=a; prob={type:t, a,want, prompt:`Two lines intersect. If ∠A = ${a}°, find its vertical angle.`};
        redraw=(svg,pro)=>diagIntersecting(svg,a,'vertical',{showUnknown:true, unknownLabel:'?', pro, teacherVal:TEACHER?`${want}°`:null});
      } else {
        const A=rand(60,150),B=rand(40,120),C=rand(30,110), want=360-(A+B+C); prob={type:t,A,B,C,want, prompt:`Angles around point: ${A}°, ${B}°, ${C}°. Find the fourth.`};
        redraw=(svg,pro)=>diagAroundPoint(svg,A,B,C,{showUnknown:true,unknownLabel:'?', pro, teacherVal:TEACHER?`${want}°`:null});
      }
      const row=document.createElement('div'); row.className='card p-4 text-left';
      row.innerHTML=`<div class="miniWrap">
        <div>
          <div class="flex items-center justify-between hdr"><div class="text-maroon font-semibold mb-1">Item ${i+1} <span class="tag">diagram</span></div></div>
          <svg id="acSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
        </div>
        <div><div class="mb-2">${prob.prompt}</div><div>Answer: <input class="acIn border rounded px-2 py-1 w-24"> °</div></div>
      </div>`;
      box.appendChild(row);
      const svg=row.querySelector(`#acSVG_${i}`); const rfn=()=>redraw(svg, row.querySelector('.proChk')?.checked || false); rfn(); addProToggle(row, `acSVG_${i}`, rfn);
      acState.items.push(prob);
    }
  }
  function acCheck(){
    let ok=0; [...id('acList').children].forEach((row,idx)=>{ const p=acState.items[idx]; const got=Number(row.querySelector('.acIn').value); const want=p.want; const good=(Math.abs(got-want)<1e-10); row.style.borderColor=good? '#22c55e':'#ef4444'; if(good) ok++; });
    id('acFb').textContent = ok===acState.items.length? '✅ Angle chase mastered!' : `Score: ${ok}/${acState.items.length}`; if(ok===acState.items.length) confetti();
  }
  id('acNew').addEventListener('click',acNew); acNew();
  id('acCheck').addEventListener('click',acCheck);
  id('acExportCSV').addEventListener('click',()=>{ const rows=[['prompt','answer','user']]; [...id('acList').children].forEach((row,idx)=>rows.push([row.querySelector('.mb-2').innerText.trim(), acState.items[idx].want, row.querySelector('.acIn').value||''])); downloadCSV(`${deckTitle}_P4_chase.csv`, rows); });
  id('acExportJSON').addEventListener('click',()=>{ const data=[...id('acList').children].map((row,idx)=>({prompt:row.querySelector('.mb-2').innerText.trim(), answer:acState.items[idx].want, user:row.querySelector('.acIn').value||''})); downloadJSON(`${deckTitle}_P4_chase.json`, data); });

  // Error analysis (figures + choices)
  function errBank(level){
    const easy=[
      {work:'“Vertical angles add to 180°.”', correct:'Vertical angles are equal, not necessarily supplementary.', key:'A', fig:(s,pro)=>diagIntersecting(s,50,'vertical',{showUnknown:false,pro})},
      {work:'For complementary angles: \\(x+(2x+30)=180\\).', correct:'Complementary sum to 90°, not 180°.', key:'B', fig:(s,pro)=>diagComplement(s,35,{pro})},
      {work:'Solve: \\(3x+12=2x+32\\) → \\(x=44\\).', correct:'Subtract \(2x\): \(x+12=32\\Rightarrow x=20\\).', key:'C', fig:(s,pro)=>diagLinearPair(s,120,{pro})},
      {work:'Pentagon interior sum is \\((n-1)\\cdot180\\).', correct:'Use \\((n-2)\\cdot180\\). For \(n=5\), sum \(=540°\\).', key:'D', fig:(s,pro)=>drawRegularPolygon(s,5,[], -1, pro)}
    ];
    const med=[
      {work:'Adjacent angles that sum to 180° are complementary.', correct:'They are supplementary; complementary sum to 90°.', key:'A', fig:(s,pro)=>diagLinearPair(s,110,{pro})},
      {work:'Linear pair: \\((4x+10)+(x+20)=90\\).', correct:'Linear pair → 180°, not 90°.', key:'B', fig:(s,pro)=>diagLinearPair(s,120,{pro})},
      {work:'If \(2x+15=2x+5\\), then \(x=10\\).', correct:'Subtract \(2x\): \(15=5\\) → no solution.', key:'C', fig:(s,pro)=>diagIntersecting(s,70,'vertical',{pro})},
      {work:'Regular nonagon exterior angle is \(20°\\).', correct:'Exterior \(=360/9=40°\\).', key:'D', fig:(s,pro)=>drawExterior(s,9,true,40,pro)}
    ];
    const hard=[
      {work:'Angles around a point: \(x+ (x+30)+(2x-20)=180\\).', correct:'Around a point total \(360°\\).', key:'B', fig:(s,pro)=>diagAroundPoint(s,120,90,70,{pro})},
      {work:'“Complementary angles must be adjacent.”', correct:'They need not be adjacent; only the sum matters.', key:'A', fig:(s,pro)=>diagComplement(s,35,{pro})},
      {work:'From \\((3x+5)+(4x+25)=180\\) → \(7x=180\\).', correct:'Forgot constants: \(7x+30=180 \\Rightarrow x=150/7\\).', key:'C', fig:(s,pro)=>diagLinearPair(s,130,{pro})},
      {work:'A convex regular polygon’s interior angle can be \(200°\\).', correct:'Impossible: interior \(=180-360/n<180°\\).', key:'D', fig:(s,pro)=>drawRegularPolygon(s,8,[], -1, pro)}
    ];
    return level==='easy'?easy: level==='med'?med: hard;
  }
  const errState={item:null};
  function errNew(){
    const bank=errBank(id('errLevel').value); errState.item=bank[rand(0,bank.length-1)];
    id('errBox').innerHTML=`Student claim:<br/><div class="mt-1 text-maroon">${errState.item.work}</div>`;
    id('errFb').textContent=''; id('errRevealBox').textContent='';
    const pro=false; const s=id('errSvg'); errState.item.fig(s,pro); renderMath(id('errSlide'));
  }
  id('errNew').addEventListener('click',errNew); errNew();
  id('errCheck').addEventListener('click',()=>{ const sel=[...document.querySelectorAll('input[name="errChoice"]')].find(x=>x.checked); if(!sel){ id('errFb').textContent='Choose a reason.'; return; } if(sel.value===errState.item.key){ id('errFb').textContent='✅ Correct diagnosis.'; confetti(); } else id('errFb').textContent='❌ Try again.'; });
  id('errReveal').addEventListener('click',()=>{ id('errRevealBox').innerHTML=`<div class="hint">${errState.item.correct}</div>`; renderMath(id('errSlide')); });
  id('errExportCSV').addEventListener('click',()=>{ const sel=[...document.querySelectorAll('input[name="errChoice"]')].find(x=>x.checked); downloadCSV(`${deckTitle}_error.csv`, [['claim','explanation','key','user'], [id('errBox').innerText.trim(), errState.item.correct, errState.item.key, sel?sel.value:'']]); });
  id('errExportJSON').addEventListener('click',()=>{ const sel=[...document.querySelectorAll('input[name="errChoice"]')].find(x=>x.checked); downloadJSON(`${deckTitle}_error.json`, {claim:id('errBox').innerText.trim(), explanation:errState.item.correct, key:errState.item.key, user: sel?sel.value:''}); });

  /* ==============================
     PART 4 — Mixed review
     ============================== */
  const mixState={cur:null};
  function mixNew(){
    const t=rand(0,5), s=id('mixSvg'); clearSvg(s);
    if(t===0){ // classify
      const kind=choice(TYPES); mixState.cur={type:'class',want:kind};
      id('mixQ').innerHTML='Name the relationship shown.';
      if(kind==='vertical') diagIntersecting(s,rand(25,140),'vertical',{showUnknown:false});
      else if(kind==='adjacent') diagIntersecting(s,rand(25,70),'adjacent',{showUnknown:false});
      else if(kind==='linear pair'||kind==='supplementary') diagLinearPair(s,rand(30,150),{showUnknown:false});
      else if(kind==='complementary') diagComplement(s,rand(20,70),{showUnknown:false});
      else { // neither
        drawRay(s,120,115,0,70,{w:2.2}); drawRay(s,120,115,35,70,{w:2.2}); drawAngleArc(s,120,115,40,0,35,'#C7A34F',3,'35°');
        drawRay(s,240,115,180,70,{w:2.2}); drawRay(s,240,115,230,70,{w:2.2}); drawAngleArc(s,240,115,40,180,230,'#f59e0b',3,'50°'); tagNS(s);
      }
    } else if(t===1){ // missing
      const kind=choice(['comp','supp','vert','lp','around']); let o={};
      if(kind==='comp'){ const a=rand(15,75); o={prompt:`Find the complement of ${a}°`, ans:90-a, draw:(pro)=>diagComplement(s,a,{showUnknown:true,unknownLabel:'?',pro})}; }
      else if(kind==='supp'){ const a=rand(25,170); o={prompt:`Linear pair with ${a}°. Find the other.`, ans:180-a, draw:(pro)=>diagLinearPair(s,a,{showUnknown:true,unknownLabel:'?',pro})}; }
      else if(kind==='vert'){ const a=rand(15,165); o={prompt:`Vertical to ${a}°`, ans:a, draw:(pro)=>diagIntersecting(s,a,'vertical',{showUnknown:true,unknownLabel:'?',pro})}; }
      else if(kind==='lp'){ const a=rand(25,155); o={prompt:`Straight line partner of ${a}°`, ans:180-a, draw:(pro)=>diagLinearPair(s,a,{showUnknown:true,unknownLabel:'?',pro})}; }
      else { const A=rand(60,140),B=rand(40,120),C=rand(30,110); o={prompt:`Around point: ${A}, ${B}, ${C}`, ans:360-(A+B+C), draw:(pro)=>diagAroundPoint(s,A,B,C,{showUnknown:true,unknownLabel:'?',pro})}; }
      id('mixQ').innerHTML=o.prompt; mixState.cur={type:'miss',want:o.ans}; o.draw(false);
    } else if(t===2){ // solve x
      const p=problemSupp(); mixState.cur={type:'solve', p}; id('mixQ').innerHTML=(p.type==='vert'? `\\( ${p.e1.a}x+${p.e1.b} = ${p.e2.a}x+${p.e2.b} \\)` : `\\( (${p.e1.a}x+${p.e1.b})+(${p.e2.a}x+${p.e2.b})=${p.target} \\)`); renderMath(id('mixSlide')); drawSolve(s,p,false);
    } else if(t===3){ // polygon missing
      const n=rand(4,7); const A=makePolygonAngles(n); const idx=rand(0,n-1); const ans=A[idx]; const labels=A.map((v,j)=> j===idx? '?' : String(v));
      mixState.cur={type:'polyMiss',want:ans}; id('mixQ').innerHTML=`n=${n}, find the missing interior angle.`; drawRegularPolygon(s,n,labels, idx,false);
    } else if(t===4){ // ext->n
      const n=choice([3,4,5,6,8,9,10,12]), ext=360/n; mixState.cur={type:'ext2n',want:n}; id('mixQ').innerHTML=`Exterior angle = ${ext}°. Find n.`; drawExterior(s,n,true,ext,false);
    } else { // n->ext
      const n=rand(3,12), ext=360/n; mixState.cur={type:'n2ext',want:ext}; id('mixQ').innerHTML=`Regular polygon with n=${n}. Find exterior angle.`; drawExterior(s,n,false,null,false);
    }
    id('mixHintBox').textContent=''; id('mixFb').textContent=''; id('mixAns').value='';
  }
  id('mixNew').addEventListener('click',mixNew); mixNew();
  id('mixHint').addEventListener('click',()=>{ const t=mixState.cur?.type; let msg=''; if(t==='class') msg='Complementary→90°, Linear/Supplementary→180°, Vertical→equal, Adjacent→share a side.'; else if(t==='miss') msg='Use the correct sum: 90°, 180°, or 360°.'; else if(t==='solve') msg='Form the equation from the diagram then solve for x; check angle sizes.'; else if(t==='polyMiss') msg='Sum of interior angles is (n−2)·180°.'; else if(t==='ext2n') msg='Exterior of regular n‑gon is 360°/n.'; else msg='Exterior of regular n‑gon is 360°/n.'; id('mixHintBox').innerHTML=`<div class="hint">${msg}</div>`; });
  id('mixCheck').addEventListener('click',()=>{ const ans=id('mixAns').value.trim(); const t=mixState.cur?.type; if(!t) return; let ok=false, expect=''; if(t==='class'){ ok=ans.toLowerCase().includes(mixState.cur.want); expect=mixState.cur.want; } else if(t==='miss'||t==='polyMiss'||t==='n2ext'){ const w=Number(mixState.cur.want); ok=(Number(ans)===w); expect=w; } else if(t==='ext2n'){ ok=(Number(ans)===mixState.cur.want); expect=mixState.cur.want; } else if(t==='solve'){ const p=mixState.cur.p; const x=(p.type==='vert'? (p.e2.b-p.e1.b)/(p.e1.a-p.e2.a) : (p.target-(p.e1.b+p.e2.b))/(p.e1.a+p.e2.a)); ok=(Number(ans)===x); expect='x='+x; } id('mixFb').textContent= ok? '✅ Correct! '+expect : '❌ Expected '+expect; if(ok) confetti(); });
  id('mixExportCSV').addEventListener('click',()=>downloadCSV(`${deckTitle}_mixed.csv`, [['prompt','user'], [id('mixQ').textContent, id('mixAns').value||'']])); id('mixExportJSON').addEventListener('click',()=>downloadJSON(`${deckTitle}_mixed.json`, {prompt:id('mixQ').textContent, user:id('mixAns').value||''}));

  /* ==============================
     PART 5 — Parallels & Transversal
     ============================== */
  // diagram engine for two parallel horizontal lines and a transversal at angle t
  function diagParallels(svg, baseAngle=50, relation='corresponding', opts={}){
    const {showUnknown=false, unknownLabel='?', pro=false, teacherVal=null}=opts;
    clearSvg(svg);
    const W=svg.viewBox.baseVal.width||360,H=svg.viewBox.baseVal.height||230;
    const top=H/2-40, bot=H/2+40; const tAng=baseAngle; const x1=40, x2=W-40;
    line(svg,x1,top,x2,top,{w:2.2}); line(svg,x1,bot,x2,bot,{w:2.2});
    // transversal crossing both
    const tx=W/2, ty=H/2; const len=160;
    drawLineThrough(svg, W/2, top, tAng, 200,{w:2.2});
    drawLineThrough(svg, W/2, bot, tAng, 200,{w:2.2});
    // At each intersection, the acute angle with the top line equals a (call it 'a')
    // acute a is min(|tAng|, 180-|tAng|)
    const a = (baseAngle<=90? baseAngle : 180-baseAngle);
    // choose positions to label based on relation
    const r=28;
    // top intersection center
    const txc=W/2, tyc=top;
    // bottom intersection center
    const bxc=W/2, byc=bot;
    // We use 0° as rightward baseline for the lines; top line baseline angle 0; bottom also 0
    // An exterior/interior choice is positional; we will pick standard "top-left" at each intersection.
    // Label A (given) at top-left interior angle = a; unknown label at the related position
    // Determine quadrant arcs: from baseline 0 to transversal angle (taking acute)
    const startTop = 0, endTop = (baseAngle<=90? baseAngle : 360-baseAngle); // CCW minor
    drawAngleArc(svg, txc, tyc, r, startTop, endTop,'#C7A34F',3, `${a}°`);
    let placeUnknownAt=''; // 'top-right', 'bottom-left', etc.; we’ll map by relation
    if(relation==='corresponding'){ // same relative position (top-left top ↔ top-left bottom)
      drawAngleArc(svg, bxc, byc, r, startTop, endTop,'#f59e0b',3, showUnknown?(teacherVal??unknownLabel):`${a}°`);
    } else if(relation==='alternate interior'){
      // interior on opposite sides of transversal: top-left interior equals bottom-right interior
      // bottom-right: arc from 180 to 180+(-endTop)? easier: use 180 - a with orientation mirrored.
      drawAngleArc(svg, bxc, byc, r, 180, 180+ (baseAngle<=90? baseAngle : -baseAngle),'#f59e0b',3, showUnknown?(teacherVal??unknownLabel):`${a}°`);
    } else if(relation==='same-side interior'){
      // interior angles on same side sum to 180 → partner at bottom-left interior equals 180-a
      drawAngleArc(svg, bxc, byc, r, startTop, endTop,'#f59e0b',3, showUnknown?(teacherVal??unknownLabel):`${180-a}°`);
    } else if(relation==='alternate exterior'){
      // exterior top-right with bottom-left equal to a
      drawAngleArc(svg, bxc, byc, r, 180, 180+ (baseAngle<=90? baseAngle : -baseAngle),'#f59e0b',3, showUnknown?(teacherVal??unknownLabel):`${a}°`);
    } else if(relation==='vertical'){
      // at top intersection itself: vertical equal
      drawAngleArc(svg, txc, tyc, r, startTop+180, endTop+180,'#f59e0b',3, showUnknown?(teacherVal??unknownLabel):`${a}°`);
    }
    if(pro){ drawProtractor(svg, txc, tyc, 52, 0); drawProtractor(svg, bxc, byc, 52, 0); }
    tagNS(svg);
  }

  const parState={items:[]};
  function parNew(){
    const box=id('parList'); box.innerHTML=''; parState.items=[];
    for(let i=0;i<6;i++){
      const type=choice(['corresponding','alternate interior','same-side interior','vertical']);
      const base=choice([35,45,55,65,75,105,125]); // ensures variety and acute measure a
      let ans;
      if(type==='same-side interior') ans=(base<=90? 180-base : 180-(180-base)); else ans=(base<=90? base : 180-base);
      const row=document.createElement('div'); row.className='card p-4 text-left';
      row.innerHTML=`<div class="miniWrap">
        <div>
          <div class="flex items-center justify-between hdr"><div class="text-maroon font-semibold mb-1">Item ${i+1} (${type}) <span class="tag">diagram</span></div></div>
          <svg id="parSVG_${i}" class="miniSvg" viewBox="0 0 360 230"></svg>
        </div>
        <div>
          <div class="mb-2">Given the highlighted angle \(=a\). Find the related angle.</div>
          <div>Answer: <input class="parIn border rounded px-2 py-1 w-24"> °</div>
        </div>
      </div>`;
      box.appendChild(row);
      const svg=row.querySelector(`#parSVG_${i}`);
      const redraw=()=>diagParallels(svg, base, type, {showUnknown:true, unknownLabel:'?', pro: row.querySelector('.proChk')?.checked || false, teacherVal: TEACHER?`${ans}°`:null});
      redraw(); addProToggle(row, `parSVG_${i}`, redraw);
      parState.items.push({ans});
    }
  }
  function parCheck(){
    let ok=0; [...id('parList').children].forEach((row,idx)=>{ const got=Number(row.querySelector('.parIn').value); const want=parState.items[idx].ans; const good=(Math.abs(got-want)<1e-10); row.style.borderColor=good? '#22c55e':'#ef4444'; if(good) ok++; });
    id('parFb').textContent = ok===parState.items.length? '✅ Parallels on lock!' : `Score: ${ok}/${parState.items.length}`; if(ok===parState.items.length) confetti();
  }
  id('parNew').addEventListener('click',parNew); parNew();
  id('parCheck').addEventListener('click',parCheck);
  id('parExportCSV').addEventListener('click',()=>{ const rows=[['answer','user']]; [...id('parList').children].forEach((row,idx)=>rows.push([parState.items[idx].ans, row.querySelector('.parIn').value||''])); downloadCSV(`${deckTitle}_P5_parallels.csv`, rows); });
  id('parExportJSON').addEventListener('click',()=>{ const data=[...id('parList').children].map((row,idx)=>({answer:parState.items[idx].ans, user:row.querySelector('.parIn').value||''})); downloadJSON(`${deckTitle}_P5_parallels.json`, data); });

  /* ---------- Init ---------- */
  window.addEventListener('resize',()=>{ if(slides[i].id==='builderSlide') drawAngle(); if(slides[i].id==='polySlide') drawPolyExplorer(); });
  show(0);

})();
</script>
</body>
</html>
